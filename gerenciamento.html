<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <meta
            name="description"
            content="Sistema de gest√£o de loja de roupas - Controle de vendas e custos"
        />
        <meta name="theme-color" content="#dc3545" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-mobile-web-app-title" content="Loja Vendas" />
        <title>Loja - Gest√£o</title>
        <link rel="stylesheet" href="/css/style.css" id="css-link" />
        <link rel="manifest" href="/manifest.json" />
        <link
            rel="icon"
            type="image/png"
            sizes="192x192"
            href="/icon-192.png"
        />
        <link rel="apple-touch-icon" href="/icon-192.png" />
        <script>
            // For√ßar recarregamento do CSS adicionando timestamp
            (function () {
                const cssLink = document.getElementById('css-link');
                if (cssLink) {
                    cssLink.href = '/css/style.css?v=' + Date.now();
                }
            })();
        </script>
    </head>
    <body>
        <div class="app-container">
            <header class="header">
                <h1>Loja - Gest√£o de Itens</h1>
                <div class="header-actions">
                    <button id="importBtn" class="btn-secondary">
                        Importar Dados
                    </button>
                    <button id="exportBtn" class="btn-secondary">
                        Exportar Dados
                    </button>
                    <input
                        type="file"
                        id="importFile"
                        accept=".txt"
                        style="display: none"
                    />
                    <button type="button" id="logoutBtn" class="btn-secondary">Sair</button>
                </div>
            </header>

            <main class="main-content">
                <div class="toolbar">
                    <button type="button" id="newItemBtn" class="btn-primary">
                        + Cadastrar Novo Item
                    </button>
                    <button type="button" id="newGroupBtn" class="btn-primary">
                        + Criar Grupo Mensal
                    </button>
                    <div class="search-filter">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Pesquisar por nome ou marca..."
                        />
                        <select id="monthFilter">
                            <option value="">Todos os meses</option>
                        </select>
                    </div>
                </div>

                <div class="content-tabs">
                    <button class="tab-btn active" data-tab="items">
                        Itens
                    </button>
                    <button class="tab-btn" data-tab="groups">
                        Grupos Mensais
                    </button>
                    <button class="tab-btn" data-tab="costs">
                        Custos de Compra
                    </button>
                </div>

                <!-- Tab: Itens -->
                <div id="itemsTab" class="tab-content active">
                    <div id="itemsGrid" class="items-grid">
                        <!-- Itens ser√£o inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Tab: Grupos Mensais -->
                <div id="groupsTab" class="tab-content">
                    <div class="groups-layout">
                        <div class="overall-summary-card">
                            <h3>Resumo Geral</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <h4>Total de Vendas</h4>
                                    <p id="overallTotalSales">0</p>
                                </div>
                                <div class="stat-item">
                                    <h4>Valor Total Vendas</h4>
                                    <p id="overallTotalValue">R$ 0,00</p>
                                </div>
                                <div
                                    class="stat-item"
                                    style="
                                        background: #fff3cd;
                                        border: 1px solid #ffc107;
                                    "
                                >
                                    <h4>Total de Custos</h4>
                                    <p
                                        id="overallTotalCosts"
                                        style="color: #856404"
                                    >
                                        R$ 0,00
                                    </p>
                                </div>
                                <div
                                    class="stat-item"
                                    style="
                                        background: #d4edda;
                                        border: 1px solid #28a745;
                                    "
                                >
                                    <h4>Lucro L√≠quido</h4>
                                    <p
                                        id="overallNetProfit"
                                        style="
                                            color: #155724;
                                            font-size: 1.6rem;
                                        "
                                    >
                                        R$ 0,00
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="groups-content">
                            <div id="groupsList" class="groups-list">
                                <!-- Grupos ser√£o inseridos aqui via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Custos de Compra -->
                <div id="costsTab" class="tab-content">
                    <div class="costs-layout">
                        <div class="costs-summary-card">
                            <h3>Resumo de Custos</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <h4>Total de Compras</h4>
                                    <p id="totalCostsCount">0</p>
                                </div>
                                <div class="stat-item">
                                    <h4>Valor Total Custos</h4>
                                    <p id="totalCostsValue">R$ 0,00</p>
                                </div>
                            </div>
                        </div>
                        <div class="costs-content">
                            <div class="toolbar-costs">
                                <button type="button" id="newCostBtn" class="btn-primary">
                                    + Cadastrar Novo Custo
                                </button>
                            </div>
                            <div id="costsList" class="costs-list">
                                <!-- Custos ser√£o inseridos aqui via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="footer">
                <p>Gerenciamento de loja vendas</p>
            </footer>
        </div>

        <!-- Modal: Cadastro/Edi√ß√£o de Item -->
        <div id="itemModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Cadastrar Novo Item</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="itemForm">
                    <div class="form-group">
                        <label for="itemName">Nome do Item *</label>
                        <input type="text" id="itemName" required />
                    </div>
                    <div class="form-group">
                        <label for="itemBrand">Marca *</label>
                        <input type="text" id="itemBrand" required />
                    </div>
                    <div class="form-group">
                        <label for="itemSize">Tamanho *</label>
                        <input type="text" id="itemSize" required />
                    </div>
                    <div class="form-group">
                        <label for="itemPrice">Pre√ßo *</label>
                        <input
                            type="number"
                            id="itemPrice"
                            step="0.01"
                            min="0.01"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="itemGender">G√™nero *</label>
                        <select id="itemGender" required>
                            <option value="">Selecione...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Unissex">Unissex</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn-secondary"
                            id="cancelBtn"
                        >
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Criar Grupo Mensal -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Criar Grupo Mensal</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="groupForm">
                    <div class="form-group">
                        <label for="groupMonth">M√™s</label>
                        <input type="month" id="groupMonth" required />
                    </div>
                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn-secondary"
                            id="cancelGroupBtn"
                        >
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">Criar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Visualizar/Editar Grupo -->
        <div id="viewGroupModal" class="modal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2 id="groupTitle">Grupo Mensal</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="group-content">
                    <div class="group-summary">
                        <div class="summary-card">
                            <h3>Total de Vendas (M√™s)</h3>
                            <p id="totalSales">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Valor Total (M√™s)</h3>
                            <p id="totalValue">R$ 0,00</p>
                        </div>
                        <div
                            class="summary-card"
                            style="
                                background: #fff3cd;
                                border: 2px solid #ffc107;
                            "
                        >
                            <h3>Total de Vendas (Todos os Meses)</h3>
                            <p
                                id="totalSalesAll"
                                style="
                                    color: #856404;
                                    font-size: 1.8rem;
                                    font-weight: bold;
                                "
                            >
                                0
                            </p>
                        </div>
                        <div
                            class="summary-card"
                            style="
                                background: #fff3cd;
                                border: 2px solid #ffc107;
                            "
                        >
                            <h3>Valor Total (Todos os Meses)</h3>
                            <p
                                id="totalValueAll"
                                style="
                                    color: #856404;
                                    font-size: 1.8rem;
                                    font-weight: bold;
                                "
                            >
                                R$ 0,00
                            </p>
                        </div>
                    </div>
                    <div class="days-container">
                        <h3>Vendas por Dia</h3>
                        <div id="daysList" class="days-list">
                            <!-- Dias ser√£o inseridos aqui -->
                        </div>
                    </div>
                    <div class="items-summary">
                        <h3>Resumo por Item</h3>
                        <div id="itemsSummary" class="items-summary-list">
                            <!-- Resumo ser√° inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Registrar Venda -->
        <div id="saleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Registrar Venda</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="saleForm">
                    <div class="form-group">
                        <label for="saleItem">Item *</label>
                        <select id="saleItem" required>
                            <option value="">Selecione um item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="saleDate">Data (Dia) *</label>
                        <input
                            type="number"
                            id="saleDate"
                            min="1"
                            max="31"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="saleQuantity">Quantidade *</label>
                        <input
                            type="number"
                            id="saleQuantity"
                            min="1"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="salePrice">Pre√ßo Aplicado *</label>
                        <input
                            type="number"
                            id="salePrice"
                            step="0.01"
                            min="0.01"
                            required
                        />
                    </div>
                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn-secondary"
                            id="cancelSaleBtn"
                        >
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            Registrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Cadastrar Custo de Compra -->
        <div id="costModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="costModalTitle">Cadastrar Novo Custo</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="costForm">
                    <div class="form-group">
                        <label for="costItem">Item *</label>
                        <select id="costItem" required>
                            <option value="">Selecione um item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="costDate">Data da Compra *</label>
                        <input type="date" id="costDate" required />
                    </div>
                    <div class="form-group">
                        <label for="costQuantity">Quantidade *</label>
                        <input
                            type="number"
                            id="costQuantity"
                            min="1"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="costPrice">Custo Unit√°rio *</label>
                        <input
                            type="number"
                            id="costPrice"
                            step="0.01"
                            min="0.01"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="costTotal">Custo Total</label>
                        <input
                            type="number"
                            id="costTotal"
                            step="0.01"
                            readonly
                            style="background: var(--light-gray)"
                        />
                    </div>
                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn-secondary"
                            id="cancelCostBtn"
                        >
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // TESTE DIRETO - Escrever no DOM para verificar se JavaScript est√° executando
            (function() {
                try {
                    // Fun√ß√£o para adicionar log (apenas no console agora)
                    function addDebugLog(msg) {
                        if (window.console && console.log) {
                            console.log(msg);
                        }
                    }
                    
                    addDebugLog('Script inline iniciado');
                    
                    function tentarInicializar() {
                        if (typeof LojaApp !== 'undefined') {
                            if (!window.app) {
                                console.log('üü° [GERENCIAMENTO.HTML] Criando LojaApp via script inline...');
                                try {
                                    window.app = new LojaApp();
                                    console.log('‚úÖ [GERENCIAMENTO.HTML] LojaApp criado com sucesso!');
                                } catch (error) {
                                    console.error('‚ùå [GERENCIAMENTO.HTML] Erro ao criar LojaApp:', error);
                                }
                            }
                        } else {
                            setTimeout(tentarInicializar, 200);
                        }
                    }
                    
                    if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        setTimeout(tentarInicializar, 100);
                    } else {
                        document.addEventListener('DOMContentLoaded', function() {
                            setTimeout(tentarInicializar, 100);
                        });
                    }
                } catch (error) {
                    // Se houver erro, mostrar no DOM
                    var errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;';
                    errorDiv.innerHTML = 'ERRO: ' + error.message;
                    document.body.appendChild(errorDiv);
                }
            })();
        </script>
        <script>
            // Carregar app.js com timestamp para evitar cache
            console.log(
                'üü£ [GERENCIAMENTO.HTML] ========== CARREGANDO APP.JS =========='
            );
            console.log('üü£ [GERENCIAMENTO.HTML] URL atual:', window.location.href);
            console.log('üü£ [GERENCIAMENTO.HTML] Timestamp:', Date.now());
            console.log(
                'üü£ [GERENCIAMENTO.HTML] SessionStorage antes de carregar app.js:',
                {
                    loggedIn: sessionStorage.getItem('loggedIn'),
                    username: sessionStorage.getItem('username'),
                }
            );

            const script = document.createElement('script');
            script.src = '/js/app.js?v=' + Date.now();

            script.onerror = function (e) {
                console.error('‚ùå [GERENCIAMENTO.HTML] Erro ao carregar app.js!');
                console.error('‚ùå [GERENCIAMENTO.HTML] Erro:', e);
                // Tentar novamente
                this.src = '/js/app.js?v=' + Date.now();
            };

            script.onload = function () {
                console.log('‚úÖ [GERENCIAMENTO.HTML] app.js carregado com sucesso!');
                console.log('‚úÖ [GERENCIAMENTO.HTML] LojaApp definido?', typeof LojaApp !== 'undefined');
                
                // Garantir que a aplica√ß√£o seja inicializada mesmo se DOMContentLoaded j√° foi disparado
                function tentarInicializarApp() {
                    if (typeof LojaApp !== 'undefined') {
                        if (!window.app) {
                            console.log('üü° [GERENCIAMENTO.HTML] Criando inst√¢ncia de LojaApp...');
                            try {
                                window.app = new LojaApp();
                                console.log('‚úÖ [GERENCIAMENTO.HTML] LojaApp criado com sucesso!');
                            } catch (error) {
                                console.error('‚ùå [GERENCIAMENTO.HTML] Erro ao criar LojaApp:', error);
                            }
                        } else {
                            console.log('‚ÑπÔ∏è [GERENCIAMENTO.HTML] LojaApp j√° existe');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è [GERENCIAMENTO.HTML] LojaApp ainda n√£o est√° definido, tentando novamente...');
                        setTimeout(tentarInicializarApp, 200);
                    }
                }
                
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    console.log('üü° [GERENCIAMENTO.HTML] DOM j√° est√° pronto, inicializando app...');
                    setTimeout(tentarInicializarApp, 100);
                } else {
                    document.addEventListener('DOMContentLoaded', tentarInicializarApp);
                }
            };

            document.head.appendChild(script);
            
            // Tamb√©m garantir inicializa√ß√£o quando DOMContentLoaded disparar
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üü° [GERENCIAMENTO.HTML] DOMContentLoaded disparado');
                
                function tentarInicializarApp() {
                    if (typeof LojaApp !== 'undefined') {
                        if (!window.app) {
                            console.log('üü° [GERENCIAMENTO.HTML] Criando inst√¢ncia de LojaApp no DOMContentLoaded...');
                            try {
                                window.app = new LojaApp();
                                console.log('‚úÖ [GERENCIAMENTO.HTML] LojaApp criado com sucesso no DOMContentLoaded!');
                            } catch (error) {
                                console.error('‚ùå [GERENCIAMENTO.HTML] Erro ao criar LojaApp:', error);
                            }
                        } else {
                            console.log('‚ÑπÔ∏è [GERENCIAMENTO.HTML] LojaApp j√° existe no DOMContentLoaded');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è [GERENCIAMENTO.HTML] LojaApp ainda n√£o est√° definido, aguardando...');
                        // Tentar novamente ap√≥s 500ms
                        setTimeout(() => {
                            if (typeof LojaApp !== 'undefined' && !window.app) {
                                console.log('üü° [GERENCIAMENTO.HTML] Criando inst√¢ncia de LojaApp (tentativa 2)...');
                                try {
                                    window.app = new LojaApp();
                                    console.log('‚úÖ [GERENCIAMENTO.HTML] LojaApp criado na tentativa 2!');
                                } catch (error) {
                                    console.error('‚ùå [GERENCIAMENTO.HTML] Erro na tentativa 2:', error);
                                }
                            }
                        }, 500);
                    }
                }
                
                setTimeout(tentarInicializarApp, 200);
            });
        </script>
        <script>
            // Service Worker DESABILITADO temporariamente para evitar cache
            // TODO: Reabilitar quando cache estiver funcionando corretamente
            /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado:', registration);
                    })
                    .catch((error) => {
                        console.log('Erro ao registrar Service Worker:', error);
                    });
            });
        }
        */

            // Desregistrar qualquer Service Worker existente
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .getRegistrations()
                    .then(function (registrations) {
                        for (let registration of registrations) {
                            registration.unregister();
                            console.log('Service Worker desregistrado');
                        }
                    });
            }
        </script>
    </body>
</html>

