console.log("üü£ [APP.JS] Script carregado e executando..."),window.__APP_INITIALIZED__?console.warn("[APP] Inicializa√ß√£o duplicada evitada"):window.__APP_INITIALIZED__=!0;class ToastSystem{constructor(){this.container=this.createContainer(),this.toasts=[],this.usuario=sessionStorage.getItem("username")}createContainer(){let e=document.getElementById("toast-container");if(!e)if(e=document.createElement("div"),e.id="toast-container",e.className="toast-container",document.body)document.body.appendChild(e);else{const t=()=>{document.body?document.body.appendChild(e):setTimeout(t,10)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}return e}show(e,t="info",o=3e3){const a=this.createToast(e,t);return this.container.appendChild(a),this.toasts.push(a),requestAnimationFrame(()=>{setTimeout(()=>a.classList.add("show"),10)}),o>0&&setTimeout(()=>this.hide(a),o),a}getEstoqueKey(e,t){return`estoque_${e}_${t}`}salvarEstoque(e,t,o){localStorage.setItem(this.getEstoqueKey(e,t),JSON.stringify(o))}carregarEstoqueDoMesSelecionado(){const e=this.usuario||sessionStorage.getItem("username"),t=document.getElementById("mesSelecionado"),o=document.getElementById("estoqueMes");if(!e||!t||!o)return void console.warn("‚ö†Ô∏è Usu√°rio, m√™s ou input de estoque n√£o encontrado");const a=t.value;if(!a)return;const s=this.carregarEstoque(e,a);s?(o.value=s.totalInicial,console.log("üì¶ Estoque carregado para o m√™s:",a,s)):(o.value="",console.log("‚ÑπÔ∏è Nenhum estoque encontrado para o m√™s:",a))}registrarVenda(e){const t=sessionStorage.getItem("username"),o=document.getElementById("mesSelecionado")?.value;if(!t||!o)return void console.warn("‚ö†Ô∏è Usu√°rio ou m√™s n√£o definido");let a=this.carregarEstoque(t,o);a?(a.movimentacoes.push({data:(new Date).toISOString().slice(0,10),tipo:"venda",qtd:-Math.abs(e)}),this.salvarEstoque(t,o,a),this.carregarEstoqueDoMesSelecionado(),console.log("üí∏ Venda registrada e estoque abatido:",e)):alert("Estoque do m√™s n√£o definido")}carregarEstoque(e,t){const o=localStorage.getItem(getEstoqueKey(e,t));return o?JSON.parse(o):null}createToast(e,t){const o=document.createElement("div");o.className=`toast toast-${t}`;const a=this.getIcon(t);return o.innerHTML=`\n            <div class="toast-icon">\n                <i class="fas fa-${a}"></i>\n            </div>\n            <div class="toast-message">${this.escapeHtml(e)}</div>\n            <button class="toast-close" aria-label="Fechar notifica√ß√£o" onclick="this.parentElement.remove()">\n                <i class="fas fa-times"></i>\n            </button>\n        `,o.addEventListener("click",e=>{(e.target.classList.contains("toast-close")||e.target.closest(".toast-close"))&&this.hide(o)}),o}hide(e){e&&e.parentElement&&(e.classList.add("hiding"),setTimeout(()=>{e.parentElement&&e.remove(),this.toasts=this.toasts.filter(t=>t!==e)},200))}getIcon(e){return{success:"check-circle",error:"exclamation-circle",warning:"exclamation-triangle",info:"info-circle"}[e]||"info-circle"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}success(e,t=3e3){return this.show(e,"success",t)}error(e,t=5e3){return this.show(e,"error",t)}warning(e,t=4e3){return this.show(e,"warning",t)}info(e,t=3e3){return this.show(e,"info",t)}}class ConfirmSystem{constructor(){this.modal=this.createModal()}createModal(){let e=document.getElementById("confirm-modal");if(!e){e=document.createElement("div"),e.id="confirm-modal",e.className="confirm-modal",e.innerHTML='\n                <div class="confirm-modal-content">\n                    <div class="confirm-modal-header">\n                        <div class="confirm-modal-icon" id="confirm-modal-icon">\n                            <i class="fas fa-exclamation-triangle"></i>\n                        </div>\n                        <h3 class="confirm-modal-title" id="confirm-modal-title">Confirmar a√ß√£o</h3>\n                    </div>\n                    <div class="confirm-modal-body" id="confirm-modal-body">\n                        Tem certeza que deseja continuar?\n                    </div>\n                    <div class="confirm-modal-actions">\n                        <button class="confirm-modal-btn confirm-modal-btn-cancel" id="confirm-modal-cancel">\n                            <i class="fas fa-times"></i> Cancelar\n                        </button>\n                        <button class="confirm-modal-btn confirm-modal-btn-confirm" id="confirm-modal-confirm">\n                            <i class="fas fa-check"></i> Confirmar\n                        </button>\n                    </div>\n                </div>\n            ';const t=()=>{document.body?document.body.appendChild(e):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):setTimeout(t,10)};t(),e.addEventListener("click",t=>{t.target===e&&this.close()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.classList.contains("active")&&this.close()})}return e}show(e={}){return new Promise(t=>{const{title:o="Confirmar a√ß√£o",message:a="Tem certeza que deseja continuar?",type:s="warning",confirmText:n="Confirmar",cancelText:r="Cancelar",confirmButtonClass:i="confirm-modal-btn-confirm",icon:c=null}=e,l=this.modal.querySelector("#confirm-modal-icon"),d=this.modal.querySelector("#confirm-modal-title"),m=this.modal.querySelector("#confirm-modal-body"),u=this.modal.querySelector("#confirm-modal-confirm"),p=this.modal.querySelector("#confirm-modal-cancel");if(l.className=`confirm-modal-icon ${s}`,c)l.innerHTML=`<i class="fas fa-${c}"></i>`;else{const e={warning:"exclamation-triangle",danger:"exclamation-circle",info:"info-circle"};l.innerHTML=`<i class="fas fa-${e[s]||"exclamation-triangle"}"></i>`}d.textContent=o,m.textContent=a,u.textContent=n,u.className=`confirm-modal-btn ${i}`,p.textContent=r;const g=u.cloneNode(!0),h=p.cloneNode(!0);u.parentNode.replaceChild(g,u),p.parentNode.replaceChild(h,p),g.addEventListener("click",()=>{this.close(),t(!0)}),h.addEventListener("click",()=>{this.close(),t(!1)}),this.modal.classList.add("active"),setTimeout(()=>h.focus(),100)})}close(){this.modal.classList.remove("active")}confirm(e,t="Confirmar a√ß√£o"){return this.show({message:e,title:t,type:"warning"})}danger(e,t="Aten√ß√£o!"){return this.show({message:e,title:t,type:"danger",confirmButtonClass:"confirm-modal-btn-danger",confirmText:"Excluir"})}info(e,t="Informa√ß√£o"){return this.show({message:e,title:t,type:"info"})}}let toast,confirmDialog;const initToastAndConfirm=()=>{toast||(toast=new ToastSystem),confirmDialog||(confirmDialog=new ConfirmSystem)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initToastAndConfirm):initToastAndConfirm();class LoadingOverlay{constructor(){this.overlay=this.createOverlay()}createOverlay(){let e=document.getElementById("loading-overlay");return e||(e=document.createElement("div"),e.id="loading-overlay",e.className="loading-overlay",e.innerHTML='\n                <div class="loading-overlay-content">\n                    <div class="loading-overlay-spinner"></div>\n                    <div class="loading-overlay-message" id="loading-overlay-message">Carregando...</div>\n                </div>\n            ',document.body.appendChild(e)),e}show(e="Carregando..."){const t=this.overlay.querySelector("#loading-overlay-message");t&&(t.textContent=e),this.overlay.classList.add("active")}hide(){this.overlay.classList.remove("active")}}let loadingOverlay;const initLoadingOverlay=()=>{loadingOverlay||(loadingOverlay=new LoadingOverlay)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initLoadingOverlay):initLoadingOverlay();class FieldValidator{constructor(){this.validators={required:e=>e.trim().length>0,email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),minLength:(e,t)=>e.length>=t,maxLength:(e,t)=>e.length<=t,cpf:e=>11===e.replace(/\D/g,"").length,phone:e=>{const t=e.replace(/\D/g,"");return t.length>=10&&t.length<=11},number:e=>!isNaN(e)&&""!==e,positive:e=>parseFloat(e)>0}}validateField(e,t={}){const o=e.value,a=[];let s=!0;return t.required&&!this.validators.required(o)&&(a.push("Este campo √© obrigat√≥rio"),s=!1),t.email&&o&&!this.validators.email(o)&&(a.push("Email inv√°lido"),s=!1),t.minLength&&o&&!this.validators.minLength(o,t.minLength)&&(a.push(`M√≠nimo de ${t.minLength} caracteres`),s=!1),t.maxLength&&o&&!this.validators.maxLength(o,t.maxLength)&&(a.push(`M√°ximo de ${t.maxLength} caracteres`),s=!1),t.cpf&&o&&!this.validators.cpf(o)&&(a.push("CPF inv√°lido"),s=!1),t.phone&&o&&!this.validators.phone(o)&&(a.push("Telefone inv√°lido"),s=!1),t.number&&o&&!this.validators.number(o)&&(a.push("Deve ser um n√∫mero"),s=!1),t.positive&&o&&!this.validators.positive(o)&&(a.push("Deve ser maior que zero"),s=!1),{isValid:s,errors:a}}setupFieldValidation(e,t={}){let o=e.parentElement;o.classList.contains("field-wrapper")||(o=document.createElement("div"),o.className="field-wrapper",e.parentElement.insertBefore(o,e),o.appendChild(e));let a=o.querySelector(".field-status");a||(a=document.createElement("i"),a.className="field-status fas",o.appendChild(a));let s=o.querySelector(".field-message");s||(s=document.createElement("div"),s.className="field-message",o.appendChild(s));let n=null;t.maxLength&&(n=o.querySelector(".char-counter"),n||(n=document.createElement("div"),n.className="char-counter",o.appendChild(n)));const r=()=>{const{isValid:o,errors:r}=this.validateField(e,t);if(e.classList.remove("valid","invalid"),""!==e.value.trim()&&e.classList.add(o?"valid":"invalid"),a.className="field-status fas",""!==e.value.trim()?a.classList.add(o?"fa-check-circle":"fa-exclamation-circle",o?"valid":"invalid"):a.classList.remove("fa-check-circle","fa-exclamation-circle","valid","invalid"),s.className="field-message",r.length>0?(s.classList.add("error","show"),s.textContent=r[0]):""!==e.value.trim()&&o?(s.classList.add("success","show"),s.textContent="Campo v√°lido"):s.classList.remove("show"),n){const o=e.value.length,a=t.maxLength;n.textContent=`${o}/${a}`,n.classList.remove("warning","error"),o>.9*a?n.classList.add("error"):o>.75*a&&n.classList.add("warning")}return o};e.addEventListener("input",r),e.addEventListener("blur",r),e.value&&r()}}const fieldValidator=new FieldValidator;class LojaApp{constructor(){this.items=[],this.groups=[],this.serviceGroups=[],this.serviceTypes=[],this.costs=[],this.goals=[],this.clients=[],this.clientNotifications=[],this.suppliers=[],this.completedSales=[],this.pendingOrders=[],this.serviceAppointments=[],this.currentEditingItem=null,this.currentEditingClient=null,this.currentEditingCoupon=null,this.currentEditingSupplier=null,this.currentGroup=null,this.currentServiceGroup=null,this.currentServiceDay=null,this.currentSaleDay=null,this.currentEditingCost=null,this.currentEditingGoal=null,this.modalStack=[],this.currentQRScanner=null,this.advancedSearchQRScanner=null,this.currentEditingPendingOrder=null,this.currentEditingServiceAppointment=null,this.currentDashboardType="sales",this.avgStockChart=null,this.goalsChart=null,this.costsChart=null,this.servicesChart=null,this.chartCache={},this.cacheStrategies={charts:{ttl:3e5},data:{ttl:6e4},images:{ttl:864e5}},this.tutorialStep=0,this.tutorialActive=!1,this.searchHistory=[],this.searchDebounceTimer=null,this.productSearchDebounceTimer=null,this.clientSearchDebounceTimer=null,this.supplierSearchDebounceTimer=null,this.coupons=[],this.auditLog=[],this.templates=[],this.currentEditingTemplate=null,this.itemTags={},this.dataAccessLogs=[],this.cookieConsent=null,this.actionThrottle={},this.requestQueue=[],this.lastRequestTime=0,this.requestCount=0,this.requestWindowStart=Date.now(),this.inactivityTimer=null,this.inactivityTimeout=18e5,this.lastActivityTime=Date.now(),this.backupHistory=[],this.encryptionKeys={},this.encryptionEnabled=!0,this.backupInterval=null,this.lastBackupTime=null,this.userPermissions={},this.entityLocks={},this.maxAuditLogSize=1e3,this.indexedDB=null,this.paymentConfig={pagseguro:{enabled:!1,email:"",token:""},mercadoPago:{enabled:!1,accessToken:"",publicKey:""},stripe:{enabled:!1,publishableKey:"",secretKey:""},pix:{enabled:!0,key:"",merchantName:"",merchantCity:""}},this.ecommerceConfig={woocommerce:{enabled:!1,url:"",consumerKey:"",consumerSecret:""},shopify:{enabled:!1,shop:"",apiKey:"",apiSecret:""},mercadoLivre:{enabled:!1,clientId:"",clientSecret:"",accessToken:""}},this.erpConfig={totvs:{enabled:!1,url:"",username:"",password:"",database:""},sap:{enabled:!1,url:"",username:"",password:"",client:""},outros:[]},this.emailConfig={enabled:!1,provider:"smtp",smtp:{host:"",port:587,secure:!1,username:"",password:""},sendgrid:{apiKey:""},ses:{accessKeyId:"",secretAccessKey:"",region:"us-east-1"},mailgun:{apiKey:"",domain:""}},this.smsConfig={enabled:!1,provider:"twilio",twilio:{accountSid:"",authToken:"",fromNumber:""},zenvia:{apiKey:"",fromNumber:""},totalvoice:{accessToken:"",fromNumber:""}},this.useIndexedDB=!1,this.dbName="LojaGestaoDB",this.dbVersion=1,this.voiceRecognition=null,this.voiceRecognitionActive=!1,this.voiceCommands={},this.pullToRefresh={startY:0,currentY:0,isPulling:!1,threshold:80,maxPull:120},this.scheduledReports=[],this.sharedReports=[],this.scheduledExports=[],this.scheduleCheckInterval=null,this.exportScheduleCheckInterval=null,this.emailTracking={},this.whatsappConfig={enabled:!1,provider:"whatsapp_business",apiKey:"",phoneNumberId:"",businessAccountId:"",webhookUrl:""},this.whatsappChats=[],this.whatsappAutomations=[],this.messageTemplates=[],this.messageHistory=[],this.scheduledMessages=[],this.init()}getUserLevel(){const e=sessionStorage.getItem("username");return e?"admin"===e?"admin":this.userPermissions[e]&&this.userPermissions[e].level||"user":"user"}closeGroupModal(){console.log("[MODAL] Fechando groupModal");const e=document.getElementById("groupModal");e&&(e.classList.remove("active"),e.classList.add("hidden"),e.style.display="none",e.style.visibility="",e.style.opacity="",e.style.pointerEvents="",document.body.style.overflow="",document.getElementById("groupForm")?.reset())}getUserPermissions(e){const t={admin:{read:!0,write:!0,delete:!0,export:!0,import:!0,manageUsers:!0,viewAdmin:!0},manager:{read:!0,write:!0,delete:!0,export:!0,import:!1,manageUsers:!1,viewAdmin:!1},user:{read:!0,write:!0,delete:!1,export:!1,import:!1,manageUsers:!1,viewAdmin:!1}};return t[e]||t.user}checkPermission(e,t=null){const o=sessionStorage.getItem("username");if(!o)return!1;if("admin"===o)return!0;const a=this.getUserLevel();return!0===this.getUserPermissions(a)[e]}logAction(e,t,o,a,s={}){const n=sessionStorage.getItem("username")||"unknown",r=(new Date).toISOString();let i=s.previousData||null;"update"===e&&!i&&o&&(i=this.getPreviousDataFromAuditLog(t,o)),i&&(s.previousData=i);const c={id:"AUDIT_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),action:e,entityType:t,entityId:o,entityName:a,username:n,timestamp:r,details:s,reversible:"update"===e&&null!==i||"create"===e&&null!==o};this.auditLog.unshift(c),this.auditLog.length>this.maxAuditLogSize&&(this.auditLog=this.auditLog.slice(0,this.maxAuditLogSize)),setTimeout(()=>{this.saveData()},100)}getPreviousDataFromAuditLog(e,t){try{const o=this.auditLog.filter(o=>o.entityType===e&&o.entityId===t&&("update"===o.action||"create"===o.action)).slice(1);return o.length>0?(o[0],null):null}catch(e){return console.error("Erro ao buscar dados anteriores do audit log:",e),null}}renderAuditLog(e="auditLogList",t=100){const o=document.getElementById(e);if(!o)return;const a=document.getElementById("auditLogFilter")?.value||"all",s=document.getElementById("auditLogEntityFilter")?.value||"all";let n=this.auditLog;"all"!==a&&(n=n.filter(e=>e.action===a)),"all"!==s&&(n=n.filter(e=>e.entityType===s));const r=n.slice(0,t);if(0===r.length)return void(o.innerHTML='\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-history"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhuma altera√ß√£o registrada</h3>\n                    <p class="empty-state-message">\n                        O hist√≥rico de altera√ß√µes aparecer√° aqui conforme voc√™ usar o sistema.\n                    </p>\n                </div>');const i={create:"fa-plus-circle",update:"fa-edit",delete:"fa-trash",view:"fa-eye",export:"fa-download",import:"fa-upload",login:"fa-sign-in-alt",logout:"fa-sign-out-alt"},c={create:"#28a745",update:"#ffc107",delete:"#dc3545",view:"#17a2b8",export:"#6c757d",import:"#6c757d",login:"#28a745",logout:"#dc3545"},l={item:"Produto",client:"Cliente",supplier:"Fornecedor",coupon:"Cupom",sale:"Venda",cost:"Custo",goal:"Meta",group:"Grupo Mensal",serviceGroup:"Grupo de Servi√ßos",pendingOrder:"Pedido Pendente",serviceAppointment:"Agendamento"};o.innerHTML=r.map(e=>{const t={create:"Criou",update:"Atualizou",delete:"Excluiu",view:"Visualizou",export:"Exportou",import:"Importou",login:"Entrou",logout:"Saiu"}[e.action]||e.action,o=i[e.action]||"fa-circle",a=c[e.action]||"#6c757d",s=l[e.entityType]||e.entityType,n=new Date(e.timestamp),r=n.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}),d=n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),m=("update"===e.action&&(e.reversible||e.details&&e.details.previousData)||"create"===e.action&&e.entityId&&e.entityType)&&e.entityId&&e.entityType;return`\n                <div class="item-card" style="border-left: 4px solid ${a}; position: relative;">\n                    <div class="item-header">\n                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">\n                            <i class="fas ${o}" style="color: ${a}; font-size: 1.1rem;"></i>\n                            <div style="flex: 1;">\n                                <h3 style="margin: 0; font-size: 0.95rem; font-weight: 600;">${t} ${s}</h3>\n                                ${e.entityName?`<p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);"><i class="fas fa-tag"></i> ${this.escapeHtml(e.entityName)}</p>`:""}\n                            </div>\n                        </div>\n                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">\n                            <div style="font-size: 0.75rem; color: var(--gray-500);">\n                                ${r}\n                            </div>\n                            <div style="font-size: 0.75rem; color: var(--gray-500);">\n                                ${d}\n                            </div>\n                        </div>\n                    </div>\n                    <div class="item-details" style="padding-top: 0.75rem; border-top: 1px solid var(--border-color); margin-top: 0.75rem;">\n                        <p style="margin: 0.5rem 0;"><i class="fas fa-user" style="color: var(--primary-color);"></i> <strong>Usu√°rio:</strong> ${this.escapeHtml(e.username)}</p>\n                        ${e.details&&Object.keys(e.details).length>0?`\n                            <details style="margin-top: 0.5rem;">\n                                <summary style="cursor: pointer; color: var(--primary-color); font-size: 0.85rem; font-weight: 500;">\n                                    <i class="fas fa-info-circle"></i> Ver Detalhes\n                                </summary>\n                                <div style="margin-top: 0.5rem; padding: 0.75rem; background: var(--light-gray); border-radius: var(--radius-sm); font-size: 0.85rem;">\n                                    ${Object.entries(e.details).map(([e,t])=>`<p style="margin: 0.25rem 0;"><strong>${this.escapeHtml(e)}:</strong> ${this.escapeHtml(String(t))}</p>`).join("")}\n                                </div>\n                            </details>\n                        `:""}\n                        ${m?`\n                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">\n                                <button class="btn-small btn-secondary" onclick="app.revertAuditLogAction('${e.id}')" style="font-size: 0.8rem;">\n                                    <i class="fas fa-undo"></i> Reverter A√ß√£o\n                                </button>\n                            </div>\n                        `:""}\n                    </div>\n                </div>\n            `}).join("")}revertAuditLogAction(e){const t=this.auditLog.find(t=>t.id===e);if(!t)return void(void 0!==toast&&toast&&toast.error("Registro de log n√£o encontrado.",3e3));if(!t.entityId||!t.entityType)return void(void 0!==toast&&toast&&toast.warning("Esta a√ß√£o n√£o pode ser revertida (dados insuficientes).",3e3));const o=async e=>{if(e)try{if("delete"===t.action)return void(void 0!==toast&&toast&&toast.warning("N√£o √© poss√≠vel reverter exclus√µes automaticamente. Use o backup para restaurar dados.",4e3));if("update"===t.action)if(t.details&&t.details.previousData){const e=t.details.previousData;this.restoreEntityData(t.entityType,t.entityId,e)?(this.saveData(),this.updateUIAfterRevert(t.entityType),this.logAction("revert",t.entityType,t.entityId,t.entityName,{revertedFrom:t.id,revertedAction:t.action,revertedAt:t.timestamp}),void 0!==toast&&toast&&toast.success(`A√ß√£o revertida com sucesso! ${t.entityName||t.entityType} restaurado.`,3e3)):void 0!==toast&&toast&&toast.error("Erro ao restaurar dados. A entidade pode n√£o existir mais.",4e3)}else void 0!==toast&&toast&&toast.warning("Dados anteriores n√£o dispon√≠veis para revers√£o. Esta a√ß√£o foi registrada antes da implementa√ß√£o de revers√£o.",4e3);else"create"===t.action&&(this.deleteEntityForRevert(t.entityType,t.entityId)?(this.saveData(),this.updateUIAfterRevert(t.entityType),this.logAction("revert",t.entityType,t.entityId,t.entityName,{revertedFrom:t.id,revertedAction:t.action}),void 0!==toast&&toast&&toast.success(`Cria√ß√£o revertida. ${t.entityName||t.entityType} removido.`,3e3)):void 0!==toast&&toast&&toast.error("Erro ao reverter cria√ß√£o. A entidade pode n√£o existir mais.",4e3))}catch(e){console.error("Erro ao reverter a√ß√£o:",e),void 0!==toast&&toast&&toast.error("Erro ao reverter a√ß√£o. Verifique o console para mais detalhes.",4e3)}};void 0!==confirmDialog&&confirmDialog?confirmDialog.confirm(`Tem certeza que deseja reverter a a√ß√£o "${t.action}" em "${t.entityName||t.entityType}"?`,"Reverter A√ß√£o",{type:"warning"}).then(o):confirm(`Tem certeza que deseja reverter a a√ß√£o "${t.action}"?`)&&o(!0)}restoreEntityData(e,t,o){try{switch(e){case"item":const e=this.items.findIndex(e=>e.id===t);if(-1!==e)return this.items[e]=JSON.parse(JSON.stringify(o)),!0;break;case"client":const a=this.clients.findIndex(e=>e.id===t);if(-1!==a)return this.clients[a]=JSON.parse(JSON.stringify(o)),!0;break;case"supplier":const s=this.suppliers.findIndex(e=>e.id===t);if(-1!==s)return this.suppliers[s]=JSON.parse(JSON.stringify(o)),!0;break;case"cost":const n=this.costs.findIndex(e=>e.id===t);if(-1!==n)return this.costs[n]=JSON.parse(JSON.stringify(o)),!0;break;case"goal":const r=this.goals.findIndex(e=>e.id===t);if(-1!==r)return this.goals[r]=JSON.parse(JSON.stringify(o)),!0}return!1}catch(e){return console.error("Erro ao restaurar dados:",e),!1}}deleteEntityForRevert(e,t){try{switch(e){case"item":const e=this.items.findIndex(e=>e.id===t);if(-1!==e)return this.items.splice(e,1),!0;break;case"client":const o=this.clients.findIndex(e=>e.id===t);if(-1!==o)return this.clients.splice(o,1),!0;break;case"supplier":const a=this.suppliers.findIndex(e=>e.id===t);if(-1!==a)return this.suppliers.splice(a,1),!0;break;case"cost":const s=this.costs.findIndex(e=>e.id===t);if(-1!==s)return this.costs.splice(s,1),!0;break;case"goal":const n=this.goals.findIndex(e=>e.id===t);if(-1!==n)return this.goals.splice(n,1),!0}return!1}catch(e){return console.error("Erro ao deletar entidade para revers√£o:",e),!1}}updateUIAfterRevert(e){switch(e){case"item":this.renderItems();break;case"client":this.renderClients();break;case"supplier":this.renderSuppliers();break;case"cost":this.renderCosts();break;case"goal":this.renderGoals()}this.renderAuditLog()}salvarEstoque(e,t,o){localStorage.setItem(`estoque_${e}_${t}`,JSON.stringify(o))}carregarEstoque(e,t){const o=localStorage.getItem(`estoque_${e}_${t}`);return o?JSON.parse(o):null}carregarEstoqueDoMesSelecionado(){const e=sessionStorage.getItem("username"),t=document.getElementById("mesSelecionado"),o=document.getElementById("estoqueMes");if(!e||!t)return;const a=t.value;if(!a)return;const s=this.carregarEstoque(e,a);o&&(o.value=s?.totalInicial??""),atualizarResumoEstoqueMes(e,a)}popularSelectMeses(){const e=document.getElementById("mesSelecionado");if(!e)return;e.innerHTML='<option value="">Selecione o m√™s</option>';const t=sessionStorage.getItem("username");if(!t)return;const o=`estoque_${t}_`;Object.keys(localStorage).filter(e=>e.startsWith(o)).forEach(t=>{const a=t.replace(o,""),s=document.createElement("option");s.value=a,s.textContent=this.formatarMesAno(a),e.appendChild(s)})}formatarMesAno(e){const[t,o]=e.split("-");return`${["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][Number(o)-1]} ${t}`}coletarEstoqueLocal(){const e=sessionStorage.getItem("username");if(!e)return{};const t={};return Object.keys(localStorage).filter(t=>t.startsWith(`estoque_${e}_`)).forEach(o=>{const a=o.replace(`estoque_${e}_`,"");try{t[a]=JSON.parse(localStorage.getItem(o))}catch{console.warn("‚ö†Ô∏è Estoque inv√°lido ignorado:",o)}}),t}initEstoqueMes(){const e=document.getElementById("estoqueMes"),t=document.getElementById("mesSelecionado");e&&t&&(e.addEventListener("change",()=>{const o=sessionStorage.getItem("username"),a=t.value;if(!o||!a)return;let s=this.carregarEstoque(o,a)||{totalInicial:0,movimentacoes:[]};s.totalInicial=Number(e.value)||0,this.salvarEstoque(o,a,s),"function"==typeof this.renderResumoEstoque&&this.renderResumoEstoque(s)}),t.addEventListener("change",()=>{this.carregarEstoqueDoMesSelecionado()}))}init(){if(this._initializing||this._initialized)console.log("‚ÑπÔ∏è [APP.JS] init() j√° foi chamado, ignorando chamada duplicada");else{this._initializing=!0;try{const e=!0===window.TEST_MODE;console.log("üü£ [APP.JS] ========== INICIALIZANDO APLICA√á√ÉO =========="),console.log("üü£ [APP.JS] URL atual:",window.location.href),console.log("üü£ [APP.JS] Document readyState:",document.readyState),console.log("üü£ [APP.JS] Modo de teste:",e),console.log("üü£ [APP.JS] SessionStorage:",{loggedIn:sessionStorage.getItem("loggedIn"),username:sessionStorage.getItem("username"),allKeys:Object.keys(sessionStorage)});const t="true"===sessionStorage.getItem("loggedIn");if(console.log("üü£ [APP.JS] Verificando autentica√ß√£o..."),console.log("üü£ [APP.JS] Status de login:",t),!t){if(!e){console.warn("‚ö†Ô∏è [APP.JS] Usu√°rio N√ÉO autenticado!"),console.log("üü° [APP.JS] Redirecionando para /index.html...");try{window.location.href="/index.html",console.log("‚úÖ [APP.JS] Redirecionamento executado")}catch(e){console.error("‚ùå [APP.JS] Erro ao redirecionar:",e),window.location.href="index.html"}return void(this._initializing=!1)}console.log("‚ÑπÔ∏è [APP.JS] Modo de teste: pulando redirecionamento de autentica√ß√£o")}console.log("‚úÖ [APP.JS] Usu√°rio autenticado! Continuando inicializa√ß√£o...");const o=e=>{window.console&&console.log&&console.log("üü£ [APP.JS] "+e)};o("Usu√°rio autenticado, continuando...");const a=sessionStorage.getItem("username");if("admin"===a){const e=document.getElementById("helpBtn");e&&(e.style.display="none");const t=document.getElementById("tutorialModal");t&&(t.classList.remove("active"),t.style.display="none")}document.addEventListener("click",e=>{const t=e.target.closest(".modal.active");t&&e.target===t&&this.closeModalSafely(t)},!0),document.addEventListener("keydown",e=>{if("Escape"===e.key){const e=this.getTopModalFromStack();e&&this.closeModalSafely(e)}}),window.forceCleanModals=()=>this.forceCleanAllModals(),setTimeout(()=>{if(o("Iniciando setup..."),"admin"===a){document.querySelectorAll(".tab-btn").forEach(e=>{"adminPanel"!==e.getAttribute("data-tab")&&(e.style.display="none")});const e=document.getElementById("adminTabBtn");e&&(this.checkPermission("viewAdmin")?e.style.display="flex":e.style.display="none"),document.querySelectorAll(".tab-content").forEach(e=>{"adminPanelTab"!==e.id&&(e.style.display="none")});const t=document.getElementById("mainToolbar");t&&(t.style.display="none");const o=document.getElementById("helpBtn");o&&(o.style.display="none"),setTimeout(()=>{this.switchTab("adminPanel")},100)}if(this.loadTheme(),this.checkCookieConsent(),this.startInactivityMonitoring(),this.initPWA(),this.initLazyLoading(),this.initKeyboardNavigation(),this.initCacheCleanup(),this.setupScrollThrottle(),this.initPerformanceMonitoring(),this.initIndexedDB(),this.initVoiceNavigation(),this.initPullToRefresh(),this.scheduledReports&&this.scheduledReports.length>0&&this.initScheduleChecker(),this.scheduledExports&&this.scheduledExports.length>0&&this.initExportScheduleChecker(),this.setupEventListeners(),e||"admin"===a||(document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active"),e.style.display="none"}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.remove("active")}),setTimeout(()=>{this.switchTab("salesPanel")},50)),this.popularSelectMeses(),this.initEstoqueMes(),this.carregarEstoqueDoMesSelecionado(),this.populateServiceTypes(),this.loadSearchHistory(),"admin"!==a){const t=setTimeout(()=>{console.warn("‚ö†Ô∏è [INIT] Timeout no loadData() ap√≥s 3 segundos, continuando com renderiza√ß√£o...");try{this.removeAllSkeletons(),this.renderGroups(),this.renderItems(),this.renderClients(),this.renderSuppliers(),this.renderTemplates(),this.renderCoupons(),this.renderPendingOrders(),this.renderServiceAppointments(),this.renderServiceGroups(),this.renderCosts(),this.renderGoals(),this.updateOverallSummary()}catch(e){console.error("‚ùå [INIT] Erro ao renderizar ap√≥s timeout:",e)}},3e3);this.loadData().then(()=>{clearTimeout(t),console.log("‚úÖ [INIT] Dados carregados com sucesso, renderizando..."),this.removeAllSkeletons(),this.renderGroups(),this.updateTagFilter(),this.renderItems(),this.renderClients(),this.renderSuppliers(),this.renderTemplates(),this.renderCoupons(),this.renderPendingOrders(),setTimeout(()=>{this.checkPendingOrdersAlerts(),this.checkGoalsAlerts(),this.checkAppointmentsReminders()},1e3),this.loadBackupHistory();const o=sessionStorage.getItem("username");if(o){const e=localStorage.getItem(`autoBackupConfig_${o}`);if(e)try{const t=JSON.parse(e);t.enabled&&this.startAutoBackup(t.frequency||"daily")}catch(e){console.error("Erro ao carregar configura√ß√£o de backup:",e)}}e||setTimeout(()=>{this.renderLastReceiptsCarousel()},200),this.renderServiceAppointments(),this.renderServiceGroups(),this.renderCosts(),this.renderGoals(),this.updateMonthFilter(),this.updateYearFilter(),this.updateGoalsYearFilter(),this.updateServicesYearFilter(),this.updateOverallSummary()}).catch(e=>{clearTimeout(t),console.error("‚ùå [INIT] Erro ao carregar dados:",e),console.error("‚ùå [INIT] Stack:",e.stack),console.error("‚ùå [INIT] Mensagem:",e.message),console.warn("‚ö†Ô∏è [INIT] Continuando com dados vazios devido ao erro");try{this.removeAllSkeletons(),this.renderGroups(),this.renderItems(),this.renderClients(),this.renderSuppliers(),this.renderTemplates(),this.renderCoupons(),this.renderPendingOrders(),this.renderServiceAppointments(),this.renderServiceGroups(),this.renderCosts(),this.renderGoals(),this.updateOverallSummary()}catch(e){console.error("‚ùå [INIT] Erro ao renderizar ap√≥s falha no loadData:",e),console.error("‚ùå [INIT] Stack do renderError:",e.stack)}})}this._initialized=!0,this._initializing=!1,requestAnimationFrame(()=>{document.body.classList.add("app-ready"),console.log("‚úÖ [APP] app-ready marcado")})},100),setTimeout(()=>{this._initializing&&!this._initialized&&(console.warn("‚ö†Ô∏è [INIT] Timeout na inicializa√ß√£o, marcando como inicializado"),this._initialized=!0,this._initializing=!1)},5e3)}catch(e){console.error("‚ùå [INIT] ERRO CR√çTICO na inicializa√ß√£o:",e),console.error("‚ùå [INIT] Stack:",e.stack),console.error("‚ùå [INIT] Mensagem:",e.message),this._initialized=!0,this._initializing=!1;try{"function"==typeof this.renderGroups&&this.renderGroups(),"function"==typeof this.renderItems&&this.renderItems()}catch(e){console.error("‚ùå [INIT] Erro ao renderizar ap√≥s erro cr√≠tico:",e)}}}}setupEventListeners(){const e=!0===window.TEST_MODE;if(window.SUPPRESS_UI_WARNINGS,e)return;function t(e){window.console&&console.log&&console.log("üü£ [APP.JS] "+e)}t("Configurando event listeners...");const o=document.getElementById("logoutBtn"),a=document.getElementById("themeToggleBtn");if(a){const e=this;a.addEventListener("click",function(){e.toggleTheme()}),t("Listener anexado ao themeToggleBtn")}const s=document.getElementById("darkModeToggle");if(s&&(s.addEventListener("click",()=>{this.toggleDarkMode()}),t("Listener anexado ao darkModeToggle"),this.loadDarkMode()),t("Elementos encontrados: logoutBtn="+!!o+", themeToggleBtn="+!!a),o){const e=this;o.onclick=function(o){t("logoutBtn CLICADO (onclick)!"),o.preventDefault(),o.stopPropagation(),t("Chamando logout()...");try{e.logout(),t("logout() chamado com sucesso!")}catch(e){t("ERRO ao chamar logout(): "+e.message)}return!1},o.addEventListener("click",function(o){t("logoutBtn CLICADO (addEventListener)!"),o.preventDefault(),o.stopPropagation(),t("Chamando logout()...");try{e.logout(),t("logout() chamado com sucesso!")}catch(e){t("ERRO ao chamar logout(): "+e.message)}},!0),t("Listener anexado ao logoutBtn (onclick + addEventListener)")}else t("ERRO: logoutBtn n√£o encontrado!");const n=document.getElementById("helpBtn"),r=document.getElementById("importBtn"),i=document.getElementById("importFile"),c=(document.getElementById("exportBtn"),sessionStorage.getItem("username"));if("admin"===c){n&&(n.style.display="none");const e=document.getElementById("tutorialModal");e&&(e.classList.remove("active"),e.style.display="none")}r&&i?(r.addEventListener("click",()=>{i.click()}),console.log("‚úÖ [APP.JS] Listener anexado ao importBtn")):console.error("‚ùå [APP.JS] importBtn ou importFile n√£o encontrado!"),i&&(i.addEventListener("change",e=>this.importData(e)),console.log("‚úÖ [APP.JS] Listener anexado ao importFile"));const l=document.getElementById("adicionarEntradaEstoqueBtn");l&&(l.addEventListener("click",()=>{adicionarEntradaEstoque()}),console.log("‚úÖ [APP.JS] Listener anexado ao adicionarEntradaEstoqueBtn")),n&&"admin"!==c?(n.addEventListener("click",()=>this.openTutorialModal()),console.log("‚úÖ [APP.JS] Listener anexado ao helpBtn")):n&&"admin"===c?(n.style.display="none",console.log("‚ÑπÔ∏è [APP.JS] helpBtn escondido para admin")):console.error("‚ùå [APP.JS] helpBtn n√£o encontrado!");const d=document.getElementById("closeTutorialBtn"),m=document.getElementById("startTutorialBtn"),u=document.querySelector("#tutorialModal .close"),p=document.getElementById("closeTutorialTooltip"),g=document.getElementById("tutorialNextBtn"),h=document.getElementById("tutorialPrevBtn"),v=document.getElementById("tutorialSkipBtn");d?(d.addEventListener("click",e=>{console.log("üü¢ [TUTORIAL] Bot√£o Fechar clicado"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}),d.onclick=e=>{console.log("üü¢ [TUTORIAL] Bot√£o Fechar (onclick) clicado"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}):console.error("‚ùå [TUTORIAL] closeTutorialBtn n√£o encontrado!"),m&&m.addEventListener("click",()=>this.startInteractiveTutorial()),u?(u.addEventListener("click",e=>{console.log("üü¢ [TUTORIAL] Bot√£o X (close) clicado"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}),u.onclick=e=>{console.log("üü¢ [TUTORIAL] Bot√£o X (onclick) clicado"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}):console.error("‚ùå [TUTORIAL] tutorialModalClose n√£o encontrado!");const y=document.getElementById("tutorialModal");y?(y.addEventListener("click",e=>{console.log("üü¢ [TUTORIAL] Overlay clicado, target:",e.target,"currentTarget:",e.currentTarget),e.target!==y&&"tutorialModal"!==e.target.id||(console.log("üü¢ [TUTORIAL] Fechando modal via overlay"),this.closeTutorialModal())},!0),document.addEventListener("keydown",e=>{"Escape"===e.key&&y.classList.contains("active")&&(console.log("üü¢ [TUTORIAL] Tecla ESC pressionada"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal())},!0)):console.error("‚ùå [TUTORIAL] tutorialModal n√£o encontrado!"),p&&p.addEventListener("click",()=>this.closeTutorialTooltip()),g&&g.addEventListener("click",()=>this.nextTutorialStep()),h&&h.addEventListener("click",()=>this.prevTutorialStep()),v&&v.addEventListener("click",()=>this.skipTutorial()),this.checkFirstTimeUser();const f=document.querySelectorAll(".tab-btn"),E=document.getElementById("dashboardToggleBtn");f.length>0?(f.forEach(e=>{e.addEventListener("click",t=>{if("dashboardToggleBtn"===e.id||e===E)return t.preventDefault(),t.stopPropagation(),void this.toggleDashboard();const o=t.currentTarget.dataset.tab||e.dataset.tab;o&&this.switchTab(o)})}),console.log("‚úÖ [APP.JS] Listeners anexados aos tabs ("+f.length+" tabs)")):console.error("‚ùå [APP.JS] Nenhum tab-btn encontrado!");const b=document.getElementById("refreshDashboard"),S=document.getElementById("periodFilter");b&&b.addEventListener("click",()=>{this.renderDashboard()}),S&&S.addEventListener("change",()=>{this.renderDashboard()});const C=document.getElementById("refreshServicesDashboard"),w=document.getElementById("servicesPeriodFilter");C&&C.addEventListener("click",()=>{this.renderServicesDashboard()}),w&&w.addEventListener("change",()=>{this.renderServicesDashboard()});const I=document.getElementById("globalSearchInput"),T=document.getElementById("monthFilter");I?(I.addEventListener("input",e=>{this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(()=>{this.handleSearch(e.target.value)},300)}),I.addEventListener("keydown",e=>{"Enter"===e.key&&I.value.trim()&&this.addToSearchHistory(I.value.trim())}),I.addEventListener("focus",()=>{""===I.value.trim()&&this.showSearchHistory()}),document.addEventListener("click",e=>{const t=document.getElementById("searchHistoryContainer");t&&!t.contains(e.target)&&e.target!==I&&this.hideSearchHistory()}),console.log("‚úÖ [APP.JS] Listener anexado ao searchInput (com debounce)")):console.error("‚ùå [APP.JS] searchInput n√£o encontrado!"),T?(T.addEventListener("change",()=>this.renderItems()),console.log("‚úÖ [APP.JS] Listener anexado ao monthFilter")):console.error("‚ùå [APP.JS] monthFilter n√£o encontrado!");const A=document.getElementById("productSearchInput");A&&(A.addEventListener("input",e=>{this.productSearchDebounceTimer&&clearTimeout(this.productSearchDebounceTimer),this.productSearchDebounceTimer=setTimeout(()=>{this.renderItems()},300)}),console.log("‚úÖ [APP.JS] Listener anexado ao productSearchInput (com debounce)"));const $=document.getElementById("yearFilter");$?($.addEventListener("change",()=>this.renderGroups()),console.log("‚úÖ [APP.JS] Listener anexado ao yearFilter")):console.error("‚ùå [APP.JS] yearFilter n√£o encontrado!");const k=document.getElementById("goalsYearFilter");k?(k.addEventListener("change",()=>this.renderGoals()),console.log("‚úÖ [APP.JS] Listener anexado ao goalsYearFilter")):console.error("‚ùå [APP.JS] goalsYearFilter n√£o encontrado!");const B=document.getElementById("servicesYearFilter");B?(B.addEventListener("change",()=>{this.renderServiceGroups(),this.updateServicesChart()}),console.log("‚úÖ [APP.JS] Listener anexado ao servicesYearFilter")):console.error("‚ùå [APP.JS] servicesYearFilter n√£o encontrado!");const D=document.getElementById("reportBuilderForm");D?(D.addEventListener("submit",e=>this.generateCustomReport(e)),console.log("‚úÖ [APP.JS] Listener anexado ao reportBuilderForm")):console.error("‚ùå [APP.JS] reportBuilderForm n√£o encontrado!");const x=document.getElementById("itemForm"),M=document.getElementById("cancelBtn"),L=document.querySelector("#itemModal .close"),R=document.getElementById("itemCategory");x?(x.addEventListener("submit",e=>this.saveItem(e)),console.log("‚úÖ [APP.JS] Listener anexado ao itemForm")):console.error("‚ùå [APP.JS] itemForm n√£o encontrado!");const P=document.getElementById("exportForm");P&&(P.addEventListener("submit",e=>this.exportData(e)),console.log("‚úÖ [APP.JS] Listener anexado ao exportForm"));const O=document.getElementById("clientForm"),F=document.querySelector("#clientModal .close"),q=document.getElementById("clientSearch");O&&(O.addEventListener("submit",e=>this.saveClient(e)),console.log("‚úÖ [APP.JS] Listener anexado ao clientForm")),F&&F.addEventListener("click",()=>this.closeClientModal()),q&&(q.addEventListener("input",e=>{this.clientSearchDebounceTimer&&clearTimeout(this.clientSearchDebounceTimer),this.clientSearchDebounceTimer=setTimeout(()=>{this.renderClients()},300)}),console.log("‚úÖ [APP.JS] Listener anexado ao clientSearch (com debounce)"));const N=document.getElementById("supplierForm"),z=document.querySelector("#supplierModal .close"),H=document.getElementById("supplierRating");N&&(N.addEventListener("submit",e=>this.saveSupplier(e)),console.log("‚úÖ [APP.JS] Listener anexado ao supplierForm")),z&&(z.addEventListener("click",()=>this.closeSupplierModal()),console.log("‚úÖ [APP.JS] Listener anexado ao supplierModal .close")),H&&(H.addEventListener("input",()=>this.updateSupplierRatingDisplay()),console.log("‚úÖ [APP.JS] Listener anexado ao supplierRating"));const j=document.getElementById("supplierSearch");j&&(j.addEventListener("input",e=>{this.supplierSearchDebounceTimer&&clearTimeout(this.supplierSearchDebounceTimer),this.supplierSearchDebounceTimer=setTimeout(()=>{this.renderSuppliers()},300)}),console.log("‚úÖ [APP.JS] Listener anexado ao supplierSearch (com debounce)"));const V=document.getElementById("couponForm"),U=document.querySelector("#couponModal .close");V&&(V.addEventListener("submit",e=>this.saveCoupon(e)),console.log("‚úÖ [APP.JS] Listener anexado ao couponForm")),U&&(U.addEventListener("click",()=>this.closeCouponModal()),console.log("‚úÖ [APP.JS] Listener anexado ao couponModal .close"));const G=document.getElementById("clientCPF"),Q=document.getElementById("clientPhone");G&&G.addEventListener("input",e=>{let t=e.target.value.replace(/\D/g,"");t.length<=11&&(t=t.replace(/(\d{3})(\d)/,"$1.$2"),t=t.replace(/(\d{3})(\d)/,"$1.$2"),t=t.replace(/(\d{3})(\d{1,2})$/,"$1-$2"),e.target.value=t)}),Q&&Q.addEventListener("input",e=>{let t=e.target.value.replace(/\D/g,"");t.length<=11&&(t.length<=10?(t=t.replace(/(\d{2})(\d)/,"($1) $2"),t=t.replace(/(\d{4})(\d)/,"$1-$2")):(t=t.replace(/(\d{2})(\d)/,"($1) $2"),t=t.replace(/(\d{5})(\d)/,"$1-$2")),e.target.value=t)}),R?(R.addEventListener("change",()=>this.toggleCategoryFields()),console.log("‚úÖ [APP.JS] Listener anexado ao itemCategory")):console.error("‚ùå [APP.JS] itemCategory n√£o encontrado!"),M?(M.addEventListener("click",()=>this.closeItemModal()),console.log("‚úÖ [APP.JS] Listener anexado ao cancelBtn")):console.error("‚ùå [APP.JS] cancelBtn n√£o encontrado!"),L?(L.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.closeItemModal()}),console.log("‚úÖ [APP.JS] Listener anexado ao itemModal .close")):console.error("‚ùå [APP.JS] itemModal .close n√£o encontrado!");const J=document.getElementById("itemModal");J&&J.addEventListener("click",e=>{e.target===J&&this.closeItemModal()});const _=document.getElementById("downloadQRBtn"),K=document.getElementById("printQRBtn");_&&_.addEventListener("click",()=>{this.currentEditingItem&&this.downloadQRCode("qrcodeCanvas",`qrcode-${this.currentEditingItem.id}.png`)}),K&&K.addEventListener("click",()=>{this.printQRCode("qrcodeCanvas")});const W=document.getElementById("scanQRBtn"),Y=document.getElementById("stopScanBtn");W&&W.addEventListener("click",()=>{this.startQRScanner()}),Y&&Y.addEventListener("click",()=>{this.stopQRScanner()});const X=document.querySelector("#qrcodeModal .close"),Z=document.getElementById("downloadQRModalBtn"),ee=document.getElementById("printQRModalBtn");X&&X.addEventListener("click",()=>{document.getElementById("qrcodeModal").classList.remove("active")}),Z&&Z.addEventListener("click",()=>{const e=Z.dataset.itemId;e&&this.downloadQRCode("qrcodeModalCanvas",`qrcode-${e}.png`)}),ee&&ee.addEventListener("click",()=>{this.printQRCode("qrcodeModalCanvas")});const te=document.getElementById("groupForm"),oe=document.getElementById("cancelGroupBtn"),ae=document.querySelector("#groupModal .close");te?(te.addEventListener("submit",e=>this.createGroup(e)),console.log("‚úÖ [APP.JS] Listener anexado ao groupForm")):console.error("‚ùå [APP.JS] groupForm n√£o encontrado!"),oe&&oe.addEventListener("click",()=>this.closeGroupModal()),ae&&ae.addEventListener("click",()=>this.closeGroupModal());const se=document.getElementById("newServiceGroupBtn"),ne=document.getElementById("serviceGroupForm"),re=document.getElementById("cancelServiceGroupBtn"),ie=document.querySelector("#serviceGroupModal .close");se&&se.addEventListener("click",()=>this.openServiceGroupModal()),ne&&ne.addEventListener("submit",e=>this.createServiceGroup(e)),re&&re.addEventListener("click",()=>this.closeServiceGroupModal()),ie&&ie.addEventListener("click",()=>this.closeServiceGroupModal());const ce=document.getElementById("serviceRecordForm"),le=document.getElementById("cancelServiceRecordBtn"),de=document.querySelector("#serviceRecordModal .close"),me=document.getElementById("serviceRecordItem");ce&&ce.addEventListener("submit",e=>this.saveServiceRecord(e)),le&&le.addEventListener("click",()=>this.closeServiceRecordModal()),de&&de.addEventListener("click",()=>this.closeServiceRecordModal()),me&&me.addEventListener("change",()=>{const e=me.value;if(e){const t=this.items.find(t=>t.id===e);if(t&&"Servi√ßos"===t.category){const e=document.getElementById("serviceRecordHours"),o=document.getElementById("serviceRecordMinutes"),a=document.getElementById("serviceRecordPrice");e&&void 0!==t.defaultHours&&(e.value=t.defaultHours||0),o&&void 0!==t.defaultMinutes&&(o.value=t.defaultMinutes||0),a&&t.price&&(a.value=t.price)}}});const ue=document.querySelector("#viewServiceGroupModal .close");ue&&ue.addEventListener("click",()=>this.closeViewServiceGroupModal()),oe?(oe.addEventListener("click",()=>this.closeGroupModal()),console.log("‚úÖ [APP.JS] Listener anexado ao cancelGroupBtn")):console.error("‚ùå [APP.JS] cancelGroupBtn n√£o encontrado!"),ae?(ae.addEventListener("click",()=>this.closeGroupModal()),console.log("‚úÖ [APP.JS] Listener anexado ao groupModal .close")):console.error("‚ùå [APP.JS] groupModal .close n√£o encontrado!");const pe=document.getElementById("saleForm"),ge=document.getElementById("cancelSaleBtn"),he=document.querySelector("#saleModal .close");pe?(pe.addEventListener("submit",e=>this.saveSale(e)),console.log("‚úÖ [APP.JS] Listener anexado ao saleForm")):console.error("‚ùå [APP.JS] saleForm n√£o encontrado!"),ge?(ge.addEventListener("click",()=>this.closeSaleModal()),console.log("‚úÖ [APP.JS] Listener anexado ao cancelSaleBtn")):console.error("‚ùå [APP.JS] cancelSaleBtn n√£o encontrado!"),he?(he.addEventListener("click",()=>this.closeSaleModal()),console.log("‚úÖ [APP.JS] Listener anexado ao saleModal .close")):console.error("‚ùå [APP.JS] saleModal .close n√£o encontrado!");const ve=document.getElementById("closeReceiptBtn"),ye=document.getElementById("printReceiptBtn"),fe=document.querySelector("#receiptPreviewModal .close");ve&&ve.addEventListener("click",()=>this.closeReceiptPreview()),ye&&ye.addEventListener("click",()=>this.printReceipt()),fe&&fe.addEventListener("click",()=>this.closeReceiptPreview());const Ee=document.getElementById("pendingOrderForm"),be=document.getElementById("cancelPendingOrderBtn"),Se=document.querySelector("#pendingOrderModal .close"),Ce=document.getElementById("addPendingOrderItemBtn");Ee&&Ee.addEventListener("submit",e=>this.savePendingOrder(e)),be&&be.addEventListener("click",()=>this.closePendingOrderModal()),Se&&Se.addEventListener("click",()=>this.closePendingOrderModal()),Ce&&Ce.addEventListener("click",()=>this.addPendingOrderItemRow());const we=document.getElementById("serviceAppointmentForm"),Ie=document.getElementById("cancelServiceAppointmentBtn"),Te=document.querySelector("#serviceAppointmentModal .close");we&&we.addEventListener("submit",e=>this.saveServiceAppointment(e)),Ie&&Ie.addEventListener("click",()=>this.closeServiceAppointmentModal()),Te&&Te.addEventListener("click",()=>this.closeServiceAppointmentModal());const Ae=document.getElementById("calendarModal"),$e=document.querySelector("#calendarModal .close");$e&&$e.addEventListener("click",()=>this.closeCalendarModal()),Ae&&Ae.addEventListener("click",e=>{e.target===Ae&&this.closeCalendarModal()});const ke=document.getElementById("receiptSearchModal");ke&&ke.addEventListener("click",e=>{e.target===ke&&this.closeReceiptSearchModal()}),this.setupReceiptCarouselDrag();const Be=document.querySelector("#viewGroupModal .close");Be?(Be.addEventListener("click",()=>this.closeViewGroupModal()),console.log("‚úÖ [APP.JS] Listener anexado ao viewGroupModal .close")):console.error("‚ùå [APP.JS] viewGroupModal .close n√£o encontrado!");const De=document.getElementById("costForm"),xe=document.getElementById("cancelCostBtn"),Me=document.querySelector("#costModal .close"),Le=document.getElementById("costQuantity"),Re=document.getElementById("costPrice");De?(De.addEventListener("submit",e=>this.saveCost(e)),console.log("‚úÖ [APP.JS] Listener anexado ao costForm")):console.error("‚ùå [APP.JS] costForm n√£o encontrado!"),xe?(xe.addEventListener("click",()=>this.closeCostModal()),console.log("‚úÖ [APP.JS] Listener anexado ao cancelCostBtn")):console.error("‚ùå [APP.JS] cancelCostBtn n√£o encontrado!"),Me?(Me.addEventListener("click",()=>this.closeCostModal()),console.log("‚úÖ [APP.JS] Listener anexado ao costModal .close")):console.error("‚ùå [APP.JS] costModal .close n√£o encontrado!"),Le?(Le.addEventListener("input",()=>this.calculateCostTotal()),console.log("‚úÖ [APP.JS] Listener anexado ao costQuantity")):console.error("‚ùå [APP.JS] costQuantity n√£o encontrado!"),Re?(Re.addEventListener("input",()=>this.calculateCostTotal()),Re.addEventListener("input",e=>{let t=e.target.value;t.includes(",")&&(e.target.value=t.replace(",","."))}),console.log("‚úÖ [APP.JS] Listener anexado ao costPrice")):console.error("‚ùå [APP.JS] costPrice n√£o encontrado!");const Pe=document.getElementById("itemPrice"),Oe=document.getElementById("salePrice"),Fe=document.getElementById("goalAmount");Pe&&Pe.addEventListener("input",e=>{let t=e.target.value;t.includes(",")&&(e.target.value=t.replace(",","."))}),Oe&&Oe.addEventListener("input",e=>{let t=e.target.value;t.includes(",")&&(e.target.value=t.replace(",",".")),this.updateDiscountCalculation()});const qe=document.getElementById("saleQuantity"),Ne=document.getElementById("saleDiscountType"),ze=document.getElementById("saleDiscountValue");qe&&qe.addEventListener("input",()=>{this.updateDiscountCalculation()}),Ne&&Ne.addEventListener("change",()=>{this.updateDiscountCalculation()}),ze&&ze.addEventListener("input",()=>{this.updateDiscountCalculation()}),Fe&&Fe.addEventListener("input",e=>{let t=e.target.value;t.includes(",")&&(e.target.value=t.replace(",","."))});const He=document.getElementById("goalForm"),je=document.getElementById("newGoalBtn"),Ve=document.getElementById("cancelGoalBtn"),Ue=document.querySelector("#goalModal .close");je&&(je.addEventListener("click",()=>this.openGoalModal()),console.log("‚úÖ [APP.JS] Listener anexado ao newGoalBtn")),He&&(He.addEventListener("submit",e=>this.saveGoal(e)),console.log("‚úÖ [APP.JS] Listener anexado ao goalForm")),Ve&&(Ve.addEventListener("click",()=>this.closeGoalModal()),console.log("‚úÖ [APP.JS] Listener anexado ao cancelGoalBtn")),Ue&&(Ue.addEventListener("click",()=>this.closeGoalModal()),console.log("‚úÖ [APP.JS] Listener anexado ao goalModal .close"));const Ge=document.getElementById("saleItem");Ge&&(Ge.addEventListener("change",()=>{const e=Ge.value;this.updateSaleModalForItem(e),this.updateStockInfo()}),console.log("‚úÖ [APP.JS] Listener anexado ao saleItem para atualizar estoque"));const Qe=document.getElementById("saleSize");Qe&&(Qe.addEventListener("input",()=>{this.updateStockInfo()}),console.log("‚úÖ [APP.JS] Listener anexado ao saleSize para atualizar estoque"));const Je=document.getElementById("saleColor");Je&&(Je.addEventListener("input",()=>{this.updateStockInfo()}),console.log("‚úÖ [APP.JS] Listener anexado ao saleColor para atualizar estoque")),window.addEventListener("click",e=>{e.target.classList.contains("modal")&&this.closeAllModals()})}toggleCategoryFields(){const e=document.getElementById("itemCategory").value,t=document.getElementById("clothingFields"),o=document.getElementById("electronicsFields"),a=document.getElementById("clothingBasicFields"),s=document.getElementById("itemName"),n=document.getElementById("itemBrand");"Roupas"===e?(a&&(a.style.display="block"),s&&(s.required=!1,s.parentElement.style.display="block"),n&&(n.required=!0,n.parentElement.style.display="block"),t&&(t.style.display="block"),o&&(o.style.display="none"),document.getElementById("itemModel").value="",document.getElementById("itemCapacity").value="",document.getElementById("itemColor").value=""):"Eletr√¥nicos"===e?(a&&(a.style.display="none"),s&&(s.required=!1,s.parentElement.style.display="none",s.value=""),n&&(n.required=!1,n.parentElement.style.display="none",n.value=""),t&&(t.style.display="none"),o&&(o.style.display="block"),document.getElementById("itemStyle").value="",document.getElementById("itemSize").value="",document.getElementById("itemGender").value=""):(a&&(a.style.display="none"),s&&(s.required=!1,s.parentElement.style.display="none"),n&&(n.required=!1,n.parentElement.style.display="none"),t&&(t.style.display="none"),o&&(o.style.display="none"))}openItemModal(e=null){this.currentEditingItem=e;const t=document.getElementById("itemModal"),o=document.getElementById("itemForm"),a=document.getElementById("modalTitle");if(e){a.textContent="Editar Item",document.getElementById("itemCategory").value=e.category||"Roupas",document.getElementById("itemPrice").value=e.price||"";const t=document.getElementById("itemCost");if(t&&(t.value=e.cost||""),"Roupas"===e.category?(document.getElementById("itemName").value=e.name||"",document.getElementById("itemBrand").value=e.brand||"",document.getElementById("itemStyle").value=e.style||"",document.getElementById("itemSize").value=e.size||"",document.getElementById("itemGender").value=e.gender||""):"Eletr√¥nicos"===e.category&&(document.getElementById("itemModel").value=e.model||"",document.getElementById("itemCapacity").value=e.capacity||"",document.getElementById("itemColor").value=e.color||""),this.toggleCategoryFields(),e.id){if(!e.qrCodeNumber){e.qrCodeNumber=this.generateQRCodeNumber();const t=this.items.findIndex(t=>t.id===e.id);-1!==t&&(this.items[t]=e,this.saveData())}this.generateQRCode(e.id)}}else{a.textContent="Novo Produto",o.reset(),document.getElementById("clothingFields").style.display="none",document.getElementById("electronicsFields").style.display="none";const e=document.getElementById("clothingBasicFields");e&&(e.style.display="block");const t=document.getElementById("qrcodeSection");t&&(t.style.display="none")}if(t.classList.add("active"),void 0!==fieldValidator){const e=document.getElementById("itemName"),t=document.getElementById("itemPrice"),o=document.getElementById("itemModel");document.getElementById("itemEmail"),e&&fieldValidator.setupFieldValidation(e,{required:!0,minLength:2}),t&&fieldValidator.setupFieldValidation(t,{required:!0,number:!0,positive:!0}),o&&fieldValidator.setupFieldValidation(o,{minLength:2})}}openModalSafely(e){if(!e)return;const t=/Android/i.test(navigator.userAgent)&&/Chrome/i.test(navigator.userAgent),o=document.getElementById("quickSaleFAB");o&&(o.style.display="none"),e.style.cssText="",e.style.cssText=t?"\n                display: flex !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n                pointer-events: auto !important;\n                z-index: 10000 !important;\n                position: fixed !important;\n                left: 0 !important;\n                top: 0 !important;\n                width: 100% !important;\n                height: 100% !important;\n                background-color: rgba(0, 0, 0, 0.85) !important;\n                background: rgba(0, 0, 0, 0.85) !important;\n                backdrop-filter: none !important;\n                -webkit-backdrop-filter: none !important;\n            ":"\n                display: flex !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n                pointer-events: auto !important;\n                z-index: 10000 !important;\n                position: fixed !important;\n                left: 0 !important;\n                top: 0 !important;\n                width: 100% !important;\n                height: 100% !important;\n                background-color: rgba(0, 0, 0, 0.5) !important;\n                backdrop-filter: blur(8px) !important;\n                -webkit-backdrop-filter: blur(8px) !important;\n            ",e.classList.add("active"),this.pushModalToStack(e),this.updateModalStackZIndexes(),e.setAttribute("tabindex","-1"),e.focus({preventScroll:!0})}closeModalSafely(e){if(!e)return;if("string"==typeof e&&!(e=document.getElementById(e)))return;const t=/Android/i.test(navigator.userAgent)&&/Chrome/i.test(navigator.userAgent),o=document.querySelectorAll(".modal.active"),a=1===o.length&&o[0]===e;if(e.classList.remove("active"),e.style.setProperty("pointer-events","none","important"),e.style.setProperty("backdrop-filter","blur(0px)","important"),e.style.setProperty("-webkit-backdrop-filter","blur(0px)","important"),e.style.setProperty("background","rgba(0, 0, 0, 0)","important"),e.style.setProperty("background-color","rgba(0, 0, 0, 0)","important"),e.style.setProperty("opacity","0","important"),e.style.setProperty("visibility","hidden","important"),t){document.body.style.removeProperty("backdrop-filter"),document.body.style.removeProperty("-webkit-backdrop-filter"),document.documentElement.style.removeProperty("backdrop-filter"),document.documentElement.style.removeProperty("-webkit-backdrop-filter");const e=document.body.style.cssText||"",t=document.documentElement.style.cssText||"";document.body.style.cssText=e.replace(/backdrop-filter[^;]*;?/gi,"").replace(/-webkit-backdrop-filter[^;]*;?/gi,""),document.documentElement.style.cssText=t.replace(/backdrop-filter[^;]*;?/gi,"").replace(/-webkit-backdrop-filter[^;]*;?/gi,""),document.body.style.setProperty("background","","important"),document.body.style.setProperty("background-color","","important"),document.documentElement.style.setProperty("background","","important"),document.documentElement.style.setProperty("background-color","","important"),requestAnimationFrame(()=>{document.body.style.display="none",document.body.offsetHeight,document.body.style.display="",requestAnimationFrame(()=>{document.body.offsetHeight})})}else document.body.style.setProperty("backdrop-filter","","important"),document.body.style.setProperty("-webkit-backdrop-filter","","important"),document.documentElement.style.setProperty("backdrop-filter","","important"),document.documentElement.style.setProperty("-webkit-backdrop-filter","","important");this.removeModalFromStack(e),this.updateModalStackZIndexes(),a&&setTimeout(()=>{if(0===document.querySelectorAll(".modal.active").length){const e=document.getElementById("quickSaleFAB");e&&window.matchMedia("(max-width: 768px)").matches&&(e.style.display="flex")}},350),setTimeout(()=>{if(e.style.setProperty("display","none","important"),e.style.removeProperty("background"),e.style.removeProperty("background-color"),e.style.removeProperty("backdrop-filter"),e.style.removeProperty("-webkit-backdrop-filter"),e.style.removeProperty("pointer-events"),e.style.removeProperty("opacity"),e.style.removeProperty("visibility"),t){const t=(e.style.cssText||"").replace(/backdrop-filter[^;]*;?/gi,"").replace(/-webkit-backdrop-filter[^;]*;?/gi,"").replace(/background[^;]*;?/gi,"").replace(/background-color[^;]*;?/gi,"");e.style.cssText=t+"display: none !important;"}e.style.removeProperty("opacity"),e.style.removeProperty("visibility")},300)}closeItemModal(){const e=document.getElementById("itemModal");e&&this.closeModalSafely(e),this.currentEditingItem=null;const t=document.getElementById("qrcodeSection");t&&(t.style.display="none");const o=document.getElementById("itemForm");o&&o.reset()}pushModalToStack(e){e&&(this.modalStack.includes(e)||this.modalStack.push(e))}removeModalFromStack(e){e&&(this.modalStack=this.modalStack.filter(t=>t!==e))}getTopModalFromStack(){if(!this.modalStack.length)return null;const e=this.modalStack[this.modalStack.length-1];return e&&e.classList.contains("active")?e:null}updateModalStackZIndexes(){this.modalStack.forEach((e,t)=>{if(!e||!e.classList.contains("active"))return;const o=1e4+10*t;e.style.setProperty("z-index",String(o),"important");const a=e.querySelector(".modal-content");a&&a.style.setProperty("z-index",String(o+1),"important")})}saveItem(e){if(e.preventDefault(),!this.checkPermission("write","item"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para criar/editar produtos.",3e3):alert("Voc√™ n√£o tem permiss√£o para criar/editar produtos."));if(this.currentEditingItem){const e=this.checkEntityLock("item",this.currentEditingItem.id);if(e.locked&&!e.isOwner)return void(void 0!==toast&&toast?toast.warning(`Este item est√° sendo editado por ${e.lockedBy}. Aguarde alguns minutos.`,4e3):alert(`Este item est√° sendo editado por ${e.lockedBy}. Aguarde alguns minutos.`));if(!this.lockEntity("item",this.currentEditingItem.id))return void(void 0!==toast&&toast&&toast.error("N√£o foi poss√≠vel bloquear o item para edi√ß√£o.",3e3))}const t=e.target.querySelector('button[type="submit"]');t&&t.innerHTML,t&&(t.disabled=!0,t.classList.add("loading"));const o=document.getElementById("itemCategory").value,a=document.getElementById("itemMinStock"),s=a&&a.value?parseInt(a.value):null,n=document.getElementById("itemTags"),r=n&&n.value?n.value.split(",").map(e=>e.trim()).filter(e=>e):[],i=document.getElementById("itemNotes"),c=i&&i.value?i.value.trim():"",l=document.getElementById("itemCost"),d=l&&l.value?this.parsePrice(l.value):void 0,m={id:this.currentEditingItem?this.currentEditingItem.id:Date.now().toString(),category:o,price:this.parsePrice(document.getElementById("itemPrice").value),cost:d,minStock:s||void 0,notes:c||void 0};if(r.length>0?this.itemTags[m.id]=r:this.itemTags[m.id]&&delete this.itemTags[m.id],"Roupas"===o)m.name=this.formatText(document.getElementById("itemName").value)||"",m.brand=this.formatText(document.getElementById("itemBrand").value),m.style=this.formatText(document.getElementById("itemStyle").value)||"",m.size=document.getElementById("itemSize").value.trim()||"",m.gender=document.getElementById("itemGender").value||"";else if("Eletr√¥nicos"===o){const e=this.formatText(document.getElementById("itemModel").value),t=this.formatText(document.getElementById("itemCapacity").value),o=this.formatText(document.getElementById("itemColor").value);let a=[];e&&a.push(e),t&&a.push(t),o&&a.push(o),m.name=a.length>0?a.join(" "):"Eletr√¥nico",m.brand="",m.model=e||"",m.capacity=t||"",m.color=o||""}if(!o)return this.showError("Por favor, selecione uma categoria."),void(t&&(t.disabled=!1,t.classList.remove("loading")));if("Roupas"===o){if(!m.brand)return this.showError("Por favor, preencha a marca."),void(t&&(t.disabled=!1,t.classList.remove("loading")))}else if("Eletr√¥nicos"===o&&!m.model)return this.showError("Por favor, preencha o modelo."),void(t&&(t.disabled=!1,t.classList.remove("loading")));if(m.price<=0||isNaN(m.price))return this.showError("O pre√ßo deve ser um valor num√©rico maior que zero."),void(t&&(t.disabled=!1,t.classList.remove("loading")));this.currentEditingItem&&this.currentEditingItem.qrCodeNumber?(m.qrCodeNumber=this.currentEditingItem.qrCodeNumber,console.log(`‚úÖ Mantendo QR Code existente: ${m.qrCodeNumber} para produto ${m.name||m.id}`)):(m.qrCodeNumber=this.generateQRCodeNumber(),console.log(`‚úÖ Novo QR Code gerado: ${m.qrCodeNumber} para produto ${m.name||"novo"}`));const u=this.items.find(e=>e.id!==m.id&&e.qrCodeNumber===m.qrCodeNumber);u&&(console.error(`‚ùå ERRO: QR Code duplicado detectado! Produto ${m.name} tem o mesmo QR Code que ${this.getItemName(u.id)}`),m.qrCodeNumber=this.generateQRCodeNumber(),console.log(`‚úÖ Novo QR Code √∫nico gerado ap√≥s detec√ß√£o de duplicata: ${m.qrCodeNumber}`));let p=null;if(this.currentEditingItem){const e=this.items.findIndex(e=>e.id===this.currentEditingItem.id);-1!==e&&(p=JSON.parse(JSON.stringify(this.items[e])),this.items[e]=m)}else this.items.push(m);t&&(t.disabled=!1,t.classList.remove("loading")),this.currentEditingItem&&this.unlockEntity("item",this.currentEditingItem.id),this.saveData(),this.updateTagFilter(),this.renderItems(),this.closeItemModal(),this.logAction(this.currentEditingItem?"update":"create","item",m.id,this.getItemName(m.id),{category:m.category,price:m.price,minStock:m.minStock||null,previousData:p}),this.showSuccess(this.currentEditingItem?"Item atualizado com sucesso!":"Item cadastrado com sucesso!"),m.id&&this.generateQRCode(m.id)}animateValue(e,t,o,a=400,s=null){if(!e)return;const n=performance.now(),r="number"==typeof o,i=c=>{const l=c-n,d=Math.min(l/a,1),m=1-Math.pow(1-d,3);if(r){const a=t+(o-t)*m;e.textContent=s?s(a):Math.round(a)}else e.style.opacity=m;d<1?requestAnimationFrame(i):(r&&(e.textContent=s?s(o):o),e.style.opacity="1",e.classList.add("animated-value"),setTimeout(()=>{e.classList.remove("animated-value")},500))};requestAnimationFrame(i)}updateValueWithAnimation(e,t,o=null){const a=document.getElementById(e);if(!a)return;const s=a.textContent.trim();let n=0;if(o){const e=s.match(/[\d,]+\.?\d*/);e&&(n=parseFloat(e[0].replace(",","."))||0)}else n=parseInt(s)||0;this.animateValue(a,n,t,300,o)}loadQRCodeLibrary(){return new Promise((e,t)=>{if(window.QRCode||window.qrcode||window.QRCodeLib&&window.QRCodeLib.default)return console.log("‚úÖ Biblioteca QRCode j√° est√° carregada"),void e();const o=document.querySelector('script[src*="qrcode"]');if(o){if(console.log("üì¶ Script QRCode j√° existe no DOM, aguardando carregamento..."),console.log("üîç Verificando window.QRCode:",typeof window.QRCode),console.log("üîç Verificando window.qrcode:",typeof window.qrcode),console.log("üîç Verificando window.qrcodeLoaded:",window.qrcodeLoaded),!1===window.qrcodeLoaded)console.warn("‚ö†Ô∏è Script QRCode falhou ao carregar anteriormente. Tentando recarregar..."),o.remove();else if(!0===window.qrcodeLoaded){console.log("üì¶ Script marcado como carregado, mas biblioteca n√£o encontrada. Verificando formas alternativas...");try{if("undefined"!=typeof QRCode)return window.QRCode=QRCode,console.log("‚úÖ Biblioteca QRCode encontrada como QRCode global!"),void e()}catch(e){console.log("‚ö†Ô∏è QRCode n√£o encontrado como vari√°vel global")}}let t=0,a=!1;const s=30,n=setInterval(()=>{t++;let r=window.QRCode||window.qrcode||window.QRCodeLib&&window.QRCodeLib.default;return r||"undefined"==typeof QRCode||(window.QRCode=QRCode,r=QRCode,console.log("‚úÖ Biblioteca QRCode encontrada como QRCode global!")),r?(clearInterval(n),console.log("‚úÖ Biblioteca QRCode carregada ap√≥s",t,"tentativas!"),void e()):!1===window.qrcodeLoaded?(clearInterval(n),console.error("‚ùå Script QRCode falhou ao carregar. Tentando recarregar..."),o.remove(),void(a=!0)):(t%10==0&&(console.log(`‚è≥ Aguardando biblioteca QRCode... (${t}/${s})`),console.log("üîç window.QRCode:",typeof window.QRCode),console.log("üîç window.qrcode:",typeof window.qrcode),console.log("üîç typeof QRCode:",typeof QRCode),console.log("üîç window.qrcodeLoaded:",window.qrcodeLoaded)),void(t>=s&&(clearInterval(n),console.error("‚ùå Timeout: Biblioteca QRCode n√£o foi carregada ap√≥s",s,"tentativas"),console.error("üîç Estado final - window.QRCode:",typeof window.QRCode),console.error("üîç Estado final - window.qrcode:",typeof window.qrcode),console.error("üîç Estado final - typeof QRCode:",typeof QRCode),console.error("üîç Estado final - window.qrcodeLoaded:",window.qrcodeLoaded),console.warn("üîÑ Tentando recarregar script QRCode..."),o.remove(),a=!0)))},100);if(!a&&!1!==window.qrcodeLoaded)return}console.log("üì• Carregando biblioteca QRCode dinamicamente..."),document.createElement("script");const a=["https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js","https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js","https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"],s=o=>{if(o>=a.length){console.error("‚ùå Todas as URLs do CDN falharam ao carregar"),console.error("üí° Poss√≠veis causas:"),console.error("   1. Problema de conex√£o com a internet"),console.error("   2. Firewall ou proxy bloqueando CDNs"),console.error("   3. Problema de CORS no servidor local"),console.error("   4. CDNs temporariamente indispon√≠veis"),console.error("üí° Solu√ß√µes:"),console.error("   - Verifique sua conex√£o com a internet"),console.error("   - Verifique configura√ß√µes de firewall/proxy"),console.error("   - Tente acessar os CDNs diretamente no navegador"),console.error("   - Considere usar uma vers√£o local da biblioteca QRCode");const e="N√£o foi poss√≠vel carregar a biblioteca QRCode. Verifique sua conex√£o com a internet ou configura√ß√µes de firewall.";return alert(e),void t(new Error(e))}const n=a[o];console.log(`üì• Tentando carregar de: ${n}`);const r=document.createElement("script");r.src=n,r.onload=()=>{console.log("‚úÖ Script QRCode carregado, verificando disponibilidade..."),window.qrcodeLoaded=!0,setTimeout(()=>{let t=window.QRCode||window.qrcode||window.QRCodeLib&&window.QRCodeLib.default;t||"undefined"==typeof QRCode||(window.QRCode=QRCode,t=QRCode),t?(console.log("‚úÖ Biblioteca QRCode dispon√≠vel!"),e()):(console.error("‚ùå Biblioteca QRCode n√£o encontrada ap√≥s carregamento do script"),console.error("üîç window.QRCode:",typeof window.QRCode),console.error("üîç window.qrcode:",typeof window.qrcode),console.error("üîç typeof QRCode:",typeof QRCode),s(o+1))},300)},r.onerror=e=>{console.error(`‚ùå Erro ao carregar de ${n}`),console.error("üîç Detalhes do erro:",e),window.qrcodeLoaded=!1,0===o&&(console.warn("‚ö†Ô∏è Primeira tentativa falhou. Verificando conectividade..."),fetch("https://www.google.com/favicon.ico",{method:"HEAD",mode:"no-cors",cache:"no-cache"}).then(()=>{console.log("‚úÖ Conectividade com internet OK")}).catch(()=>{console.error("‚ùå Problema de conectividade detectado")})),s(o+1)},document.head.appendChild(r)};s(0)})}createSkeletonHTML(e=6,t=!1){const o=t?"skeleton-card-small":"skeleton-card";let a="";for(let t=0;t<e;t++)a+=`\n                <div class="${o}">\n                    <div class="skeleton-line"></div>\n                    <div class="skeleton-line"></div>\n                    <div class="skeleton-line"></div>\n                    <div class="skeleton-line"></div>\n                </div>\n            `;return a}showSkeleton(e,t=6,o=!1){const a=document.getElementById(e);if(!a)return;const s=document.createElement("div");s.className=o?"skeleton-list":"skeleton-container",s.id=`${e}-skeleton`,s.innerHTML=this.createSkeletonHTML(t,o),a.innerHTML="",a.appendChild(s),setTimeout(()=>{this.hideSkeleton(e)},3e3)}hideSkeleton(e){const t=document.getElementById(`${e}-skeleton`);t&&t.remove()}removeAllSkeletons(){document.querySelectorAll('[id$="-skeleton"], .skeleton-container, .skeleton-list, .skeleton-card, .skeleton-card-small').forEach(e=>{e.remove()}),console.log("‚úÖ Todos os skeletons foram removidos")}showError(e){void 0!==toast&&toast?toast.error(e,5e3):alert(e)}showSuccess(e){void 0!==toast&&toast?toast.success(e,3e3):console.log("‚úÖ",e)}showWarning(e){void 0!==toast&&toast?toast.warning(e,4e3):alert(e)}showInfo(e){void 0!==toast&&toast?toast.info(e,3e3):console.log("‚ÑπÔ∏è",e)}showSuccessOld(e){const t=document.querySelector(".error-message"),o=document.querySelector(".success-message");t&&t.remove(),o&&o.remove();const a=document.createElement("div");a.className="success-message show",a.textContent=e,a.setAttribute("role","status"),a.setAttribute("aria-live","polite");const s=document.querySelector(".modal.active");if(s){const e=s.querySelector("form");e?e.insertBefore(a,e.firstChild):s.querySelector(".modal-content").insertBefore(a,s.querySelector(".modal-content").firstChild)}else{const e=document.querySelector(".main-content");e&&e.insertBefore(a,e.firstChild)}setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},3e3)}generateQRCodeNumber(){let e="";let t=0;do{e="";for(let t=0;t<9;t++)e+="123456789".charAt(Math.floor(9*Math.random()));if(t++,!this.items.find(t=>t.qrCodeNumber===e))return console.log(`‚úÖ QR Code √∫nico gerado: ${e} (tentativa ${t})`),e;if(t>=100){console.warn("‚ö†Ô∏è Muitas tentativas para gerar QR code √∫nico. Adicionando timestamp...");const t=Date.now().toString().slice(-4);if(e=e.slice(0,5)+t,!this.items.find(t=>t.qrCodeNumber===e))return console.log(`‚úÖ QR Code √∫nico gerado com timestamp: ${e}`),e}}while(t<200);const o=Date.now().toString().slice(-9);return console.warn(`‚ö†Ô∏è Usando c√≥digo de fallback baseado em timestamp: ${o}`),o}generateQRCode(e){const t=window.QRCode||window.qrcode||window.QRCodeLib&&window.QRCodeLib.default;if(!t)return console.warn("‚ö†Ô∏è Biblioteca QRCode n√£o encontrada imediatamente"),console.log("üîÑ Tentando carregar biblioteca QRCode..."),void this.loadQRCodeLibrary().then(()=>{console.log("‚úÖ Biblioteca QRCode carregada, tentando gerar novamente..."),this.generateQRCode(e)}).catch(e=>{console.error("‚ùå Erro ao carregar biblioteca QRCode:",e)});const o=document.getElementById("qrcodeCanvas"),a=document.getElementById("qrcodeSection");if(!o||!a)return;const s=this.items.find(t=>t.id===e);if(!s||!s.qrCodeNumber)return void console.error("Item n√£o encontrado ou sem c√≥digo QR");const n=s.qrCodeNumber;console.log("Gerando QR code para:",n);const r=o.getContext("2d");r.clearRect(0,0,o.width,o.height),t.toCanvas(o,n,{width:200,margin:2,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"M"},e=>{e?(console.error("Erro ao gerar QR code:",e),alert("Erro ao gerar QR code: "+e.message)):(console.log("QR code gerado com sucesso para:",n),setTimeout(()=>{const e=r.getImageData(0,0,o.width,o.height);let t=0,a=0;for(let o=0;o<e.data.length;o+=4){const s=e.data[o],n=e.data[o+1],r=e.data[o+2];s<50&&n<50&&r<50?t++:s>200&&n>200&&r>200&&a++}const s=o.width*o.height,n=t/s*100,i=a/s*100;0===t&&0===a?console.warn("‚ö†Ô∏è Canvas est√° completamente vazio ap√≥s gera√ß√£o"):0===t?console.warn("‚ö†Ô∏è Canvas n√£o cont√©m pixels pretos (QR code pode estar incorreto)"):console.log(`‚úÖ QR code verificado: ${t} pixels pretos (${n.toFixed(2)}%), ${a} pixels brancos (${i.toFixed(2)}%)`)},200),a&&(a.style.display="block"))})}generateQRCodeForModal(e,t){const o=window.QRCode||window.qrcode||window.QRCodeLib&&window.QRCodeLib.default;if(!o)return console.warn("‚ö†Ô∏è Biblioteca QRCode n√£o encontrada imediatamente"),console.log("üì¶ Verificando se script est√° no DOM..."),document.querySelector('script[src*="qrcode"]')&&console.log("üì¶ Script encontrado no DOM, aguardando carregamento..."),console.log("üîÑ Tentando carregar biblioteca QRCode..."),void this.loadQRCodeLibrary().then(()=>{console.log("‚úÖ Biblioteca QRCode carregada, tentando gerar novamente..."),this.generateQRCodeForModal(e,t)}).catch(e=>{console.error("‚ùå Erro ao carregar biblioteca QRCode:",e),console.error("üí° Dica: Recarregue a p√°gina ou verifique sua conex√£o com a internet."),alert("Erro ao carregar biblioteca QRCode. Verifique sua conex√£o e recarregue a p√°gina.")});const a=document.getElementById(t);if(!a)return void console.error("Canvas n√£o encontrado:",t);const s=this.items.find(t=>t.id===e);if(!s)return void console.error("Item n√£o encontrado:",e);s.qrCodeNumber||(console.error("Item sem c√≥digo QR:",e),alert("Item n√£o possui c√≥digo QR. Um c√≥digo ser√° gerado agora."),s.qrCodeNumber=this.generateQRCodeNumber(),this.saveData());const n=s.qrCodeNumber;console.log("Gerando QR code no canvas:",t,"com dados:",n);const r=a.getContext("2d");r.clearRect(0,0,a.width||300,a.height||300),a.width&&a.height||(a.width=300,a.height=300),o.toCanvas(a,n,{width:300,margin:2,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"M"},e=>{e?(console.error("Erro ao gerar QR code:",e),alert("Erro ao gerar QR code: "+e.message)):(console.log("‚úÖ QR code gerado com sucesso no modal:",n),setTimeout(()=>{const e=r.getImageData(0,0,a.width,a.height);let t=0,o=0;for(let a=0;a<e.data.length;a+=4){const s=e.data[a],n=e.data[a+1],r=e.data[a+2];s<50&&n<50&&r<50?t++:s>200&&n>200&&r>200&&o++}const s=a.width*a.height,n=t/s*100,i=o/s*100;0===t&&0===o?console.warn("‚ö†Ô∏è Canvas est√° completamente vazio ap√≥s gera√ß√£o"):0===t?console.warn("‚ö†Ô∏è Canvas n√£o cont√©m pixels pretos (QR code pode estar incorreto)"):console.log(`‚úÖ QR code verificado: ${t} pixels pretos (${n.toFixed(2)}%), ${o} pixels brancos (${i.toFixed(2)}%)`)},200))})}showQRCodeModal(e){const t=this.items.find(t=>t.id===e);if(!t)return void console.error("Item n√£o encontrado:",e);t.qrCodeNumber||(t.qrCodeNumber=this.generateQRCodeNumber(),this.saveData(),console.log("C√≥digo QR gerado para item:",t.qrCodeNumber));const o=document.getElementById("qrcodeModal"),a=document.getElementById("qrcodeModalCanvas"),s=document.getElementById("qrcodeItemName"),n=document.getElementById("downloadQRModalBtn");o&&a&&s?(s.textContent=this.getItemName(e),n&&(n.dataset.itemId=e),this.openModalSafely(o),setTimeout(()=>{console.log("Gerando QR code no modal para:",t.qrCodeNumber),this.generateQRCodeForModal(e,"qrcodeModalCanvas")},100)):console.error("Elementos do modal n√£o encontrados")}downloadQRCode(e,t){const o=document.getElementById(e);if(o){if(!o.getContext("2d").getImageData(0,0,o.width,o.height).data.some(e=>0!==e)||0===o.width||0===o.height){console.warn("Canvas vazio, tentando gerar QR code...");let o=null;if("qrcodeCanvas"===e&&this.currentEditingItem)o=this.currentEditingItem.id;else if("qrcodeModalCanvas"===e){const e=document.getElementById("downloadQRModalBtn");e&&e.dataset.itemId&&(o=e.dataset.itemId)}return o?("qrcodeCanvas"===e?this.generateQRCode(o):"qrcodeModalCanvas"===e&&this.generateQRCodeForModal(o,e),void setTimeout(()=>{this.downloadQRCode(e,t)},500)):void toast.error("Erro: N√£o foi poss√≠vel identificar o item para gerar o QR code.",4e3)}try{const e=document.createElement("a");e.download=t||`qrcode-${Date.now()}.png`,e.href=o.toDataURL("image/png"),document.body.appendChild(e),e.click(),document.body.removeChild(e),console.log("QR code baixado com sucesso:",t)}catch(e){console.error("Erro ao baixar QR code:",e),toast.error("Erro ao baixar QR code. Tente novamente.",4e3)}}else console.error("Canvas n√£o encontrado:",e)}printQRCode(e){const t=document.getElementById(e);if(!t)return;const o=t.toDataURL("image/png"),a=window.open("","_blank");a.document.write(`\n            <html>\n                <head>\n                    <title>Imprimir QR Code</title>\n                    <style>\n                        body {\n                            margin: 0;\n                            padding: 20px;\n                            display: flex;\n                            justify-content: center;\n                            align-items: center;\n                            min-height: 100vh;\n                        }\n                        img {\n                            max-width: 100%;\n                            height: auto;\n                        }\n                        @media print {\n                            body { margin: 0; padding: 0; }\n                        }\n                    </style>\n                </head>\n                <body>\n                    <img src="${o}" alt="QR Code" />\n                </body>\n            </html>\n        `),a.document.close(),a.focus(),setTimeout(()=>{a.print()},250)}startQRScanner(){if(!window.Html5Qrcode)return void alert("Biblioteca de scanner n√£o carregada. Verifique sua conex√£o.");const e=document.getElementById("qrScannerContainer"),t=document.getElementById("qrReader");if(!e||!t)return;this.currentQRScanner&&this.stopQRScanner(),t.innerHTML="",e.style.display="block";const o=new Html5Qrcode("qrReader");this.currentQRScanner=o,o.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},(t,a)=>{this.handleQRScanned(t),o.stop().then(()=>{e.style.display="none",this.currentQRScanner=null}).catch(t=>{console.error("Erro ao parar scanner:",t),e.style.display="none",this.currentQRScanner=null})},e=>{}).catch(t=>{console.error("Erro ao iniciar scanner:",t),alert("Erro ao acessar a c√¢mera. Verifique as permiss√µes ou tente novamente."),e.style.display="none",this.currentQRScanner=null})}stopQRScanner(){const e=document.getElementById("qrScannerContainer"),t=document.getElementById("qrReader");this.currentQRScanner?this.currentQRScanner.stop().then(()=>{e&&(e.style.display="none"),t&&(t.innerHTML=""),this.currentQRScanner=null}).catch(o=>{console.error("Erro ao parar scanner:",o),e&&(e.style.display="none"),t&&(t.innerHTML=""),this.currentQRScanner=null}):(e&&(e.style.display="none"),t&&(t.innerHTML=""))}handleQRScanned(e){const t=e.trim();console.log(`üì± QR Code escaneado: "${t}"`);let o=this.items.find(e=>e.qrCodeNumber===t);if(o)console.log(`‚úÖ Produto encontrado pelo QR Code: ${this.getItemName(o.id)} (ID: ${o.id})`);else{console.log(`‚ö†Ô∏è Produto n√£o encontrado pelo QR Code "${t}". Tentando compatibilidade com formato antigo...`);let e=null;t.startsWith("ITEM:")?(e=t.replace("ITEM:",""),console.log(`üîç Tentando buscar por ID (formato ITEM:): ${e}`)):(e=t,console.log(`üîç Tentando buscar por ID direto: ${e}`)),o=this.items.find(t=>t.id===e),o?console.log(`‚úÖ Produto encontrado por ID (formato antigo): ${this.getItemName(o.id)}`):console.error(`‚ùå Produto n√£o encontrado. QR Code: "${t}"`)}if(o){const e=o.id,t=this.getItemName(e),a=document.getElementById("saleItem");a&&(a.value=e,a.dispatchEvent(new Event("change")));const s=document.getElementById("salePrice");s&&o.price&&(s.value=o.price),this.updateStockInfo();const n=document.getElementById("saleDayInfo");if(n){const e=n.style.background;n.style.background="#28a745",n.innerHTML=`<strong style="color: white;">‚úì Produto identificado: ${t}</strong>`,setTimeout(()=>{n.style.background=e,n.innerHTML=`<strong>Dia: <span id="saleDayDisplay">${this.currentSaleDay||"-"}</span></strong>`},3e3)}this.showSuccess(`Produto "${t}" identificado pelo QR Code!`)}else alert(`Produto n√£o encontrado!\n\nQR Code escaneado: "${t}"\n\nVerifique se:\n- O QR code pertence a um produto cadastrado\n- O produto n√£o foi exclu√≠do\n- O QR code est√° correto`),console.error("‚ùå Produto n√£o encontrado pelo QR Code:",t),console.log("üìã Produtos dispon√≠veis:",this.items.map(e=>({id:e.id,name:this.getItemName(e.id),qrCode:e.qrCodeNumber})))}deleteItem(e){if(!this.checkPermission("delete","item"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para excluir produtos.",3e3):alert("Voc√™ n√£o tem permiss√£o para excluir produtos."));const t=this.items.find(t=>t.id===e)?this.getItemName(e):"este item",o=o=>{o&&(this.items=this.items.filter(t=>t.id!==e),this.itemTags[e]&&delete this.itemTags[e],this.groups.forEach(t=>{t.days.forEach(t=>{t.sales=t.sales.filter(t=>t.itemId!==e)})}),this.saveData(),this.updateTagFilter(),this.renderItems(),this.renderGroups(),this.logAction("delete","item",e,t),void 0!==toast&&toast&&toast.success(`Produto "${t}" exclu√≠do com sucesso!`,3e3))};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir "${t}"? Esta a√ß√£o n√£o pode ser desfeita.`,"Excluir Produto").then(o):confirm(`Tem certeza que deseja excluir "${t}"?`)&&o(!0)}openQuickSaleScanner(){const e=document.getElementById("quickSaleScannerModal");if(!e)return void console.error("Modal de scanner n√£o encontrado");if(this.openModalSafely(e),!window.Html5Qrcode)return void toast.error("Biblioteca de scanner n√£o carregada. Verifique sua conex√£o.",3e3);const t=document.getElementById("quickSaleQrReader");if(!t)return;t.innerHTML="";const o=new Html5Qrcode("quickSaleQrReader");this.quickSaleQRScanner=o,o.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},t=>{this.handleQuickSaleQRScanned(t),o.stop().then(()=>{this.quickSaleQRScanner=null,this.closeModalSafely(e)}).catch(t=>{console.error("Erro ao parar scanner ap√≥s escanear:",t),this.quickSaleQRScanner=null,this.closeModalSafely(e)})},e=>{}).catch(e=>{console.error("Erro ao iniciar scanner:",e),toast.error("Erro ao acessar a c√¢mera. Verifique as permiss√µes.",5e3),this.quickSaleQRScanner=null;const t=document.getElementById("quickSaleQrReader");t&&(t.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Erro ao acessar c√¢mera. Verifique as permiss√µes do navegador.</p>')})}closeQuickSaleScanner(){const e=document.getElementById("quickSaleScannerModal");e&&(this.quickSaleQRScanner?this.quickSaleQRScanner.stop().then(()=>{this.quickSaleQRScanner=null,this.closeModalSafely(e)}).catch(t=>{console.error("Erro ao parar scanner:",t),this.quickSaleQRScanner=null,this.closeModalSafely(e)}):this.closeModalSafely(e),/Android/i.test(navigator.userAgent)&&/Chrome/i.test(navigator.userAgent)&&(setTimeout(()=>{document.body.style.removeProperty("backdrop-filter"),document.body.style.removeProperty("-webkit-backdrop-filter"),document.documentElement.style.removeProperty("backdrop-filter"),document.documentElement.style.removeProperty("-webkit-backdrop-filter"),document.body.style.removeProperty("background"),document.body.style.removeProperty("background-color"),document.documentElement.style.removeProperty("background"),document.documentElement.style.removeProperty("background-color"),0===document.querySelectorAll(".modal.active").length&&(document.body.style.setProperty("opacity","1","important"),document.body.style.setProperty("visibility","visible","important"))},100),setTimeout(()=>{document.body.style.removeProperty("backdrop-filter"),document.body.style.removeProperty("-webkit-backdrop-filter"),document.documentElement.style.removeProperty("backdrop-filter"),document.documentElement.style.removeProperty("-webkit-backdrop-filter")},500)))}handleQuickSaleQRScanned(e){const t=e.trim();console.log(`üì± [VENDA R√ÅPIDA] QR Code escaneado: "${t}"`);let o=this.items.find(e=>e.qrCodeNumber===t);if(!o){let e=t.startsWith("ITEM:")?t.replace("ITEM:",""):t;o=this.items.find(t=>t.id===e)}o?this.openQuickSaleModal(o.id):(toast.error(`Produto n√£o encontrado para o QR Code: ${t}`,4e3),console.error("Produtos dispon√≠veis:",this.items.map(e=>({id:e.id,name:this.getItemName(e.id),qrCode:e.qrCodeNumber}))))}openQuickSaleModal(e){const t=this.items.find(t=>t.id===e);if(!t)return void toast.error("Produto n√£o encontrado.",3e3);const o=document.getElementById("quickSaleModal");if(!o)return;const a=document.getElementById("quickSaleProductName"),s=document.getElementById("quickSaleProductCategory"),n=document.getElementById("quickSaleProductPrice"),r=document.getElementById("quickSaleStockInfo"),i=document.getElementById("quickSaleStockQty"),c=document.getElementById("quickSaleItemId"),l=document.getElementById("quickSalePrice"),d=document.getElementById("quickSaleQuantity");a&&(a.textContent=this.getItemName(e)),s&&(s.textContent=t.category||"Sem categoria"),n&&(n.textContent=`R$ ${(t.price||0).toFixed(2).replace(".",",")}`),c&&(c.value=e),l&&(l.value=t.price||0),d&&(d.value=1);const m="Servi√ßos"===t.category;if(r)if(m)r.style.display="none";else{r.style.display="block";const t=this.getAvailableStock(e);i&&(i.textContent=null!==t?`${t} un.`:"N√£o definido")}const u=document.getElementById("quickSaleVariationFields");u&&("Roupas"===t.category||"Eletr√¥nicos"===t.category?(u.style.display="block",this.populateQuickSaleVariations(t)):u.style.display="none"),this.populateQuickSaleClients();const p=document.getElementById("quickDiscountFields"),g=document.getElementById("toggleQuickDiscountBtn");p&&(p.style.display="none"),g&&(g.innerHTML='<i class="fas fa-plus"></i> Aplicar Desconto');const h=document.getElementById("quickSaleDiscountType"),v=document.getElementById("quickSaleDiscountValue"),y=document.getElementById("quickSaleCouponCode");h&&(h.value=""),v&&(v.value=""),y&&(y.value=""),this.updateQuickSaleTotal();const f=document.getElementById("quickSaleForm");f&&(f.onsubmit=e=>this.processQuickSale(e)),this.openModalSafely(o)}closeQuickSaleModal(){const e=document.getElementById("quickSaleModal");e&&e.classList.remove("active"),window.quickSaleCouponCode&&delete window.quickSaleCouponCode}populateQuickSaleVariations(e){const t=document.getElementById("quickSaleSize"),o=document.getElementById("quickSaleColor");t&&(t.innerHTML='<option value="">Selecione...</option>',e.variations&&e.variations.length>0)&&[...new Set(e.variations.map(e=>e.size).filter(Boolean))].forEach(e=>{const o=document.createElement("option");o.value=e,o.textContent=e,t.appendChild(o)}),o&&(o.innerHTML='<option value="">Selecione...</option>',e.variations&&e.variations.length>0)&&[...new Set(e.variations.map(e=>e.color).filter(Boolean))].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)})}populateQuickSaleClients(){const e=document.getElementById("quickSaleCustomerSelect");e&&(e.innerHTML='<option value="">Selecione ou digite...</option>',this.clients&&this.clients.length>0&&this.clients.forEach(t=>{const o=document.createElement("option");o.value=t.name,o.textContent=t.name+(t.cpf?` (${this.formatCPF(t.cpf)})`:""),e.appendChild(o)}))}onQuickSaleClientChange(){const e=document.getElementById("quickSaleCustomerSelect"),t=document.getElementById("quickSaleCustomerName");e&&t&&e.value&&(t.value=e.value)}toggleQuickSaleDiscount(){const e=document.getElementById("quickDiscountFields"),t=document.getElementById("toggleQuickDiscountBtn");if(e&&t){const o="none"!==e.style.display;if(e.style.display=o?"none":"block",t.innerHTML=o?'<i class="fas fa-plus"></i> Aplicar Desconto':'<i class="fas fa-minus"></i> Remover Desconto',o){const e=document.getElementById("quickSaleDiscountType"),t=document.getElementById("quickSaleDiscountValue");e&&(e.value=""),t&&(t.value=""),this.updateQuickSaleTotal()}}}applyQuickSaleCoupon(){const e=document.getElementById("quickSaleCouponCode");if(!e||!e.value.trim())return void toast.warning("Digite o c√≥digo do cupom.",2e3);const t=e.value.trim().toUpperCase(),o=this.coupons.find(e=>e.code.toUpperCase()===t&&!1!==e.active);if(!o)return void toast.error("Cupom inv√°lido ou expirado.",3e3);if(o.maxUses&&o.uses>=o.maxUses)return void toast.error("Este cupom atingiu o limite de uso.",3e3);if(o.expiresAt&&new Date>new Date(o.expiresAt))return void toast.error("Este cupom expirou.",3e3);window.quickSaleCouponCode=t;const a=document.getElementById("quickSaleDiscountType"),s=document.getElementById("quickSaleDiscountValue");a&&s&&(a.value="percentage"===o.type?"percent":"fixed",s.value=o.value),this.updateQuickSaleTotal(),toast.success(`Cupom "${t}" aplicado com sucesso!`,3e3)}updateQuickSaleTotal(){const e=document.getElementById("quickSalePrice"),t=document.getElementById("quickSaleQuantity"),o=document.getElementById("quickSaleDiscountType"),a=document.getElementById("quickSaleDiscountValue"),s=(parseFloat(e?.value)||0)*(parseInt(t?.value)||1);let n=0;const r=o?.value,i=parseFloat(a?.value)||0;"percent"===r&&i>0?n=s*(i/100):"fixed"===r&&i>0&&(n=i),n=Math.min(n,s);const c=s-n,l=document.getElementById("quickSaleSubtotal"),d=document.getElementById("quickSaleDiscountAmount"),m=document.getElementById("quickSaleDiscountRow"),u=document.getElementById("quickSaleTotal");l&&(l.textContent=`R$ ${s.toFixed(2).replace(".",",")}`),d&&(d.textContent=`- R$ ${n.toFixed(2).replace(".",",")}`),m&&(m.style.display=n>0?"flex":"none"),u&&(u.textContent=`R$ ${c.toFixed(2).replace(".",",")}`)}getAvailableStock(e,t="",o=""){if(!this.currentGroup||!this.currentSaleDay){const t=this.items.find(t=>t.id===e);return t&&void 0!==t.stock?t.stock:null}const a=this.groups.find(e=>e.id===this.currentGroup.id);if(!a)return null;const s=a.days.find(e=>e.day===this.currentSaleDay);if(!s||!s.stock)return null;const n=this.getStockKey(e,t,o);return(s.stock[n]||0)-s.sales.filter(e=>this.getStockKey(e.itemId,e.size||"",e.color||"")===n).reduce((e,t)=>e+t.quantity,0)}processQuickSale(e){e.preventDefault();const t=document.getElementById("quickSaleItemId")?.value,o=this.formatText(document.getElementById("quickSaleCustomerName")?.value||""),a=parseInt(document.getElementById("quickSaleQuantity")?.value)||1,s=parseFloat(document.getElementById("quickSalePrice")?.value)||0,n=document.getElementById("quickSaleSize")?.value||"",r=document.getElementById("quickSaleColor")?.value||"",i=document.getElementById("quickSaleDiscountType")?.value,c=parseFloat(document.getElementById("quickSaleDiscountValue")?.value)||0;if(!t)return void toast.error("Produto n√£o selecionado.",3e3);if(!o)return void toast.warning("Por favor, informe o nome do cliente.",3e3);if(a<=0||s<=0)return void toast.warning("Quantidade e pre√ßo devem ser maiores que zero.",3e3);const l=this.items.find(e=>e.id===t);if(!l)return void toast.error("Produto n√£o encontrado.",3e3);if(("Roupas"===l.category||"Eletr√¥nicos"===l.category)&&!n)return void toast.warning("Por favor, selecione o tamanho.",3e3);if(!this.currentGroup||!this.currentSaleDay)return void toast.warning("Selecione um m√™s e dia antes de registrar a venda.",4e3);const d=this.groups.find(e=>e.id===this.currentGroup.id);if(!d)return void toast.error("Grupo n√£o encontrado.",3e3);let m=d.days.find(e=>e.day===this.currentSaleDay);m||(m={day:this.currentSaleDay,sales:[],stock:{}},d.days.push(m));const u="Servi√ßos"===l.category;if(!u&&m.stock){const e=this.getStockKey(t,n,r),o=m.stock[e]||0,s=o-m.sales.filter(t=>this.getStockKey(t.itemId,t.size||"",t.color||"")===e).reduce((e,t)=>e+t.quantity,0);if(o>0&&a>s&&!confirm(`Estoque dispon√≠vel: ${s} un. Deseja registrar ${a} un. mesmo assim?`))return}const p=s*a;let g=0;"percent"===i&&c>0?g=p*(c/100):"fixed"===i&&c>0&&(g=c),g=Math.min(g,p);const h=p-g,v={itemId:t,quantity:a,price:s,basePrice:s,discount:g>0?{type:i,value:c,amount:g,couponCode:window.quickSaleCouponCode||null}:null};"Roupas"!==l.category&&"Eletr√¥nicos"!==l.category||(n&&(v.size=n),r&&(v.color=r)),m.sales.push(v);const y=this.generateOrderCode(),f=new Date,E={id:Date.now().toString()+Math.random().toString(36).substr(2,9),orderCode:y,customerName:o,customerCPF:null,items:[{itemId:t,name:this.getItemName(t),quantity:a,price:s,size:n||void 0,color:r||void 0}],totalValue:h,discount:v.discount,notes:"Venda r√°pida via QR Code",date:f.toISOString(),timestamp:f.getTime(),groupId:d.id,groupMonth:d.month,day:this.currentSaleDay};if(this.completedSales.push(E),window.quickSaleCouponCode){const e=this.coupons.find(e=>e.code===window.quickSaleCouponCode);e&&(e.uses=(e.uses||0)+1),delete window.quickSaleCouponCode}if(!u&&m.stock){const e=this.getStockKey(t,n,r);m.stock[e]&&m.stock[e]>=a&&console.log(`‚úÖ Estoque ser√° abatido: ${a} un. do item ${this.getItemName(t)}`)}if(this.clients.find(e=>e.name.toLowerCase()===o.toLowerCase()))this.addLoyaltyPoints(o,h);else{const e={id:Date.now().toString(),name:o,cpf:null,phone:null,email:null,loyaltyPoints:Math.floor(h/10),receiveNotifications:!1};this.clients.push(e),console.log(`‚úÖ Cliente "${o}" cadastrado automaticamente`)}"Servi√ßos"!==l.category&&this.registrarVenda(a),this.saveData(),this.renderGroups(),this.updateOverallSummary(),this.closeQuickSaleModal(),toast.success(`Venda registrada com sucesso!\nProduto: ${this.getItemName(t)}\nTotal: R$ ${h.toFixed(2).replace(".",",")}`,4e3),this.logAction("create","sale",E.id,`Venda r√°pida via QR - ${this.getItemName(t)}`),console.log("‚úÖ Venda r√°pida conclu√≠da:",E)}handleSearch(e){if(!e||!e.trim())return this.renderItems(),this.renderClients(),void this.hideSearchHistory();const t=e.trim().toLowerCase();this.renderItems(),this.renderClients(),this.showSearchResults(t)}addToSearchHistory(e){if(!e||!e.trim())return;const t=e.trim();this.searchHistory=this.searchHistory.filter(e=>e!==t),this.searchHistory.unshift(t),this.searchHistory.length>10&&(this.searchHistory=this.searchHistory.slice(0,10)),localStorage.setItem("searchHistory",JSON.stringify(this.searchHistory))}loadSearchHistory(){const e=localStorage.getItem("searchHistory");if(e)try{this.searchHistory=JSON.parse(e)}catch(e){this.searchHistory=[]}}showSearchHistory(){if(0===this.searchHistory.length)return;let e=document.getElementById("searchHistoryContainer");if(!e){e=document.createElement("div"),e.id="searchHistoryContainer",e.className="search-history-container";const t=document.getElementById("globalSearchInput");t&&t.parentElement&&t.parentElement.appendChild(e)}e.innerHTML=`\n            <div class="search-history-header">\n                <span>Buscas recentes</span>\n                <button class="search-history-clear" onclick="app.clearSearchHistory()" aria-label="Limpar hist√≥rico">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="search-history-list">\n                ${this.searchHistory.map(e=>`\n                    <button class="search-history-item" onclick="app.selectSearchHistory('${e.replace(/'/g,"\\'")}')">\n                        <i class="fas fa-history"></i>\n                        <span>${this.escapeHtml(e)}</span>\n                    </button>\n                `).join("")}\n            </div>\n        `,e.style.display="block"}hideSearchHistory(){const e=document.getElementById("searchHistoryContainer");e&&(e.style.display="none")}selectSearchHistory(e){const t=document.getElementById("globalSearchInput");t&&(t.value=e,this.handleSearch(e),this.hideSearchHistory())}clearSearchHistory(){this.searchHistory=[],localStorage.removeItem("searchHistory"),this.hideSearchHistory(),void 0!==toast&&toast&&toast.info("Hist√≥rico de buscas limpo",2e3)}showSearchResults(e){const t=document.getElementById("itemsGrid"),o=document.getElementById("clientsList");let a=0,s=0;t&&t.querySelectorAll(".item-card").length,o&&o.querySelectorAll(".client-card, .item-card").length}renderItemTags(e){const t=this.itemTags[e]||[];if(0===t.length)return"";const o=["#dc3545","#28a745","#007bff","#ffc107","#17a2b8","#6f42c1","#e83e8c","#fd7e14","#20c997","#6610f2"];return`\n            <div class="item-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 0.75rem 0;">\n                ${t.map(e=>{const t=(e=>{let t=0;for(let o=0;o<e.length;o++)t=e.charCodeAt(o)+((t<<5)-t);return o[Math.abs(t)%o.length]})(e);return`\n                        <span class="item-tag" \n                              style="background-color: ${t}; color: ${this.getContrastColor(t)}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.25rem; cursor: pointer; transition: all 0.2s;"\n                              onclick="app.filterByTag('${e.replace(/'/g,"\\'")}')"\n                              title="Clique para filtrar por esta tag">\n                            <i class="fas fa-tag" style="font-size: 0.65rem;"></i>\n                            ${this.escapeHtml(e)}\n                        </span>\n                    `}).join("")}\n            </div>\n        `}filterByTag(e){const t=document.getElementById("tagFilter");t&&(t.value=e,t.dispatchEvent(new Event("change")))}updateTagFilter(){const e=document.getElementById("tagFilter");if(!e)return;const t=new Set;Object.values(this.itemTags||{}).forEach(e=>{e.forEach(e=>t.add(e))});const o=e.value;e.innerHTML='<option value="">Todas as tags</option>',Array.from(t).sort().forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)}),o&&t.has(o)&&(e.value=o)}getContrastColor(e){return(.299*parseInt(e.substr(1,2),16)+.587*parseInt(e.substr(3,2),16)+.114*parseInt(e.substr(5,2),16))/255>.5?"#000000":"#ffffff"}renderItems(){const e=document.getElementById("itemsGrid");if(!e)return;if(0===this.items.length&&!e.querySelector(".item-card"))return void this.showSkeleton("itemsGrid",6,!1);const t=document.getElementById("productSearchInput"),o=document.getElementById("monthFilter"),a=t?t.value.toLowerCase():"",s=o?o.value:"";let n=this.items.filter(e=>"Servi√ßos"!==e.category);if(a&&(n=n.filter(e=>{const t=a.toLowerCase(),o=e.category||"Roupas";return e.name.toLowerCase().includes(t)||"Roupas"===o&&e.brand&&e.brand.toLowerCase().includes(t)||"Roupas"===o&&e.style&&e.style.toLowerCase().includes(t)||"Roupas"===o&&e.size&&e.size.toLowerCase().includes(t)||"Eletr√¥nicos"===o&&e.model&&e.model.toLowerCase().includes(t)||"Eletr√¥nicos"===o&&e.capacity&&e.capacity.toLowerCase().includes(t)||"Eletr√¥nicos"===o&&e.color&&e.color.toLowerCase().includes(t)||e.notes&&e.notes.toLowerCase().includes(t)})),s){const[e,t]=s.split("-");n=n.filter(e=>this.groups.some(t=>t.month===s&&t.days.some(t=>t.sales.some(t=>t.itemId===e.id))))}const r=document.getElementById("tagFilter")?.value;r&&(n=n.filter(e=>(this.itemTags[e.id]||[]).includes(r))),0!==n.length?e.innerHTML=n.map(e=>{const t=e.category||"Roupas";let o,a="";if("Roupas"===t?a=`\n                    ${e.style?`<div class="item-info">Estilo: ${this.escapeHtml(e.style)}</div>`:""}\n                    ${e.size?`<div class="item-info">Tamanho: ${this.escapeHtml(e.size)}</div>`:""}\n                    ${e.gender?`<div class="item-info">G√™nero: ${this.escapeHtml(e.gender)}</div>`:""}\n                `:"Eletr√¥nicos"===t&&(a=`\n                    ${e.model?`<div class="item-info">Modelo: ${this.escapeHtml(e.model)}</div>`:""}\n                    ${e.capacity?`<div class="item-info">Capacidade: ${this.escapeHtml(e.capacity)}</div>`:""}\n                    ${e.color?`<div class="item-info">Cor: ${this.escapeHtml(e.color)}</div>`:""}\n                `),"Eletr√¥nicos"===t&&e.model)o=e.model;else if("Roupas"===t){if(e.name)o=e.name;else{const t=[e.brand||""];e.style&&t.push(e.style),o=t.filter(e=>e).join(" - ")||"Roupa"}e.size&&(o+=` ‚Äì tamanho ${e.size}`)}else o=e.name||"Item";let s="";return"Eletr√¥nicos"===t?s="electronics-badge":"Roupas"===t&&(s="clothing-badge"),`\n            <div class="item-card">\n                <div class="item-category-badge ${s}">${this.escapeHtml(t)}</div>\n                <h3>${this.escapeHtml(o)}</h3>\n                ${"Roupas"===t&&e.name?`<div class="item-info">Marca: ${this.escapeHtml(e.brand)}</div>`:""}\n                ${a}\n                ${this.renderItemTags(e.id)}\n                <div class="item-price">R$ ${e.price.toFixed(2).replace(".",",")}</div>\n                <div class="item-actions">\n                    ${"Servi√ßos"!==t?`<button class="btn-small btn-secondary btn-qr" onclick="app.showQRCodeModal('${e.id}')" title="Ver QR Code">\n                            <i class="fas fa-qrcode"></i><span class="btn-text">QR Code</span>\n                        </button>`:""}\n                    <div class="item-actions-row">\n                        <button class="btn-small btn-edit" onclick="app.openItemModal(${JSON.stringify(e).replace(/"/g,"&quot;")})" title="Editar">\n                            <i class="fas fa-pen"></i><span class="btn-text">Editar</span>\n                        </button>\n                        <button class="btn-small btn-delete" onclick="app.deleteItem('${e.id}')" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                </div>\n            </div>\n        `}).join(""):e.innerHTML=`<div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-box-open"></i>\n                    </div>\n                    <h3 class="empty-state-title">${a?"Nenhum item encontrado":"Nenhum produto cadastrado"}</h3>\n                    <p class="empty-state-message">\n                        ${a?"Tente ajustar os filtros de pesquisa ou adicionar um novo produto.":"Comece adicionando seu primeiro produto ao sistema. Clique no bot√£o abaixo para come√ßar!"}\n                    </p>\n                    ${a?"":'\n                        <div class="empty-state-action">\n                            <button class="btn-primary" onclick="app.openItemModal()">\n                                <i class="fas fa-plus"></i> Adicionar Primeiro Produto\n                            </button>\n                        </div>\n                    '}\n                </div>`}openClientModal(e=null){const t=document.getElementById("clientModal"),o=document.getElementById("clientForm"),a=document.getElementById("clientModalTitle");if(t&&o&&a){if(this.currentEditingClient=e?this.clients.find(t=>t.id===e):null,this.currentEditingClient?(a.textContent="Editar Cliente",o.clientName.value=this.currentEditingClient.name||"",o.clientCPF.value=this.currentEditingClient.cpf||"",o.clientPhone.value=this.currentEditingClient.phone||"",o.clientEmail.value=this.currentEditingClient.email||"",o.clientAddress.value=this.currentEditingClient.address||"",o.clientNotes.value=this.currentEditingClient.notes||"",o.clientLoyaltyPoints.value=this.currentEditingClient.loyaltyPoints||0,o.clientReceiveNotifications.checked=!1!==this.currentEditingClient.receiveNotifications):(a.textContent="Novo Cliente",o.reset()),this.openModalSafely(t),void 0!==fieldValidator){const e=o.clientName,t=o.clientCPF,a=o.clientPhone,s=o.clientEmail,n=o.clientNotes;e&&fieldValidator.setupFieldValidation(e,{required:!0,minLength:2,maxLength:100}),t&&fieldValidator.setupFieldValidation(t,{cpf:!0}),a&&fieldValidator.setupFieldValidation(a,{phone:!0}),s&&fieldValidator.setupFieldValidation(s,{email:!0}),n&&fieldValidator.setupFieldValidation(n,{maxLength:500})}}else console.error("Elementos do modal de cliente n√£o encontrados")}closeClientModal(){const e=document.getElementById("clientModal"),t=document.getElementById("clientForm");e&&this.closeModalSafely(e),t&&t.reset(),this.currentEditingClient=null}openServiceTypeModal(){const e=document.getElementById("serviceTypeName");e&&(e.value="");const t=document.getElementById("serviceTypeModal");this.openModalSafely(t)}saveServiceType(){const e=document.getElementById("serviceTypeName");e&&e.value.trim()?(Array.isArray(this.serviceTypes)||(this.serviceTypes=[]),this.serviceTypes.push({id:Date.now().toString(),name:e.value.trim()}),this.closeModalSafely("serviceTypeModal"),this.populateServiceTypes(),this.saveData(),toast.success("Tipo de servi√ßo cadastrado")):toast.error("Informe o nome do tipo de servi√ßo")}populateServiceTypes(){const e=document.getElementById("serviceTypeSelect");e&&(e.innerHTML='<option value="">Selecione</option>',(Array.isArray(this.serviceTypes)?this.serviceTypes:[]).forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.name,e.appendChild(o)}))}saveClient(e){if(e&&e.preventDefault(),!this.checkPermission("write","client"))return void(void 0!==toast&&toast&&toast.error("Voc√™ n√£o tem permiss√£o para criar/editar clientes.",3e3));const t=document.getElementById("clientForm");if(!t)return;const o=t.clientName.value.trim();if(!o)return void(void 0!==toast&&toast?toast.warning("Por favor, informe o nome do cliente.",3e3):alert("Por favor, informe o nome do cliente."));const a=parseInt(t.clientLoyaltyPoints.value)||0,s=t.clientReceiveNotifications.checked,n={id:this.currentEditingClient?this.currentEditingClient.id:Date.now().toString(),name:o,cpf:t.clientCPF.value.trim(),phone:t.clientPhone.value.trim(),email:t.clientEmail.value.trim(),address:t.clientAddress.value.trim(),notes:t.clientNotes.value.trim(),loyaltyPoints:a,receiveNotifications:s,createdAt:this.currentEditingClient?this.currentEditingClient.createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};let r=null;if(this.currentEditingClient){const e=this.clients.findIndex(e=>e.id===this.currentEditingClient.id);-1!==e&&(r=JSON.parse(JSON.stringify(this.clients[e])),this.clients[e]=n)}else this.clients.push(n);this.saveData(),this.renderClients(),this.closeClientModal(),this.logAction(this.currentEditingClient?"update":"create","client",n.id,n.name,{cpf:n.cpf||null,phone:n.phone||null,previousData:r}),this.logDataAccess(this.currentEditingClient?"update":"create","client",n.id,`${this.currentEditingClient?"Atualiza√ß√£o":"Cria√ß√£o"} de cliente: ${n.name}`),void 0!==toast&&toast&&toast.success(this.currentEditingClient?"Cliente atualizado com sucesso!":"Cliente cadastrado com sucesso!",3e3)}deleteClient(e){if(!this.checkPermission("delete","client"))return void(void 0!==toast&&toast&&toast.error("Voc√™ n√£o tem permiss√£o para excluir clientes.",3e3));const t=this.clients.find(t=>t.id===e),o=t?t.name:"este cliente",a=t=>{t&&(this.clients=this.clients.filter(t=>t.id!==e),this.logDataAccess("delete","client",e,`Exclus√£o de cliente: ${o}`),this.saveData(),this.renderClients(),void 0!==toast&&toast&&toast.success(`Cliente "${o}" exclu√≠do com sucesso!`,3e3))};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir "${o}"? Esta a√ß√£o n√£o pode ser desfeita.`,"Excluir Cliente").then(a):confirm(`Tem certeza que deseja excluir "${o}"?`)&&a(!0)}renderClients(){const e=document.getElementById("clientsList");if(!e)return;const t=document.getElementById("clientSearch")?document.getElementById("clientSearch").value.toLowerCase():"";let o=this.clients;t&&(o=this.clients.filter(e=>e.name.toLowerCase().includes(t)||e.cpf&&e.cpf.includes(t)||e.phone&&e.phone.includes(t))),0!==o.length||e.querySelector(".item-card")?(this.hideSkeleton("clientsList"),0!==o.length?e.innerHTML=o.map(e=>{const t=this.completedSales.filter(t=>t.customerName===e.name).length,o=this.completedSales.filter(t=>t.customerName===e.name).reduce((e,t)=>e+(t.totalValue||0),0);return`\n                <div class="item-card">\n                    <div class="item-header">\n                        <h3>${this.escapeHtml(e.name)}</h3>\n                        <div class="item-actions">\n                            <button class="btn-small btn-edit" onclick="app.openClientModal('${e.id}')" title="Editar">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button class="btn-small btn-delete" onclick="app.deleteClient('${e.id}')" title="Excluir">\n                                <i class="fas fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="item-details">\n                        ${e.cpf?`<p><i class="fas fa-id-card"></i> CPF: ${this.escapeHtml(e.cpf)}</p>`:""}\n                        ${e.phone?`<p><i class="fas fa-phone"></i> ${this.escapeHtml(e.phone)}</p>`:""}\n                        ${e.email?`<p><i class="fas fa-envelope"></i> ${this.escapeHtml(e.email)}</p>`:""}\n                        ${t>0?`<p><i class="fas fa-shopping-cart"></i> ${t} compra${t>1?"s":""}</p>`:""}\n                        ${o>0?`<p><i class="fas fa-dollar-sign"></i> Total: R$ ${o.toFixed(2).replace(".",",")}</p>`:""}\n                        ${e.loyaltyPoints>0?`<p><i class="fas fa-star" style="color: #ffc107;"></i> ${e.loyaltyPoints} pontos de fidelidade</p>`:""}\n                        ${e.receiveNotifications?'<p><i class="fas fa-bell" style="color: #28a745;"></i> Recebe notifica√ß√µes</p>':""}\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML=`\n                <div class="empty-state">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-users"></i>\n                    </div>\n                    <h3 class="empty-state-title">${t?"Nenhum cliente encontrado":"Nenhum cliente cadastrado"}</h3>\n                    <p class="empty-state-message">\n                        ${t?"Tente ajustar os termos de busca ou cadastrar um novo cliente.":"Comece cadastrando seus clientes para facilitar o controle de vendas e hist√≥rico de compras."}\n                    </p>\n                    ${t?"":'\n                        <div class="empty-state-action">\n                            <button class="btn-primary" onclick="app.openClientModal()">\n                                <i class="fas fa-user-plus"></i> Cadastrar Primeiro Cliente\n                            </button>\n                        </div>\n                    '}\n                </div>`):this.showSkeleton("clientsList",6,!1)}openSupplierModal(e=null){const t=document.getElementById("supplierModal"),o=document.getElementById("supplierForm"),a=document.getElementById("supplierModalTitle");t&&o&&a?(this.currentEditingSupplier=e?this.suppliers.find(t=>t.id===e):null,this.currentEditingSupplier?(a.textContent="Editar Fornecedor",o.supplierName.value=this.currentEditingSupplier.name||"",o.supplierCNPJ.value=this.currentEditingSupplier.cnpj||"",o.supplierContactName.value=this.currentEditingSupplier.contactName||"",o.supplierPhone.value=this.currentEditingSupplier.phone||"",o.supplierEmail.value=this.currentEditingSupplier.email||"",o.supplierAddress.value=this.currentEditingSupplier.address||"",o.supplierRating.value=this.currentEditingSupplier.rating||3,o.supplierNotes.value=this.currentEditingSupplier.notes||"",this.updateSupplierRatingDisplay()):(a.textContent="Novo Fornecedor",o.reset(),o.supplierRating.value=3,this.updateSupplierRatingDisplay()),t.classList.add("active")):console.error("Elementos do modal de fornecedor n√£o encontrados")}updateSupplierRatingDisplay(){const e=document.getElementById("supplierRating"),t=document.getElementById("supplierRatingDisplay");if(e&&t){const o=parseInt(e.value);t.textContent=`${o} ${"‚≠ê".repeat(o)}`}}closeSupplierModal(){const e=document.getElementById("supplierModal"),t=document.getElementById("supplierForm");e&&e.classList.remove("active"),t&&t.reset(),this.currentEditingSupplier=null}saveSupplier(e){if(e&&e.preventDefault(),!this.checkPermission("write","supplier"))return void(void 0!==toast&&toast&&toast.error("Voc√™ n√£o tem permiss√£o para criar/editar fornecedores.",3e3));const t=document.getElementById("supplierForm");if(!t)return;const o=t.supplierName.value.trim();if(!o)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe o nome do fornecedor.",3e3));const a={id:this.currentEditingSupplier?this.currentEditingSupplier.id:this.generateSupplierId(),name:o,cnpj:t.supplierCNPJ.value.trim(),contactName:t.supplierContactName.value.trim(),phone:t.supplierPhone.value.trim(),email:t.supplierEmail.value.trim(),address:t.supplierAddress.value.trim(),rating:parseInt(t.supplierRating.value)||3,notes:t.supplierNotes.value.trim(),createdAt:this.currentEditingSupplier?this.currentEditingSupplier.createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};let s=null;if(this.currentEditingSupplier){const e=this.suppliers.findIndex(e=>e.id===this.currentEditingSupplier.id);-1!==e&&(s=JSON.parse(JSON.stringify(this.suppliers[e])),this.suppliers[e]=a)}else this.suppliers.push(a);this.saveData(),this.renderSuppliers(),this.closeSupplierModal(),this.logAction(this.currentEditingSupplier?"update":"create","supplier",a.id,a.name,{name:a.name,rating:a.rating,previousData:s}),this.logDataAccess(this.currentEditingSupplier?"update":"create","supplier",a.id,`${this.currentEditingSupplier?"Atualiza√ß√£o":"Cria√ß√£o"} de fornecedor: ${a.name}`),void 0!==toast&&toast&&toast.success(this.currentEditingSupplier?"Fornecedor atualizado com sucesso!":"Fornecedor cadastrado com sucesso!",3e3)}deleteSupplier(e){if(!this.checkPermission("delete","supplier"))return void(void 0!==toast&&toast&&toast.error("Voc√™ n√£o tem permiss√£o para excluir fornecedores.",3e3));const t=this.suppliers.find(t=>t.id===e),o=t?t.name:"este fornecedor",a=t=>{t&&(this.suppliers=this.suppliers.filter(t=>t.id!==e),this.logDataAccess("delete","supplier",e,`Exclus√£o de fornecedor: ${o}`),this.saveData(),this.renderSuppliers(),this.logAction("delete","supplier",e,o),void 0!==toast&&toast&&toast.success(`Fornecedor "${o}" exclu√≠do com sucesso!`,3e3))};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir o fornecedor "${o}"? Esta a√ß√£o n√£o pode ser desfeita.`,"Excluir Fornecedor").then(a):confirm(`Tem certeza que deseja excluir o fornecedor "${o}"?`)&&a(!0)}renderSuppliers(){const e=document.getElementById("suppliersList");if(!e)return;const t=document.getElementById("supplierSearch")?document.getElementById("supplierSearch").value.toLowerCase():"";let o=this.suppliers;t&&(o=this.suppliers.filter(e=>e.name.toLowerCase().includes(t)||e.cnpj&&e.cnpj.includes(t)||e.phone&&e.phone.includes(t))),0!==o.length||e.querySelector(".item-card")?(this.hideSkeleton("suppliersList"),0!==o.length?e.innerHTML=o.map(e=>{const t=this.costs.filter(t=>t.supplierId===e.id).length,o=this.costs.filter(t=>t.supplierId===e.id).reduce((e,t)=>e+(t.total||0),0);return`\n                <div class="item-card">\n                    <div class="item-header">\n                        <h3>${this.escapeHtml(e.name)}</h3>\n                        <div class="item-actions">\n                            <button class="btn-small btn-edit" onclick="app.openSupplierModal('${e.id}')" title="Editar">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button class="btn-small btn-delete" onclick="app.deleteSupplier('${e.id}')" title="Excluir">\n                                <i class="fas fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="item-details">\n                        ${e.cnpj?`<p><i class="fas fa-id-card"></i> CNPJ: ${this.escapeHtml(e.cnpj)}</p>`:""}\n                        ${e.contactName?`<p><i class="fas fa-user"></i> Contato: ${this.escapeHtml(e.contactName)}</p>`:""}\n                        ${e.phone?`<p><i class="fas fa-phone"></i> ${this.escapeHtml(e.phone)}</p>`:""}\n                        ${e.email?`<p><i class="fas fa-envelope"></i> ${this.escapeHtml(e.email)}</p>`:""}\n                        <p><i class="fas fa-star" style="color: #ffc107;"></i> Avalia√ß√£o: ${"‚≠ê".repeat(e.rating||3)} (${e.rating||3}/5)</p>\n                        ${t>0?`<p><i class="fas fa-shopping-cart"></i> ${t} compra${t>1?"s":""}</p>`:""}\n                        ${o>0?`<p><i class="fas fa-dollar-sign"></i> Total: R$ ${o.toFixed(2).replace(".",",")}</p>`:""}\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML=`\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-truck"></i>\n                    </div>\n                    <h3 class="empty-state-title">${t?"Nenhum fornecedor encontrado":"Nenhum fornecedor cadastrado"}</h3>\n                    <p class="empty-state-message">\n                        ${t?"Tente ajustar os termos de busca ou cadastrar um novo fornecedor.":"Comece cadastrando seus fornecedores para facilitar o controle de compras e custos."}\n                    </p>\n                    ${t?"":'\n                        <div class="empty-state-action">\n                            <button class="btn-primary" onclick="app.openSupplierModal()">\n                                <i class="fas fa-truck"></i> Cadastrar Primeiro Fornecedor\n                            </button>\n                        </div>\n                    '}\n                </div>`):this.showSkeleton("suppliersList",6,!1)}generateSupplierId(){let e,t=0;do{e="SUPPLIER_"+Date.now()+"_"+Math.random().toString(36).substr(2,5).toUpperCase(),t++}while(this.suppliers.find(t=>t.id===e)&&t<10);return t>=10&&(e="SUPPLIER_"+Date.now()+"_"+Math.random().toString(36).substr(2,9).toUpperCase()),e}openCouponModal(e=null){const t=document.getElementById("couponModal"),o=document.getElementById("couponForm"),a=document.getElementById("couponModalTitle");t&&o&&a?(this.currentEditingCoupon=e?this.coupons.find(t=>t.id===e):null,this.currentEditingCoupon?(a.textContent="Editar Cupom",o.couponCode.value=this.currentEditingCoupon.code||"",o.couponType.value=this.currentEditingCoupon.type||"",o.couponValue.value=this.currentEditingCoupon.value||"",o.couponDescription.value=this.currentEditingCoupon.description||"",o.couponStartsAt.value=this.currentEditingCoupon.startsAt||"",o.couponExpiresAt.value=this.currentEditingCoupon.expiresAt||"",o.couponMaxUses.value=this.currentEditingCoupon.maxUses||"",o.couponMinQuantity.value=this.currentEditingCoupon.minQuantity||"",o.couponActive.checked=!1!==this.currentEditingCoupon.active):(a.textContent="Novo Cupom",o.reset(),o.couponActive.checked=!0),t.classList.add("active")):console.error("Elementos do modal de cupom n√£o encontrados")}closeCouponModal(){const e=document.getElementById("couponModal"),t=document.getElementById("couponForm");e&&e.classList.remove("active"),t&&t.reset(),this.currentEditingCoupon=null}saveCoupon(e){e&&e.preventDefault();const t=document.getElementById("couponForm");if(!t)return;const o=t.couponCode.value.trim().toUpperCase(),a=t.couponType.value,s=parseFloat(t.couponValue.value),n=t.couponDescription.value.trim(),r=t.couponExpiresAt.value||null,i=t.couponMaxUses.value?parseInt(t.couponMaxUses.value):null,c=t.couponActive.checked;if(!o)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe o c√≥digo do cupom.",3e3));if(!a)return void(void 0!==toast&&toast&&toast.warning("Por favor, selecione o tipo de desconto.",3e3));if(!s||s<=0)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe um valor v√°lido para o desconto.",3e3));if("percent"===a&&s>100)return void(void 0!==toast&&toast&&toast.warning("O desconto percentual n√£o pode ser maior que 100%.",3e3));if(this.coupons.find(e=>e.code===o&&(!this.currentEditingCoupon||e.id!==this.currentEditingCoupon.id)))return void(void 0!==toast&&toast&&toast.warning("J√° existe um cupom com este c√≥digo.",3e3));const l={id:this.currentEditingCoupon?this.currentEditingCoupon.id:this.generateCouponId(),code:o,type:a,value:s,description:n,startsAt:startsAt,expiresAt:r,maxUses:i,minQuantity:minQuantity,active:c,uses:this.currentEditingCoupon&&this.currentEditingCoupon.uses||0,createdAt:this.currentEditingCoupon?this.currentEditingCoupon.createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};let d=null;if(this.currentEditingCoupon){const e=this.coupons.findIndex(e=>e.id===this.currentEditingCoupon.id);-1!==e&&(d=JSON.parse(JSON.stringify(this.coupons[e])),this.coupons[e]=l)}else this.coupons.push(l);this.saveData(),this.renderCoupons(),this.closeCouponModal(),this.logAction(this.currentEditingCoupon?"update":"create","coupon",l.id,l.code,{type:l.type,value:l.value,previousData:d}),void 0!==toast&&toast&&toast.success(this.currentEditingCoupon?"Cupom atualizado com sucesso!":"Cupom cadastrado com sucesso!",3e3)}deleteCoupon(e){const t=this.coupons.find(t=>t.id===e),o=t?t.code:"este cupom",a=t=>{t&&(this.coupons=this.coupons.filter(t=>t.id!==e),this.saveData(),this.renderCoupons(),void 0!==toast&&toast&&toast.success(`Cupom "${o}" exclu√≠do com sucesso!`,3e3))};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir o cupom "${o}"? Esta a√ß√£o n√£o pode ser desfeita.`,"Excluir Cupom").then(a):confirm(`Tem certeza que deseja excluir o cupom "${o}"?`)&&a(!0)}renderCoupons(){const e=document.getElementById("couponsList");e&&(0!==this.coupons.length||e.querySelector(".item-card")?(this.hideSkeleton("couponsList"),0!==this.coupons.length?e.innerHTML=this.coupons.map(e=>{const t=e.expiresAt&&new Date(e.expiresAt)<new Date,o=e.maxUses&&e.uses>=e.maxUses,a=e.active&&!t&&!o;return`\n                <div class="item-card ${a?"":"opacity-50"}">\n                    <div class="item-header">\n                        <h3>${this.escapeHtml(e.code)}</h3>\n                        <div class="item-actions">\n                            <button class="btn-small btn-edit" onclick="app.openCouponModal('${e.id}')" title="Editar">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button class="btn-small btn-delete" onclick="app.deleteCoupon('${e.id}')" title="Excluir">\n                                <i class="fas fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="item-details">\n                        <p><i class="fas fa-percent"></i> Tipo: ${"percent"===e.type?"Percentual":"Valor Fixo"}</p>\n                        <p><i class="fas fa-dollar-sign"></i> Desconto: ${"percent"===e.type?`${e.value}%`:`R$ ${e.value.toFixed(2).replace(".",",")}`}</p>\n                        ${e.description?`<p><i class="fas fa-info-circle"></i> ${this.escapeHtml(e.description)}</p>`:""}\n                        ${e.startsAt?`<p><i class="fas fa-calendar-check"></i> In√≠cio: ${new Date(e.startsAt).toLocaleDateString("pt-BR")}</p>`:""}\n                        ${e.expiresAt?`<p><i class="fas fa-calendar-times"></i> Expira em: ${new Date(e.expiresAt).toLocaleDateString("pt-BR")}</p>`:""}\n                        ${e.minQuantity?`<p><i class="fas fa-shopping-bag"></i> Qtd. m√≠nima: ${e.minQuantity} unidade(s)</p>`:""}\n                        ${e.maxUses?`<p><i class="fas fa-times-circle"></i> Limite: ${e.maxUses} uso${e.maxUses>1?"s":""}</p>`:""}\n                        <p><i class="fas fa-chart-line"></i> Usado: ${e.uses||0} vez${1!==(e.uses||0)?"es":""}</p>\n                        <p><i class="fas fa-${a?"check-circle":"times-circle"}" style="color: ${a?"#28a745":"#dc3545"};"></i> Status: ${a?"Ativo":t?"Expirado":o?"Limite atingido":"Inativo"}</p>\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML='\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-tag"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum cupom cadastrado</h3>\n                    <p class="empty-state-message">\n                        Comece criando cupons de desconto para oferecer promo√ß√µes aos seus clientes.\n                    </p>\n                    <div class="empty-state-action">\n                        <button class="btn-primary" onclick="app.openCouponModal()">\n                            <i class="fas fa-tag"></i> Criar Primeiro Cupom\n                        </button>\n                    </div>\n                </div>'):this.showSkeleton("couponsList",6,!1))}generateCouponId(){let e,t=0;do{e="COUPON_"+Date.now()+"_"+Math.random().toString(36).substr(2,5).toUpperCase(),t++}while(this.coupons.find(t=>t.id===e)&&t<10);return t>=10&&(e="COUPON_"+Date.now()+"_"+Math.random().toString(36).substr(2,9).toUpperCase()),e}applyCouponCode(){const e=document.getElementById("saleCouponCode");if(!e)return;const t=e.value.trim().toUpperCase();if(!t)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe o c√≥digo do cupom.",3e3));const o=this.coupons.find(e=>e.code===t&&e.active);if(!o)return void(void 0!==toast&&toast&&toast.error("Cupom n√£o encontrado ou inativo.",3e3));const a=new Date;if(o.startsAt&&new Date(o.startsAt)>a)return void(void 0!==toast&&toast&&toast.error(`Este cupom ainda n√£o est√° ativo. V√°lido a partir de ${new Date(o.startsAt).toLocaleDateString("pt-BR")}.`,4e3));if(o.expiresAt&&new Date(o.expiresAt)<a)return void(void 0!==toast&&toast&&toast.error("Este cupom est√° expirado.",3e3));if(o.maxUses&&o.uses>=o.maxUses)return void(void 0!==toast&&toast&&toast.error("Este cupom atingiu o limite de uso.",3e3));const s=parseInt(document.getElementById("saleQuantity")?.value||0);if(o.minQuantity&&s<o.minQuantity)return void(void 0!==toast&&toast&&toast.warning(`Este cupom requer compra m√≠nima de ${o.minQuantity} unidade(s). Quantidade atual: ${s}.`,4e3));const n=document.getElementById("saleDiscountType"),r=document.getElementById("saleDiscountValue");n&&r&&(n.value=o.type,r.value=o.value,window.currentSaleCouponCode||(window.currentSaleCouponCode=o.code),"function"==typeof this.updateSaleTotals?this.updateSaleTotals():"function"==typeof this.updateDiscountCalculation&&this.updateDiscountCalculation(),void 0!==toast&&toast&&toast.success(`Cupom "${o.code}" aplicado com sucesso!`,3e3))}applyCoupon(){this.applyCouponCode()}openTemplateModal(e=null){const t=document.getElementById("templateModal"),o=document.getElementById("templateForm"),a=document.getElementById("templateModalTitle");t&&o&&a?(this.currentEditingTemplate=e?this.templates.find(t=>t.id===e):null,this.currentEditingTemplate?(a.textContent="Editar Template",o.templateName.value=this.currentEditingTemplate.name||"",o.templateType.value=this.currentEditingTemplate.type||"",o.templateDescription.value=this.currentEditingTemplate.description||"","product"===this.currentEditingTemplate.type?(o.templateCategory.value=this.currentEditingTemplate.data?.category||"",o.templatePrice.value=this.currentEditingTemplate.data?.price||""):"sale"===this.currentEditingTemplate.type?(o.templateSaleQuantity.value=this.currentEditingTemplate.data?.quantity||"",o.templateSaleDiscount.value=this.currentEditingTemplate.data?.discount||""):"service"===this.currentEditingTemplate.type?(o.templateServiceHours.value=this.currentEditingTemplate.data?.hours||"",o.templateServiceMinutes.value=this.currentEditingTemplate.data?.minutes||""):"report"===this.currentEditingTemplate.type&&(o.templateReportType.value=this.currentEditingTemplate.data?.reportType||"",o.templateReportPeriod.value=this.currentEditingTemplate.data?.period||"month",o.templateReportFormat.value=this.currentEditingTemplate.data?.format||"pdf",o.templateReportColumns.value=this.currentEditingTemplate.data?.columns||"",o.templateReportIncludeCharts.checked=this.currentEditingTemplate.data?.includeCharts||!1),this.toggleTemplateFields(this.currentEditingTemplate.type)):(a.textContent="Novo Template",o.reset()),t.classList.add("active")):console.error("Elementos do modal de template n√£o encontrados")}toggleTemplateFields(e){const t=document.getElementById("templateProductFields"),o=document.getElementById("templateSaleFields"),a=document.getElementById("templateServiceFields"),s=document.getElementById("templateReportFields");t&&(t.style.display="product"===e?"block":"none"),o&&(o.style.display="sale"===e?"block":"none"),a&&(a.style.display="service"===e?"block":"none"),s&&(s.style.display="report"===e?"block":"none")}closeTemplateModal(){const e=document.getElementById("templateModal"),t=document.getElementById("templateForm");e&&e.classList.remove("active"),t&&t.reset(),this.currentEditingTemplate=null}saveTemplate(e){e&&e.preventDefault();const t=document.getElementById("templateForm");if(!t)return;const o=t.templateName.value.trim(),a=t.templateType.value,s=t.templateDescription.value.trim();if(!o)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe o nome do template.",3e3));if(!a)return void(void 0!==toast&&toast&&toast.warning("Por favor, selecione o tipo de template.",3e3));let n={};if("product"===a)n={category:t.templateCategory.value||"",price:parseFloat(t.templatePrice.value)||0};else if("sale"===a)n={quantity:parseInt(t.templateSaleQuantity.value)||1,discount:parseFloat(t.templateSaleDiscount.value)||0};else if("service"===a)n={hours:parseInt(t.templateServiceHours.value)||0,minutes:parseInt(t.templateServiceMinutes.value)||0};else if("report"===a){const e=t.templateReportType.value;if(!e)return void(void 0!==toast&&toast&&toast.warning("Por favor, selecione o tipo de relat√≥rio.",3e3));n={reportType:e,period:t.templateReportPeriod.value||"month",format:t.templateReportFormat.value||"pdf",columns:t.templateReportColumns.value.split(",").map(e=>e.trim()).filter(e=>e)||[],includeCharts:t.templateReportIncludeCharts.checked||!1}}const r={id:this.currentEditingTemplate?this.currentEditingTemplate.id:this.generateTemplateId(),name:o,type:a,description:s,data:n,createdAt:this.currentEditingTemplate?this.currentEditingTemplate.createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};if(this.currentEditingTemplate){const e=this.templates.findIndex(e=>e.id===this.currentEditingTemplate.id);-1!==e&&(this.templates[e]=r)}else this.templates.push(r);this.saveData(),this.renderTemplates(),this.closeTemplateModal(),this.logAction(this.currentEditingTemplate?"update":"create","template",r.id,r.name,{type:r.type}),void 0!==toast&&toast&&toast.success(this.currentEditingTemplate?"Template atualizado com sucesso!":"Template criado com sucesso!",3e3)}deleteTemplate(e){const t=this.templates.find(t=>t.id===e),o=t?t.name:"este template",a=t=>{t&&(this.templates=this.templates.filter(t=>t.id!==e),this.saveData(),this.renderTemplates(),this.logAction("delete","template",e,o),void 0!==toast&&toast&&toast.success(`Template "${o}" exclu√≠do com sucesso!`,3e3))};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir o template "${o}"? Esta a√ß√£o n√£o pode ser desfeita.`,"Excluir Template").then(a):confirm(`Tem certeza que deseja excluir o template "${o}"?`)&&a(!0)}renderTemplates(){const e=document.getElementById("templatesList");if(!e)return;if(0===this.templates.length&&!e.querySelector(".item-card"))return void this.showSkeleton("templatesList",6,!1);if(this.hideSkeleton("templatesList"),0===this.templates.length)return void(e.innerHTML='\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-file-alt"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum template cadastrado</h3>\n                    <p class="empty-state-message">\n                        Crie templates para agilizar o cadastro de produtos, vendas e servi√ßos frequentes.\n                    </p>\n                    <div class="empty-state-action">\n                        <button class="btn-primary" onclick="app.openTemplateModal()">\n                            <i class="fas fa-file-alt"></i> Criar Primeiro Template\n                        </button>\n                    </div>\n                </div>');const t={product:"Produto",sale:"Venda",service:"Servi√ßo",report:"Relat√≥rio"},o={product:"fa-box",sale:"fa-shopping-cart",service:"fa-tools",report:"fa-chart-bar"};e.innerHTML=this.templates.map(e=>{let a="";return"product"===e.type&&e.data?a=`<p><i class="fas fa-tag"></i> Categoria: ${e.data.category||"N/A"}</p>\n                               <p><i class="fas fa-dollar-sign"></i> Pre√ßo: R$ ${(e.data.price||0).toFixed(2).replace(".",",")}</p>`:"sale"===e.type&&e.data?a=`<p><i class="fas fa-shopping-bag"></i> Qtd. padr√£o: ${e.data.quantity||1}</p>\n                               <p><i class="fas fa-percent"></i> Desconto: ${(e.data.discount||0).toFixed(1)}%</p>`:"service"===e.type&&e.data?a=`<p><i class="fas fa-clock"></i> Dura√ß√£o: ${e.data.hours||0}h ${e.data.minutes||0}min</p>`:"report"===e.type&&e.data&&(a=`<p><i class="fas fa-chart-line"></i> Tipo: ${{sales:"Vendas",services:"Servi√ßos",products:"Produtos",clients:"Clientes",financial:"Financeiro",custom:"Personalizado"}[e.data.reportType]||e.data.reportType}</p>\n                               <p><i class="fas fa-calendar"></i> Per√≠odo: ${e.data.period||"Este M√™s"}</p>\n                               <p><i class="fas fa-file"></i> Formato: ${e.data.format?.toUpperCase()||"PDF"}</p>`),`\n                <div class="item-card">\n                    <div class="item-header">\n                        <div style="display: flex; align-items: center; gap: 0.5rem;">\n                            <i class="fas ${o[e.type]||"fa-file"}" style="color: var(--primary-color);"></i>\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                        </div>\n                        <div class="item-actions">\n                            <button class="btn-small btn-secondary" onclick="app.useTemplate('${e.id}')" title="Usar Template">\n                                <i class="fas fa-check"></i>\n                            </button>\n                            <button class="btn-small btn-edit" onclick="app.openTemplateModal('${e.id}')" title="Editar">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button class="btn-small btn-delete" onclick="app.deleteTemplate('${e.id}')" title="Excluir">\n                                <i class="fas fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="item-details">\n                        <p><i class="fas fa-file-alt"></i> Tipo: ${t[e.type]||e.type}</p>\n                        ${e.description?`<p><i class="fas fa-info-circle"></i> ${this.escapeHtml(e.description)}</p>`:""}\n                        ${a}\n                    </div>\n                </div>\n            `}).join("")}useTemplate(e){const t=this.templates.find(t=>t.id===e);if(t)if("product"===t.type)this.openItemModal(),setTimeout(()=>{t.data.category&&(document.getElementById("itemCategory").value=t.data.category,this.toggleCategoryFields()),t.data.price&&(document.getElementById("itemPrice").value=t.data.price),void 0!==toast&&toast&&toast.success(`Template "${t.name}" aplicado! Preencha os campos restantes.`,3e3)},100);else if("sale"===t.type){const e=document.getElementById("saleQuantity"),o=document.getElementById("saleDiscountValue"),a=document.getElementById("saleDiscountType");e&&t.data.quantity&&(e.value=t.data.quantity),o&&t.data.discount&&(o.value=t.data.discount,a&&(a.value="percent"),this.updateDiscountCalculation()),void 0!==toast&&toast&&toast.success(`Template "${t.name}" aplicado!`,3e3)}else if("service"===t.type){const e=document.getElementById("serviceRecordHours"),o=document.getElementById("serviceRecordMinutes");e&&void 0!==t.data.hours&&(e.value=t.data.hours),o&&void 0!==t.data.minutes&&(o.value=t.data.minutes),void 0!==toast&&toast&&toast.success(`Template "${t.name}" aplicado!`,3e3)}else if("report"===t.type){void 0!==toast&&toast&&toast.info(`Gerando relat√≥rio com template "${t.name}"...`,3e3),sessionStorage.setItem("reportTemplate",JSON.stringify(t.data));const e=document.querySelector('[data-tab="reports"]')||document.querySelector('button[onclick*="report"]')||document.querySelector('a[href*="report"]');e&&e.click(),setTimeout(()=>{void 0!==toast&&toast&&toast.success(`Template de relat√≥rio "${t.name}" aplicado! Configure o per√≠odo e gere o relat√≥rio.`,4e3)},500)}}generateTemplateId(){let e,t=0;do{e="TEMPLATE_"+Date.now()+"_"+Math.random().toString(36).substr(2,5).toUpperCase(),t++}while(this.templates.find(t=>t.id===e)&&t<10);return t>=10&&(e="TEMPLATE_"+Date.now()+"_"+Math.random().toString(36).substr(2,9).toUpperCase()),e}exportTemplates(){if(!this.checkPermission("export"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para exportar templates.",3e3):alert("Voc√™ n√£o tem permiss√£o para exportar templates."));if(0===this.templates.length)return void(void 0!==toast&&toast?toast.warning("N√£o h√° templates para exportar.",3e3):alert("N√£o h√° templates para exportar."));const e={templates:this.templates,version:"1.0",exportDate:(new Date).toISOString(),exportedBy:sessionStorage.getItem("username")||"unknown"},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=`templates_export_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),this.logAction("export","template",null,`Exporta√ß√£o de ${this.templates.length} template(s)`),void 0!==toast&&toast?toast.success(`${this.templates.length} template(s) exportado(s) com sucesso!`,3e3):alert(`${this.templates.length} template(s) exportado(s) com sucesso!`)}importTemplates(e){if(!this.checkPermission("import"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para importar templates.",3e3):alert("Voc√™ n√£o tem permiss√£o para importar templates."));const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=t=>{try{const o=JSON.parse(t.target.result);if(!o.templates||!Array.isArray(o.templates))return void(void 0!==toast&&toast?toast.error("Arquivo inv√°lido. O arquivo deve conter um array de templates.",3e3):alert("Arquivo inv√°lido. O arquivo deve conter um array de templates."));o.templates.length;let a=0,s=0;o.templates.forEach(e=>{if(!e.name||!e.type)return void s++;const t=this.templates.find(t=>t.name===e.name&&t.type===e.type);if(t)if(confirm(`Template "${e.name}" (${e.type}) j√° existe. Deseja substituir?`)){const o=this.templates.findIndex(e=>e.id===t.id);-1!==o&&(e.id=t.id,e.updatedAt=(new Date).toISOString(),this.templates[o]=e,a++)}else s++;else e.id=this.generateTemplateId(),e.createdAt=e.createdAt||(new Date).toISOString(),e.updatedAt=(new Date).toISOString(),this.templates.push(e),a++}),this.saveData(),this.renderTemplates(),this.logAction("import","template",null,`Importa√ß√£o de ${a} template(s)`),void 0!==toast&&toast?s>0?toast.success(`${a} template(s) importado(s), ${s} ignorado(s).`,4e3):toast.success(`${a} template(s) importado(s) com sucesso!`,3e3):alert(`${a} template(s) importado(s)${s>0?`, ${s} ignorado(s)`:""}.`),e.target.value=""}catch(t){console.error("Erro ao importar templates:",t),void 0!==toast&&toast?toast.error("Erro ao importar templates. Verifique se o arquivo est√° no formato correto.",4e3):alert("Erro ao importar templates. Verifique se o arquivo est√° no formato correto."),e.target.value=""}},o.onerror=()=>{void 0!==toast&&toast?toast.error("Erro ao ler o arquivo.",3e3):alert("Erro ao ler o arquivo."),e.target.value=""},o.readAsText(t)}onClientSelectChange(e){const t="sale"===e?"saleCustomerSelect":"pending"===e?"pendingOrderCustomerSelect":"appointmentCustomerSelect",o="sale"===e?"saleCustomerName":"pending"===e?"pendingOrderCustomerName":"appointmentCustomerName",a=document.getElementById(t),s=document.getElementById(o);if(a&&s)if(a.value){s.value=a.value;const t=this.clients.find(e=>e.name===a.value);if(t){const o=document.getElementById("sale"===e?"saleCustomerCPF":"pending"===e?"pendingOrderCustomerCPF":null);o&&t.cpf&&(o.value=t.cpf)}}else s.value=""}openGroupModal(){console.log("[MODAL] Abrindo groupModal");const e=document.getElementById("groupModal");e?(e.classList.remove("hidden"),e.classList.add("active"),e.style.display="flex",e.style.visibility="visible",e.style.opacity="1",e.style.pointerEvents="auto",document.body.style.overflow="hidden"):console.error("[MODAL] groupModal n√£o encontrado")}createGroup(e){e.preventDefault();const t=document.getElementById("groupMonth").value,o=sessionStorage.getItem("username");if(o&&t){const e=`estoque_${o}_${t}`;localStorage.getItem(e)||(localStorage.setItem(e,JSON.stringify({totalInicial:0,movimentacoes:[]})),console.log("[ESTOQUE] Criado estoque para o m√™s:",t))}if(this.groups.some(e=>e.month===t))return void toast.warning("J√° existe um grupo para este m√™s.",4e3);const a={id:Date.now().toString(),month:t,days:[]},[s,n]=t.split("-"),r=new Date(s,n,0).getDate();for(let e=1;e<=r;e++){const t={day:e,sales:[]};t.stock||(t.stock={}),a.days.push(t)}this.groups.push(a),this.groups.sort((e,t)=>t.month.localeCompare(e.month)),this.saveData(),this.renderGroups(),this.popularSelectMeses();const i=document.getElementById("mesSelecionado");i&&(i.value=t),this.carregarEstoqueDoMesSelecionado(),this.updateMonthFilter(),this.updateYearFilter(),this.closeGroupModal(),toast.success("Grupo mensal criado com sucesso!",3e3)}viewGroup(e){const t=this.groups.find(t=>t.id===e);if(!t)return;const o=document.getElementById("receiptPreviewModal");o&&o.classList.contains("active")&&this.closeReceiptPreview(),this.currentGroup=t;const a=document.getElementById("viewGroupModal");if(!a)return void console.error("‚ùå [VIEW GROUP] Modal n√£o encontrado!");const[s,n]=t.month.split("-");document.getElementById("groupTitle").textContent=`${["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(n)-1]} ${s}`,this.renderGroupView(t),console.log("üîß [VIEW GROUP] Restaurando z-index do viewGroupModal"),a.style.opacity="1",a.style.display="flex",a.style.setProperty("z-index","1000","important"),a.style.pointerEvents="auto";const r=a.querySelector(".close");r&&(r.style.pointerEvents="auto",r.style.opacity="1",r.style.zIndex="1001",r.style.position="relative");const i=a.querySelector(".modal-content");i&&(i.style.zIndex="",i.style.pointerEvents="auto"),a.querySelectorAll("button").forEach(e=>{e.style.pointerEvents="auto",e.style.opacity="1"}),requestAnimationFrame(()=>{a.classList.remove("hidden"),a.classList.add("active"),a.style.display="flex",a.style.opacity="1",a.style.visibility="visible",a.style.pointerEvents="auto"})}getSaleTotalValue(e){const t=e.price*e.quantity;return e.discount&&e.discount.amount?t-e.discount.amount:t}calculateTotalAllMonths(){let e=0,t=0;return this.groups.forEach(o=>{o.days.forEach(o=>{o.sales.forEach(o=>{e+=o.quantity,t+=this.getSaleTotalValue(o)})})}),{totalSales:e,totalValue:t}}renderGroupView(e){let t=0,o=0;const a={};e.days.forEach(e=>{e.sales.forEach(e=>{t+=e.quantity;const s=this.getSaleTotalValue(e);o+=s,a[e.itemId]||(a[e.itemId]={name:this.getItemName(e.itemId),quantity:0,total:0}),a[e.itemId].quantity+=e.quantity,a[e.itemId].total+=s})}),this.updateValueWithAnimation("totalSales",t),this.updateValueWithAnimation("totalValue",o,e=>`R$ ${e.toFixed(2).replace(".",",")}`);const s=this.calculateTotalAllMonths();this.updateValueWithAnimation("totalSalesAll",s.totalSales),this.updateValueWithAnimation("totalValueAll",s.totalValue,e=>`R$ ${e.toFixed(2).replace(".",",")}`),document.getElementById("daysList").innerHTML=e.days.map(t=>{const o=t.sales.reduce((e,t)=>e+t.quantity,0),a=t.sales.reduce((e,t)=>e+t.price*t.quantity,0);return`\n                <div class="day-card">\n                    <h4>Dia ${t.day}</h4>\n                    <div class="day-sales">${o} venda(s)</div>\n                    <div class="day-total">R$ ${a.toFixed(2).replace(".",",")}</div>\n                    <button class="btn-small btn-edit" style="margin-top: 0.5rem; width: 100%;" \n                            onclick="app.openSaleModal('${e.id}', ${t.day})">\n                        ${o>0?"Editar":"Registrar"}\n                    </button>\n                </div>\n            `}).join(""),this.updateGroupStockStats(e);const n=document.getElementById("itemsSummary"),r=Object.values(a);0===r.length?n.innerHTML='<div class="empty-state">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-shopping-cart"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhuma venda registrada</h3>\n                    <p class="empty-state-message">\n                        Comece registrando suas vendas para acompanhar o desempenho do neg√≥cio.\n                    </p>\n                </div>':n.innerHTML=r.map(e=>`\n                <div class="summary-item">\n                    <span class="summary-item-name">${this.escapeHtml(e.name)}</span>\n                    <span class="summary-item-total">\n                        ${e.quantity} un. - R$ ${e.total.toFixed(2).replace(".",",")}\n                    </span>\n                </div>\n            `).join("")}openSaleModal(e,t){const o=this.groups.find(t=>t.id===e);if(!o)return void console.error("‚ùå [SALE MODAL] Grupo n√£o encontrado:",e);this.currentGroup=o,this.currentSaleDay=t;const a=o.days.find(e=>e.day===t),s=document.getElementById("viewGroupModal"),n=document.getElementById("saleModal");if(!n)return void console.error("‚ùå [SALE MODAL] Modal de venda n√£o encontrado no DOM");s&&s.classList.contains("active")&&n?(n.classList.add("modal-overlay"),n.style.zIndex="1001"):(n.classList.remove("modal-overlay"),n.style.zIndex="");const r=document.getElementById("saleCustomerSelect");r&&(r.innerHTML='<option value="">Selecione um cliente ou digite novo nome...</option>'+this.clients.map(e=>`<option value="${this.escapeHtml(e.name)}">${this.escapeHtml(e.name)}${e.phone?` - ${this.escapeHtml(e.phone)}`:""}</option>`).join(""));const i=document.getElementById("saleItem");if(!i)return void console.error("‚ùå [SALE MODAL] saleItem n√£o encontrado!");i.innerHTML='<option value="">Selecione um item...</option>'+this.items.map(e=>{let t;if("Eletr√¥nicos"===(e.category||"Roupas"))t=e.model||e.name;else if(e.name)t=`${e.name} - ${e.brand||""}`;else{const o=[e.brand||""];e.style&&o.push(e.style),t=o.filter(e=>e).join(" - ")||"Roupa"}return`<option value="${e.id}">${this.escapeHtml(t)}</option>`}).join("");const c=document.getElementById("saleForm");c?c.reset():console.error("‚ùå [SALE MODAL] saleForm n√£o encontrado!");const l=document.getElementById("saleDayDisplay");if(l&&(l.textContent=t),this.updateSaleModalForItem(null),this.updateStockInfo(),a&&a.sales.length>0)this.showDaySales(a);else{const e=document.getElementById("daySalesList");e&&e.remove()}n?(n.style.display="flex",n.classList.contains("modal-overlay")&&(n.style.zIndex="1001"),requestAnimationFrame(()=>{if(n.classList.add("active"),n.classList.contains("modal-overlay")){n.style.zIndex="1001";const e=n.querySelector(".modal-content");e&&(e.style.zIndex="1002")}})):console.error("‚ùå [SALE MODAL] N√£o foi poss√≠vel abrir o modal - elemento n√£o encontrado")}getStockKey(e,t,o){const a=[e];return t&&t.trim()&&a.push(t.trim()),o&&o.trim()&&a.push(o.trim()),a.length>1?a.join("_"):e}updateSaleModalForItem(e){const t=e?this.items.find(t=>t.id===e):null,o=document.getElementById("scanQRBtn"),a=(document.getElementById("qrScannerContainer"),document.getElementById("serviceInfo")),s=document.getElementById("saleQuantityLabel"),n=document.getElementById("stockInfo"),r=document.getElementById("saleSizeGroup"),i=document.getElementById("saleSize"),c=document.getElementById("saleColorGroup"),l=document.getElementById("saleColor");if(!t)return o&&(o.style.display="inline-block"),a&&(a.style.display="none"),s&&(s.textContent="Quantidade *"),n&&(n.style.display="block"),r&&(r.style.display="none"),c&&(c.style.display="none"),i&&(i.required=!1,i.value=""),void(l&&(l.value=""));o&&(o.style.display="inline-block"),a&&(a.style.display="none"),s&&(s.textContent="Quantidade (unidades) *"),n&&(n.style.display="block");const d="Roupas"===t.category||"Eletr√¥nicos"===t.category,m="Roupas"===t.category||"Eletr√¥nicos"===t.category;r&&i&&(d?(r.style.display="block",i.required=!0,t.size?i.value=t.size:i.value=""):(r.style.display="none",i.required=!1,i.value="")),c&&l&&(m?(c.style.display="block",l.required=!1,t.color?l.value=t.color:l.value=""):(c.style.display="none",l.value=""))}updateStockInfo(){if(!this.currentGroup||!this.currentSaleDay)return;const e=document.getElementById("saleItem").value,t=document.getElementById("stockInfo"),o=document.getElementById("saleSize"),a=document.getElementById("saleColor");if(!e||!t)return;const s=this.items.find(t=>t.id===e);if(s&&"Servi√ßos"===s.category)return t.textContent="Servi√ßo - N√£o possui estoque f√≠sico.",void(t.style.color="#6c757d");const n=this.currentGroup.days.find(e=>e.day===this.currentSaleDay);if(!n)return;n.stock||(n.stock={});const r=o&&o.value?o.value.trim():"",i=a&&a.value?a.value.trim():"",c=this.getStockKey(e,r,i),l=n.stock[c]||0,d=n.sales.filter(t=>{if(s&&("Roupas"===s.category||"Eletr√¥nicos"===s.category)){const e=t.size||"",o=t.color||"";return this.getStockKey(t.itemId,e,o)===c}return t.itemId===e}).reduce((e,t)=>e+t.quantity,0),m=l-d;let u="";if(!s||"Roupas"!==s.category&&"Eletr√¥nicos"!==s.category)u=`Estoque dispon√≠vel: ${m} un. (Total: ${l} un. - Vendido: ${d} un.)`;else{let e=[];r&&e.push(`Tamanho: ${r}`),i&&e.push(`Cor: ${i}`),u=e.length>0?`Estoque dispon√≠vel (${e.join(", ")}): ${m} un. (Total: ${l} un. - Vendido: ${d} un.)`:`Estoque dispon√≠vel: ${m} un. (Total: ${l} un. - Vendido: ${d} un.)`}l>0?(t.textContent=u,m<0?(t.style.color="#dc3545",t.textContent+=" ‚ö†Ô∏è Estoque negativo!"):t.style.color=0===m?"#ffc107":"#28a745"):(t.textContent="Nenhum estoque cadastrado para este item neste dia.",t.style.color="#6c757d")}showDaySales(e){const t=document.getElementById("daySalesList");t&&t.remove();const o=document.createElement("div");o.id="daySalesList",o.style.marginBottom="1.5rem",o.style.padding="1rem",o.style.background="var(--light-gray)",o.style.borderRadius="8px",o.style.border="2px solid var(--border-color)",o.innerHTML=`\n            <h4 style="color: var(--primary-red); margin-bottom: 1rem;">Vendas do Dia ${e.day}</h4>\n            ${e.sales.map((e,t)=>{const o=this.items.find(t=>t.id===e.itemId);return`\n                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 5px; border: 1px solid var(--border-color);">\n                        <div>\n                            <strong>${this.escapeHtml(o?o.name:"Item n√£o encontrado")}</strong>${e.size||e.color?` <span style="color: var(--primary-color); font-weight: 600;">(${e.size?`Tamanho: ${this.escapeHtml(e.size)}`:""}${e.size&&e.color?", ":""}${e.color?`Cor: ${this.escapeHtml(e.color)}`:""})</span>`:""}<br>\n                            <small style="color: var(--gray);">${e.quantity} un. √ó R$ ${e.price.toFixed(2).replace(".",",")} = R$ ${(e.quantity*e.price).toFixed(2).replace(".",",")}</small>\n                        </div>\n                        <button class="btn-small btn-delete" onclick="app.deleteSale(${this.currentSaleDay}, ${t})" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                `}).join("")}\n        `;const a=document.getElementById("saleForm");a&&a.parentNode?a.parentNode.insertBefore(o,a):console.error("‚ùå [SHOW DAY SALES] saleForm n√£o encontrado!")}deleteSale(e,t){const o=this.groups.find(e=>e.id===this.currentGroup.id);if(!o)return;const a=o.days.find(t=>t.day===e);if(a&&a.sales[t]){const s=s=>{if(!s)return;a.sales.splice(t,1),this.currentGroup=o,this.saveData(),this.renderGroupView(o);const n=document.getElementById("groupsTab");n&&n.classList.contains("active")&&this.renderGroups(),this.updateOverallSummary(),this.openSaleModal(o.id,e),void 0!==toast&&toast&&toast.success("Venda exclu√≠da com sucesso!",3e3)};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger("Deseja excluir esta venda?","Excluir Venda").then(s):confirm("Deseja excluir esta venda?")&&s(!0)}}closeSaleModal(){this.stopQRScanner();const e=document.getElementById("saleModal");e&&(e.classList.remove("modal-overlay"),e.style.zIndex="",e.style.opacity="0",setTimeout(()=>{e.classList.remove("active"),e.style.display="none",e.style.opacity=""},300));const t=document.getElementById("discountFields"),o=document.getElementById("discountSummary"),a=document.getElementById("toggleDiscountBtn");t&&(t.style.display="none"),o&&(o.style.display="none"),a&&(a.innerHTML='<i class="fas fa-plus"></i> Aplicar');const s=document.getElementById("saleDiscountType"),n=document.getElementById("saleDiscountValue"),r=document.getElementById("saleCouponCode");s&&(s.value=""),n&&(n.value=""),r&&(r.value="");const i=document.getElementById("viewGroupModal");if(i&&i.classList.contains("active")&&this.currentGroup){const e=this.groups.find(e=>e.id===this.currentGroup.id);e&&(this.currentGroup=e,this.renderGroupView(e))}const c=document.getElementById("groupsTab");c&&c.classList.contains("active")&&this.renderGroups(),this.currentSaleDay=null}saveSale(e){if(e.preventDefault(),!this.currentGroup||!this.currentSaleDay)return;const t=e.target.querySelector('button[type="submit"]')||document.querySelector('#saleForm button[type="submit"]');t&&(t.classList.add("loading"),t.disabled=!0);const o=document.getElementById("saleItem"),a=document.getElementById("saleQuantity"),s=document.getElementById("salePrice");if(!o||!a||!s)return console.error("‚ùå [SAVE SALE] Elementos do formul√°rio n√£o encontrados!"),toast.error("Erro: Formul√°rio incompleto. Por favor, recarregue a p√°gina.",5e3),void(t&&(t.classList.remove("loading"),t.disabled=!1));const n=o.value,r=parseInt(a.value),i=this.parsePrice(s.value),c=document.getElementById("saleSize"),l=document.getElementById("saleColor"),d=c&&c.value?c.value.trim():"",m=l&&l.value?l.value.trim():"",u=this.calculateDiscount(i,r),p=i;if(!n)return void 0!==toast&&toast?toast.warning("Por favor, selecione um item.",3e3):alert("Por favor, selecione um item."),void(t&&(t.classList.remove("loading"),t.disabled=!1));if(p<=0||r<=0)return void 0!==toast&&toast?toast.warning("Pre√ßo e quantidade devem ser maiores que zero.",3e3):alert("Pre√ßo e quantidade devem ser maiores que zero."),void(t&&(t.classList.remove("loading"),t.disabled=!1));const g=this.groups.find(e=>e.id===this.currentGroup.id);if(!g)return void(t&&(t.classList.remove("loading"),t.disabled=!1));const h=g.days.find(e=>e.day===this.currentSaleDay);if(!h)return void(t&&(t.classList.remove("loading"),t.disabled=!1));const v=this.items.find(e=>e.id===n),y=v&&"Servi√ßos"===v.category;if(v&&("Roupas"===v.category||"Eletr√¥nicos"===v.category)&&!d)return toast.warning(`Por favor, informe o tamanho do ${"Roupas"===v.category?"roupa":"eletr√¥nico"}.`,3e3),void(t&&(t.classList.remove("loading"),t.disabled=!1));if(!y){h.stock||(h.stock={});const e=this.getStockKey(n,d,m),o=h.stock[e]||0,a=h.sales.filter(t=>{if(v&&("Roupas"===v.category||"Eletr√¥nicos"===v.category)){const o=t.size||"",a=t.color||"";return this.getStockKey(t.itemId,o,a)===e}return t.itemId===n}).reduce((e,t)=>e+t.quantity,0),s=o-a;if(o>0&&r>s&&!confirm(`Aten√ß√£o! Estoque dispon√≠vel: ${s} un. Deseja registrar ${r} un. mesmo assim?`))return void(t&&(t.classList.remove("loading"),t.disabled=!1))}const f=this.formatText(document.getElementById("saleCustomerName").value),E=document.getElementById("saleCustomerCPF").value.trim().replace(/\D/g,"");if(!f)return toast.warning("Por favor, informe o nome do cliente.",3e3),void(t&&(t.classList.remove("loading"),t.disabled=!1));const b=i*r;let S=0,C=0;const w=this.clients.find(e=>e.name===f);if(w&&w.loyaltyPoints>0){const e=this.calculateLoyaltyDiscount(f,b);S=e.discount,C=e.pointsUsed}const I=u.discount+S,T={itemId:n,quantity:r,price:i,basePrice:i,discount:I>0?{type:u.discountType||"loyalty",value:u.discountValue||S,amount:I,couponCode:u.couponCode||null,loyaltyDiscount:S,loyaltyPointsUsed:C}:null};!v||"Roupas"!==v.category&&"Eletr√¥nicos"!==v.category||(d&&(T.size=d),m&&(T.color=m)),h.sales.push(T);const A=this.generateOrderCode(),$=v?this.getItemName(n):"Item n√£o encontrado",k=I>0?b-I:b,B=new Date,D=document.getElementById("saleNotes"),x=D&&D.value?D.value.trim():null,M={id:Date.now().toString()+Math.random().toString(36).substr(2,9),orderCode:A,customerName:f,customerCPF:E||null,items:[{itemId:n,name:$,quantity:r,price:i,size:v&&("Roupas"===v.category||"Eletr√¥nicos"===v.category)&&d?d:void 0,color:v&&("Roupas"===v.category||"Eletr√¥nicos"===v.category)&&m?m:void 0}],totalValue:k,discount:T.discount,notes:x,date:B.toISOString(),timestamp:B.getTime(),groupId:g.id,groupMonth:g.month,day:this.currentSaleDay};if(this.completedSales.push(M),M.discount&&M.discount.couponCode){const e=this.coupons.find(e=>e.code===M.discount.couponCode);e&&(e.uses=(e.uses||0)+1,this.saveData(),this.renderCoupons())}if(window.currentSaleCouponCode&&delete window.currentSaleCouponCode,w)C>0&&w.loyaltyPoints>=C&&(w.loyaltyPoints-=C),this.addLoyaltyPoints(f,k),w.receiveNotifications&&this.createClientNotification(w.id,"Nova Compra Registrada",`Sua compra de R$ ${k.toFixed(2).replace(".",",")} foi registrada com sucesso!${C>0?` Voc√™ usou ${C} ponto(s) de fidelidade.`:""}`,"success");else if(f){const e={id:Date.now().toString(),name:f,cpf:E||"",loyaltyPoints:Math.floor(k/10),receiveNotifications:!1,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.clients.push(e),void 0!==toast&&toast&&toast.info(`Cliente "${f}" foi cadastrado automaticamente e ganhou ${e.loyaltyPoints} ponto(s)!`,4e3)}this.currentGroup=g,this.saveData(),this.renderLastReceiptsCarousel();const L=document.getElementById("viewGroupModal");if(L&&L.classList.contains("active")){console.log("üîß [SAVE SALE] viewGroupModal est√° ativo, reduzindo z-index antes de mostrar recibo"),L.style.setProperty("z-index","999","important"),L.style.pointerEvents="none",L.style.opacity="0.3";const e=L.querySelector(".modal-content");e&&e.style.setProperty("z-index","999","important")}this.closeSaleModal(),setTimeout(()=>{console.log("üîß [SAVE SALE] Mostrando preview de recibo"),this.showReceiptPreview(M)},150);const R=document.getElementById("groupsTab");R&&R.classList.contains("active")&&this.renderGroups(),this.updateOverallSummary(),t&&setTimeout(()=>{t.classList.remove("loading"),t.disabled=!1},300)}generateOrderCode(){const e=new Date;return`PED-${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}-${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}showReceiptPreview(e){try{if(!e)return void console.error("‚ùå [SHOW RECEIPT] Sale n√£o fornecido");if(!document.getElementById("receiptPreviewModal"))try{this.createReceiptPreviewModal()}catch(e){return void console.error("‚ùå [SHOW RECEIPT] Erro ao criar modal:",e)}const t=document.getElementById("receiptPreviewModal"),o=document.getElementById("receiptContent");if(!o||!t)return void console.error("‚ùå [SHOW RECEIPT] Elementos do modal n√£o encontrados");try{const e=document.getElementById("viewGroupModal");e&&e.classList.contains("active")&&(e.dataset.wasActive="true",console.log("üîß [SHOW RECEIPT] viewGroupModal estava ativo - salvando estado"))}catch(e){console.error("‚ùå [SHOW RECEIPT] Erro ao salvar estado do viewGroupModal:",e)}t.style.display="flex",t.style.zIndex="1003";const a=new Date(e.date).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});o.innerHTML=`\n            <div class="receipt-header">\n                <h2>Recibo de Venda</h2>\n                <p class="receipt-order-code">C√≥digo: ${this.escapeHtml(e.orderCode)}</p>\n            </div>\n            <div class="receipt-info">\n                <div class="receipt-section">\n                    <h3>Dados do Cliente</h3>\n                    <p><strong>Nome:</strong> ${this.escapeHtml(e.customerName)}</p>\n                    ${e.customerCPF?`<p><strong>CPF:</strong> ${this.formatCPF(e.customerCPF)}</p>`:""}\n                </div>\n                <div class="receipt-section">\n                    <h3>Data e Hor√°rio</h3>\n                    <p>${a}</p>\n                </div>\n                <div class="receipt-section">\n                    <h3>Itens Comprados</h3>\n                    <div class="receipt-items">\n                        ${e.items.map(e=>`\n                            <div class="receipt-item">\n                                <div class="receipt-item-name">${this.escapeHtml(e.name)}</div>\n                                <div class="receipt-item-details">\n                                    ${e.quantity} un. √ó R$ ${e.price.toFixed(2).replace(".",",")} = \n                                    <strong>R$ ${(e.quantity*e.price).toFixed(2).replace(".",",")}</strong>\n                                </div>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n                <div class="receipt-total">\n                    <h3>Valor Total</h3>\n                    <p class="receipt-total-value">R$ ${e.totalValue.toFixed(2).replace(".",",")}</p>\n                </div>\n            </div>\n        `,t.parentNode!==document.body&&document.body.appendChild(t);const s=document.getElementById("viewGroupModal");if(s&&s.classList.contains("active")){console.log("üîß [RECEIPT] Reduzindo z-index do viewGroupModal"),s.style.setProperty("z-index","999","important"),s.style.pointerEvents="none",s.style.opacity="0.3";const e=s.querySelector(".modal-content");e&&e.style.setProperty("z-index","999","important")}console.log("üîß [RECEIPT] Configurando z-index do receiptPreviewModal"),t.style.setProperty("z-index","10000","important"),t.style.display="flex",t.style.pointerEvents="auto",t.style.opacity="1",t.style.position="fixed",requestAnimationFrame(()=>{t.classList.add("active");const e=t.querySelector(".modal-content");e&&(e.style.setProperty("z-index","10001","important"),e.style.pointerEvents="auto",e.style.position="relative"),setTimeout(()=>{console.log("üîß [RECEIPT] For√ßando z-index novamente ap√≥s anima√ß√£o"),t.style.setProperty("z-index","10000","important"),t.style.position="fixed",e&&e.style.setProperty("z-index","10001","important"),s&&s.classList.contains("active")&&s.style.setProperty("z-index","999","important")},100)})}catch(t){console.error("‚ùå [SHOW RECEIPT] Erro cr√≠tico ao mostrar recibo:",t),console.error("‚ùå [SHOW RECEIPT] Stack:",t.stack),console.error("‚ùå [SHOW RECEIPT] Sale:",e);const o=document.getElementById("receiptPreviewModal");o&&(o.style.display="none",o.classList.remove("active"))}}createReceiptPreviewModal(){const e=document.createElement("div");e.id="receiptPreviewModal",e.className="modal",e.innerHTML='\n            <div class="modal-content" style="max-width: 500px;">\n                <div class="modal-header">\n                    <h2>Recibo de Venda</h2>\n                    <span class="close" aria-label="Fechar modal" role="button" tabindex="0">&times;</span>\n                </div>\n                <div id="receiptContent" class="receipt-content">\n                    \x3c!-- Conte√∫do do recibo ser√° inserido aqui --\x3e\n                </div>\n                <div class="modal-actions">\n                    <button type="button" class="btn-secondary" id="closeReceiptBtn">\n                        Fechar\n                    </button>\n                    <button type="button" class="btn-primary" id="printReceiptBtn">\n                        <i class="fas fa-print"></i> Imprimir\n                    </button>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=document.getElementById("closeReceiptBtn"),o=document.getElementById("printReceiptBtn"),a=e.querySelector(".close");t&&t.addEventListener("click",()=>this.closeReceiptPreview()),o&&o.addEventListener("click",()=>this.printReceipt()),a&&a.addEventListener("click",()=>this.closeReceiptPreview())}closeReceiptPreview(){try{const e=document.getElementById("receiptPreviewModal");if(!e)return void console.warn("‚ö†Ô∏è [CLOSE RECEIPT] Modal n√£o encontrado");console.log("üîß [CLOSE RECEIPT] Fechando modal de recibo"),e.style.opacity="0",e.style.pointerEvents="none";try{const e=document.getElementById("viewGroupModal");if(e&&"true"===e.dataset.wasActive){console.log("üîß [CLOSE RECEIPT] Restaurando viewGroupModal (estava ativo antes do recibo)"),e.style.setProperty("z-index","1000","important"),e.style.pointerEvents="auto",e.style.opacity="1",e.style.display="flex",delete e.dataset.wasActive;const t=e.querySelector(".modal-content");t&&(t.style.zIndex="",t.style.pointerEvents="auto"),e.querySelectorAll("button").forEach(e=>{e.style.pointerEvents="auto",e.style.opacity="1",e.disabled=!1})}else console.log("üîß [CLOSE RECEIPT] viewGroupModal n√£o estava ativo antes - n√£o restaurar")}catch(e){console.error("‚ùå [CLOSE RECEIPT] Erro ao restaurar viewGroupModal:",e)}setTimeout(()=>{try{e.classList.remove("active"),e.style.display="none",e.style.opacity="",e.style.zIndex="",e.style.pointerEvents="",e.style.position="";const t=e.querySelector(".modal-content");t&&(t.style.zIndex="")}catch(e){console.error("‚ùå [CLOSE RECEIPT] Erro ao limpar modal:",e)}},300)}catch(e){console.error("‚ùå [CLOSE RECEIPT] Erro cr√≠tico ao fechar recibo:",e),console.error("‚ùå [CLOSE RECEIPT] Stack:",e.stack);const t=document.getElementById("receiptPreviewModal");t&&(t.style.display="none",t.classList.remove("active"))}}printReceipt(){const e=document.getElementById("receiptContent");if(!e)return;const t=window.open("","_blank");t.document.write(`\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <title>Recibo de Venda</title>\n                <style>\n                    body { font-family: Arial, sans-serif; padding: 20px; }\n                    .receipt-header { text-align: center; margin-bottom: 20px; }\n                    .receipt-section { margin-bottom: 15px; }\n                    .receipt-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }\n                    .receipt-total { margin-top: 20px; padding-top: 15px; border-top: 2px solid #000; text-align: right; }\n                    .receipt-total-value { font-size: 1.5em; font-weight: bold; }\n                </style>\n            </head>\n            <body>\n                ${e.innerHTML}\n            </body>\n            </html>\n        `),t.document.close(),t.print()}formatCPF(e){const t=e.replace(/\D/g,"");return 11!==t.length?e:t.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4")}openReceiptSearchModal(){const e=document.getElementById("receiptSearchModal");if(!e)return;e.classList.add("active");const t=document.getElementById("receiptSearchName"),o=document.getElementById("receiptSearchCPF");t&&(t.value=""),o&&(o.value=""),this.searchReceipts()}closeReceiptSearchModal(){const e=document.getElementById("receiptSearchModal");e&&e.classList.remove("active")}renderReceiptCarousel(){const e=document.getElementById("receiptCarousel");e&&this.renderLastReceiptsCarousel(e)}renderLastReceiptsCarousel(e=null){const t=!0===window.TEST_MODE,o=!0===window.SUPPRESS_UI_WARNINGS;if(t)return;const a=e||document.getElementById("lastReceiptsCarousel");if(!a)return o||console.warn("‚ö†Ô∏è [CARROSSEL] Container do carrossel n√£o encontrado. Tentando novamente em 500ms..."),void setTimeout(()=>{const e=document.getElementById("lastReceiptsCarousel");e?this.renderLastReceiptsCarousel(e):o||console.error("‚ùå [CARROSSEL] Container n√£o encontrado ap√≥s retry")},500);console.log(`üìä [CARROSSEL] Total de comprovantes: ${this.completedSales.length}`),console.log("üìä [CARROSSEL] Array completedSales:",this.completedSales),this.completedSales.length>0?console.log("üìã [CARROSSEL] Primeiros 3 comprovantes:",this.completedSales.slice(0,3).map(e=>({id:e.id,name:e.customerName,date:e.date,total:e.totalValue}))):console.warn("‚ö†Ô∏è [CARROSSEL] Nenhum comprovante encontrado no array completedSales");const s=[...this.completedSales].sort((e,t)=>{const o=e.timestamp||new Date(e.date).getTime();return(t.timestamp||new Date(t.date).getTime())-o}).slice(0,3);if(console.log(`üéØ [CARROSSEL] Renderizando ${s.length} comprovantes`),0!==s.length)try{a.innerHTML=s.map((e,t)=>{let o="Data inv√°lida";try{const t=new Date(e.date);isNaN(t.getTime())||(o=t.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}))}catch(t){console.error("‚ùå [CARROSSEL] Erro ao formatar data:",t,e)}return e.customerName&&e.totalValue?`\n                <div class="receipt-mini-card" \n                     style="\n                         flex: 0 0 auto;\n                         width: 280px; \n                         min-width: 280px;\n                         max-width: 280px;\n                         background: var(--white); \n                         border: 1px solid var(--gray-300); \n                         border-radius: var(--radius-md); \n                         padding: 1.25rem; \n                         box-shadow: var(--shadow-sm);\n                         cursor: pointer;\n                         transition: all var(--transition-base);\n                         animation: slideInUp 0.3s ease-out ${.1*t}s both;\n                     "\n                     onclick="app.viewFullReceipt('${e.id}')"\n                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary-color)';"\n                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'; this.style.borderColor='var(--gray-300)';">\n                    <div style="margin-bottom: 0.75rem;">\n                        <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-gray); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n                            ${this.escapeHtml(e.customerName)}\n                        </h4>\n                        <p style="margin: 0; color: var(--gray-600); font-size: 0.85rem;">\n                            üìÖ ${o}\n                        </p>\n                        ${e.customerCPF?`<p style="margin: 0.25rem 0 0 0; color: var(--gray-500); font-size: 0.8rem;">\n                                    üÜî ${this.formatCPF(e.customerCPF)}\n                                </p>`:""}\n                    </div>\n                    <div style="border-top: 1px solid var(--gray-200); padding-top: 0.75rem;">\n                        <p style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 1.2rem;">\n                            R$ ${e.totalValue.toFixed(2).replace(".",",")}\n                        </p>\n                        <p style="margin: 0.25rem 0 0 0; color: var(--gray-500); font-size: 0.75rem;">\n                            ${e.items.length} ${1===e.items.length?"item":"itens"}\n                        </p>\n                    </div>\n                </div>\n            `:(console.error("‚ùå [CARROSSEL] Dados incompletos no comprovante:",e),"")}).filter(e=>""!==e).join(""),setTimeout(()=>{this.setupReceiptCarouselDrag(a)},100)}catch(e){console.error("‚ùå [CARROSSEL] Erro ao renderizar carrossel:",e),a.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem; width: 100%;">Erro ao carregar comprovantes.</p>'}else a.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem; width: 100%;">Nenhum comprovante encontrado.</p>'}searchReceipts(){const e=document.getElementById("receiptSearchName"),t=document.getElementById("receiptSearchCPF"),o=document.getElementById("receiptResultsList");if(!e||!t||!o)return;const a=e.value.toLowerCase().trim(),s=t.value.replace(/\D/g,"").trim();let n=[...this.completedSales];a&&(n=n.filter(e=>!!e.customerName&&e.customerName.toLowerCase().includes(a))),s&&(n=n.filter(e=>!!e.customerCPF&&e.customerCPF.replace(/\D/g,"").includes(s))),n.sort((e,t)=>{const o=e.timestamp||new Date(e.date).getTime();return(t.timestamp||new Date(t.date).getTime())-o}),0!==n.length?o.innerHTML=n.map((e,t)=>{const o=new Date(e.date).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});return`\n                <div class="receipt-result-card" \n                     style="\n                         background: var(--white); \n                         border: 1px solid var(--gray-300); \n                         border-radius: var(--radius-md); \n                         padding: 1.25rem; \n                         margin-bottom: 1rem;\n                         box-shadow: var(--shadow-sm);\n                         cursor: pointer;\n                         transition: all var(--transition-base);\n                         animation: slideInLeft 0.3s ease-out ${.05*t}s both;\n                     "\n                     onclick="app.viewFullReceipt('${e.id}')"\n                     onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary-color)';"\n                     onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='var(--shadow-sm)'; this.style.borderColor='var(--gray-300)';">\n                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">\n                        <div style="flex: 1;">\n                            <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-gray); font-size: 1rem;">\n                                ${this.escapeHtml(e.customerName)}\n                            </h4>\n                            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">\n                                üìÖ ${o}\n                            </p>\n                            ${e.customerCPF?`\n                                <p style="margin: 0.25rem 0 0 0; color: var(--gray-600); font-size: 0.85rem;">\n                                    üÜî ${this.formatCPF(e.customerCPF)}\n                                </p>\n                            `:""}\n                        </div>\n                        <div style="text-align: right;">\n                            <p style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 1.2rem;">\n                                R$ ${e.totalValue.toFixed(2).replace(".",",")}\n                            </p>\n                            <p style="margin: 0.25rem 0 0 0; color: var(--gray-500); font-size: 0.85rem;">\n                                C√≥digo: ${this.escapeHtml(e.orderCode)}\n                            </p>\n                        </div>\n                    </div>\n                    <div style="border-top: 1px solid var(--gray-200); padding-top: 0.75rem;">\n                        <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">\n                            <strong>Itens:</strong> ${e.items.map(e=>`${e.quantity}x ${this.escapeHtml(e.name)}`).join(", ")}\n                        </p>\n                    </div>\n                </div>\n            `}).join(""):o.innerHTML='\n                <div style="text-align: center; padding: 3rem; color: var(--gray-600);">\n                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>\n                    <p style="margin: 0;">Nenhum comprovante encontrado.</p>\n                </div>\n            '}viewFullReceipt(e){const t=this.completedSales.find(t=>t.id===e);t?(this.closeReceiptSearchModal(),this.showReceiptPreview(t)):this.showError("Comprovante n√£o encontrado.")}setupReceiptCarouselDrag(e=null){const t=e||document.getElementById("lastReceiptsCarousel");if(!t)return;if("true"===t.dataset.dragSetup)return;t.dataset.dragSetup="true";let o,a,s=!1,n=!1;t.addEventListener("mousedown",e=>{n=!1,s=!0,t.style.cursor="grabbing",o=e.pageX-t.offsetLeft,a=t.scrollLeft}),t.addEventListener("mouseleave",()=>{s=!1,t.style.cursor="grab"}),t.addEventListener("mouseup",e=>{if(s&&!n){const t=e.target.closest(".receipt-mini-card");t&&t.onclick&&setTimeout(()=>{const e=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(e)},10)}s=!1,n=!1,t.style.cursor="grab"}),t.addEventListener("mousemove",e=>{if(s&&Math.abs(e.pageX-o-t.offsetLeft)>5){n=!0,e.preventDefault();const s=2*(e.pageX-t.offsetLeft-o);t.scrollLeft=a-s}});let r=0,i=0,c=0,l=!1;t.addEventListener("touchstart",e=>{r=e.touches[0].pageX-t.offsetLeft,i=t.scrollLeft,c=Date.now(),l=!1},{passive:!0}),t.addEventListener("touchmove",e=>{if(!r)return;const o=2*(e.touches[0].pageX-t.offsetLeft-r);Math.abs(o)>5&&(l=!0),t.scrollLeft=i-o},{passive:!0}),t.addEventListener("touchend",e=>{const t=Date.now()-c;if(!l&&t<300){const t=e.changedTouches[0],o=document.elementFromPoint(t.clientX,t.clientY),a=o?.closest(".receipt-mini-card");a&&a.onclick&&setTimeout(()=>a.click(),10)}r=0,l=!1})}formatCPFInput(e){let t=e.value.replace(/\D/g,"");t.length>11&&(t=t.slice(0,11)),t.length>0?t.length<=3?e.value=t:t.length<=6?e.value=t.replace(/(\d{3})(\d+)/,"$1.$2"):t.length<=9?e.value=t.replace(/(\d{3})(\d{3})(\d+)/,"$1.$2.$3"):e.value=t.replace(/(\d{3})(\d{3})(\d{3})(\d+)/,"$1.$2.$3-$4"):e.value=""}openPendingOrderModal(e=null){const t=document.getElementById("pendingOrderModal");if(!t)return void console.error("Modal de pedido pendente n√£o encontrado");const o=document.getElementById("pendingOrderForm"),a=document.getElementById("pendingOrderModalTitle"),s=document.getElementById("pendingOrderItemsList"),n=document.getElementById("pendingOrderTotal");a&&(a.textContent=e?"Editar Pedido Pendente":"Novo Pedido Pendente"),o&&(o.reset(),s&&(s.innerHTML="")),e?(document.getElementById("pendingOrderCustomerName").value=e.customerName||"",document.getElementById("pendingOrderCustomerCPF").value=e.customerCPF?this.formatCPF(e.customerCPF):"",document.getElementById("pendingOrderStatus").value=e.status||"pending",document.getElementById("pendingOrderDueDate").value=e.dueDate||"",e.items&&s&&e.items.forEach((e,t)=>{this.addPendingOrderItemRow(e,t)}),n&&(n.value=e.totalValue||0),this.currentEditingPendingOrder=e.id):(this.currentEditingPendingOrder=null,s&&this.addPendingOrderItemRow(),n&&(n.value="0.00"));const r=document.getElementById("pendingOrderCustomerCPF");r&&r.addEventListener("input",()=>this.formatCPFInput(r)),t.classList.add("active")}addPendingOrderItemRow(e=null,t=null){const o=document.getElementById("pendingOrderItemsList");if(!o)return;null!==t||o.children.length;const a=document.createElement("div");a.className="pending-order-item-row",a.style.cssText="display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 0.5rem;";const s=document.createElement("select");s.required=!0,s.style.cssText="flex: 2;",s.innerHTML='<option value="">Selecione um item...</option>',this.items.filter(e=>"Servi√ßos"!==e.category).forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=this.getItemName(t.id),e&&e.itemId===t.id&&(o.selected=!0),s.appendChild(o)});const n=document.createElement("input");n.type="number",n.min="1",n.required=!0,n.placeholder="Qtd",n.style.cssText="flex: 1; max-width: 80px;",e&&(n.value=e.quantity||1);const r=document.createElement("input");r.type="number",r.step="0.01",r.min="0.01",r.required=!0,r.placeholder="Pre√ßo",r.style.cssText="flex: 1; max-width: 100px;",e&&(r.value=e.price||0);const i=document.createElement("button");i.type="button",i.className="btn-secondary",i.innerHTML='<i class="fas fa-times"></i>',i.style.cssText="min-width: 36px; padding: 0.5rem;",i.onclick=()=>{a.remove(),this.updatePendingOrderTotal()},[s,n,r].forEach(e=>{e.addEventListener("change",()=>this.updatePendingOrderTotal())}),a.appendChild(s),a.appendChild(n),a.appendChild(r),a.appendChild(i),o.appendChild(a)}updatePendingOrderTotal(){const e=document.getElementById("pendingOrderItemsList"),t=document.getElementById("pendingOrderTotal");if(!e||!t)return;let o=0;e.querySelectorAll(".pending-order-item-row").forEach(e=>{const t=parseFloat(e.querySelector('input[type="number"]:nth-of-type(1)').value)||0,a=parseFloat(e.querySelector('input[type="number"]:nth-of-type(2)').value)||0;o+=t*a}),t.value=o.toFixed(2)}savePendingOrder(e){e.preventDefault();const t=this.formatText(document.getElementById("pendingOrderCustomerName").value),o=document.getElementById("pendingOrderCustomerCPF").value.replace(/\D/g,""),a=document.getElementById("pendingOrderStatus").value,s=document.getElementById("pendingOrderDueDate").value,n=document.getElementById("pendingOrderItemsList"),r=document.getElementById("pendingOrderTotal");if(!t)return void toast.warning("Por favor, informe o nome do cliente.",3e3);const i=[];if(n.querySelectorAll(".pending-order-item-row").forEach(e=>{const t=e.querySelector("select").value,o=parseInt(e.querySelector('input[type="number"]:nth-of-type(1)').value)||0,a=parseFloat(e.querySelector('input[type="number"]:nth-of-type(2)').value)||0;if(t&&o>0&&a>0){const e=this.items.find(e=>e.id===t);i.push({itemId:t,name:e?this.getItemName(t):"Item n√£o encontrado",quantity:o,price:a})}}),0===i.length)return void alert("Por favor, adicione pelo menos um item.");const c=parseFloat(r.value)||0,l={id:this.currentEditingPendingOrder||Date.now().toString()+Math.random().toString(36).substr(2,9),customerName:t,customerCPF:o||null,items:i,totalValue:c,status:a,dueDate:s||null,createdAt:this.currentEditingPendingOrder&&this.pendingOrders.find(e=>e.id===this.currentEditingPendingOrder)?.createdAt||(new Date).toISOString(),updatedAt:(new Date).toISOString()};if(this.currentEditingPendingOrder){const e=this.pendingOrders.findIndex(e=>e.id===this.currentEditingPendingOrder);-1!==e&&(this.pendingOrders[e]=l)}else this.pendingOrders.push(l);this.saveData(),this.renderPendingOrders(),this.closePendingOrderModal(),this.showSuccess("Pedido pendente salvo com sucesso!")}closePendingOrderModal(){const e=document.getElementById("pendingOrderModal");e&&e.classList.remove("active"),this.currentEditingPendingOrder=null;const t=document.getElementById("pendingOrderForm");t&&t.reset()}renderPendingOrders(){const e=document.getElementById("pendingOrdersList");e&&(0!==this.pendingOrders.length?e.innerHTML=this.pendingOrders.map(e=>{const t=`order-status-${e.status}`,o={pending:"Pendente",confirmed:"Confirmado",cancelled:"Cancelado"}[e.status]||e.status,a=new Date(e.createdAt).toLocaleDateString("pt-BR");let s="",n="var(--border-color)";if(e.dueDate&&"cancelled"!==e.status&&"completed"!==e.status){const t=new Date(e.dueDate),o=new Date;o.setHours(0,0,0,0),t.setHours(0,0,0,0);const a=Math.ceil((t-o)/864e5);a<0?(s=`<div style="padding: 0.75rem; background: #fee; border: 2px solid #dc3545; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                            <p style="margin: 0; color: #721c24; font-weight: 600;">\n                                <i class="fas fa-exclamation-triangle"></i> VENCIDO h√° ${Math.abs(a)} dia(s)\n                            </p>\n                        </div>`,n="#dc3545"):a<=3&&(s=`<div style="padding: 0.75rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                            <p style="margin: 0; color: #856404; font-weight: 600;">\n                                <i class="fas fa-clock"></i> Vence em ${a} dia(s)\n                            </p>\n                        </div>`,n="#ffc107")}return`\n                <div class="pending-order-card" style="background: var(--white); border: 2px solid ${n}; border-radius: var(--radius-md); padding: 1.25rem; box-shadow: var(--shadow-sm);">\n                    ${s}\n                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">\n                        <div>\n                            <h3 style="margin: 0 0 0.5rem 0; color: var(--dark-gray);">${this.escapeHtml(e.customerName)}</h3>\n                            ${e.customerCPF?`<p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">CPF: ${this.formatCPF(e.customerCPF)}</p>`:""}\n                        </div>\n                        <span class="order-status ${t}">${o}</span>\n                    </div>\n                    <div style="margin-bottom: 0.75rem;">\n                        <p style="margin: 0 0 0.5rem 0; color: var(--gray-600); font-size: 0.9rem;"><strong>Itens:</strong></p>\n                        <ul style="margin: 0; padding-left: 1.25rem; color: var(--dark-gray);">\n                            ${e.items.map(e=>`<li>${this.escapeHtml(e.name)} - ${e.quantity} un. √ó R$ ${e.price.toFixed(2).replace(".",",")}</li>`).join("")}\n                        </ul>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">\n                        <p style="margin: 0; color: var(--dark-gray);"><strong>Total:</strong> R$ ${e.totalValue.toFixed(2).replace(".",",")}</p>\n                        <p style="margin: 0; color: var(--gray-600); font-size: 0.85rem;">${a}</p>\n                    </div>\n                    ${e.dueDate?`<p style="margin: 0 0 0.75rem 0; color: var(--gray-600); font-size: 0.85rem;"><strong>Vencimento:</strong> ${new Date(e.dueDate).toLocaleDateString("pt-BR")}</p>`:""}\n                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">\n                        <button type="button" class="btn-secondary" onclick="app.editPendingOrder('${e.id}')" style="flex: 1; min-width: 80px;">\n                            <i class="fas fa-edit"></i> Editar\n                        </button>\n                        ${"cancelled"!==e.status&&"completed"!==e.status?`\n                            <button type="button" class="btn-primary" onclick="app.completePendingOrder('${e.id}')" style="flex: 1; min-width: 120px;">\n                                <i class="fas fa-check"></i> Finalizar\n                            </button>\n                        `:""}\n                        <button type="button" class="btn-delete" onclick="app.deletePendingOrder('${e.id}')" style="min-width: 36px; padding: 0.5rem;">\n                            <i class="fas fa-times"></i>\n                        </button>\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML='<p style="text-align: center; color: var(--gray); padding: 2rem;">Nenhum pedido pendente cadastrado.</p>')}editPendingOrder(e){const t=this.pendingOrders.find(t=>t.id===e);t&&this.openPendingOrderModal(t)}deletePendingOrder(e){confirm("Tem certeza que deseja excluir este pedido pendente?")&&(this.pendingOrders=this.pendingOrders.filter(t=>t.id!==e),this.saveData(),this.renderPendingOrders(),this.showSuccess("Pedido pendente exclu√≠do com sucesso!"))}completePendingOrder(e){const t=this.pendingOrders.find(t=>t.id===e);if(t&&confirm("Deseja finalizar o pagamento e converter este pedido em venda conclu√≠da?")){const o=t.dueDate?new Date(t.dueDate):new Date,a=o.getFullYear(),s=String(o.getMonth()+1).padStart(2,"0"),n=o.getDate(),r=`${a}-${s}`;let i=this.groups.find(e=>e.month===r);if(!i){i={id:Date.now().toString(),month:r,days:[]};const e=new Date(a,parseInt(s),0).getDate();for(let t=1;t<=e;t++)i.days.push({day:t,sales:[],stock:{}});this.groups.push(i),this.groups.sort((e,t)=>t.month.localeCompare(e.month))}let c=i.days.find(e=>e.day===n);c||(c={day:n,sales:[],stock:{}},i.days.push(c),i.days.sort((e,t)=>e.day-t.day)),c.stock||(c.stock={}),t.items.forEach(e=>{const t=this.items.find(t=>t.id===e.itemId),o=t&&"Servi√ßos"===t.category;c.sales.push({itemId:e.itemId,quantity:e.quantity,price:e.price}),o||(c.stock[e.itemId]||(c.stock[e.itemId]=0),c.stock[e.itemId]+=e.quantity)});const l={id:Date.now().toString()+Math.random().toString(36).substr(2,9),orderCode:this.generateOrderCode(),customerName:t.customerName,customerCPF:t.customerCPF||null,items:t.items.map(e=>{const t=this.items.find(t=>t.id===e.itemId);return{itemId:e.itemId,name:t?this.getItemName(e.itemId):"Item n√£o encontrado",quantity:e.quantity,price:e.price}}),totalValue:t.totalValue,date:o.toISOString(),timestamp:o.getTime(),groupId:i.id,groupMonth:r,day:n,fromPendingOrder:!0};this.completedSales.push(l),this.pendingOrders=this.pendingOrders.filter(t=>t.id!==e),this.saveData(),this.renderPendingOrders(),this.renderLastReceiptsCarousel(),this.renderGroups(),this.updateYearFilter(),this.updateOverallSummary(),this.showReceiptPreview(l),this.showSuccess("Pedido finalizado e convertido em venda conclu√≠da! Venda registrada no grupo mensal e estoque atualizado.")}}openServiceAppointmentModal(e=null){const t=document.getElementById("serviceAppointmentModal");if(!t)return void console.error("Modal de agendamento n√£o encontrado");const o=document.getElementById("serviceAppointmentForm"),a=document.getElementById("serviceAppointmentModalTitle"),s=document.getElementById("appointmentServiceType");if(a&&(a.textContent=e?"Editar Agendamento":"Novo Agendamento"),s&&(s.innerHTML='<option value="">Selecione um servi√ßo...</option>',this.items.filter(e=>"Servi√ßos"===e.category).forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.name||"Servi√ßo",e&&e.serviceTypeId===t.id&&(o.selected=!0),s.appendChild(o)})),o)if(e)document.getElementById("appointmentServiceType").value=e.serviceTypeId||"",document.getElementById("appointmentCustomerName").value=e.customerName||"",document.getElementById("appointmentCustomerContact").value=e.customerContact||"",document.getElementById("appointmentDate").value=e.date||"",document.getElementById("appointmentTime").value=e.time||"",document.getElementById("appointmentPrice").value=e.price||"",document.getElementById("appointmentStatus").value=e.status||"pending",document.getElementById("appointmentNotes").value=e.notes||"",this.currentEditingServiceAppointment=e.id;else{o.reset();const e=(new Date).toISOString().split("T")[0];document.getElementById("appointmentDate").value=e,this.currentEditingServiceAppointment=null}t.classList.add("active")}saveServiceAppointment(e){e.preventDefault();const t=document.getElementById("appointmentServiceType").value,o=this.formatText(document.getElementById("appointmentCustomerName").value),a=document.getElementById("appointmentCustomerContact").value.trim(),s=document.getElementById("appointmentDate").value,n=document.getElementById("appointmentTime").value,r=parseFloat(document.getElementById("appointmentPrice").value)||0,i=document.getElementById("appointmentStatus").value,c=this.formatText(document.getElementById("appointmentNotes").value);if(!t)return void alert("Por favor, selecione um tipo de servi√ßo.");if(!o)return void toast.warning("Por favor, informe o nome do cliente.",3e3);if(!s||!n)return void alert("Por favor, informe a data e hor√°rio do agendamento.");if(r<=0)return void alert("Por favor, informe um pre√ßo v√°lido.");const l={id:this.currentEditingServiceAppointment||Date.now().toString()+Math.random().toString(36).substr(2,9),serviceTypeId:t,customerName:o,customerContact:a||null,date:s,time:n,price:r,status:i,notes:c||null,createdAt:this.currentEditingServiceAppointment&&this.serviceAppointments.find(e=>e.id===this.currentEditingServiceAppointment)?.createdAt||(new Date).toISOString(),updatedAt:(new Date).toISOString()};if(this.currentEditingServiceAppointment){const e=this.serviceAppointments.findIndex(e=>e.id===this.currentEditingServiceAppointment);-1!==e&&(this.serviceAppointments[e]=l)}else this.serviceAppointments.push(l);this.saveData(),this.renderServiceAppointments(),this.closeServiceAppointmentModal(),this.showSuccess("Agendamento salvo com sucesso!")}closeServiceAppointmentModal(){const e=document.getElementById("serviceAppointmentModal");e&&e.classList.remove("active"),this.currentEditingServiceAppointment=null;const t=document.getElementById("serviceAppointmentForm");t&&t.reset()}renderServiceAppointments(){const e=document.getElementById("serviceAppointmentsList");if(!e)return;if(0===this.serviceAppointments.length)return void(e.innerHTML='<p style="text-align: center; color: var(--gray); padding: 2rem;">Nenhum agendamento cadastrado.</p>');const t=new Date,o=[],a=[];this.serviceAppointments.forEach(e=>{new Date(`${e.date}T${e.time}`)>=t?o.push(e):a.push(e)}),o.sort((e,t)=>new Date(`${e.date}T${e.time}`)-new Date(`${t.date}T${t.time}`)),a.sort((e,t)=>new Date(`${t.date}T${t.time}`)-new Date(`${e.date}T${e.time}`));let s="";o.length>0&&(s+='<h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1.1rem;">Pr√≥ximos Agendamentos</h3>',s+=o.map(e=>this.renderServiceAppointmentCard(e)).join("")),a.length>0&&(s+='<h3 style="margin: 1.5rem 0 1rem 0; color: var(--dark-gray); font-size: 1.1rem;">Agendamentos Passados</h3>',s+='<div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">',s+=a.map(e=>this.renderServiceAppointmentCard(e,!0)).join(""),s+="</div>"),e.innerHTML=s,this.checkAppointmentsReminders(),this.renderMiniCalendar()}renderMiniCalendar(){const e=document.getElementById("miniCalendarContainer");if(!e)return;const t=new Date,o=t.getMonth(),a=t.getFullYear(),s=t.getDate(),n=this.getDaysWithAppointments(a,o),r=new Date(a,o,1).getDay(),i=new Date(a,o+1,0).getDate();let c=`\n            <div class="mini-calendar" onclick="app.openCalendarModal()">\n                <div class="mini-calendar-header">\n                    <span class="mini-calendar-month">${this.getMonthName(o)}</span>\n                    <span class="mini-calendar-year">${a}</span>\n                </div>\n                <div class="mini-calendar-weekdays">\n                    ${["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map(e=>`<span class="mini-calendar-weekday">${e}</span>`).join("")}\n                </div>\n                <div class="mini-calendar-days">\n        `;for(let e=0;e<r;e++)c+='<div class="mini-calendar-day empty"></div>';for(let e=1;e<=i;e++){String(o+1).padStart(2,"0"),String(e).padStart(2,"0");const t=n.includes(e);c+=`\n                <div class="mini-calendar-day ${t?"has-appointment":""} ${e===s?"today":""}" \n                     data-day="${e}">\n                    <span class="day-number">${e}</span>\n                    ${t?'<span class="appointment-dot"></span>':""}\n                </div>\n            `}c+="\n                </div>\n            </div>\n        ",e.innerHTML=c}getDaysWithAppointments(e,t){const o=[];return this.serviceAppointments.forEach(a=>{let s;if("string"==typeof a.date){const e=a.date.split("T")[0].split(" ")[0],[t,o,n]=e.split("-");s=new Date(parseInt(t),parseInt(o)-1,parseInt(n))}else s=new Date(a.date);if(s.getFullYear()===e&&s.getMonth()===t){const e=s.getDate();o.includes(e)||o.push(e)}}),o}getMonthName(e){return["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][e]}openCalendarModal(){const e=document.getElementById("calendarModal");e&&(this.currentCalendarMonth=(new Date).getMonth(),this.currentCalendarYear=(new Date).getFullYear(),this.renderFullCalendar(this.currentCalendarYear,this.currentCalendarMonth),e.classList.add("active"))}closeCalendarModal(){const e=document.getElementById("calendarModal");e&&e.classList.remove("active")}renderFullCalendar(e,t){const o=document.getElementById("calendarMonthYear"),a=document.getElementById("calendarGrid");if(!o||!a)return;o.textContent=`${this.getMonthName(t)} ${e}`;const s=this.getDaysWithAppointments(e,t),n=this.getAppointmentsByDay(e,t),r=new Date(e,t,1).getDay(),i=new Date(e,t+1,0).getDate(),c=new Date,l=c.getMonth()===t&&c.getFullYear()===e,d=c.getDate();let m="";["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].forEach(e=>{m+=`<div class="calendar-weekday">${e}</div>`});for(let e=0;e<r;e++)m+='<div class="calendar-day empty"></div>';for(let o=1;o<=i;o++){const a=`${e}-${String(t+1).padStart(2,"0")}-${String(o).padStart(2,"0")}`,r=s.includes(o),i=l&&o===d,c=n[o]||[];m+=`\n                <div class="calendar-day ${r?"has-appointment":""} ${i?"today":""}" \n                     data-day="${o}" data-date="${a}">\n                    <span class="calendar-day-number">${o}</span>\n                    ${r?`<div class="calendar-appointment-indicator">${c.length}</div>`:""}\n                    ${c.length>0?`\n                        <div class="calendar-day-tooltip">\n                            ${c.map(e=>`\n                                <div class="tooltip-item">\n                                    <strong>${e.time}</strong> - ${e.customerName}\n                                </div>\n                            `).join("")}\n                        </div>\n                    `:""}\n                </div>\n            `}a.innerHTML=m;const u=document.getElementById("prevMonthBtn"),p=document.getElementById("nextMonthBtn");u&&(u.onclick=()=>{0===this.currentCalendarMonth?(this.currentCalendarMonth=11,this.currentCalendarYear--):this.currentCalendarMonth--,this.renderFullCalendar(this.currentCalendarYear,this.currentCalendarMonth)}),p&&(p.onclick=()=>{11===this.currentCalendarMonth?(this.currentCalendarMonth=0,this.currentCalendarYear++):this.currentCalendarMonth++,this.renderFullCalendar(this.currentCalendarYear,this.currentCalendarMonth)})}getAppointmentsByDay(e,t){const o={};return this.serviceAppointments.forEach(a=>{let s;if("string"==typeof a.date){const e=a.date.split("T")[0].split(" ")[0],[t,o,n]=e.split("-");s=new Date(parseInt(t),parseInt(o)-1,parseInt(n))}else s=new Date(a.date);if(s.getFullYear()===e&&s.getMonth()===t){const e=s.getDate();o[e]||(o[e]=[]),o[e].push({time:a.time,customerName:a.customerName,serviceTypeId:a.serviceTypeId})}}),o}renderServiceAppointmentCard(e,t=!1){const o=this.items.find(t=>t.id===e.serviceTypeId),a=o?o.name:"Servi√ßo n√£o encontrado",s=`appointment-status-${e.status}`,n={pending:"Pendente",confirmed:"Confirmado",completed:"Conclu√≠do",cancelled:"Cancelado"}[e.status]||e.status,r=new Date(`${e.date}T${e.time}`),i=r.toLocaleDateString("pt-BR"),c=r.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),l=t?"background: var(--white); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 0.875rem; box-shadow: var(--shadow-sm); width: 100%; max-width: 400px; margin: 0 auto;":"background: var(--white); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1.25rem; box-shadow: var(--shadow-sm); margin-bottom: 1rem;",d=t?"margin: 0 0 0.4rem 0; color: var(--dark-gray); font-size: 0.95rem;":"margin: 0 0 0.5rem 0; color: var(--dark-gray);",m=t?"margin: 0; color: var(--gray-600); font-size: 0.85rem;":"margin: 0; color: var(--gray-600); font-size: 0.9rem;",u=t?"margin: 0 0 0.2rem 0; color: var(--dark-gray); font-size: 0.85rem;":"margin: 0 0 0.25rem 0; color: var(--dark-gray);",p=new Date,g=new Date(p);g.setDate(g.getDate()+1),g.setHours(0,0,0,0);const h=new Date(p);h.setHours(23,59,59,999);const v=new Date(g);v.setHours(23,59,59,999);let y="",f="var(--border-color)";return t||"completed"===e.status||"cancelled"===e.status||(r>=p&&r<=h?(y=`<div style="padding: 0.75rem; background: #d1ecf1; border: 2px solid #17a2b8; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                    <p style="margin: 0; color: #0c5460; font-weight: 600;">\n                        <i class="fas fa-bell"></i> Agendamento HOJE √†s ${c}\n                    </p>\n                </div>`,f="#17a2b8"):r>=g&&r<=v&&(y=`<div style="padding: 0.75rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                    <p style="margin: 0; color: #856404; font-weight: 600;">\n                        <i class="fas fa-clock"></i> Agendamento AMANH√É √†s ${c}\n                    </p>\n                </div>`,f="#ffc107")),`\n            <div class="service-appointment-card" style="${l}; border: 2px solid ${f};">\n                ${y}\n                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${t?"0.75rem":"1rem"};">\n                    <div style="flex: 1; min-width: 0;">\n                        <h3 style="${d}">${this.escapeHtml(a)}</h3>\n                        <p style="${m}">${this.escapeHtml(e.customerName)}</p>\n                        ${e.customerContact?`<p style="margin: 0.2rem 0 0 0; color: var(--gray-600); font-size: 0.8rem;">üìû ${this.escapeHtml(e.customerContact)}</p>`:""}\n                    </div>\n                    <span class="appointment-status ${s}" style="flex-shrink: 0; margin-left: 0.5rem;">${n}</span>\n                </div>\n                <div style="margin-bottom: ${t?"0.5rem":"0.75rem"};">\n                    <p style="${u}"><strong>üìÖ Data:</strong> ${i}</p>\n                    <p style="${u}"><strong>üïê Hor√°rio:</strong> ${c}</p>\n                    <p style="margin: 0; color: var(--dark-gray); font-size: ${t?"0.85rem":"1rem"};"><strong>üí∞ Pre√ßo:</strong> R$ ${e.price.toFixed(2).replace(".",",")}</p>\n                </div>\n                ${e.notes?`<p style="margin: 0 0 ${t?"0.5rem":"0.75rem"} 0; color: var(--gray-600); font-size: ${t?"0.8rem":"0.9rem"}; font-style: italic;">${this.escapeHtml(e.notes)}</p>`:""}\n                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">\n                    <button type="button" class="btn-secondary" onclick="app.editServiceAppointment('${e.id}')" style="flex: 1; min-width: 80px; font-size: ${t?"0.85rem":"0.95rem"}; padding: ${t?"0.5rem":"0.625rem"};">\n                        <i class="fas fa-edit"></i> Editar\n                    </button>\n                    <button type="button" class="btn-delete" onclick="app.deleteServiceAppointment('${e.id}')" style="min-width: 36px; padding: ${t?"0.4rem":"0.5rem"}; font-size: ${t?"0.85rem":"0.95rem"};">\n                        <i class="fas fa-times"></i>\n                    </button>\n                </div>\n            </div>\n        `}editServiceAppointment(e){const t=this.serviceAppointments.find(t=>t.id===e);t&&this.openServiceAppointmentModal(t)}deleteServiceAppointment(e){confirm("Tem certeza que deseja excluir este agendamento?")&&(this.serviceAppointments=this.serviceAppointments.filter(t=>t.id!==e),this.saveData(),this.renderServiceAppointments(),this.renderMiniCalendar(),this.showSuccess("Agendamento exclu√≠do com sucesso!"))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}fixAccents(e){if(!e||"string"!=typeof e)return e;const t={acao:"a√ß√£o",aviao:"avi√£o",cao:"c√£o",coracao:"cora√ß√£o",edicao:"edi√ß√£o",eleicao:"elei√ß√£o",funcao:"fun√ß√£o",informacao:"informa√ß√£o",nacao:"na√ß√£o",opcao:"op√ß√£o",previsao:"previs√£o",sessao:"sess√£o",situacao:"situa√ß√£o",televisao:"televis√£o",transacao:"transa√ß√£o",camisa:"camisa",calca:"cal√ßa",blusa:"blusa",vestido:"vestido",sapato:"sapato",tenis:"t√™nis",bone:"bon√©",oculos:"√≥culos",relogio:"rel√≥gio",celular:"celular",tablet:"tablet",notebook:"notebook",computador:"computador",televisao:"televis√£o",som:"som",fone:"fone",mouse:"mouse",teclado:"teclado"};let o=e;for(const[e,a]of Object.entries(t)){const t=new RegExp(`\\b${e}\\b`,"gi");o=o.replace(t,e=>e===e.toUpperCase()?a.toUpperCase():e[0]===e[0].toUpperCase()?a.charAt(0).toUpperCase()+a.slice(1):a)}return o}capitalizeWords(e){if(!e||"string"!=typeof e)return e;const t=["de","da","do","das","dos","e","em","na","no","nas","nos","para","por","com","sem","a","o","as","os"];return e.split(" ").map((e,o)=>0!==o&&t.includes(e.toLowerCase())?e.toLowerCase():e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ")}formatText(e){if(!e||"string"!=typeof e)return e;let t=this.fixAccents(e.trim());return t=this.capitalizeWords(t),t}showSuccessOld2(e){const t=document.createElement("div");t.style.cssText="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; animation: slideInRight 0.3s ease-out;",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}showErrorOld(e){const t=document.createElement("div");t.style.cssText="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; animation: slideInRight 0.3s ease-out;",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},4e3)}deleteGroup(e){confirm("Tem certeza que deseja excluir este grupo mensal? Todas as vendas ser√£o perdidas.")&&(this.groups=this.groups.filter(t=>t.id!==e),this.saveData(),this.renderGroups(),this.updateMonthFilter(),this.updateYearFilter(),this.updateOverallSummary())}renderGroups(){const e=document.getElementById("groupsList");if(!e)return;if(0===this.groups.length&&!e.querySelector(".group-card"))return void this.showSkeleton("groupsList",6,!0);const t=document.getElementById("yearFilter")?.value||"";let o=this.groups;t&&(o=this.groups.filter(e=>{const[o]=e.month.split("-");return o===t}));const a=this.calculateTotalAllMonths(),s=document.getElementById("overallTotalSales"),n=document.getElementById("overallTotalValue");s&&this.updateValueWithAnimation("overallTotalSales",a.totalSales),n&&this.updateValueWithAnimation("overallTotalValue",a.totalValue,e=>`R$ ${e.toFixed(2).replace(".",",")}`);const r=this.calculateTotalCosts(),i=a.totalValue-r,c=document.getElementById("overallTotalCosts"),l=document.getElementById("overallNetProfit");c&&(c.textContent=`R$ ${r.toFixed(2).replace(".",",")}`),l&&(l.textContent=`R$ ${i.toFixed(2).replace(".",",")}`,l.style.color=i<0?"#dc3545":"#155724"),0!==o.length?e.innerHTML=o.map(e=>{const[t,o]=e.month.split("-"),a=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(o)-1],s=e.days.reduce((e,t)=>e+t.sales.reduce((e,t)=>e+t.quantity,0),0),n=e.days.reduce((e,t)=>e+t.sales.reduce((e,t)=>e+this.getSaleTotalValue(t),0),0),r={};e.days.forEach(e=>{e.stock||(e.stock={}),Object.keys(e.stock).forEach(t=>{r[t]||(r[t]={stock:0,sold:0}),r[t].stock=Math.max(r[t].stock,e.stock[t]||0)}),e.sales.forEach(e=>{r[e.itemId]||(r[e.itemId]={stock:0,sold:0}),r[e.itemId].sold+=e.quantity})});const i=Object.values(r).reduce((e,t)=>e+t.stock,0),c=Object.values(r).reduce((e,t)=>e+t.sold,0),l=i-c;return`\n                <div class="group-card">\n                    <h3>${a} ${t}</h3>\n                    <div class="group-info">\n                        <div><strong>Total de Vendas:</strong> ${s}</div>\n                        <div><strong>Valor Total:</strong> R$ ${n.toFixed(2).replace(".",",")}</div>\n                        <div class="stock-section">\n                            <div class="stock-total"><strong>Estoque Total:</strong> ${i} un.</div>\n                            <div class="stock-sold"><strong>Estoque Vendido:</strong> ${c} un.</div>\n                            <div class="stock-available ${l<0?"danger":0===l?"warning":""}"><strong>Estoque Dispon√≠vel:</strong> ${l} un.</div>\n                        </div>\n                    </div>\n                    <div class="group-actions">\n                        <button class="btn-small btn-edit" onclick="app.viewGroup('${e.id}')">Ver Detalhes</button>\n                        <button class="btn-small btn-delete" onclick="app.deleteGroup('${e.id}')" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML=`<div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-calendar-alt"></i>\n                    </div>\n                    <h3 class="empty-state-title">${t?`Nenhum grupo encontrado para ${t}`:"Nenhum grupo mensal criado ainda"}</h3>\n                    <p class="empty-state-message">\n                        ${t?"Tente selecionar outro ano ou criar um novo grupo mensal.":"Comece criando um grupo mensal para organizar suas vendas por m√™s."}\n                    </p>\n                </div>`}updateMonthFilter(){const e=document.getElementById("monthFilter");if(!e)return;const t=Array.from(e.options).slice(1).map(e=>e.value);this.groups.forEach(o=>{if(!t.includes(o.month)){const[t,a]=o.month.split("-"),s=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],n=document.createElement("option");n.value=o.month,n.textContent=`${s[parseInt(a)-1]} ${t}`,e.appendChild(n)}})}updateYearFilter(){const e=document.getElementById("yearFilter");if(!e)return;const t=new Set;this.groups.forEach(e=>{const[o]=e.month.split("-");t.add(o)});const o=Array.from(t).sort((e,t)=>parseInt(t)-parseInt(e));for(;e.options.length>1;)e.remove(1);o.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)})}updateGoalsYearFilter(){const e=document.getElementById("goalsYearFilter");if(!e)return;const t=new Set;this.goals.forEach(e=>{if(e.month){const[o]=e.month.split("-");t.add(o)}});const o=Array.from(t).sort((e,t)=>parseInt(t)-parseInt(e));for(;e.options.length>1;)e.remove(1);o.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)})}updateServicesYearFilter(){const e=document.getElementById("servicesYearFilter");if(!e)return;const t=new Set;this.serviceGroups.forEach(e=>{if(e.month){const[o]=e.month.split("-");t.add(o)}});const o=Array.from(t).sort((e,t)=>parseInt(t)-parseInt(e));for(;e.options.length>1;)e.remove(1);o.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)})}openServiceGroupModal(){document.getElementById("serviceGroupModal").classList.add("active")}closeServiceGroupModal(){document.getElementById("serviceGroupModal").classList.remove("active"),document.getElementById("serviceGroupForm").reset()}createServiceGroup(e){e.preventDefault();const t=document.getElementById("serviceGroupMonth").value;if(this.serviceGroups.some(e=>e.month===t))return void alert("J√° existe um grupo de servi√ßos para este m√™s.");const o={id:Date.now().toString(),month:t,days:[]},[a,s]=t.split("-"),n=new Date(a,s,0).getDate();for(let e=1;e<=n;e++){const t={day:e,services:[]};o.days.push(t)}this.serviceGroups.push(o),this.serviceGroups.sort((e,t)=>t.month.localeCompare(e.month)),this.saveData(),this.updateServicesYearFilter(),this.renderServiceGroups(),this.closeServiceGroupModal()}openServiceRecordModal(e,t){const o=this.serviceGroups.find(t=>t.id===e);if(!o)return;this.currentServiceGroup=o,this.currentServiceDay=t;const a=o.days.find(e=>e.day===t),s=document.getElementById("serviceRecordItem"),n=this.items.filter(e=>"Servi√ßos"===e.category);s.innerHTML='<option value="">Selecione um servi√ßo...</option>'+n.map(e=>`<option value="${e.id}">${this.escapeHtml(e.name)}</option>`).join(""),document.getElementById("serviceRecordForm").reset();const r=document.getElementById("serviceRecordDayDisplay");if(r&&(r.textContent=t),a&&a.services.length>0)this.showDayServices(a);else{const e=document.getElementById("dayServicesList");e&&e.remove()}const i=document.getElementById("viewServiceGroupModal"),c=document.getElementById("serviceRecordModal");i&&i.classList.contains("active")&&c.classList.add("modal-overlay"),c.classList.add("active")}showDayServices(e){document.getElementById("serviceRecordModal");let t=document.getElementById("dayServicesList");if(!t){t=document.createElement("div"),t.id="dayServicesList",t.style.cssText="margin-bottom: 1.5rem; padding: 1rem; background: var(--light-gray); border-radius: 5px;";const e=document.getElementById("serviceRecordForm");e.insertBefore(t,e.firstChild)}t.innerHTML='<h4 style="margin-bottom: 0.75rem;">Servi√ßos Registrados:</h4>'+e.services.map((e,t)=>{this.items.find(t=>t.id===e.itemId);const o=e.hours||0,a=e.minutes||0,s=e.price||0;return`\n                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 5px; border: 1px solid var(--border-color);">\n                        <div>\n                            <strong>${this.escapeHtml(this.getItemName(e.itemId))}</strong>\n                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 0.25rem;">\n                                ${o}h ${a}min - R$ ${s.toFixed(2).replace(".",",")}\n                            </div>\n                        </div>\n                        <button type="button" class="btn-small btn-delete" onclick="app.deleteServiceRecord(${this.currentServiceDay}, ${t})" title="Excluir">\n                            <i class="fas fa-times"></i>\n                        </button>\n                    </div>\n                `}).join("")}saveServiceRecord(e){if(e.preventDefault(),!this.currentServiceGroup||!this.currentServiceDay)return;const t=document.getElementById("serviceRecordItem").value,o=parseInt(document.getElementById("serviceRecordHours").value)||0,a=parseInt(document.getElementById("serviceRecordMinutes").value)||0,s=this.parsePrice(document.getElementById("serviceRecordPrice").value);if(!t)return void alert("Por favor, selecione um servi√ßo.");if(s<=0)return void alert("O pre√ßo deve ser maior que zero.");if(0===o&&0===a)return void alert("Por favor, informe pelo menos 1 minuto trabalhado.");const n=this.serviceGroups.find(e=>e.id===this.currentServiceGroup.id);if(!n)return;const r=n.days.find(e=>e.day===this.currentServiceDay);if(!r)return;r.services.push({itemId:t,hours:o,minutes:a,price:s}),this.currentServiceGroup=n,this.saveData();const i=document.getElementById("viewServiceGroupModal");i&&i.classList.contains("active")&&this.renderServiceGroupView(n);const c=document.getElementById("servicesTab");c&&c.classList.contains("active")&&this.renderServiceGroups(),this.updateServiceSummary(),this.openServiceRecordModal(n.id,this.currentServiceDay)}deleteServiceRecord(e,t){if(!this.currentServiceGroup)return;const o=this.serviceGroups.find(e=>e.id===this.currentServiceGroup.id);if(!o)return;const a=o.days.find(t=>t.day===e);if(a&&a.services[t]&&confirm("Deseja excluir este registro de servi√ßo?")){a.services.splice(t,1),this.currentServiceGroup=o,this.saveData(),this.renderServiceGroupView(o);const s=document.getElementById("servicesTab");s&&s.classList.contains("active")&&this.renderServiceGroups(),this.updateServiceSummary(),this.openServiceRecordModal(o.id,e)}}closeServiceRecordModal(){const e=document.getElementById("serviceRecordModal");e&&(e.classList.remove("active"),e.classList.remove("modal-overlay")),this.currentServiceGroup=null,this.currentServiceDay=null}viewServiceGroup(e){const t=this.serviceGroups.find(t=>t.id===e);t&&(this.currentServiceGroup=t,this.renderServiceGroupView(t),document.getElementById("viewServiceGroupModal").classList.add("active"))}renderServiceGroupView(e){const[t,o]=e.month.split("-"),a=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(o)-1];document.getElementById("serviceGroupTitle").textContent=`Servi√ßos - ${a}/${t}`;let s=0,n=0,r=0;e.days.forEach(e=>{e.services.forEach(e=>{s+=e.hours||0,n+=e.minutes||0,r+=e.price||0})}),s+=Math.floor(n/60),n%=60,document.getElementById("serviceGroupTotalHours").textContent=`${s}h ${n}min`,document.getElementById("serviceGroupTotalRevenue").textContent=`R$ ${r.toFixed(2).replace(".",",")}`;let i=0,c=0,l=0;this.serviceGroups.forEach(e=>{e.days.forEach(e=>{e.services.forEach(e=>{i+=e.hours||0,c+=e.minutes||0,l+=e.price||0})})}),i+=Math.floor(c/60),c%=60,document.getElementById("serviceGroupTotalHoursAll").textContent=`${i}h ${c}min`,document.getElementById("serviceGroupTotalRevenueAll").textContent=`R$ ${l.toFixed(2).replace(".",",")}`,document.getElementById("serviceDaysList").innerHTML=e.days.map(t=>{const o=t.services.length,a=t.services.reduce((e,t)=>e+(t.price||0),0);let s=0,n=0;return t.services.forEach(e=>{s+=e.hours||0,n+=e.minutes||0}),s+=Math.floor(n/60),n%=60,`\n                <div class="day-card">\n                    <div class="day-header">\n                        <h4>Dia ${t.day}</h4>\n                        <span class="day-badge">${o} servi√ßo(s)</span>\n                    </div>\n                    <div class="day-info">\n                        <span>${s}h ${n}min</span>\n                        <span>R$ ${a.toFixed(2).replace(".",",")}</span>\n                    </div>\n                    <button type="button" class="btn-small btn-primary" onclick="app.openServiceRecordModal('${e.id}', ${t.day})">\n                        ${o>0?"Editar":"Registrar"}\n                    </button>\n                </div>\n            `}).join("");const d={};e.days.forEach(e=>{e.services.forEach(e=>{d[e.itemId]||(d[e.itemId]={name:this.getItemName(e.itemId),hours:0,minutes:0,total:0}),d[e.itemId].hours+=e.hours||0,d[e.itemId].minutes+=e.minutes||0,d[e.itemId].total+=e.price||0})}),document.getElementById("serviceItemsSummary").innerHTML=Object.entries(d).map(([e,t])=>{const o=t.hours+Math.floor(t.minutes/60),a=t.minutes%60;return`\n                    <div class="summary-item">\n                        <div>\n                            <strong>${this.escapeHtml(t.name)}</strong>\n                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 0.25rem;">\n                                ${o}h ${a}min - R$ ${t.total.toFixed(2).replace(".",",")}\n                            </div>\n                        </div>\n                    </div>\n                `}).join("")||'<p style="text-align: center; color: var(--gray); padding: 1rem;">Nenhum servi√ßo registrado ainda.</p>'}closeViewServiceGroupModal(){document.getElementById("viewServiceGroupModal").classList.remove("active"),this.currentServiceGroup=null}deleteServiceGroup(e){confirm("Tem certeza que deseja excluir este grupo de servi√ßos? Todos os registros ser√£o perdidos.")&&(this.serviceGroups=this.serviceGroups.filter(t=>t.id!==e),this.saveData(),this.updateServicesYearFilter(),this.renderServiceGroups(),this.updateServiceSummary())}renderServiceGroups(){const e=document.getElementById("servicesList");if(!e)return;const t=document.getElementById("servicesYearFilter"),o=t?t.value:"";let a=this.serviceGroups;o&&""!==o&&(a=this.serviceGroups.filter(e=>{if(!e.month)return!1;const[t]=e.month.split("-");return t===o})),0!==a.length?e.innerHTML=a.map(e=>{const[t,o]=e.month.split("-"),a=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(o)-1];let s=0,n=0,r=0,i=0;return e.days.forEach(e=>{e.services.forEach(e=>{s+=e.hours||0,n+=e.minutes||0,r+=e.price||0,i++})}),s+=Math.floor(n/60),n%=60,`\n                <div class="group-card">\n                    <h3>${a}/${t}</h3>\n                    <div class="group-info">\n                        <div><strong>Total de Horas:</strong> ${s}h ${n}min</div>\n                        <div><strong>Total Faturado:</strong> R$ ${r.toFixed(2).replace(".",",")}</div>\n                        <div><strong>Servi√ßos Registrados:</strong> ${i}</div>\n                    </div>\n                    <div class="group-actions">\n                        <button class="btn-small btn-edit" onclick="app.viewServiceGroup('${e.id}')">Ver Detalhes</button>\n                        <button class="btn-small btn-delete" onclick="app.deleteServiceGroup('${e.id}')" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML='<p style="grid-column: 1/-1; text-align: center; color: var(--gray); padding: 2rem;">'+(o?`Nenhum m√™s de servi√ßos encontrado para o ano ${o}.`:"Nenhum m√™s de servi√ßos cadastrado ainda.")+"</p>"}updateServiceSummary(){const e=document.getElementById("servicesTotalHours");if(!e)return;let t=0,o=0,a=0,s=0,n=0;this.serviceGroups.forEach(e=>{e.days.forEach(e=>{e.services.forEach(e=>{const r=e.hours||0,i=e.minutes||0;t+=r,o+=i,a+=e.price||0,s++,n+=r+i/60})})}),t+=Math.floor(o/60),o%=60;const r=this.serviceGroups.length;let i=0,c=0;if(r>0){const e=60*t+o,a=Math.floor(e/r);i=Math.floor(a/60),c=a%60}let l=0;n>0&&(l=a/n);let d=0,m=0;if(s>0){const e=(60*t+o)/s;d=Math.floor(e/60),m=Math.round(e%60)}const u=document.getElementById("servicesAvgHours"),p=document.getElementById("servicesTotalRevenue"),g=document.getElementById("servicesTotalCount"),h=document.getElementById("servicesAvgValuePerHour"),v=document.getElementById("servicesAvgHoursPerService");e&&(e.textContent=`${t}h ${o}min`),u&&(u.textContent=`${i}h ${c}min`),p&&(p.textContent=`R$ ${a.toFixed(2).replace(".",",")}`),g&&(g.textContent=s),h&&(h.textContent=`R$ ${l.toFixed(2).replace(".",",")}`),v&&(v.textContent=`${d}h ${m}min`),this.updateServicesChart()}openCostModal(e=null){this.currentEditingCost=e;const t=document.getElementById("costModal"),o=document.getElementById("costForm"),a=document.getElementById("costModalTitle"),s=document.getElementById("costItem"),n=this.items.filter(e=>"Servi√ßos"!==e.category);s.innerHTML='<option value="">Selecione um item...</option>'+n.map(e=>{if("Eletr√¥nicos"===(e.category||"Roupas")){const t=e.model||e.name;return`<option value="${e.id}">${this.escapeHtml(t)}</option>`}{let t;if(e.name)t=`${e.name} - ${e.brand||""}`;else{const o=[e.brand||""];e.style&&o.push(e.style),t=o.filter(e=>e).join(" - ")||"Roupa"}return`<option value="${e.id}">${this.escapeHtml(t)}</option>`}}).join("");const r=document.getElementById("costSupplier");r&&(r.innerHTML='<option value="">Selecione um fornecedor ou deixe em branco...</option>'+this.suppliers.map(e=>`<option value="${e.id}">${this.escapeHtml(e.name)}</option>`).join("")),e?(a.textContent="Editar Custo",document.getElementById("costItem").value=e.itemId,document.getElementById("costDate").value=e.date,document.getElementById("costQuantity").value=e.quantity,document.getElementById("costPrice").value=e.price,r&&e.supplierId&&(r.value=e.supplierId),this.calculateCostTotal()):(a.textContent="Cadastrar Novo Custo",o.reset(),document.getElementById("costDate").value=(new Date).toISOString().split("T")[0]),t.classList.add("active")}closeCostModal(){document.getElementById("costModal").classList.remove("active"),this.currentEditingCost=null}calculateCostTotal(){const e=(parseFloat(document.getElementById("costQuantity").value)||0)*this.parsePrice(document.getElementById("costPrice").value);document.getElementById("costTotal").value=e.toFixed(2)}saveCost(e){e.preventDefault();const t=document.getElementById("costItem").value,o=document.getElementById("costDate").value,a=parseInt(document.getElementById("costQuantity").value),s=this.parsePrice(document.getElementById("costPrice").value);if(!t)return void alert("Por favor, selecione um item.");if(s<=0||a<=0)return void alert("Pre√ßo e quantidade devem ser maiores que zero.");const n=document.getElementById("costSupplier")?.value||null,r={id:this.currentEditingCost?this.currentEditingCost.id:Date.now().toString(),itemId:t,supplierId:n,date:o,quantity:a,price:s,total:a*s};if(this.currentEditingCost){const e=this.costs.findIndex(e=>e.id===this.currentEditingCost.id);-1!==e&&(this.costs[e]=r)}else this.costs.push(r);this.saveData(),this.renderCosts(),this.updateOverallSummary(),this.closeCostModal()}deleteCost(e){confirm("Tem certeza que deseja excluir este custo?")&&(this.costs=this.costs.filter(t=>t.id!==e),this.saveData(),this.renderCosts(),this.updateOverallSummary())}renderCosts(){const e=document.getElementById("costsList");if(!e)return;if(0===this.costs.length&&!e.querySelector(".cost-card"))return void this.showSkeleton("costsList",4,!0);const t=document.getElementById("totalCostsCount"),o=document.getElementById("totalCostsValue"),a=this.costs.length,s=this.costs.reduce((e,t)=>e+t.total,0);if(t&&(t.textContent=a),o&&(o.textContent=`R$ ${s.toFixed(2).replace(".",",")}`),this.updateCostsChart(),0===this.costs.length)return void(e.innerHTML='<div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-receipt"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum custo cadastrado ainda</h3>\n                    <p class="empty-state-message">\n                        Comece registrando seus custos para ter um controle financeiro completo.\n                    </p>\n                    <div class="empty-state-action">\n                        <button class="btn-primary" onclick="app.openCostModal()">\n                            <i class="fas fa-plus"></i> Adicionar Primeiro Custo\n                        </button>\n                    </div>\n                </div>');const n=[...this.costs].sort((e,t)=>new Date(t.date)-new Date(e.date));e.innerHTML=n.map(e=>{const t=this.items.find(t=>t.id===e.itemId),o=new Date(e.date).toLocaleDateString("pt-BR");return`\n                <div class="cost-card">\n                    <h3>${this.escapeHtml(t?t.name:"Item n√£o encontrado")}</h3>\n                    <div class="cost-info"><strong>Data:</strong> ${o}</div>\n                    <div class="cost-info"><strong>Quantidade:</strong> ${e.quantity} un.</div>\n                    <div class="cost-info"><strong>Custo Unit√°rio:</strong> R$ ${e.price.toFixed(2).replace(".",",")}</div>\n                    <div class="cost-total">Total: R$ ${e.total.toFixed(2).replace(".",",")}</div>\n                    <div class="cost-actions">\n                        <button class="btn-small btn-edit" onclick="app.openCostModal(${JSON.stringify(e).replace(/"/g,"&quot;")})">Editar</button>\n                        <button class="btn-small btn-delete" onclick="app.deleteCost('${e.id}')" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                </div>\n            `}).join("")}openGoalModal(e=null){this.currentEditingGoal=e;const t=document.getElementById("goalModal"),o=document.getElementById("goalForm"),a=document.getElementById("goalModalTitle");if(e)a.textContent="Editar Meta",document.getElementById("goalMonth").value=e.month,document.getElementById("goalAmount").value=e.amount,document.getElementById("goalDescription").value=e.description||"";else{a.textContent="Criar Nova Meta";const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`;document.getElementById("goalMonth").value=t,o.reset(),document.getElementById("goalMonth").value=t}t.classList.add("active")}closeGoalModal(){document.getElementById("goalModal").classList.remove("active"),document.getElementById("goalForm").reset(),this.currentEditingGoal=null}saveGoal(e){e.preventDefault();const t=document.getElementById("goalMonth").value,o=this.parsePrice(document.getElementById("goalAmount").value),a=document.getElementById("goalDescription").value.trim();if(o<=0)return void alert("O valor da meta deve ser maior que zero.");const s={id:this.currentEditingGoal?this.currentEditingGoal.id:Date.now().toString(),month:t,amount:o,description:a,createdAt:this.currentEditingGoal?this.currentEditingGoal.createdAt:(new Date).toISOString()};if(this.currentEditingGoal){const e=this.goals.findIndex(e=>e.id===this.currentEditingGoal.id);-1!==e&&(this.goals[e]=s)}else{if(this.goals.find(e=>e.month===t)){if(!confirm("J√° existe uma meta para este m√™s. Deseja substitu√≠-la?"))return;this.goals=this.goals.filter(e=>e.month!==t)}this.goals.push(s)}this.saveData(),this.renderGoals(),this.updateGoalsYearFilter(),this.closeGoalModal()}deleteGoal(e){confirm("Tem certeza que deseja excluir esta meta?")&&(this.goals=this.goals.filter(t=>t.id!==e),this.saveData(),this.renderGoals(),this.updateGoalsYearFilter())}getMonthSales(e){const t=this.groups.find(t=>t.month===e);if(!t)return 0;let o=0;return t.days.forEach(e=>{e.sales.forEach(e=>{o+=this.getSaleTotalValue(e)})}),o}renderGoals(){const e=document.getElementById("goalsList");if(!e)return;if(0===this.goals.length&&!e.querySelector(".goal-card"))return void this.showSkeleton("goalsList",4,!0);const t=document.getElementById("currentMonthGoal"),o=document.getElementById("currentMonthSales"),a=document.getElementById("goalProgress"),s=document.getElementById("goalStatus"),n=document.getElementById("goalProgressItem"),r=(document.getElementById("goalStatusItem"),document.getElementById("goalsYearFilter")),i=r?r.value:"";let c=this.goals;i&&""!==i&&(c=this.goals.filter(e=>{if(!e.month)return!1;const[t]=e.month.split("-");return t===i}));const l=new Date,d=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,m=this.goals.find(e=>e.month===d),u=this.getMonthSales(d);if(m){const e=u/m.amount*100,r=m.amount-u;t&&(t.textContent=`R$ ${m.amount.toFixed(2).replace(".",",")}`),o&&(o.textContent=`R$ ${u.toFixed(2).replace(".",",")}`),a&&(a.textContent=`${Math.min(e,100).toFixed(1)}%`),s&&(e>=100?(s.textContent="‚úÖ Meta Atingida!",s.style.color="#28a745",n&&n.querySelector(".goal-progress-fill")?.classList.add("success")):e>=75?(s.textContent="üü° Quase l√°!",s.style.color="#ffc107"):(s.textContent=`Faltam R$ ${r.toFixed(2).replace(".",",")}`,s.style.color="#dc3545"))}else t&&(t.textContent="R$ 0,00"),o&&(o.textContent=`R$ ${u.toFixed(2).replace(".",",")}`),a&&(a.textContent="-"),s&&(s.textContent="Sem meta definida",s.style.color="#6c757d");if(0===c.length)return void(e.innerHTML=`<div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-bullseye"></i>\n                    </div>\n                    <h3 class="empty-state-title">${i?`Nenhuma meta encontrada para ${i}`:"Nenhuma meta cadastrada ainda"}</h3>\n                    <p class="empty-state-message">\n                        ${i?"Tente selecionar outro ano ou criar uma nova meta.":"Comece definindo suas metas financeiras para acompanhar o desempenho do neg√≥cio."}\n                    </p>\n                    ${i?"":'\n                        <div class="empty-state-action">\n                            <button class="btn-primary" onclick="app.openGoalModal()">\n                                <i class="fas fa-bullseye"></i> Criar Primeira Meta\n                            </button>\n                        </div>\n                    '}\n                </div>`);this.checkGoalsAlerts();const p=[...c].sort((e,t)=>t.month.localeCompare(e.month));e.innerHTML=p.map(e=>{const[t,o]=e.month.split("-"),a=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(o)-1],s=this.getMonthSales(e.month),n=s/e.amount*100,r=n>=100?"success":n>=75?"warning":"danger",i=n>=75&&n<100,c=new Date(parseInt(t),parseInt(o),0).getDate(),l=new Date,d=e.month===`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,m=d?c-l.getDate():null,u=d&&null!==m&&m<=7;return`\n                <div class="goal-card" ${i||u?'style="border: 2px solid #ffc107;"':""}>\n                    ${i?`\n                        <div style="padding: 0.75rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: var(--radius-sm); margin-bottom: 1rem;">\n                            <p style="margin: 0; color: #856404; font-weight: 600;">\n                                <i class="fas fa-bullseye"></i> Meta quase atingida! ${n.toFixed(1)}% conclu√≠do\n                            </p>\n                        </div>\n                    `:""}\n                    ${u&&n<100?`\n                        <div style="padding: 0.75rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: var(--radius-sm); margin-bottom: 1rem;">\n                            <p style="margin: 0; color: #856404; font-weight: 600;">\n                                <i class="fas fa-clock"></i> Faltam ${m} dia(s) para o fim do m√™s! Progresso: ${n.toFixed(1)}%\n                            </p>\n                        </div>\n                    `:""}\n                    <h3>${a}/${t}</h3>\n                    ${e.description?`<div class="goal-info"><strong>Descri√ß√£o:</strong> ${this.escapeHtml(e.description)}</div>`:""}\n                    <div class="goal-info"><strong>Meta:</strong> R$ ${e.amount.toFixed(2).replace(".",",")}</div>\n                    <div class="goal-info"><strong>Vendas:</strong> R$ ${s.toFixed(2).replace(".",",")}</div>\n                    <div class="goal-progress-bar">\n                        <div class="goal-progress-fill ${r}" style="width: ${Math.min(n,100)}%">\n                            ${Math.min(n,100).toFixed(1)}%\n                        </div>\n                    </div>\n                    <div class="goal-actions">\n                        <button class="btn-small btn-edit" onclick="app.openGoalModal(${JSON.stringify(e).replace(/"/g,"&quot;")})">Editar</button>\n                        <button class="btn-small btn-delete" onclick="app.deleteGoal('${e.id}')" title="Excluir"><i class="fas fa-times"></i></button>\n                    </div>\n                </div>\n            `}).join(""),this.updateGoalsChart()}updateGoalsChart(){const e=document.getElementById("goalsChart");if(!e)return;if("undefined"==typeof Chart)return void console.warn("Chart.js n√£o est√° dispon√≠vel ainda");const t=document.getElementById("goalsYearFilter"),o=t?t.value:"";let a=this.goals;o&&""!==o&&(a=this.goals.filter(e=>{if(!e.month)return!1;const[t]=e.month.split("-");return t===o}));const s=[],n=[],r=[],i=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];if(o&&""!==o){const e=parseInt(o);for(let t=1;t<=12;t++){const o=`${e}-${String(t).padStart(2,"0")}`,c=a.find(e=>e.month===o),l=this.getMonthSales(o);s.push(`${i[t-1]}/${String(e).slice(-2)}`),n.push(c?c.amount:0),r.push(l)}}else{const e=new Date;for(let t=5;t>=0;t--){const o=new Date(e.getFullYear(),e.getMonth()-t,1),a=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`;s.push(`${i[o.getMonth()]}/${String(o.getFullYear()).slice(-2)}`);const c=this.goals.find(e=>e.month===a),l=this.getMonthSales(a);n.push(c?c.amount:0),r.push(l)}}this.goalsChart&&this.goalsChart.destroy();const c=getComputedStyle(document.documentElement).getPropertyValue("--primary-color")||"#dc3545";this.goalsChart=new Chart(e,{type:"bar",data:{labels:s,datasets:[{label:"Meta",data:n,backgroundColor:c.replace("rgb","rgba").replace(")",", 0.6)"),borderColor:c,borderWidth:2},{label:"Vendas",data:r,backgroundColor:"#28a745",borderColor:"#28a745",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{font:{size:14,weight:"bold"},padding:15,usePointStyle:!0,pointStyle:"circle"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",padding:12,titleFont:{size:14,weight:"bold"},bodyFont:{size:13,weight:"600"},callbacks:{label:function(e){return e.dataset.label+": R$ "+e.parsed.y.toFixed(2).replace(".",",")}}}},elements:{bar:{borderWidth:3,borderRadius:4}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"R$ "+e.toFixed(0)},font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{color:"rgba(0, 0, 0, 0.08)",lineWidth:1}},x:{ticks:{font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{display:!1}}}}})}updateCostsChart(){const e=document.getElementById("costsChart");if(!e)return;if("undefined"==typeof Chart)return void console.warn("Chart.js n√£o est√° dispon√≠vel ainda");const t={};this.costs.forEach(e=>{const o=new Date(e.date),a=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`;t[a]||(t[a]={total:0,count:0}),t[a].total+=e.total||0,t[a].count+=1});const o=new Date,a=[],s=[],n=[];for(let e=5;e>=0;e--){const r=new Date(o.getFullYear(),o.getMonth()-e,1),i=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`,c=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];a.push(`${c[r.getMonth()]}/${String(r.getFullYear()).slice(-2)}`);const l=t[i]||{total:0,count:0};s.push(l.total),n.push(l.count)}this.costsChart&&this.costsChart.destroy();const r=getComputedStyle(document.documentElement).getPropertyValue("--primary-color")||"#dc3545";this.costsChart=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Valor Total",data:s,backgroundColor:r.replace("rgb","rgba").replace(")",", 0.6)"),borderColor:r,borderWidth:2,yAxisID:"y"},{label:"Quantidade de Compras",data:n,backgroundColor:"#ffc107",borderColor:"#ffc107",borderWidth:2,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{font:{size:14,weight:"bold"},padding:15,usePointStyle:!0,pointStyle:"circle"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",padding:12,titleFont:{size:14,weight:"bold"},bodyFont:{size:13,weight:"600"},callbacks:{label:function(e){return 0===e.datasetIndex?e.dataset.label+": R$ "+e.parsed.y.toFixed(2).replace(".",","):e.dataset.label+": "+e.parsed.y+" compras"}}}},elements:{bar:{borderWidth:3,borderRadius:4}},scales:{y:{beginAtZero:!0,position:"left",ticks:{callback:function(e){return"R$ "+e.toFixed(0)},font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{color:"rgba(0, 0, 0, 0.08)",lineWidth:1}},y1:{beginAtZero:!0,position:"right",ticks:{font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{drawOnChartArea:!1}},x:{ticks:{font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{display:!1}}}}})}updateServicesChart(){const e=document.getElementById("servicesChart");if(!e)return;if("undefined"==typeof Chart)return void console.warn("Chart.js n√£o est√° dispon√≠vel ainda");const t=document.getElementById("servicesYearFilter"),o=t?t.value:"";let a=this.serviceGroups;o&&""!==o&&(a=this.serviceGroups.filter(e=>{if(!e.month)return!1;const[t]=e.month.split("-");return t===o}));const s={};a.forEach(e=>{const t=e.month;s[t]||(s[t]={revenue:0,hours:0,minutes:0,count:0}),e.days.forEach(e=>{e.services.forEach(e=>{s[t].revenue+=e.price||0,s[t].hours+=e.hours||0,s[t].minutes+=e.minutes||0,s[t].count+=1})})});const n=[],r=[],i=[],c=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];if(o&&""!==o){const e=parseInt(o);for(let t=1;t<=12;t++){const o=`${e}-${String(t).padStart(2,"0")}`,a=s[o]||{revenue:0,hours:0,minutes:0,count:0};n.push(`${c[t-1]}/${String(e).slice(-2)}`),r.push(a.revenue);const l=a.hours+a.minutes/60;i.push(l)}}else{const e=new Date;for(let t=5;t>=0;t--){const o=new Date(e.getFullYear(),e.getMonth()-t,1),a=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`;n.push(`${c[o.getMonth()]}/${String(o.getFullYear()).slice(-2)}`);const l=s[a]||{revenue:0,hours:0,minutes:0,count:0};r.push(l.revenue);const d=l.hours+l.minutes/60;i.push(d)}}this.servicesChart&&this.servicesChart.destroy();const l=getComputedStyle(document.documentElement).getPropertyValue("--primary-color")||"#dc3545";this.servicesChart=new Chart(e,{type:"bar",data:{labels:n,datasets:[{label:"Faturamento",data:r,backgroundColor:"#28a745",borderColor:"#28a745",borderWidth:2,yAxisID:"y"},{label:"Horas Trabalhadas",data:i,backgroundColor:l.replace("rgb","rgba").replace(")",", 0.6)"),borderColor:l,borderWidth:2,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{font:{size:14,weight:"bold"},padding:15,usePointStyle:!0,pointStyle:"circle"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",padding:12,titleFont:{size:14,weight:"bold"},bodyFont:{size:13,weight:"600"},callbacks:{label:function(e){return 0===e.datasetIndex?e.dataset.label+": R$ "+e.parsed.y.toFixed(2).replace(".",","):e.dataset.label+": "+e.parsed.y.toFixed(1)+"h"}}}},elements:{bar:{borderWidth:3,borderRadius:4}},scales:{y:{beginAtZero:!0,position:"left",ticks:{callback:function(e){return"R$ "+e.toFixed(0)},font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{color:"rgba(0, 0, 0, 0.08)",lineWidth:1}},y1:{beginAtZero:!0,position:"right",ticks:{callback:function(e){return e.toFixed(1)+"h"},font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{drawOnChartArea:!1}},x:{ticks:{font:{size:12,weight:"600"},color:"rgba(0, 0, 0, 0.8)"},grid:{display:!1}}}}})}calculateTotalCosts(){let e=this.costs.reduce((e,t)=>e+(t.total||0),0);return this.groups.forEach(t=>{t.days.forEach(t=>{t.sales.forEach(t=>{const o=this.items.find(e=>e.id===t.itemId);o&&o.cost&&o.cost>0&&(e+=o.cost*(t.quantity||1))})})}),e}updateOverallSummary(){const e=this.calculateTotalAllMonths(),t=this.calculateTotalCosts(),o=e.totalValue-t,a=document.getElementById("overallTotalCosts"),s=document.getElementById("overallNetProfit");a&&(a.textContent=`R$ ${t.toFixed(2).replace(".",",")}`),s&&(s.textContent=`R$ ${o.toFixed(2).replace(".",",")}`,s.style.color=o<0?"#dc3545":"#155724"),this.updateAvgStockChart(),this.updateRestockSuggestions()}getSKU(e,t=""){return t?`${e}_${t}`:e}calculateAvgStockByMonth(){const e={};return this.groups.forEach(t=>{const o=t.month;e[o]||(e[o]={});const a={};t.days.forEach(e=>{e.stock||(e.stock={}),e.sales||(e.sales=[]),Object.keys(e.stock).forEach(t=>{const o=this.items.find(e=>e.id===t);if(o&&"Roupas"===o.category&&o.size){const s=this.getSKU(t,o.size);a[s]||(a[s]={itemId:t,size:o.size,stockValues:[],sold:0}),a[s].stockValues.push(e.stock[t]||0)}else{const o=this.getSKU(t);a[o]||(a[o]={itemId:t,size:"",stockValues:[],sold:0}),a[o].stockValues.push(e.stock[t]||0)}}),e.sales.forEach(e=>{const t=this.items.find(t=>t.id===e.itemId);if(t&&"Roupas"===t.category&&t.size){const o=this.getSKU(e.itemId,t.size);a[o]&&(a[o].sold+=e.quantity)}else{const t=this.getSKU(e.itemId);a[t]&&(a[t].sold+=e.quantity)}})}),Object.keys(a).forEach(t=>{const s=a[t],n=s.stockValues.length>0?s.stockValues.reduce((e,t)=>e+t,0)/s.stockValues.length:0;e[o][t]||(e[o][t]={itemId:s.itemId,size:s.size,avgStock:0,totalSold:0}),e[o][t].avgStock=Math.round(n),e[o][t].totalSold+=s.sold})}),e}updateAvgStockChart(){const e=document.getElementById("avgStockChart");if(!e)return;if("undefined"==typeof Chart)return void console.warn("Chart.js n√£o est√° dispon√≠vel ainda");const t=this.calculateAvgStockByMonth(),o=Object.keys(t).sort();if(0===o.length){const t=e.getContext("2d");return t&&t.clearRect(0,0,e.width,e.height),void(this.avgStockChart&&(this.avgStockChart.destroy(),this.avgStockChart=null))}const a=o.map(e=>Object.values(t[e]).reduce((e,t)=>e+t.avgStock,0)),s=o.map(e=>{const[t,o]=e.split("-");return`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(o)-1]}/${t.slice(-2)}`});this.avgStockChart&&this.avgStockChart.destroy();const n=getComputedStyle(document.documentElement).getPropertyValue("--primary-color")||"#dc3545";this.avgStockChart=new Chart(e,{type:"line",data:{labels:s,datasets:[{label:"M√©dia de Estoque",data:a,borderColor:n,backgroundColor:n.replace("rgb","rgba").replace(")",", 0.1)"),tension:.4,fill:!0,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:10,titleFont:{size:12},bodyFont:{size:11}}},scales:{y:{beginAtZero:!0,ticks:{precision:0,font:{size:10}},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{ticks:{font:{size:10}},grid:{display:!1}}}}})}updateRestockSuggestions(){const e=document.getElementById("restockSuggestions");if(!e)return;const t=this.calculateAvgStockByMonth(),o=[];Object.keys(t).forEach(e=>{const a=t[e];Object.keys(a).forEach(t=>{const s=a[t],n=this.items.find(e=>e.id===s.itemId);if(!n||"Servi√ßos"===n.category)return;const r=s.totalSold,i=s.avgStock;if(i<5||r>3&&i<1.5*r){const a=this.getItemName(s.itemId),n=i<3?"high":i<5?"medium":"low",c=Math.max(2*r,10);o.push({itemName:a,sku:t,currentStock:i,monthlySales:r,suggestedQty:c,priority:n,month:e})}})}),o.sort((e,t)=>{if(e.priority!==t.priority){const o={high:0,medium:1,low:2};return o[e.priority]-o[t.priority]}return e.currentStock-t.currentStock});const a=o.slice(0,10);0!==a.length?e.innerHTML=a.map(e=>{const t="high"===e.priority?"#dc3545":"medium"===e.priority?"#ffc107":"#28a745",o="high"===e.priority?"Urgente":"medium"===e.priority?"Aten√ß√£o":"Sugest√£o";return`\n                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 5px; border-left: 3px solid ${t};">\n                    <div style="flex: 1;">\n                        <strong style="font-size: 0.9rem;">${this.escapeHtml(e.itemName)}</strong>\n                        <div style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">\n                            Estoque atual: ${e.currentStock} un. | Vendas/m√™s: ${e.monthlySales} un.\n                        </div>\n                    </div>\n                    <div style="text-align: right;">\n                        <div style="font-size: 0.75rem; color: ${t}; font-weight: 600; margin-bottom: 0.25rem;">${o}</div>\n                        <div style="font-size: 0.85rem; color: var(--gray-700);">Sugerido: ${e.suggestedQty} un.</div>\n                    </div>\n                </div>\n            `}).join(""):e.innerHTML='<p style="color: var(--gray-500); font-size: 0.9rem; text-align: center; padding: 1rem;">Nenhuma sugest√£o de reposi√ß√£o no momento.</p>'}toggleDashboard(){const e=document.getElementById("dashboardTab"),t=document.getElementById("servicesDashboardTab"),o=e&&(e.classList.contains("active")||"block"===e.style.display);t&&(t.classList.contains("active")||"block"===t.style.display)?(this.currentDashboardType="sales",this.switchTab("dashboard"),this.updateDashboardButtonText("sales")):o?(this.currentDashboardType="services",this.switchTab("servicesDashboard"),this.updateDashboardButtonText("services")):(this.currentDashboardType="sales",this.switchTab("dashboard"),this.updateDashboardButtonText("sales"))}updateDashboardButtonText(e){const t=document.getElementById("dashboardToggleBtn");if(!t)return;const o=t.querySelector("i"),a=t.querySelector(".btn-text");"services"===e?(o&&(o.className="fas fa-chart-pie"),a&&(a.textContent="Dashboard Servi√ßos"),t.title="Dashboard Servi√ßos"):(o&&(o.className="fas fa-chart-line"),a&&(a.textContent="Dashboard Vendas"),t.title="Dashboard Vendas")}switchTab(e){const t=!0===window.TEST_MODE,o=!0===window.SUPPRESS_UI_WARNINGS;if(t||"salesPanel"!==e||setTimeout(()=>{this.renderLastReceiptsCarousel()},300),"adminPanel"===e){if(setTimeout(()=>{this.populateROIProductSelect()},100),"admin"!==sessionStorage.getItem("username"))return void console.warn("‚ö†Ô∏è [ADMIN] Acesso negado - apenas administradores");setTimeout(()=>{this.loadAdminData(),this.renderEcommerceSyncStatus(),this.renderMessageTemplates(),this.renderScheduledMessages(),this.renderMessageHistory()},200)}if(!e)return void console.warn("‚ö†Ô∏è [SWITCH TAB] Tab n√£o especificado");document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active"),e.style.display="none"});const a=document.querySelector(`[data-tab="${e}"]`);if(a)a.classList.add("active");else if("dashboard"===e||"servicesDashboard"===e){const e=document.getElementById("dashboardToggleBtn");e&&e.classList.add("active")}else o||console.warn(`‚ö†Ô∏è [SWITCH TAB] Bot√£o da aba "${e}" n√£o encontrado`);let s=document.getElementById(`${e}Tab`);s||"servicesDashboard"!==e||(s=document.getElementById("servicesDashboardTab")),s||"adminPanel"!==e||(s=document.getElementById("adminPanelTab"),"adminPanel"===e&&setTimeout(()=>{this.renderIntegrationsStatus(),this.renderPerformancePanel()},100)),s?(s.style.display="block",s.style.opacity="0",s.style.transform="translateX(10px)",s.classList.add("active"),s.offsetWidth,setTimeout(()=>{s.style.opacity="1",s.style.transform="translateX(0)"},5)):o||(console.warn(`‚ö†Ô∏è [SWITCH TAB] Conte√∫do da aba "${e}Tab" n√£o encontrado`),console.warn(`‚ö†Ô∏è [SWITCH TAB] Tentando encontrar elemento com ID: ${e}Tab`)),"dashboard"===e&&setTimeout(()=>{this.renderDashboard()},100),"servicesDashboard"===e&&setTimeout(()=>{this.renderServicesDashboard()},100),"goals"===e&&this.renderGoals(),"salesPanel"===e&&(this.renderGroups(),this.renderItems(),this.renderPendingOrders(),this.renderCosts()),"servicesPanel"===e&&(this.renderServiceAppointments(),this.renderServiceGroups(),this.updateServiceSummary(),setTimeout(()=>{this.updateServicesChart()},100))}getItemName(e){const t=this.items.find(t=>t.id===e);if(!t)return"Item n√£o encontrado";const o=t.category||"Roupas";if("Eletr√¥nicos"===o)return t.model||t.name||"Eletr√¥nico";if("Roupas"===o){let e;if(t.name)e=t.name;else{const o=[t.brand||""];t.style&&o.push(t.style),e=o.filter(e=>e).join(" - ")||"Roupa"}return t.size&&(e+=` ‚Äì tamanho ${t.size}`),e}return"Servi√ßos"===o?t.name||"Servi√ßo":t.name||"Item"}checkFirstTimeUser(){"admin"!==sessionStorage.getItem("username")&&(localStorage.getItem("hasSeenTutorial")||setTimeout(()=>{this.openTutorialModal()},2e3))}openTutorialModal(){if("admin"===sessionStorage.getItem("username")){const e=document.getElementById("tutorialModal");return void(e&&(e.classList.remove("active"),e.style.display="none"))}const e=document.getElementById("tutorialModal");if(!e)return;e.style.display="flex";const t=document.getElementById("tutorialContent");t&&(t.innerHTML='\n                <div style="line-height: 1.8; color: var(--gray-700);">\n                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Bem-vindo ao Sistema de Gest√£o Financeira!</h3>\n                    \n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üì¶ Cadastro de Produtos</h4>\n                        <p>Cadastre seus produtos (Roupas, Eletr√¥nicos ou Servi√ßos) atrav√©s do bot√£o "Novo Produto". Para produtos f√≠sicos, um <strong>QR Code exclusivo com c√≥digo num√©rico de 9 d√≠gitos</strong> ser√° gerado automaticamente para cada item.</p>\n                        <p style="margin-top: 0.5rem;"><strong>üí° Dica:</strong> O sistema valida automaticamente os campos e mostra mensagens de erro ou sucesso para facilitar o cadastro.</p>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üì± QR Code - Sistema Exclusivo</h4>\n                        <p><strong>1. Gera√ß√£o autom√°tica de QR Code:</strong></p>\n                        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">\n                            <li>Cadastre um produto f√≠sico (Roupas ou Eletr√¥nicos)</li>\n                            <li>O sistema gera automaticamente um <strong>c√≥digo num√©rico exclusivo de 9 d√≠gitos</strong> (usando apenas n√∫meros de 1 a 9)</li>\n                            <li>Esse c√≥digo √© convertido em QR Code e armazenado no produto</li>\n                            <li>Ap√≥s salvar, o QR Code aparece no modal de edi√ß√£o</li>\n                            <li>Clique em "QR Code" no card do produto para visualizar, baixar ou imprimir</li>\n                        </ul>\n                        <p><strong>2. Realizar leitura do QR Code:</strong></p>\n                        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">\n                            <li>V√° em "Grupos Mensais" e abra um m√™s</li>\n                            <li>Clique em "Adicionar Venda" em um dia espec√≠fico</li>\n                            <li>Clique no bot√£o <i class="fas fa-qrcode"></i> ao lado do campo "Item"</li>\n                            <li>Permita o acesso √† c√¢mera quando solicitado</li>\n                            <li>Aponte a c√¢mera para o QR Code do produto</li>\n                            <li>O sistema identifica o produto pelo c√≥digo num√©rico e seleciona automaticamente</li>\n                            <li>Se a permiss√£o for negada, voc√™ pode fechar o scanner e tentar novamente</li>\n                        </ul>\n                        <p><strong>3. Como a leitura impacta o sistema:</strong></p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>O produto √© identificado pelo c√≥digo num√©rico exclusivo</li>\n                            <li>O estoque √© atualizado automaticamente quando voc√™ registra a venda</li>\n                            <li>As estat√≠sticas de vendas s√£o atualizadas em tempo real</li>\n                            <li>Facilita o controle de estoque e vendas no caixa</li>\n                            <li>Reduz erros de digita√ß√£o e acelera o processo de venda</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üìä Grupos Mensais</h4>\n                        <p>Crie grupos mensais para organizar suas vendas por m√™s. Cada grupo permite:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Registrar vendas por dia (o dia √© automaticamente definido quando voc√™ abre o modal)</li>\n                            <li>Gerenciar estoque inicial e acompanhar vendas</li>\n                            <li>Visualizar estat√≠sticas do per√≠odo</li>\n                            <li>Ver sugest√µes de reposi√ß√£o de estoque baseadas nas vendas</li>\n                            <li>Consultar gr√°fico de m√©dia de estoque por SKU</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üíº Servi√ßos</h4>\n                        <p>Cadastre servi√ßos (aulas, consultorias, etc.) e registre as horas trabalhadas por m√™s. O sistema oferece:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Cadastro de servi√ßos com horas e minutos padr√£o</li>\n                            <li>Registro mensal de servi√ßos prestados</li>\n                            <li>C√°lculo autom√°tico de faturamento e estat√≠sticas</li>\n                            <li>Indicadores: valor m√©dio por hora, m√©dia de horas por servi√ßo</li>\n                            <li>Gr√°ficos de evolu√ß√£o de horas e faturamento</li>\n                            <li>Dashboard dedicado para servi√ßos (alterna com Dashboard de Vendas)</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üìà Dashboards</h4>\n                        <p>Visualize gr√°ficos e estat√≠sticas detalhadas:</p>\n                        <ul style="margin-left: 1.5rem; margin-bottom: 0.5rem;">\n                            <li><strong>Dashboard de Vendas:</strong> Gr√°ficos de vendas, lucro, estoque, e evolu√ß√£o mensal</li>\n                            <li><strong>Dashboard de Servi√ßos:</strong> Gr√°ficos de horas trabalhadas, faturamento e top servi√ßos</li>\n                            <li>Use o bot√£o "Dashboard" para alternar entre Vendas e Servi√ßos</li>\n                            <li>Filtros por per√≠odo (√∫ltimo m√™s, 3 meses, 6 meses, ano)</li>\n                        </ul>\n                        <p style="margin-top: 0.5rem;"><strong>üìä Gr√°ficos nos Resumos:</strong></p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li><strong>Resumo Geral:</strong> Gr√°fico de m√©dia de estoque por SKU e sugest√µes de reposi√ß√£o</li>\n                            <li><strong>Resumo de Custos:</strong> Gr√°fico de evolu√ß√£o de custos por m√™s (valor total e quantidade de compras)</li>\n                            <li><strong>Resumo de Servi√ßos:</strong> Gr√°fico de evolu√ß√£o de servi√ßos por m√™s (faturamento e horas trabalhadas)</li>\n                            <li><strong>Resumo de Metas:</strong> Gr√°fico comparativo de metas vs vendas</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üéØ Metas</h4>\n                        <p>Defina metas mensais de vendas e acompanhe seu progresso:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Crie metas por m√™s/ano</li>\n                            <li>Visualize o progresso em tempo real</li>\n                            <li>Gr√°fico comparativo de metas vs vendas reais</li>\n                            <li>Estat√≠sticas de cumprimento de metas</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üí∞ Custos de Compra</h4>\n                        <p>Registre os custos de compra dos produtos:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Cadastre custos por produto e data</li>\n                            <li>Acompanhe o valor total de custos</li>\n                            <li>Visualize gr√°fico de evolu√ß√£o de custos por m√™s</li>\n                            <li>Compare custos com vendas para calcular lucro</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üõí Pedidos Pendentes</h4>\n                        <p>Gerencie pedidos que ainda n√£o foram pagos:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Acesse pelo <strong>Painel de Vendas</strong> ‚Üí Se√ß√£o "Pedidos Pendentes"</li>\n                            <li>Crie pedidos pendentes com nome do cliente, CPF, itens e valor total</li>\n                            <li>Adicione m√∫ltiplos itens ao pedido</li>\n                            <li>Defina status: Pendente, Confirmado ou Cancelado</li>\n                            <li>Configure data de vencimento para acompanhamento</li>\n                            <li>Edite ou exclua pedidos pendentes a qualquer momento</li>\n                            <li><strong>Finalizar Pedido:</strong> Converta um pedido pendente em venda conclu√≠da quando o pagamento for realizado</li>\n                            <li>Ap√≥s finalizar, um recibo √© gerado automaticamente</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üìÖ Agenda de Servi√ßos</h4>\n                        <p>Organize seus agendamentos de servi√ßos:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Acesse pelo <strong>Painel de Servi√ßos</strong> ‚Üí Se√ß√£o "Agenda de Servi√ßos"</li>\n                            <li>Cadastre agendamentos com tipo de servi√ßo, cliente, data, hor√°rio e pre√ßo</li>\n                            <li>Adicione contato do cliente (telefone ou e-mail) e observa√ß√µes</li>\n                            <li>Controle status: Pendente, Confirmado, Conclu√≠do ou Cancelado</li>\n                            <li>Visualize agendamentos futuros e passados separadamente</li>\n                            <li>Agendamentos futuros s√£o ordenados por data/hora (mais pr√≥ximos primeiro)</li>\n                            <li>Agendamentos passados s√£o ordenados por data/hora (mais recentes primeiro)</li>\n                            <li>Edite ou exclua agendamentos conforme necess√°rio</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">üßæ Preview de Recibo</h4>\n                        <p>Visualize e imprima recibos de vendas:</p>\n                        <ul style="margin-left: 1.5rem;">\n                            <li>Ap√≥s registrar uma venda ou finalizar um pedido pendente, um <strong>preview de recibo</strong> √© exibido automaticamente</li>\n                            <li>O recibo mostra: nome do cliente, CPF, itens comprados, quantidade, valor total, data/hora e c√≥digo do pedido</li>\n                            <li>Use o bot√£o "Imprimir" para imprimir o recibo diretamente</li>\n                            <li>O c√≥digo do pedido √© gerado automaticamente no formato: <strong>PED-YYYYMMDD-XXXX</strong></li>\n                            <li>Todos os recibos s√£o salvos no hist√≥rico de vendas conclu√≠das</li>\n                        </ul>\n                    </div>\n\n                    <div style="margin-bottom: 2rem;">\n                        <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">‚ú® Melhorias e Recursos</h4>\n                        <ul style="margin-left: 1.5rem;">\n                            <li><strong>Feedback Visual:</strong> Mensagens de sucesso/erro, estados de loading nos bot√µes</li>\n                            <li><strong>Valida√ß√µes:</strong> Valida√ß√£o autom√°tica de campos com feedback visual</li>\n                            <li><strong>Acessibilidade:</strong> Navega√ß√£o por teclado, leitores de tela, contraste adequado</li>\n                            <li><strong>Responsividade:</strong> Interface adaptada para desktop, tablet e mobile</li>\n                            <li><strong>Sugest√µes de Reposi√ß√£o:</strong> Sistema identifica produtos com estoque baixo baseado nas vendas</li>\n                            <li><strong>SKU Inteligente:</strong> Para roupas, combina produto + tamanho para controle preciso</li>\n                            <li><strong>Armazenamento na Nuvem:</strong> Dados sincronizados via JSONBin para acesso de qualquer dispositivo</li>\n                            <li><strong>Tema Personalizado:</strong> Escolha entre tema vermelho ou azul, salvo por usu√°rio</li>\n                        </ul>\n                    </div>\n\n                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 5px; border-left: 3px solid #007bff;">\n                        <p style="margin: 0;"><strong>üí° Dica:</strong> Use o bot√£o "Iniciar Tutorial Interativo" abaixo para ver um guia passo a passo com bal√µes explicativos em cada funcionalidade!</p>\n                    </div>\n                </div>\n            ');const o=document.getElementById("loading-overlay");o&&o.classList.contains("active")&&(o.classList.remove("active"),o.style.display="none"),e.style.display="flex",e.classList.add("active"),"undefined"!=typeof window&&(window.app=this),e.style.zIndex="10003",e.style.pointerEvents="auto",setTimeout(()=>{const t=e.querySelector(".close"),o=document.getElementById("closeTutorialBtn");if(t){const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",e=>{console.log("üü¢ [TUTORIAL] Bot√£o X clicado (re-anexado)"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}),e.onclick=e=>{console.log("üü¢ [TUTORIAL] Bot√£o X (onclick) clicado (re-anexado)"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}}if(o){const e=o.cloneNode(!0);o.parentNode.replaceChild(e,o),e.addEventListener("click",e=>{console.log("üü¢ [TUTORIAL] Bot√£o Fechar clicado (re-anexado)"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}),e.onclick=e=>{console.log("üü¢ [TUTORIAL] Bot√£o Fechar (onclick) clicado (re-anexado)"),e.preventDefault(),e.stopPropagation(),this.closeTutorialModal()}}const a=e.querySelector(".close");a&&a.focus()},100)}closeTutorialModal(){console.log("üî¥ [TUTORIAL] closeTutorialModal() chamado");const e=document.getElementById("tutorialModal");if(e){console.log("üî¥ [TUTORIAL] Modal encontrado, fechando..."),e.classList.remove("active"),e.style.display="none",e.style.opacity="0",e.style.visibility="hidden",e.style.pointerEvents="none",e.style.zIndex="-1";const t=e.querySelector(".modal-content");t&&(t.style.display="none"),localStorage.setItem("hasSeenTutorial","true"),console.log("‚úÖ [TUTORIAL] Modal fechado com sucesso")}else console.error("‚ùå [TUTORIAL] Modal n√£o encontrado!")}startInteractiveTutorial(){this.closeTutorialModal(),this.tutorialActive=!0,this.tutorialStep=0,localStorage.setItem("hasSeenTutorial","true"),this.showTutorialStep(0)}skipTutorial(){this.closeTutorialTooltip(),localStorage.setItem("hasSeenTutorial","true"),this.tutorialActive=!1}closeTutorialTooltip(){const e=document.getElementById("tutorialOverlay"),t=document.getElementById("tutorialTooltip");e&&(e.style.display="none"),t&&(t.style.display="none"),this.tutorialActive=!1}nextTutorialStep(){this.tutorialStep<this.getTutorialSteps().length-1?(this.tutorialStep++,this.showTutorialStep(this.tutorialStep)):(this.closeTutorialTooltip(),alert("üéâ Tutorial conclu√≠do! Voc√™ j√° conhece as principais funcionalidades do sistema."))}prevTutorialStep(){this.tutorialStep>0&&(this.tutorialStep--,this.showTutorialStep(this.tutorialStep))}getTutorialSteps(){return[{title:"Bem-vindo!",content:'Este √© um tutorial interativo que vai te mostrar as principais funcionalidades do sistema. Clique em "Pr√≥ximo" para continuar.',target:null,position:"center"},{title:"Cadastro de Produtos",content:'Clique em "Novo Produto" para cadastrar seus itens. Voc√™ pode cadastrar Roupas, Eletr√¥nicos ou Servi√ßos. Para produtos f√≠sicos, um QR Code exclusivo com c√≥digo num√©rico de 9 d√≠gitos ser√° gerado automaticamente.',target:"newItemBtn",position:"bottom"},{title:"QR Code Exclusivo - Cadastro",content:'Ap√≥s cadastrar um produto f√≠sico, o sistema gera automaticamente um c√≥digo num√©rico exclusivo de 9 d√≠gitos (1-9) e converte em QR Code. Voc√™ ver√° um bot√£o "QR Code" no card. Clique nele para visualizar, baixar ou imprimir o QR Code do produto.',target:null,position:"center"},{title:"Grupos Mensais",content:'Use "Grupo Mensal" para criar um m√™s de vendas. Depois, abra o m√™s para registrar vendas por dia.',target:"newGroupBtn",position:"bottom"},{title:"QR Code - Leitura",content:'Ao adicionar uma venda, clique no bot√£o de QR Code ao lado do campo "Item" para escanear o c√≥digo num√©rico do produto. O sistema identifica o produto pelo c√≥digo de 9 d√≠gitos, seleciona automaticamente e atualiza o estoque quando voc√™ registra a venda.',target:null,position:"center"},{title:"Dashboards",content:'Visualize gr√°ficos e estat√≠sticas detalhadas. Use o bot√£o "Dashboard" para alternar entre Dashboard de Vendas (gr√°ficos de vendas, lucro, estoque) e Dashboard de Servi√ßos (horas trabalhadas, faturamento, top servi√ßos). Cada resumo tamb√©m tem gr√°ficos espec√≠ficos.',target:"dashboardToggleBtn",position:"bottom"},{title:"Servi√ßos",content:'Na aba "Servi√ßos", voc√™ pode cadastrar meses de servi√ßos e registrar horas trabalhadas. O sistema calcula automaticamente faturamento, valor m√©dio por hora e m√©dia de horas por servi√ßo. Visualize gr√°ficos de evolu√ß√£o no resumo.',target:null,position:"center"},{title:"Metas",content:'Defina metas mensais de vendas na aba "Metas" e acompanhe seu progresso em tempo real. O sistema mostra um gr√°fico comparativo de metas vs vendas reais nos √∫ltimos 6 meses.',target:null,position:"center"},{title:"Custos",content:'Registre os custos de compra dos produtos na aba "Custos". Visualize gr√°ficos de evolu√ß√£o de custos por m√™s no resumo, mostrando valor total e quantidade de compras.',target:null,position:"center"},{title:"Pedidos Pendentes",content:'No Painel de Vendas, use "Pedidos Pendentes" para gerenciar vendas que ainda n√£o foram pagas. Crie pedidos com m√∫ltiplos itens, defina status e data de vencimento. Quando o pagamento for realizado, finalize o pedido para convert√™-lo em venda conclu√≠da e gerar o recibo automaticamente.',target:null,position:"center"},{title:"Agenda de Servi√ßos",content:'No Painel de Servi√ßos, use "Agenda de Servi√ßos" para organizar seus agendamentos. Cadastre clientes, escolha o tipo de servi√ßo, defina data/hor√°rio, pre√ßo e status. Visualize agendamentos futuros e passados separadamente, ordenados automaticamente.',target:null,position:"center"},{title:"Preview de Recibo",content:'Ap√≥s registrar uma venda ou finalizar um pedido pendente, um preview de recibo √© exibido automaticamente mostrando todos os detalhes da compra. Use o bot√£o "Imprimir" para imprimir o recibo. O c√≥digo do pedido √© gerado automaticamente no formato PED-YYYYMMDD-XXXX.',target:null,position:"center"},{title:"Feedback e Valida√ß√µes",content:"O sistema mostra mensagens de sucesso/erro, estados de loading nos bot√µes durante opera√ß√µes, e valida automaticamente os campos com feedback visual. Isso facilita o uso e reduz erros.",target:null,position:"center"}]}showTutorialStep(e){const t=this.getTutorialSteps(),o=t[e];if(!o)return;const a=document.getElementById("tutorialOverlay"),s=document.getElementById("tutorialTooltip"),n=document.getElementById("tutorialTooltipContent"),r=document.getElementById("tutorialPrevBtn"),i=document.getElementById("tutorialNextBtn");if(!a||!s||!n)return;a.style.display="block";const c=s.querySelector("h3");if(c&&(c.textContent=o.title),n.innerHTML=o.content,o.target){const e=document.getElementById(o.target);if(e){const t=e.getBoundingClientRect();let a,n;switch(o.position){case"bottom":a=t.bottom+20,n=t.left+t.width/2-175;break;case"top":a=t.top-200,n=t.left+t.width/2-175;break;case"right":a=t.top,n=t.right+20;break;case"left":a=t.top,n=t.left-370;break;default:a=window.innerHeight/2-100,n=window.innerWidth/2-175}a=Math.max(20,Math.min(a,window.innerHeight-300)),n=Math.max(20,Math.min(n,window.innerWidth-370)),s.style.top=a+"px",s.style.left=n+"px"}else s.style.top=window.innerHeight/2-100+"px",s.style.left=window.innerWidth/2-175+"px"}else s.style.top=window.innerHeight/2-100+"px",s.style.left=window.innerWidth/2-175+"px";if(r&&(r.disabled=0===e,r.style.opacity=0===e?"0.5":"1"),i){const o=e===t.length-1;i.textContent=o?"Concluir":"Pr√≥ximo"}if(s.style.display="block",o.target){const e=document.getElementById(o.target);e&&(e.style.transition="all 0.3s",e.style.transform="scale(1.05)",e.style.zIndex="10000",e.style.position="relative",setTimeout(()=>{e&&(e.style.transform="")},500))}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}parsePrice(e){if(!e)return 0;const t=String(e).trim().replace(",","."),o=parseFloat(t);return isNaN(o)?0:o}closeViewGroupModal(){console.log("üîß [CLOSE VIEW GROUP] Fechando viewGroupModal");const e=document.getElementById("viewGroupModal");if(e){e.style.opacity="",e.style.pointerEvents="",e.style.zIndex="",e.style.display="";const t=e.querySelector(".close");t&&(t.style.pointerEvents="auto",t.style.opacity="1",t.style.zIndex="1001"),e.querySelectorAll("button").forEach(e=>{e.style.pointerEvents="auto",e.style.opacity="1"});const o=e.querySelector(".modal-content");o&&(o.style.zIndex="",o.style.pointerEvents=""),e.style.opacity="0",setTimeout(()=>{e.classList.remove("active"),e.style.display="none",e.style.opacity=""},300)}this.currentGroup=null,console.log("‚úÖ [CLOSE VIEW GROUP] viewGroupModal fechado")}closeAllModals(){document.querySelectorAll(".modal").forEach(e=>e.classList.remove("active")),this.currentEditingItem=null,this.currentGroup=null,this.currentSaleDay=null,this.currentEditingCost=null,this.currentEditingGoal=null}charts={salesByMonth:null,profitVsCosts:null,topItems:null,profitEvolution:null,stockConsumption:null,stockRotation:null};servicesCharts={hoursByMonth:null,revenueByMonth:null,topServices:null,hoursEvolution:null,avgHoursPerDay:null,avgValuePerHour:null};renderDashboard(){if(console.log("üìä [DASHBOARD] ========== INICIANDO RENDERIZA√á√ÉO DO DASHBOARD =========="),console.log("üìä [DASHBOARD] Verificando Chart.js..."),console.log("üìä [DASHBOARD] typeof Chart:",typeof Chart),console.log("üìä [DASHBOARD] window.chartJsLoaded:",window.chartJsLoaded),"undefined"==typeof Chart||!1===window.chartJsLoaded)return console.warn("‚ö†Ô∏è [DASHBOARD] Chart.js n√£o est√° carregado ainda, aguardando..."),void setTimeout(()=>{if("undefined"!=typeof Chart)console.log("‚úÖ [DASHBOARD] Chart.js carregado, renderizando gr√°ficos..."),this.renderDashboard();else if(console.error("‚ùå [DASHBOARD] Chart.js n√£o est√° dispon√≠vel ap√≥s aguardar. Verifique se o CDN est√° acess√≠vel."),document.querySelector('script[src*="chart.js"]'))console.log("‚è≥ [DASHBOARD] Script Chart.js j√° existe, aguardando carregamento..."),setTimeout(()=>{"undefined"!=typeof Chart?(console.log("‚úÖ [DASHBOARD] Chart.js carregado ap√≥s espera, renderizando..."),this.renderDashboard()):console.error("‚ùå [DASHBOARD] Chart.js ainda n√£o est√° dispon√≠vel ap√≥s 1.5s")},1e3);else{console.log("üîÑ [DASHBOARD] Tentando carregar Chart.js manualmente...");const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js",e.onload=()=>{window.chartJsLoaded=!0,console.log("‚úÖ [DASHBOARD] Chart.js carregado manualmente, renderizando..."),this.renderDashboard()},e.onerror=()=>{console.error("‚ùå [DASHBOARD] Erro ao carregar Chart.js do CDN")},document.head.appendChild(e)}},500);console.log("‚úÖ [DASHBOARD] Chart.js est√° dispon√≠vel!"),console.log("üìä [DASHBOARD] Renderizando dashboard..."),console.log("üìä [DASHBOARD] Groups:",this.groups.length),console.log("üìä [DASHBOARD] Costs:",this.costs.length),console.log("üìä [DASHBOARD] Items:",this.items.length),Object.values(this.charts).forEach(e=>{e&&e.destroy()}),this.renderSalesByMonthChart(),this.renderProfitVsCostsChart(),this.renderTopItemsChart(),this.renderProfitEvolutionChart(),this.renderStockConsumptionChart(),this.renderStockRotationChart(),this.updateDashboardStats()}getFilteredData(){const e=document.getElementById("periodFilter")?.value||"all",t=new Date;let o=null;switch(e){case"month":o=new Date(t.getFullYear(),t.getMonth()-1,t.getDate());break;case"3months":o=new Date(t.getFullYear(),t.getMonth()-3,t.getDate());break;case"6months":o=new Date(t.getFullYear(),t.getMonth()-6,t.getDate());break;case"year":o=new Date(t.getFullYear()-1,t.getMonth(),t.getDate())}let a=this.groups;return o&&(a=this.groups.filter(e=>{const[t,a]=e.month.split("-");return new Date(parseInt(t),parseInt(a)-1,1)>=o})),a}renderSalesByMonthChart(){if(console.log("üìä [CHART] Iniciando renderSalesByMonthChart..."),"undefined"==typeof Chart)return void console.error("‚ùå [CHART] Chart.js n√£o est√° dispon√≠vel para renderSalesByMonthChart");console.log("‚úÖ [CHART] Chart.js est√° dispon√≠vel");const e=document.getElementById("salesByMonthChart");if(!e)return void console.error("‚ùå [CHART] Canvas salesByMonthChart n√£o encontrado");console.log("‚úÖ [CHART] Canvas salesByMonthChart encontrado");const t=e.getBoundingClientRect();if(console.log(`üìè [CHART] Dimens√µes do canvas: width=${t.width}px, height=${t.height}px`),console.log(`üìè [CHART] Canvas offsetWidth: ${e.offsetWidth}, offsetHeight: ${e.offsetHeight}`),0===t.width||0===t.height){console.warn("‚ö†Ô∏è [CHART] Canvas tem dimens√µes zero! Tentando for√ßar dimens√µes...");const t=e.parentElement;if(t){const e=t.getBoundingClientRect();console.log(`üìè [CHART] Dimens√µes do parent: width=${e.width}px, height=${e.height}px`)}}const o=this.getFilteredData();console.log(`üìä [CHART] Grupos filtrados: ${o.length}`);const a={};o.forEach(e=>{const t=`${e.month.split("-")[1]}/${e.month.split("-")[0]}`;a[t]||(a[t]={sales:0,value:0}),e.days.forEach(e=>{e.sales.forEach(e=>{a[t].sales+=e.quantity,a[t].value+=this.getSaleTotalValue(e)})})});const s=Object.keys(a).sort((e,t)=>{const[o,a]=e.split("/").map(Number),[s,n]=t.split("/").map(Number);return a===n?o-s:a-n}),n=s.map(e=>a[e].sales),r=s.map(e=>a[e].value);if(console.log(`üìä [CHART] Labels: ${s.join(", ")}`),console.log(`üìä [CHART] Sales Data: ${n.join(", ")}`),console.log(`üìä [CHART] Values Data: ${r.join(", ")}`),0===s.length)return console.warn("‚ö†Ô∏è [CHART] Nenhum dado para renderizar, limpando canvas"),void e.getContext("2d").clearRect(0,0,e.width,e.height);console.log("üìä [CHART] Criando gr√°fico Chart.js..."),this.charts.salesByMonth&&(console.log("üîÑ [CHART] Destruindo gr√°fico anterior"),this.charts.salesByMonth.destroy());try{this.charts.salesByMonth=new Chart(e,{type:"line",data:{labels:s,datasets:[{label:"Quantidade de Vendas",data:n,borderColor:"#dc3545",backgroundColor:"rgba(220, 53, 69, 0.1)",tension:.4},{label:"Valor (R$)",data:r,borderColor:"#28a745",backgroundColor:"rgba(40, 167, 69, 0.1)",tension:.4,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:2,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Quantidade"}},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"Valor (R$)"},grid:{drawOnChartArea:!1}}}}}),console.log("‚úÖ [CHART] Gr√°fico salesByMonth criado com sucesso!"),console.log("üìä [CHART] Chart instance:",this.charts.salesByMonth),setTimeout(()=>{const e=document.getElementById("salesByMonthChart");if(e){const t=e.getBoundingClientRect();console.log(`üìè [CHART] Dimens√µes ap√≥s cria√ß√£o: width=${t.width}px, height=${t.height}px`),console.log(`üìè [CHART] Canvas width/height attributes: ${e.width}x${e.height}`);const o=this.charts.salesByMonth;o&&(console.log(`üìä [CHART] Chart width: ${o.width}, height: ${o.height}`),console.log(`üìä [CHART] Chart canvas width: ${o.canvas.width}, height: ${o.canvas.height}`))}},100)}catch(e){console.error("‚ùå [CHART] Erro ao criar gr√°fico salesByMonth:",e),console.error("‚ùå [CHART] Erro stack:",e.stack)}}renderProfitVsCostsChart(){if("undefined"==typeof Chart)return void console.warn("‚ö†Ô∏è [CHART] Chart.js n√£o est√° dispon√≠vel para renderProfitVsCostsChart");const e=document.getElementById("profitVsCostsChart");if(!e)return void console.warn("‚ö†Ô∏è [CHART] Canvas profitVsCostsChart n√£o encontrado");const t=this.getFilteredData(),o={};t.forEach(e=>{const t=`${e.month.split("-")[1]}/${e.month.split("-")[0]}`;o[t]||(o[t]={profit:0,costs:0,productCosts:0}),e.days.forEach(e=>{e.sales.forEach(e=>{const a=this.getSaleTotalValue(e);o[t].profit+=a;const s=this.items.find(t=>t.id===e.itemId);if(s&&s.cost&&s.cost>0){const a=s.cost*(e.quantity||1);o[t].productCosts+=a}})})}),this.costs.forEach(e=>{const t=new Date(e.date),a=`${t.getMonth()+1}/${t.getFullYear()}`;o[a]?o[a].costs+=e.total||0:o[a]={profit:0,costs:e.total||0,productCosts:0}}),Object.keys(o).forEach(e=>{o[e].costs+=o[e].productCosts});const a=Object.keys(o).sort((e,t)=>{const[o,a]=e.split("/").map(Number),[s,n]=t.split("/").map(Number);return a===n?o-s:a-n}),s=a.map(e=>o[e].profit),n=a.map(e=>o[e].costs||0);0!==a.length?this.charts.profitVsCosts=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Lucro (R$)",data:s,backgroundColor:"rgba(40, 167, 69, 0.7)",borderColor:"#28a745",borderWidth:1},{label:"Custos (R$)",data:n,backgroundColor:"rgba(255, 193, 7, 0.7)",borderColor:"#ffc107",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!0,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Valor (R$)"}}}}}):e.getContext("2d").clearRect(0,0,e.width,e.height)}renderTopItemsChart(){if("undefined"==typeof Chart)return void console.warn("‚ö†Ô∏è [CHART] Chart.js n√£o est√° dispon√≠vel para renderTopItemsChart");const e=document.getElementById("topItemsChart");if(!e)return void console.warn("‚ö†Ô∏è [CHART] Canvas topItemsChart n√£o encontrado");const t={};this.getFilteredData().forEach(e=>{e.days.forEach(e=>{e.sales.forEach(e=>{t[e.itemId]||(t[e.itemId]={quantity:0,name:this.getItemName(e.itemId)}),t[e.itemId].quantity+=e.quantity})})});const o=Object.entries(t).sort((e,t)=>t[1].quantity-e[1].quantity).slice(0,10);if(0===o.length)return void e.getContext("2d").clearRect(0,0,e.width,e.height);const a=o.map(([e,t])=>t.name.length>15?t.name.substring(0,15)+"...":t.name),s=o.map(([e,t])=>t.quantity);this.charts.topItems=new Chart(e,{type:"doughnut",data:{labels:a,datasets:[{data:s,backgroundColor:["#dc3545","#28a745","#ffc107","#17a2b8","#6f42c1","#e83e8c","#fd7e14","#20c997","#6610f2","#6c757d"]}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{position:"bottom"}}}})}renderProfitEvolutionChart(){if("undefined"==typeof Chart)return void console.warn("‚ö†Ô∏è [CHART] Chart.js n√£o est√° dispon√≠vel para renderProfitEvolutionChart");const e=document.getElementById("profitEvolutionChart");if(!e)return void console.warn("‚ö†Ô∏è [CHART] Canvas profitEvolutionChart n√£o encontrado");const t=this.getFilteredData(),o={};t.forEach(e=>{const t=`${e.month.split("-")[1]}/${e.month.split("-")[0]}`;o[t]||(o[t]={sales:0,costs:0,productCosts:0}),e.days.forEach(e=>{e.sales.forEach(e=>{o[t].sales+=this.getSaleTotalValue(e);const a=this.items.find(t=>t.id===e.itemId);if(a&&a.cost&&a.cost>0){const s=a.cost*(e.quantity||1);o[t].productCosts+=s}})})}),this.costs.forEach(e=>{const t=new Date(e.date),a=`${t.getMonth()+1}/${t.getFullYear()}`;o[a]?o[a].costs+=e.total||0:o[a]={sales:0,costs:e.total||0,productCosts:0}}),Object.keys(o).forEach(e=>{o[e].costs+=o[e].productCosts});const a=Object.keys(o).sort((e,t)=>{const[o,a]=e.split("/").map(Number),[s,n]=t.split("/").map(Number);return a===n?o-s:a-n}),s=a.map(e=>o[e].sales-(o[e].costs||0));0!==a.length?this.charts.profitEvolution=new Chart(e,{type:"line",data:{labels:a,datasets:[{label:"Lucro L√≠quido (R$)",data:s,borderColor:"#28a745",backgroundColor:"rgba(40, 167, 69, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!0,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Lucro (R$)"}}}}}):e.getContext("2d").clearRect(0,0,e.width,e.height)}updateDashboardStats(){const e=this.getFilteredData();let t=0,o=0;const a={};e.forEach(e=>{const s=`${e.month.split("-")[1]}/${e.month.split("-")[0]}`;a[s]||(a[s]=0,o++),e.days.forEach(e=>{e.sales.forEach(e=>{a[s]+=this.getSaleTotalValue(e),t+=this.getSaleTotalValue(e)})})});const s=o>0?t/o:0,n=document.getElementById("avgMonthlySales");if(n){const e=`R$ ${s.toFixed(2).replace(".",",")}`;n.textContent=e,n.setAttribute("title",e)}let r="-",i=0;Object.entries(a).forEach(([e,t])=>{t>i&&(i=t,r=e)});const c=document.getElementById("bestMonth");c&&(c.textContent="-"!==r?r:"-","-"!==r?c.setAttribute("title",r):c.removeAttribute("title"));let l=0;this.costs.forEach(e=>{l+=e.total||0});const d=t>0?(t-l)/t*100:0,m=document.getElementById("avgProfitMargin");if(m){const e=`${d.toFixed(1)}%`;m.textContent=e,m.setAttribute("title",e)}const u=document.getElementById("totalItemsCount");if(u){const e=this.items.length.toString();u.textContent=e,u.setAttribute("title",`Total: ${e} itens cadastrados`)}}updateGroupStockStats(e){if(!e)return;let t=0,o=0;const a={},s=[];e.days.forEach(e=>{e.stock||(e.stock={}),Object.keys(e.stock).forEach(t=>{a[t]||(a[t]={stock:0,sold:0}),a[t].stock=Math.max(a[t].stock,e.stock[t]||0)}),e.sales.forEach(e=>{a[e.itemId]||(a[e.itemId]={stock:0,sold:0}),a[e.itemId].sold+=e.quantity})}),Object.entries(a).forEach(([e,a])=>{t+=a.stock,o+=a.sold;const n=a.stock-a.sold,r=this.items.find(t=>t.id===e),i=r?.minStock||5;n<=i&&r&&s.push({name:this.getItemName(e),available:n,minStock:i})});const n=document.getElementById("groupStockTotal");n&&(n.textContent=`${t} un.`);const r=document.getElementById("groupStockSold");r&&(r.textContent=`${o} un.`);const i=document.getElementById("groupStockAvailable");if(i){const e=t-o;i.textContent=`${e} un.`,i.style.color=e<0?"#dc3545":0===e?"#ffc107":"#155724"}const c=document.getElementById("groupLowStockAlert"),l=document.getElementById("groupLowStockItems");c&&l&&(s.length>0?(c.style.display="block",l.innerHTML=s.map(e=>`<strong>${this.escapeHtml(e.name)}</strong>: ${e.available} un.`).join("<br>")):c.style.display="none")}renderStockConsumptionChart(){if("undefined"==typeof Chart)return void console.warn("‚ö†Ô∏è [CHART] Chart.js n√£o est√° dispon√≠vel para renderStockConsumptionChart");const e=document.getElementById("stockConsumptionChart");if(!e)return void console.warn("‚ö†Ô∏è [CHART] Canvas stockConsumptionChart n√£o encontrado");const t=this.getFilteredData(),o={};t.forEach(e=>{const t=`${e.month.split("-")[1]}/${e.month.split("-")[0]}`;o[t]||(o[t]=0),e.days.forEach(e=>{e.sales.forEach(e=>{o[t]+=e.quantity})})});const a=Object.keys(o).sort((e,t)=>{const[o,a]=e.split("/").map(Number),[s,n]=t.split("/").map(Number);return a===n?o-s:a-n}),s=a.map(e=>o[e]||0);0!==a.length?(this.charts.stockConsumption&&this.charts.stockConsumption.destroy(),this.charts.stockConsumption=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Quantidade Vendida (un.)",data:s,backgroundColor:"rgba(23, 162, 184, 0.7)",borderColor:"#17a2b8",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:2,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Quantidade (un.)"}}},plugins:{legend:{display:!0,position:"top"},tooltip:{enabled:!0,mode:"index",intersect:!1}}}})):e.getContext("2d").clearRect(0,0,e.width,e.height)}renderStockRotationChart(){if("undefined"==typeof Chart)return void console.warn("‚ö†Ô∏è [CHART] Chart.js n√£o est√° dispon√≠vel para renderStockRotationChart");const e=document.getElementById("stockRotationChart");if(!e)return void console.warn("‚ö†Ô∏è [CHART] Canvas stockRotationChart n√£o encontrado");const t={};this.getFilteredData().forEach(e=>{e.days.forEach(e=>{e.sales.forEach(e=>{t[e.itemId]||(t[e.itemId]={quantity:0,name:this.getItemName(e.itemId)}),t[e.itemId].quantity+=e.quantity})})});const o=Object.entries(t).sort((e,t)=>t[1].quantity-e[1].quantity).slice(0,10);if(0===o.length)return void e.getContext("2d").clearRect(0,0,e.width,e.height);const a=o.map(([e,t])=>t.name.length>20?t.name.substring(0,20)+"...":t.name),s=o.map(([e,t])=>t.quantity);this.charts.stockRotation&&this.charts.stockRotation.destroy(),this.charts.stockRotation=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Quantidade Vendida (un.)",data:s,backgroundColor:["rgba(220, 53, 69, 0.7)","rgba(40, 167, 69, 0.7)","rgba(255, 193, 7, 0.7)","rgba(23, 162, 184, 0.7)","rgba(111, 66, 193, 0.7)","rgba(232, 62, 140, 0.7)","rgba(253, 126, 20, 0.7)","rgba(32, 201, 151, 0.7)","rgba(102, 16, 242, 0.7)","rgba(108, 117, 125, 0.7)"],borderColor:["#dc3545","#28a745","#ffc107","#17a2b8","#6f42c1","#e83e8c","#fd7e14","#20c997","#6610f2","#6c757d"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:2,indexAxis:"y",scales:{x:{beginAtZero:!0,title:{display:!0,text:"Quantidade Vendida (un.)"}}},plugins:{legend:{display:!1},tooltip:{enabled:!0}}}})}logout(){if(confirm("Deseja realmente sair?")){sessionStorage.removeItem("loggedIn"),sessionStorage.removeItem("username");try{window.location.href="/index.html"}catch(e){console.error("Erro ao redirecionar:",e),window.location.href="index.html"}}}loadTheme(){const e=sessionStorage.getItem("username"),t=e?`appTheme_${e}`:"appTheme";"blue"===localStorage.getItem(t)?(document.body.classList.add("theme-blue"),this.updateThemeColor("#007bff")):(document.body.classList.remove("theme-blue"),this.updateThemeColor("#dc3545")),this.loadAccessibilitySettings()}loadAccessibilitySettings(){const e=sessionStorage.getItem("username"),t=e?`accessibilitySettings_${e}`:"accessibilitySettings",o=localStorage.getItem(t);if(o)try{const e=JSON.parse(o);e.highContrast?document.body.classList.add("high-contrast"):document.body.classList.remove("high-contrast"),document.body.classList.remove("font-small","font-normal","font-large","font-extra-large"),e.fontSize?document.body.classList.add(`font-${e.fontSize}`):document.body.classList.add("font-normal"),document.body.classList.remove("spacing-compact","spacing-normal","spacing-comfortable"),e.spacing?document.body.classList.add(`spacing-${e.spacing}`):document.body.classList.add("spacing-normal")}catch(e){console.error("Erro ao carregar configura√ß√µes de acessibilidade:",e)}}saveAccessibilitySettings(){const e=sessionStorage.getItem("username"),t=e?`accessibilitySettings_${e}`:"accessibilitySettings",o={highContrast:document.body.classList.contains("high-contrast"),fontSize:this.getCurrentFontSize(),spacing:this.getCurrentSpacing()};localStorage.setItem(t,JSON.stringify(o))}getCurrentFontSize(){return document.body.classList.contains("font-small")?"small":document.body.classList.contains("font-large")?"large":document.body.classList.contains("font-extra-large")?"extra-large":"normal"}getCurrentSpacing(){return document.body.classList.contains("spacing-compact")?"compact":document.body.classList.contains("spacing-comfortable")?"comfortable":"normal"}toggleHighContrast(){if(document.body.classList.toggle("high-contrast"),this.saveAccessibilitySettings(),void 0!==toast&&toast){const e=document.body.classList.contains("high-contrast");toast.info(e?"Modo alto contraste ativado":"Modo alto contraste desativado",2e3)}}setFontSize(e){document.body.classList.remove("font-small","font-normal","font-large","font-extra-large"),e&&"normal"!==e?document.body.classList.add(`font-${e}`):document.body.classList.add("font-normal"),this.saveAccessibilitySettings()}setSpacing(e){document.body.classList.remove("spacing-compact","spacing-normal","spacing-comfortable"),e&&"normal"!==e?document.body.classList.add(`spacing-${e}`):document.body.classList.add("spacing-normal"),this.saveAccessibilitySettings()}openAccessibilityModal(){const e=document.getElementById("accessibilityModal");if(!e)return;const t=document.getElementById("highContrastToggle"),o=document.getElementById("fontSizeSelect"),a=document.getElementById("spacingSelect");t&&(t.checked=document.body.classList.contains("high-contrast")),o&&(o.value=this.getCurrentFontSize()),a&&(a.value=this.getCurrentSpacing()),e.classList.add("active")}closeAccessibilityModal(){const e=document.getElementById("accessibilityModal");e&&e.classList.remove("active")}resetAccessibilitySettings(){document.body.classList.remove("high-contrast"),document.body.classList.remove("font-small","font-normal","font-large","font-extra-large"),document.body.classList.remove("spacing-compact","spacing-normal","spacing-comfortable"),document.body.classList.add("font-normal","spacing-normal");const e=document.getElementById("highContrastToggle"),t=document.getElementById("fontSizeSelect"),o=document.getElementById("spacingSelect");e&&(e.checked=!1),t&&(t.value="normal"),o&&(o.value="normal"),this.saveAccessibilitySettings(),void 0!==toast&&toast&&toast.success("Configura√ß√µes de acessibilidade restauradas para os padr√µes",3e3)}toggleTheme(){const e=document.body.classList.contains("theme-blue"),t=sessionStorage.getItem("username"),o=t?`appTheme_${t}`:"appTheme";e?(document.body.classList.remove("theme-blue"),localStorage.setItem(o,"red"),this.updateThemeColor("#dc3545")):(document.body.classList.add("theme-blue"),localStorage.setItem(o,"blue"),this.updateThemeColor("#007bff")),this.saveData()}toggleDarkMode(){const e=document.body.classList.contains("dark-mode"),t=sessionStorage.getItem("username"),o=t?`darkMode_${t}`:"darkMode";e?(document.body.classList.remove("dark-mode"),localStorage.setItem(o,"false")):(document.body.classList.add("dark-mode"),localStorage.setItem(o,"true"));const a=document.getElementById("darkModeToggle");a&&a.classList.toggle("active",!e)}loadDarkMode(){const e=sessionStorage.getItem("username"),t=e?`darkMode_${e}`:"darkMode";if("true"===localStorage.getItem(t)){document.body.classList.add("dark-mode");const e=document.getElementById("darkModeToggle");e&&e.classList.add("active")}}updateThemeColor(e){const t=document.getElementById("theme-color-meta");t&&t.setAttribute("content",e)}getFilteredServiceData(){const e=document.getElementById("servicesPeriodFilter"),t=e?e.value:"all",o=new Date;let a=null;return"month"===t?a=new Date(o.getFullYear(),o.getMonth()-1,1):"3months"===t?a=new Date(o.getFullYear(),o.getMonth()-3,1):"6months"===t?a=new Date(o.getFullYear(),o.getMonth()-6,1):"year"===t&&(a=new Date(o.getFullYear()-1,o.getMonth(),1)),a?(this.serviceGroups||[]).filter(e=>new Date(e.month+"-01")>=a):this.serviceGroups||[]}renderServicesDashboard(){if(console.log("üìä [SERVICES DASHBOARD] Iniciando renderiza√ß√£o..."),"undefined"==typeof Chart||!1===window.chartJsLoaded)return console.warn("‚ö†Ô∏è [SERVICES DASHBOARD] Chart.js n√£o est√° carregado, aguardando..."),void setTimeout(()=>this.renderServicesDashboard(),500);const e=this.getFilteredServiceData();this.renderHoursByMonthChart(e),this.renderRevenueByMonthChart(e),this.renderTopServicesChart(e),this.renderHoursEvolutionChart(e),this.renderAvgHoursPerDayChart(e),this.renderAvgValuePerHourChart(e),this.updateServicesDashboardStats(e)}renderHoursByMonthChart(e){const t=document.getElementById("hoursByMonthChart");if(!t)return;const o=[],a=[];e.forEach(e=>{const[t,s]=e.month.split("-");o.push(`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(s)-1]}/${t}`);let n=0,r=0;e.days.forEach(e=>{e.services.forEach(e=>{n+=e.hours||0,r+=e.minutes||0})}),n+=Math.floor(r/60),a.push(n+r%60/60)}),this.servicesCharts.hoursByMonth&&this.servicesCharts.hoursByMonth.destroy(),this.servicesCharts.hoursByMonth=new Chart(t,{type:"bar",data:{labels:o,datasets:[{label:"Horas Trabalhadas",data:a,backgroundColor:"rgba(40, 167, 69, 0.6)",borderColor:"rgba(40, 167, 69, 1)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toFixed(1)+"h"}}}}}})}renderRevenueByMonthChart(e){const t=document.getElementById("revenueByMonthChart");if(!t)return;const o=[],a=[];e.forEach(e=>{const[t,s]=e.month.split("-");o.push(`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(s)-1]}/${t}`);let n=0;e.days.forEach(e=>{e.services.forEach(e=>{n+=e.price||0})}),a.push(n)}),this.servicesCharts.revenueByMonth&&this.servicesCharts.revenueByMonth.destroy(),this.servicesCharts.revenueByMonth=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Faturamento (R$)",data:a,borderColor:"rgba(0, 123, 255, 1)",backgroundColor:"rgba(0, 123, 255, 0.1)",borderWidth:2,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"R$ "+e.toFixed(2).replace(".",",")}}}}}})}renderTopServicesChart(e){const t=document.getElementById("topServicesChart");if(!t)return;const o={};e.forEach(e=>{e.days.forEach(e=>{e.services.forEach(e=>{o[e.itemId]||(o[e.itemId]={count:0,name:this.getItemName(e.itemId)}),o[e.itemId].count++})})});const a=Object.entries(o).sort((e,t)=>t[1].count-e[1].count).slice(0,10);if(0===a.length)return void(this.servicesCharts.topServices&&this.servicesCharts.topServices.destroy());const s=a.map(([e,t])=>t.name.length>15?t.name.substring(0,15)+"...":t.name),n=a.map(([e,t])=>t.count);this.servicesCharts.topServices&&this.servicesCharts.topServices.destroy(),this.servicesCharts.topServices=new Chart(t,{type:"doughnut",data:{labels:s,datasets:[{data:n,backgroundColor:["rgba(40, 167, 69, 0.8)","rgba(0, 123, 255, 0.8)","rgba(255, 193, 7, 0.8)","rgba(220, 53, 69, 0.8)","rgba(108, 117, 125, 0.8)","rgba(23, 162, 184, 0.8)","rgba(111, 66, 193, 0.8)","rgba(253, 126, 20, 0.8)","rgba(32, 201, 151, 0.8)","rgba(233, 30, 99, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!1}})}renderHoursEvolutionChart(e){const t=document.getElementById("hoursEvolutionChart");if(!t)return;const o=[],a=[];e.forEach(e=>{const[t,s]=e.month.split("-");o.push(`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(s)-1]}/${t}`);let n=0,r=0;e.days.forEach(e=>{e.services.forEach(e=>{n+=e.hours||0,r+=e.minutes||0})}),n+=Math.floor(r/60),a.push(n+r%60/60)}),this.servicesCharts.hoursEvolution&&this.servicesCharts.hoursEvolution.destroy(),this.servicesCharts.hoursEvolution=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Horas Trabalhadas",data:a,borderColor:"rgba(40, 167, 69, 1)",backgroundColor:"rgba(40, 167, 69, 0.1)",borderWidth:2,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toFixed(1)+"h"}}}}}})}renderAvgHoursPerDayChart(e){const t=document.getElementById("avgHoursPerDayChart");if(!t)return;const o=[],a=[];e.forEach(e=>{const[t,s]=e.month.split("-");o.push(`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(s)-1]}/${t}`);let n=0,r=0,i=0;if(e.days.forEach(e=>{e.services.length>0&&(i++,e.services.forEach(e=>{n+=e.hours||0,r+=e.minutes||0}))}),i>0){const e=n+r/60;a.push(e/i)}else a.push(0)}),this.servicesCharts.avgHoursPerDay&&this.servicesCharts.avgHoursPerDay.destroy(),this.servicesCharts.avgHoursPerDay=new Chart(t,{type:"bar",data:{labels:o,datasets:[{label:"M√©dia de Horas por Dia",data:a,backgroundColor:"rgba(255, 193, 7, 0.6)",borderColor:"rgba(255, 193, 7, 1)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toFixed(1)+"h"}}}}}})}renderAvgValuePerHourChart(e){const t=document.getElementById("avgValuePerHourChart");if(!t)return;const o=[],a=[];e.forEach(e=>{const[t,s]=e.month.split("-");o.push(`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(s)-1]}/${t}`);let n=0,r=0,i=0;e.days.forEach(e=>{e.services.forEach(e=>{n+=e.hours||0,r+=e.minutes||0,i+=e.price||0})});const c=n+r/60;c>0?a.push(i/c):a.push(0)}),this.servicesCharts.avgValuePerHour&&this.servicesCharts.avgValuePerHour.destroy(),this.servicesCharts.avgValuePerHour=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Valor M√©dio por Hora (R$)",data:a,borderColor:"rgba(111, 66, 193, 1)",backgroundColor:"rgba(111, 66, 193, 0.1)",borderWidth:2,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"R$ "+e.toFixed(2).replace(".",",")}}}}}})}updateServicesDashboardStats(e){let t=0,o=0,a=0,s=0;const n=[];e.forEach(e=>{let r=0,i=0,c=0,l=0;e.days.forEach(e=>{e.services.forEach(e=>{r+=e.hours||0,i+=e.minutes||0,c+=e.price||0,l++})}),r+=Math.floor(i/60),i%=60,t+=r,o+=i,a+=c,s+=l;const[d,m]=e.month.split("-");n.push({month:`${["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][parseInt(m)-1]}/${d}`,hours:r+i/60,revenue:c})}),t+=Math.floor(o/60),o%=60;const r=e.length,i=r>0?(t+o/60)/r:0,c=Math.floor(i),l=Math.floor(60*(i-c)),d=r>0?a/r:0,m=n.length>0?n.reduce((e,t)=>t.hours>e.hours?t:e,n[0]):null,u=n.length>0?n.reduce((e,t)=>t.revenue>e.revenue?t:e,n[0]):null,p=t+o/60,g=p>0?a/p:0,h=document.getElementById("servicesAvgMonthlyHours"),v=document.getElementById("servicesBestMonthHours"),y=document.getElementById("servicesAvgMonthlyRevenue"),f=document.getElementById("servicesBestMonthRevenue"),E=document.getElementById("servicesDashboardAvgValuePerHour"),b=document.getElementById("servicesDashboardTotalServices");if(h){const e=`${c}h ${l}min`;h.textContent=e,h.setAttribute("title",e)}if(v){const e=m?m.month:"-";if(v.textContent=e,m){const e=`${m.month} - ${m.hours.toFixed(1)}h`;v.setAttribute("title",e)}else v.removeAttribute("title")}if(y){const e=`R$ ${d.toFixed(2).replace(".",",")}`;y.textContent=e,y.setAttribute("title",e)}if(f){const e=u?u.month:"-";if(f.textContent=e,u){const e=`${u.month} - R$ ${u.revenue.toFixed(2).replace(".",",")}`;f.setAttribute("title",e)}else f.removeAttribute("title")}if(E){const e=`R$ ${g.toFixed(2).replace(".",",")}`;E.textContent=e,E.setAttribute("title",e)}if(b){const e=s.toString();b.textContent=e,b.setAttribute("title",`Total: ${e} servi√ßos`)}}async saveData(){const e=sessionStorage.getItem("username")?.trim();console.log("üß≠ [SAVE DATA] Iniciando salvamento",{username:e||null,hostname:window.location?.hostname||"unknown"}),e||console.warn("‚ö†Ô∏è [SAVE DATA] Username n√£o encontrado no sessionStorage, salvando apenas localmente");const t=e?`appTheme_${e}`:"appTheme",o=localStorage.getItem(t)||"red";let a=this.clients||[],s=this.suppliers||[];if(this.encryptionEnabled&&e)try{a=await this.encryptClientData(a,e),s=await this.encryptClientData(s,e)}catch(e){console.error("Erro ao criptografar dados antes de salvar:",e)}const n={items:this.items,groups:this.groups,serviceGroups:this.serviceGroups||[],serviceTypes:this.serviceTypes||[],costs:this.costs,goals:this.goals,clients:a,clientNotifications:this.clientNotifications||[],suppliers:s,completedSales:this.completedSales||[],pendingOrders:this.pendingOrders||[],serviceAppointments:this.serviceAppointments||[],coupons:this.coupons||[],auditLog:this.auditLog||[],templates:this.templates||[],itemTags:this.itemTags||{},categoryHierarchy:this.categoryHierarchy||{},paymentConfig:this.paymentConfig||{},ecommerceConfig:this.ecommerceConfig||{},erpConfig:this.erpConfig||{},emailConfig:this.emailConfig||{},smsConfig:this.smsConfig||{},dataAccessLogs:this.dataAccessLogs||[],scheduledReports:this.scheduledReports||[],sharedReports:this.sharedReports||[],scheduledExports:this.scheduledExports||[],emailTracking:this.emailTracking||{},whatsappConfig:this.whatsappConfig||{},whatsappChats:this.whatsappChats||[],whatsappAutomations:this.whatsappAutomations||[],theme:o,encryptionEnabled:this.encryptionEnabled,version:"1.0",lastUpdate:(new Date).toISOString(),nfeConfig:this.nfeConfig||{},integrations:this.integrations||{},notificationsConfig:this.notificationsConfig||{},customFields:this.customFields||[],sharedLinks:this.sharedLinks||[],remoteBackupStatus:this.remoteBackupStatus||{},userSettings:this.userSettings||{},cashRegisters:this.cashRegisters||[],receipts:this.receipts||[],productImports:this.productImports||[],estoque:this.coletarEstoqueLocal?.()||{}};console.log("üì¶ [SAVE DATA] Contagem de dados",{items:this.items?.length||0,groups:this.groups?.length||0,serviceGroups:this.serviceGroups?.length||0,costs:this.costs?.length||0,goals:this.goals?.length||0,completedSales:this.completedSales?.length||0,pendingOrders:this.pendingOrders?.length||0,serviceAppointments:this.serviceAppointments?.length||0});try{const t=e?`lojaData_${e}`:"lojaData";localStorage.setItem(t,JSON.stringify(n)),console.log(`üíæ [SAVE DATA] Dados salvos no localStorage (chave: ${t})`)}catch(e){console.error("‚ùå [SAVE DATA] Erro ao salvar no localStorage:",e)}if(e)try{console.log(`‚òÅÔ∏è [SAVE DATA] Tentando salvar na nuvem (API: /api/save) para usu√°rio: ${e}...`);const t=this.canMakeRequest();if(!t.allowed)return console.warn(`‚ö†Ô∏è [SAVE DATA] Rate limit atingido. Aguardando ${t.remainingSeconds} segundos...`),void(void 0!==toast&&toast&&toast.warning(`Muitas requisi√ß√µes. Aguarde ${t.remainingSeconds} segundos.`,3e3));const o=await this.makeRequestWithRateLimit("/api/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,data:n})});if(console.log(`üì° [SAVE DATA] Status HTTP: ${o.status} ${o.statusText}`),504===o.status)return await o.text(),console.warn("‚ö†Ô∏è [SAVE DATA] Erro 504 (Gateway Timeout) - A API demorou muito para responder"),console.warn("üíæ [SAVE DATA] Dados foram salvos localmente, mas n√£o na nuvem"),void console.warn("üí° [SAVE DATA] Isso pode acontecer se o servidor estiver sobrecarregado");const a=o.headers.get("content-type");if(!a||!a.includes("application/json")){const e=await o.text();if(console.error("‚ùå [SAVE DATA] Resposta da API n√£o √© JSON!"),console.error(`‚ùå [SAVE DATA] Status: ${o.status}`),console.error("‚ùå [SAVE DATA] Resposta (primeiros 200 chars):",e.substring(0,200)),404===o.status&&(console.error("‚ùå [SAVE DATA] Erro 404: Rota /api/save n√£o encontrada"),console.error("üí° [SAVE DATA] Verifique se a API est√° configurada corretamente na Vercel")),o.status>=500)return void console.warn("‚ö†Ô∏è [SAVE DATA] Erro do servidor - dados salvos apenas localmente");throw new Error(`Resposta da API n√£o √© JSON (Status: ${o.status})`)}const s=await o.json();console.log("üì¶ [SAVE DATA] Resposta JSON recebida:",{success:s.success,hasError:!!s.error,hasMessage:!!s.message}),o.ok&&s.success?console.log("‚úÖ [SAVE DATA] Dados salvos na nuvem com sucesso!"):(s.error&&s.error.includes("n√£o est√£o definidas")?(console.warn("‚ö†Ô∏è [SAVE DATA] Vari√°veis de ambiente n√£o configuradas na Vercel"),console.warn("üí° [SAVE DATA] Configure JSONBIN_API_KEY e JSONBIN_BIN_ID no painel da Vercel para habilitar sincroniza√ß√£o na nuvem")):(console.warn("‚ö†Ô∏è [SAVE DATA] Erro ao salvar na nuvem:",s.error||s.message),console.warn("üíæ [SAVE DATA] Dados salvos apenas localmente (localStorage)")),o.ok||console.error(`‚ùå [SAVE DATA] HTTP ${o.status}: ${o.statusText}`))}catch(e){console.warn("‚ö†Ô∏è [SAVE DATA] Erro ao salvar na nuvem:",e),console.warn("‚ö†Ô∏è [SAVE DATA] Tipo do erro:",e.constructor.name),console.warn("‚ö†Ô∏è [SAVE DATA] Mensagem:",e.message),console.log("üì± [SAVE DATA] Modo offline: dados salvos apenas localmente"),console.log("‚ÑπÔ∏è [SAVE DATA] Isso √© normal se voc√™ estiver testando localmente (localhost)")}else console.warn("‚ö†Ô∏è [SAVE DATA] Username n√£o dispon√≠vel, pulando salvamento na nuvem")}async loadData(){console.log("üîÑ [LOAD DATA] Iniciando carregamento de dados...");const e=sessionStorage.getItem("username");if(e||console.warn("‚ö†Ô∏è [LOAD DATA] Username n√£o encontrado no sessionStorage, carregando apenas do localStorage"),e)try{console.log(`‚òÅÔ∏è [LOAD DATA] Tentando carregar da nuvem (API: /api/load) para usu√°rio: ${e}...`);const t=this.canMakeRequest();if(t.allowed){const t=await this.makeRequestWithRateLimit(`/api/load?username=${encodeURIComponent(e)}`,{method:"GET",headers:{"Content-Type":"application/json"}});console.log(`üì° [LOAD DATA] Status HTTP: ${t.status} ${t.statusText}`);const o=t.headers.get("content-type");if(console.log(`üìã [LOAD DATA] Content-Type: ${o||"n√£o especificado"}`),!o||!o.includes("application/json")){const e=await t.text();throw console.error("‚ùå [LOAD DATA] Resposta da API n√£o √© JSON!"),console.error(`‚ùå [LOAD DATA] Status: ${t.status}`),console.error("‚ùå [LOAD DATA] Resposta (primeiros 200 chars):",e.substring(0,200)),404===t.status?(console.error("‚ùå [LOAD DATA] Erro 404: Rota /api/load n√£o encontrada"),console.error("üí° [LOAD DATA] Verifique se a API est√° configurada corretamente na Vercel")):t.status>=500&&console.error("‚ùå [LOAD DATA] Erro do servidor (5xx)"),new Error(`Resposta da API n√£o √© JSON (Status: ${t.status}). Poss√≠vel erro 404 ou rota n√£o encontrada.`)}const a=await t.json();if(console.log("üì¶ [LOAD DATA] Resposta JSON recebida:",{success:a.success,hasData:!!a.data,hasError:!!a.error,hasMessage:!!a.message}),t.ok&&a.success&&a.data){const t=a.data;if(t.items&&t.items.length>0||t.groups&&t.groups.length>0||t.serviceGroups&&t.serviceGroups.length>0||t.costs&&t.costs.length>0||t.goals&&t.goals.length>0||t.clients&&t.clients.length>0){this.items=t.items||[],this.groups=t.groups||[],this.serviceGroups=t.serviceGroups||[],this.serviceTypes=t.serviceTypes||[],this.costs=t.costs||[],this.goals=t.goals||[];let o=t.clients||[],a=t.suppliers||[];if(t.encryptionEnabled&&e)try{o=await this.decryptClientData(o,e),a=await this.decryptClientData(a,e)}catch(e){console.error("Erro ao descriptografar dados ao carregar:",e)}if(this.clients=o,this.clientNotifications=t.clientNotifications||[],this.suppliers=a,void 0!==t.encryptionEnabled&&(this.encryptionEnabled=t.encryptionEnabled),this.completedSales=t.completedSales||[],this.pendingOrders=t.pendingOrders||[],this.serviceAppointments=t.serviceAppointments||[],this.coupons=t.coupons||[],this.auditLog=t.auditLog||[],this.templates=t.templates||[],this.itemTags=t.itemTags||{},this.categoryHierarchy=t.categoryHierarchy||{},this.paymentConfig=t.paymentConfig||this.paymentConfig,this.ecommerceConfig=t.ecommerceConfig||this.ecommerceConfig,this.erpConfig=t.erpConfig||this.erpConfig,this.emailConfig=t.emailConfig||this.emailConfig,this.smsConfig=t.smsConfig||this.smsConfig,this.scheduledReports=t.scheduledReports||[],this.sharedReports=t.sharedReports||[],this.scheduledExports=t.scheduledExports||[],this.emailTracking=t.emailTracking||{},this.whatsappConfig=t.whatsappConfig||this.whatsappConfig,this.whatsappChats=t.whatsappChats||[],this.whatsappAutomations=t.whatsappAutomations||[],this.autoTagsEnabled&&setTimeout(()=>{this.generateAutoTagsFromSales()},2e3),this.autoTagsEnabled&&setTimeout(()=>{this.generateAutoTagsFromSales()},2e3),console.log(`üìã [LOAD DATA] Comprovantes carregados: ${this.completedSales.length}`),this.completedSales.length>0&&console.log("üìã [LOAD DATA] Primeiro comprovante:",{id:this.completedSales[0].id,name:this.completedSales[0].customerName,date:this.completedSales[0].date,total:this.completedSales[0].totalValue}),t.theme){const o=e?`appTheme_${e}`:"appTheme";localStorage.setItem(o,t.theme),"blue"===t.theme?(document.body.classList.add("theme-blue"),this.updateThemeColor("#007bff")):(document.body.classList.remove("theme-blue"),this.updateThemeColor("#dc3545"))}let s=!1;if(this.items=this.items.map(e=>(e.category||(e.category="Roupas",s=!0),e)),this.groups.forEach(e=>{e.days.forEach(e=>{e.stock||(e.stock={},s=!0)})}),s){const e={items:this.items,groups:this.groups,serviceGroups:this.serviceGroups||[],serviceTypes:this.serviceTypes||[],costs:this.costs,goals:this.goals};localStorage.setItem("lojaData",JSON.stringify(e)),this.saveData()}else localStorage.setItem("lojaData",JSON.stringify(t));return console.log("‚úÖ [LOAD DATA] Dados carregados da nuvem com sucesso!"),console.log(`üìä [LOAD DATA] Items: ${this.items.length} | Grupos: ${this.groups.length} | Custos: ${this.costs.length} | Metas: ${this.goals.length} | Comprovantes: ${this.completedSales.length}`),this.populateServiceTypes(),Promise.resolve()}console.log("‚ÑπÔ∏è [LOAD DATA] Nenhum dado encontrado na nuvem (bin vazio ou apenas estrutura vazia)"),console.log(`üìä [LOAD DATA] Estrutura: Items: ${t.items?.length||0} | Grupos: ${t.groups?.length||0} | Custos: ${t.costs?.length||0} | Metas: ${t.goals?.length||0}`)}else a.error&&(console.error("‚ùå [LOAD DATA] Erro na resposta da API:",a.error),a.error.includes("n√£o est√£o definidas")&&(console.warn("‚ö†Ô∏è [LOAD DATA] Vari√°veis de ambiente n√£o configuradas na Vercel"),console.warn("üí° [LOAD DATA] Configure JSONBIN_API_KEY e JSONBIN_BIN_ID no painel da Vercel"))),a.message&&console.warn("‚ö†Ô∏è [LOAD DATA] Mensagem da API:",a.message),t.ok||console.error(`‚ùå [LOAD DATA] HTTP ${t.status}: ${t.statusText}`)}else console.warn(`‚ö†Ô∏è [LOAD DATA] Rate limit atingido. Aguardando ${t.remainingSeconds} segundos...`)}catch(e){console.error("‚ùå [LOAD DATA] Erro ao carregar da nuvem:",e),console.error("‚ùå [LOAD DATA] Tipo do erro:",e.constructor.name),console.error("‚ùå [LOAD DATA] Mensagem:",e.message),e.stack&&console.error("‚ùå [LOAD DATA] Stack:",e.stack),console.log("üíæ [LOAD DATA] Usando localStorage como fallback...")}else console.log("üíæ [LOAD DATA] Username n√£o dispon√≠vel, carregando apenas do localStorage...");console.log("üíæ [LOAD DATA] Verificando localStorage...");const t=e?`lojaData_${e}`:"lojaData";let o=localStorage.getItem(t);if(!o&&e){const e=localStorage.getItem("lojaData");e&&(console.log("üîÑ [LOAD DATA] Dados antigos encontrados (sem username), migrando..."),localStorage.setItem(t,e),o=e,console.log(`‚úÖ [LOAD DATA] Dados migrados para chave: ${t}`))}if(o)try{console.log("üì¶ [LOAD DATA] Dados encontrados no localStorage, parseando...");const a=JSON.parse(o);if(this.items=a.items||[],this.groups=a.groups||[],this.serviceGroups=a.serviceGroups||[],this.serviceTypes=a.serviceTypes||JSON.parse(localStorage.getItem(`serviceTypes_${e||"default"}`)||"[]"),this.costs=a.costs||[],this.goals=a.goals||[],this.clients=a.clients||[],this.clientNotifications=a.clientNotifications||[],this.suppliers=a.suppliers||[],this.completedSales=a.completedSales||[],this.pendingOrders=a.pendingOrders||[],this.serviceAppointments=a.serviceAppointments||[],this.coupons=a.coupons||[],this.auditLog=a.auditLog||[],this.templates=a.templates||[],this.itemTags=a.itemTags||{},this.categoryHierarchy=a.categoryHierarchy||{},this.paymentConfig=a.paymentConfig||this.paymentConfig,this.ecommerceConfig=a.ecommerceConfig||this.ecommerceConfig,this.erpConfig=a.erpConfig||this.erpConfig,this.emailConfig=a.emailConfig||this.emailConfig,this.smsConfig=a.smsConfig||this.smsConfig,this.dataAccessLogs=a.dataAccessLogs||[],this.scheduledReports=a.scheduledReports||[],this.sharedReports=a.sharedReports||[],this.scheduledExports=a.scheduledExports||[],this.emailTracking=a.emailTracking||{},this.whatsappConfig=a.whatsappConfig||this.whatsappConfig,this.whatsappChats=a.whatsappChats||[],this.whatsappAutomations=a.whatsappAutomations||[],console.log(`üìã [LOAD DATA] Comprovantes carregados do localStorage: ${this.completedSales.length}`),this.completedSales.length>0&&console.log("üìã [LOAD DATA] Primeiro comprovante:",{id:this.completedSales[0].id,name:this.completedSales[0].customerName,date:this.completedSales[0].date,total:this.completedSales[0].totalValue}),a.theme){const t=e?`appTheme_${e}`:"appTheme";localStorage.setItem(t,a.theme),"blue"===a.theme?(document.body.classList.add("theme-blue"),this.updateThemeColor("#007bff")):(document.body.classList.remove("theme-blue"),this.updateThemeColor("#dc3545")),console.log(`‚úÖ [LOAD DATA] Tema carregado do localStorage: ${a.theme}`)}let s=!1;if(this.items=this.items.map(e=>(e.category||(e.category="Roupas",s=!0),e)),this.groups.forEach(e=>{e.days.forEach(e=>{e.stock||(e.stock={},s=!0)})}),s){console.log("üîÑ [LOAD DATA] Migra√ß√£o de dados detectada, salvando...");const e={items:this.items,groups:this.groups,serviceGroups:this.serviceGroups||[],serviceTypes:this.serviceTypes||[],costs:this.costs,goals:this.goals};localStorage.setItem(t,JSON.stringify(e)),this.saveData()}console.log("‚úÖ [LOAD DATA] Dados carregados do localStorage com sucesso!"),console.log(`üìä [LOAD DATA] Items: ${this.items.length} | Grupos: ${this.groups.length} | Custos: ${this.costs.length} | Metas: ${this.goals.length}`),this.populateServiceTypes()}catch(e){console.error("‚ùå [LOAD DATA] Erro ao carregar dados do localStorage:",e),console.error("‚ùå [LOAD DATA] Tipo do erro:",e.constructor.name),console.error("‚ùå [LOAD DATA] Mensagem:",e.message),e.stack&&console.error("‚ùå [LOAD DATA] Stack:",e.stack),console.warn("‚ö†Ô∏è [LOAD DATA] Inicializando com dados vazios devido ao erro"),this.items=this.items||[],this.groups=this.groups||[],this.serviceGroups=this.serviceGroups||[],this.costs=this.costs||[],this.goals=this.goals||[],this.clients=this.clients||[],this.clientNotifications=this.clientNotifications||[],this.suppliers=this.suppliers||[],this.completedSales=this.completedSales||[],this.pendingOrders=this.pendingOrders||[],this.serviceAppointments=this.serviceAppointments||[],this.coupons=this.coupons||[],this.auditLog=this.auditLog||[],this.templates=this.templates||[],this.itemTags=this.itemTags||{},this.categoryHierarchy=this.categoryHierarchy||{}}else console.log("‚ÑπÔ∏è [LOAD DATA] Nenhum dado encontrado no localStorage, iniciando vazio"),this.items=this.items||[],this.groups=this.groups||[],this.serviceGroups=this.serviceGroups||[],this.costs=this.costs||[],this.goals=this.goals||[],this.clients=this.clients||[],this.suppliers=this.suppliers||[],this.completedSales=this.completedSales||[],this.pendingOrders=this.pendingOrders||[],this.serviceAppointments=this.serviceAppointments||[],this.coupons=this.coupons||[],this.templates=this.templates||[];return console.log("‚úÖ [LOAD DATA] Carregamento de dados conclu√≠do"),console.log(`üìä [LOAD DATA] Estado final: Items: ${this.items?.length||0} | Grupos: ${this.groups?.length||0} | Clientes: ${this.clients?.length||0}`),Promise.resolve()}exportData(){if(!this.checkPermission("export"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para exportar dados.",3e3):alert("Voc√™ n√£o tem permiss√£o para exportar dados."));const e={items:this.items,groups:this.groups,costs:this.costs,goals:this.goals,version:"1.0",exportDate:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"text/plain"}),o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=`loja_backup_${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}generateChecksum(e){const t=JSON.stringify(e);let o=0;for(let e=0;e<t.length;e++)o=(o<<5)-o+t.charCodeAt(e),o&=o;return Math.abs(o).toString(16)}async createManualBackup(){const e=sessionStorage.getItem("username");if(e)try{let t={items:this.items,groups:this.groups,serviceGroups:this.serviceGroups,costs:this.costs,goals:this.goals,clients:this.clients,clientNotifications:this.clientNotifications,suppliers:this.suppliers,completedSales:this.completedSales,pendingOrders:this.pendingOrders,serviceAppointments:this.serviceAppointments,coupons:this.coupons,auditLog:this.auditLog,templates:this.templates,itemTags:this.itemTags,version:"1.0",timestamp:(new Date).toISOString()};if(this.encryptionEnabled&&e)try{t=await this.encryptBackup(t,e),t.encrypted=!0}catch(e){console.error("Erro ao criptografar backup:",e)}const o=this.generateChecksum(t),a={id:"BACKUP_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString(),data:t,checksum:o,type:"manual",username:e};this.backupHistory.unshift(a),this.backupHistory.length>50&&(this.backupHistory=this.backupHistory.slice(0,50));const s=`backupHistory_${e}`;localStorage.setItem(s,JSON.stringify(this.backupHistory)),this.lastBackupTime=new Date,this.saveData(),this.renderBackupHistory(),this.logAction("export","backup",a.id,"Backup Manual",{checksum:o,itemsCount:this.items.length,groupsCount:this.groups.length}),void 0!==toast&&toast&&toast.success("Backup criado com sucesso!",3e3)}catch(e){console.error("Erro ao criar backup:",e),void 0!==toast&&toast&&toast.error("Erro ao criar backup. Verifique o console para mais detalhes.",4e3)}else void 0!==toast&&toast&&toast.error("Usu√°rio n√£o autenticado. Fa√ßa login novamente.",3e3)}configureAutoBackup(){const e=document.getElementById("autoBackupEnabled")?.checked||!1,t=document.getElementById("autoBackupFrequency")?.value||"daily";e?this.startAutoBackup(t):this.stopAutoBackup();const o=sessionStorage.getItem("username");if(o){const a={enabled:e,frequency:t};localStorage.setItem(`autoBackupConfig_${o}`,JSON.stringify(a))}}startAutoBackup(e="daily"){this.stopAutoBackup();const t="daily"===e?864e5:6048e5;this.backupInterval=setInterval(()=>{this.createAutoBackup()},t),this.lastBackupTime&&!this.shouldCreateBackup(e)||this.createAutoBackup(),void 0!==toast&&toast&&toast.info(`Backup autom√°tico ${"daily"===e?"di√°rio":"semanal"} ativado!`,3e3)}stopAutoBackup(){this.backupInterval&&(clearInterval(this.backupInterval),this.backupInterval=null)}shouldCreateBackup(e){if(!this.lastBackupTime)return!0;const t=new Date-new Date(this.lastBackupTime);return"daily"===e?t>=864e5:t>=6048e5}async createAutoBackup(){const e=sessionStorage.getItem("username");if(e)try{let t={items:this.items,groups:this.groups,serviceGroups:this.serviceGroups,costs:this.costs,goals:this.goals,clients:this.clients,clientNotifications:this.clientNotifications,suppliers:this.suppliers,completedSales:this.completedSales,pendingOrders:this.pendingOrders,serviceAppointments:this.serviceAppointments,coupons:this.coupons,auditLog:this.auditLog,templates:this.templates,itemTags:this.itemTags,version:"1.0",timestamp:(new Date).toISOString()};if(this.encryptionEnabled&&e)try{t=await this.encryptBackup(t,e),t.encrypted=!0}catch(e){console.error("Erro ao criptografar backup autom√°tico:",e)}const o=this.generateChecksum(t),a={id:"BACKUP_AUTO_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString(),data:t,checksum:o,type:"auto",username:e,storagePoints:[]};try{const t=`backupHistory_${e}`;this.backupHistory.unshift(a),this.backupHistory.length>50&&(this.backupHistory=this.backupHistory.slice(0,50)),localStorage.setItem(t,JSON.stringify(this.backupHistory)),a.storagePoints.push("localStorage"),console.log("‚úÖ [BACKUP] Backup salvo em localStorage")}catch(e){console.error("‚ùå [BACKUP] Erro ao salvar em localStorage:",e)}if(this.useIndexedDB&&this.indexedDB)try{await this.saveBackupToIndexedDB(a),a.storagePoints.push("indexedDB"),console.log("‚úÖ [BACKUP] Backup salvo em IndexedDB")}catch(e){console.error("‚ùå [BACKUP] Erro ao salvar em IndexedDB:",e)}try{await this.saveBackupToCloud(t,a.id),a.storagePoints.push("cloud"),console.log("‚úÖ [BACKUP] Backup salvo na nuvem (JSONBin)")}catch(e){console.warn("‚ö†Ô∏è [BACKUP] Erro ao salvar na nuvem (pode n√£o estar configurado):",e.message)}if("true"===localStorage.getItem(`autoBackupDownload_${e}`))try{this.downloadBackupFile(t,a.id),a.storagePoints.push("download"),console.log("‚úÖ [BACKUP] Backup baixado automaticamente")}catch(e){console.error("‚ùå [BACKUP] Erro ao baixar backup:",e)}this.lastBackupTime=new Date,this.saveData(),this.renderBackupHistory();const s=a.storagePoints.length,n=s>1?`salvo em ${s} locais`:"salvo";void 0!==toast&&toast&&toast.success(`Backup autom√°tico criado com sucesso! (${n})`,3e3),this.logAction("export","backup",a.id,"Backup Autom√°tico",{checksum:o,storagePoints:a.storagePoints,pointsCount:s})}catch(e){console.error("Erro ao criar backup autom√°tico:",e),void 0!==toast&&toast&&toast.error("Erro ao criar backup autom√°tico. Verifique o console.",4e3)}}async saveBackupToIndexedDB(e){return new Promise((t,o)=>{if(!this.indexedDB||!this.useIndexedDB)return void o(new Error("IndexedDB n√£o dispon√≠vel"));const a=this.indexedDB.transaction(["backups"],"readwrite").objectStore("backups").add(e);a.onsuccess=()=>{t()},a.onerror=()=>{o(new Error("Erro ao salvar backup no IndexedDB"))}})}async saveBackupToCloud(e,t){try{await this.saveData(),console.log("‚úÖ [BACKUP] Backup sincronizado na nuvem via saveData")}catch(e){throw new Error("Erro ao salvar backup na nuvem: "+e.message)}}downloadBackupFile(e,t){const o=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`backup_${t}_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}toggleAutoBackup(){const e=document.getElementById("autoBackupEnabled")?.checked||!1,t=document.getElementById("autoBackupFrequency")?.value||"daily";e?this.startAutoBackup(t):this.stopAutoBackup(),this.configureAutoBackup()}updateAutoBackupFrequency(){if(document.getElementById("autoBackupEnabled")?.checked){const e=document.getElementById("autoBackupFrequency")?.value||"daily";this.startAutoBackup(e)}this.configureAutoBackup()}openBackupModal(){const e=document.getElementById("backupModal");if(!e)return;this.loadBackupHistory(),this.renderBackupHistory();const t=sessionStorage.getItem("username");if(t){const e=localStorage.getItem(`autoBackupConfig_${t}`);if(e)try{const t=JSON.parse(e),o=document.getElementById("autoBackupEnabled"),a=document.getElementById("autoBackupFrequency");o&&(o.checked=t.enabled||!1),a&&(a.value=t.frequency||"daily")}catch(e){console.error("Erro ao carregar configura√ß√£o de backup:",e)}}e.classList.add("active")}closeBackupModal(){const e=document.getElementById("backupModal");e&&e.classList.remove("active")}loadBackupHistory(){const e=sessionStorage.getItem("username");if(!e)return void(this.backupHistory=[]);const t=`backupHistory_${e}`,o=localStorage.getItem(t);if(o)try{this.backupHistory=JSON.parse(o)||[]}catch(e){console.error("Erro ao carregar hist√≥rico de backups:",e),this.backupHistory=[]}else this.backupHistory=[]}renderBackupHistory(){const e=document.getElementById("backupHistoryList");e&&(0!==this.backupHistory.length?e.innerHTML=this.backupHistory.map(e=>{const t=new Date(e.timestamp).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),o=this.generateChecksum(e.data)===e.checksum,a=e.storagePoints||[],s={localStorage:"Local",indexedDB:"IndexedDB",cloud:"Nuvem",download:"Download"},n=a.length>0?a.map(e=>s[e]||e).join(", "):"Local",r=a.length||1;return`\n                    <div class="item-card" style="margin-bottom: 1rem; border-left: 4px solid ${"auto"===e.type?"#28a745":"#007bff"};">\n                        <div class="item-header">\n                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">\n                                <i class="fas ${"auto"===e.type?"fa-clock":"fa-save"}" style="color: ${"auto"===e.type?"#28a745":"#007bff"};"></i>\n                                <div style="flex: 1;">\n                                    <h3 style="margin: 0; font-size: 0.95rem; font-weight: 600;">\n                                        ${"auto"===e.type?"Backup Autom√°tico":"Backup Manual"}\n                                    </h3>\n                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                                        <i class="fas fa-calendar"></i> ${t}\n                                    </p>\n                                    ${r>1?`\n                                        <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--primary-color);">\n                                            <i class="fas fa-database"></i> Armazenado em ${r} locais: ${n}\n                                        </p>\n                                    `:""}\n                                </div>\n                            </div>\n                            <div style="display: flex; gap: 0.5rem; flex-direction: column; align-items: flex-end;">\n                                ${o?'<span style="color: #28a745; font-size: 0.75rem;"><i class="fas fa-check-circle"></i> √çntegro</span>':'<span style="color: #dc3545; font-size: 0.75rem;"><i class="fas fa-exclamation-circle"></i> Corrompido</span>'}\n                                ${r>1?`\n                                    <span style="color: var(--primary-color); font-size: 0.7rem;" title="M√∫ltiplos pontos de backup">\n                                        <i class="fas fa-shield-alt"></i> ${r}x\n                                    </span>\n                                `:""}\n                            </div>\n                        </div>\n                        <div class="item-details" style="padding-top: 0.75rem; border-top: 1px solid var(--border-color); margin-top: 0.75rem;">\n                            <p style="margin: 0.5rem 0; font-size: 0.85rem;">\n                                <i class="fas fa-box"></i> <strong>Itens:</strong> ${e.data.items?.length||0} | \n                                <i class="fas fa-users"></i> <strong>Clientes:</strong> ${e.data.clients?.length||0} | \n                                <i class="fas fa-shopping-cart"></i> <strong>Vendas:</strong> ${e.data.completedSales?.length||0}\n                            </p>\n                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">\n                                <button class="btn-small btn-secondary" onclick="app.restoreBackup('${e.id}')" ${o?"":'disabled title="Backup corrompido"'}>\n                                    <i class="fas fa-undo"></i> Restaurar\n                                </button>\n                                <button class="btn-small btn-secondary" onclick="app.downloadBackup('${e.id}')">\n                                    <i class="fas fa-download"></i> Baixar\n                                </button>\n                                <button class="btn-small btn-delete" onclick="app.deleteBackup('${e.id}')">\n                                    <i class="fas fa-times"></i> Excluir\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `}).join(""):e.innerHTML='\n                <div class="empty-state" style="padding: 2rem;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-database"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum backup encontrado</h3>\n                    <p class="empty-state-message">\n                        Crie seu primeiro backup para come√ßar a proteger seus dados.\n                    </p>\n                </div>')}async restoreBackup(e){const t=this.backupHistory.find(t=>t.id===e);if(!t)return void(void 0!==toast&&toast&&toast.error("Backup n√£o encontrado.",3e3));const o=sessionStorage.getItem("username");let a=t.data;if(a.encrypted&&o)try{a=await this.decryptBackup(a,o)}catch(e){return console.error("Erro ao descriptografar backup:",e),void(void 0!==toast&&toast&&toast.error("Erro ao descriptografar backup. Verifique se voc√™ est√° usando a mesma conta.",4e3))}this.generateChecksum(a)!==t.checksum&&void 0!==toast&&toast&&toast.warning("Backup pode estar corrompido. Continuar mesmo assim?",5e3);const s=o=>{if(o)try{this.items=a.items||[],this.groups=a.groups||[],this.serviceGroups=a.serviceGroups||[],this.costs=a.costs||[],this.goals=a.goals||[],this.clients=a.clients||[],this.clientNotifications=a.clientNotifications||[],this.suppliers=a.suppliers||[],this.completedSales=a.completedSales||[],this.pendingOrders=a.pendingOrders||[],this.serviceAppointments=a.serviceAppointments||[],this.coupons=a.coupons||[],this.auditLog=a.auditLog||[],this.templates=a.templates||[],this.itemTags=a.itemTags||{},this.saveData(),this.renderItems(),this.renderGroups(),this.renderClients(),this.renderSuppliers(),this.renderCoupons(),this.renderTemplates(),this.updateTagFilter(),this.logAction("import","backup",e,"Restaura√ß√£o de Backup",{backupTimestamp:t.timestamp}),void 0!==toast&&toast&&toast.success("Backup restaurado com sucesso!",3e3),this.closeBackupModal()}catch(e){console.error("Erro ao restaurar backup:",e),void 0!==toast&&toast&&toast.error("Erro ao restaurar backup. Verifique o console para mais detalhes.",4e3)}};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger("Tem certeza que deseja restaurar este backup? Todos os dados atuais ser√£o substitu√≠dos pelos dados do backup.","Restaurar Backup").then(s):confirm("Tem certeza que deseja restaurar este backup?")&&s(!0)}downloadBackup(e){const t=this.backupHistory.find(t=>t.id===e);if(!t)return void(void 0!==toast&&toast&&toast.error("Backup n√£o encontrado.",3e3));const o=new Blob([JSON.stringify(t.data,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`backup_${e}_${new Date(t.timestamp).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),void 0!==toast&&toast&&toast.success("Backup baixado com sucesso!",3e3)}deleteBackup(e){const t=this.backupHistory.find(t=>t.id===e),o=t?"auto"===t.type?"Backup Autom√°tico":"Backup Manual":"este backup",a=t=>{if(!t)return;this.backupHistory=this.backupHistory.filter(t=>t.id!==e);const a=sessionStorage.getItem("username");if(a){const e=`backupHistory_${a}`;localStorage.setItem(e,JSON.stringify(this.backupHistory))}this.renderBackupHistory(),void 0!==toast&&toast&&toast.success(`Backup "${o}" exclu√≠do com sucesso!`,3e3)};void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(`Tem certeza que deseja excluir o ${o}?`,"Excluir Backup").then(a):confirm(`Tem certeza que deseja excluir o ${o}?`)&&a(!0)}exportClients(){if(0===this.clients.length)return void(void 0!==toast&&toast?toast.warning("N√£o h√° clientes cadastrados para exportar.",3e3):alert("N√£o h√° clientes cadastrados para exportar."));const e=this.clients.map(e=>{const t=this.completedSales.filter(t=>t.customerName===e.name).length,o=this.completedSales.filter(t=>t.customerName===e.name).reduce((e,t)=>e+(t.totalValue||0),0);return[e.name||"",e.cpf||"",e.phone||"",e.email||"",e.address||"",(e.loyaltyPoints||0).toString(),o.toFixed(2).replace(".",","),t.toString(),(e.notes||"").replace(/"/g,'""')]}),t=[["Nome","CPF","Telefone","E-mail","Endere√ßo","Pontos de Fidelidade","Total Gasto","N√∫mero de Compras","Observa√ß√µes"].join(","),...e.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),o=new Blob(["\ufeff"+t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`clientes_${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),this.logAction("export","client",null,"Lista de Clientes",{totalClients:this.clients.length}),void 0!==toast&&toast&&toast.success(`Lista de ${this.clients.length} cliente(s) exportada com sucesso!`,3e3)}calculateLoyaltyDiscount(e,t){const o=this.clients.find(t=>t.name===e);if(!o||!o.loyaltyPoints)return{discount:0,pointsUsed:0};const a=.1*o.loyaltyPoints,s=.5*t,n=Math.min(a,s),r=Math.ceil(n/.1);return{discount:Math.round(100*n)/100,pointsUsed:r}}addLoyaltyPoints(e,t){const o=this.clients.find(t=>t.name===e);if(!o)return;const a=Math.floor(t/10);o.loyaltyPoints||(o.loyaltyPoints=0),o.loyaltyPoints+=a,o.updatedAt=(new Date).toISOString(),this.saveData(),a>0&&void 0!==toast&&toast&&toast.info(`Cliente "${e}" ganhou ${a} ponto(s) de fidelidade!`,3e3)}createClientNotification(e,t,o,a="info"){const s={id:"NOTIF_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),clientId:e,title:t,message:o,type:a,read:!1,createdAt:(new Date).toISOString()};return this.clientNotifications.push(s),this.saveData(),s}markNotificationAsRead(e){const t=this.clientNotifications.find(t=>t.id===e);t&&(t.read=!0,t.readAt=(new Date).toISOString(),this.saveData())}getClientNotifications(e){return this.clientNotifications.filter(t=>t.clientId===e).sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt))}calculateDiscount(e,t){const o=document.getElementById("saleDiscountType")?.value||"",a=parseFloat(document.getElementById("saleDiscountValue")?.value||0),s=document.getElementById("saleCouponCode")?.value.trim().toUpperCase()||"";let n=0,r=null;if(s){const o=this.coupons.find(e=>e.code===s&&e.active);if(o){const a=new Date,s=(!o.startsAt||new Date(o.startsAt)<=a)&&(!o.expiresAt||new Date(o.expiresAt)>=a),i=!o.minQuantity||t>=o.minQuantity,c=!o.maxUses||(o.uses||0)<o.maxUses;s&&i&&c&&(r=o,n="percent"===o.type?e*t*o.value/100:o.value)}}!r&&o&&a>0&&(n="percent"===o?e*t*a/100:a);const i=e*t;return n=Math.min(n,i),{discount:Math.round(100*n)/100,discountType:o||(r?r.type:""),discountValue:a||(r?r.value:0),couponCode:r?r.code:null}}updateDiscountCalculation(){const e=document.getElementById("salePrice"),t=document.getElementById("saleQuantity"),o=document.getElementById("saleDiscountType"),a=document.getElementById("saleDiscountValue"),s=document.getElementById("discountSummary");if(!e||!t||!s)return;const n=(this.parsePrice(e.value)||0)*(parseInt(t.value)||0);let r=0;if(o&&a&&o.value&&a.value){const e=o.value,t=parseFloat(a.value);r="percent"===e?n*t/100:t,r=Math.min(r,n)}const i=n-r;s.innerHTML=`\n            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; text-align: center;">\n                <div>\n                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Subtotal</div>\n                    <div style="font-weight: 600; color: var(--gray-800);">R$ ${n.toFixed(2).replace(".",",")}</div>\n                </div>\n                <div>\n                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Desconto</div>\n                    <div style="font-weight: 600; color: ${r>0?"#28a745":"var(--gray-800)"};">R$ ${r.toFixed(2).replace(".",",")}</div>\n                </div>\n                <div>\n                    <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Total</div>\n                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary-color);">R$ ${i.toFixed(2).replace(".",",")}</div>\n                </div>\n            </div>\n        `,s.style.display="block"}updateSaleTotals(){this.updateDiscountCalculation()}toggleDiscountFields(){const e=document.getElementById("discountFields"),t=document.getElementById("discountSummary"),o=document.getElementById("toggleDiscountBtn");if(e&&t&&o)if("none"!==e.style.display){e.style.display="none",t.style.display="none",o.innerHTML='<i class="fas fa-plus"></i> Aplicar';const a=document.getElementById("saleDiscountType"),s=document.getElementById("saleDiscountValue"),n=document.getElementById("saleCouponCode");a&&(a.value=""),s&&(s.value=""),n&&(n.value="")}else e.style.display="block",o.innerHTML='<i class="fas fa-times"></i> Remover',this.updateDiscountCalculation()}async loadAdminData(){const e=sessionStorage.getItem("username");if(console.log("üü¢ [ADMIN] loadAdminData chamado, username:",e),"admin"===e)try{console.log("üü¢ [ADMIN] Carregando dados do admin..."),console.log("üü¢ [ADMIN] Fazendo fetch para /api/admin?username="+e);const t=await fetch(`/api/admin?username=${e}`);console.log("üü¢ [ADMIN] Response status:",t.status),console.log("üü¢ [ADMIN] Response ok:",t.ok);const o=await t.text(),a=o.trim();if(a.startsWith("//")||a.startsWith("module.exports")||a.startsWith("export")||a.includes("// API Route")||a.includes("module.exports =")){console.error("‚ùå [ADMIN] API retornou c√≥digo JavaScript em vez de JSON."),console.error("‚ùå [ADMIN] Servidor local n√£o suporta fun√ß√µes serverless.");const e={success:!0,totalUsage:{binSize:0,binSizeKB:"0.00",binSizeMB:"0.00",freePlanLimitMB:10,freePlanLimitBytes:10485760,usagePercent:0,remainingMB:"10.00",remainingKB:"10240.00",isNearLimit:!1},usersUsage:[],timestamp:(new Date).toISOString(),message:"API n√£o dispon√≠vel - servidor local n√£o suporta fun√ß√µes serverless. Use Vercel ou configure um servidor Node.js."};return console.log("üü¢ [ADMIN] Dados vazios retornados (API n√£o dispon√≠vel)"),this.renderAdminTotalUsageDashboard(e.totalUsage),void this.renderAdminUsersUsageDashboard(e.usersUsage)}if(!t.ok)throw console.error("‚ùå [ADMIN] Erro HTTP:",t.status,o.substring(0,200)),new Error(`Erro HTTP: ${t.status}`);let s;try{s=JSON.parse(o)}catch(e){console.error("‚ùå [ADMIN] Erro ao fazer parse do JSON:",e),console.error("‚ùå [ADMIN] Resposta (primeiros 200 chars):",o.substring(0,200)),s={success:!0,totalUsage:{binSize:0,binSizeKB:"0.00",binSizeMB:"0.00",freePlanLimitMB:10,freePlanLimitBytes:10485760,usagePercent:0,remainingMB:"10.00",remainingKB:"10240.00",isNearLimit:!1},usersUsage:[],timestamp:(new Date).toISOString(),error:"Erro ao processar resposta da API"}}if(console.log("üü¢ [ADMIN] Dados recebidos:",s),console.log("üü¢ [ADMIN] Result.success:",s.success),s.success)console.log("üü¢ [ADMIN] Renderizando dashboards..."),console.log("üü¢ [ADMIN] totalUsage:",s.totalUsage),console.log("üü¢ [ADMIN] usersUsage:",s.usersUsage),s.totalUsage?this.renderAdminTotalUsageDashboard(s.totalUsage):console.error("‚ùå [ADMIN] totalUsage n√£o encontrado no resultado"),s.usersUsage?this.renderAdminUsersUsageDashboard(s.usersUsage,s.totalUsage):console.error("‚ùå [ADMIN] usersUsage n√£o encontrado no resultado"),console.log("‚úÖ [ADMIN] Dashboards renderizados com sucesso!");else{console.error("‚ùå [ADMIN] Erro ao carregar dados:",s.error);const e=s.error||s.message||"Erro desconhecido";this.showError(`Erro ao carregar dados de administra√ß√£o: ${e}`)}}catch(e){console.error("‚ùå [ADMIN] Erro ao carregar dados:",e),console.error("‚ùå [ADMIN] Stack:",e.stack),this.showError(`Erro ao carregar dados de administra√ß√£o: ${e.message}`)}else console.warn("‚ö†Ô∏è [ADMIN] Acesso negado - apenas administradores")}refreshAdminData(){this.loadAdminData(),this.renderIntegrationsStatus(),this.showSuccess("Dados atualizados com sucesso!")}renderAdminTotalUsageDashboard(e){const t=document.getElementById("adminTotalUsageDashboard");if(!t)return;const o=e.usagePercent>80?"#dc3545":e.usagePercent>60?"#ffc107":"#28a745";t.innerHTML=`\n            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">\n                <div class="admin-stat-card" style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border-left: 4px solid ${o};">\n                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">\n                        <h3 style="margin: 0; color: var(--gray-600); font-size: 0.9rem; font-weight: 600;">Espa√ßo Utilizado</h3>\n                        <i class="fas fa-database" style="color: ${o}; font-size: 1.5rem;"></i>\n                    </div>\n                    <p style="margin: 0; font-size: 2rem; font-weight: 700; color: var(--dark-gray);">${e.binSizeMB} MB</p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--gray-500);">${e.binSizeKB} KB</p>\n                </div>\n                <div class="admin-stat-card" style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border-left: 4px solid #28a745;">\n                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">\n                        <h3 style="margin: 0; color: var(--gray-600); font-size: 0.9rem; font-weight: 600;">Espa√ßo Restante</h3>\n                        <i class="fas fa-hdd" style="color: #28a745; font-size: 1.5rem;"></i>\n                    </div>\n                    <p style="margin: 0; font-size: 2rem; font-weight: 700; color: var(--dark-gray);">${e.remainingMB} MB</p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--gray-500);">${e.remainingKB} KB</p>\n                </div>\n                <div class="admin-stat-card" style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border-left: 4px solid #007bff;">\n                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">\n                        <h3 style="margin: 0; color: var(--gray-600); font-size: 0.9rem; font-weight: 600;">Limite do Plano</h3>\n                        <i class="fas fa-chart-pie" style="color: #007bff; font-size: 1.5rem;"></i>\n                    </div>\n                    <p style="margin: 0; font-size: 2rem; font-weight: 700; color: var(--dark-gray);">${e.freePlanLimitMB} MB</p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--gray-500);">Plano gratuito JSONBin</p>\n                </div>\n                <div class="admin-stat-card" style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border-left: 4px solid ${o};">\n                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">\n                        <h3 style="margin: 0; color: var(--gray-600); font-size: 0.9rem; font-weight: 600;">Percentual de Uso</h3>\n                        <i class="fas fa-percentage" style="color: ${o}; font-size: 1.5rem;"></i>\n                    </div>\n                    <p style="margin: 0; font-size: 2rem; font-weight: 700; color: var(--dark-gray);">${e.usagePercent}%</p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: ${e.isNearLimit?"#dc3545":"var(--gray-500)"};">\n                        ${e.isNearLimit?"‚ö†Ô∏è Pr√≥ximo do limite!":"Dispon√≠vel"}\n                    </p>\n                </div>\n            </div>\n\n            <div style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1.1rem;">\n                    <i class="fas fa-chart-pie"></i> Compara√ß√£o Visual: Utilizado vs Restante\n                </h3>\n                <div style="height: 350px; position: relative;">\n                    <canvas id="adminTotalUsageChart"></canvas>\n                </div>\n            </div>\n        `,setTimeout(()=>{this.renderAdminTotalUsageChart(e)},100)}renderAdminTotalUsageChart(e){const t=document.getElementById("adminTotalUsageChart");if(!t||!window.Chart)return;const o=t.getContext("2d");this.adminTotalUsageChart&&this.adminTotalUsageChart.destroy();const a=parseFloat(e.binSizeMB),s=parseFloat(e.remainingMB);this.adminTotalUsageChart=new Chart(o,{type:"doughnut",data:{labels:["Espa√ßo Utilizado","Espa√ßo Restante"],datasets:[{data:[a,s],backgroundColor:[e.usagePercent>80?"#dc3545":e.usagePercent>60?"#ffc107":"#28a745","#e9ecef"],borderColor:["#fff","#fff"],borderWidth:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(t){const o=t.label||"",a=t.parsed||0;return`${o}: ${a.toFixed(2)} MB (${(a/e.freePlanLimitMB*100).toFixed(2)}%)`}}}}}})}renderAdminUsersUsageDashboard(e,t){const o=document.getElementById("adminUsersUsageDashboard");if(!o)return;const a=[...e].sort((e,t)=>t.dataSize-e.dataSize);o.innerHTML=`\n            <div style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); margin-bottom: 2rem;">\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1.1rem;">\n                    <i class="fas fa-chart-bar"></i> Gr√°fico de Consumo por Usu√°rio\n                </h3>\n                <div style="height: 350px; position: relative;">\n                    <canvas id="adminUsersUsageChart"></canvas>\n                </div>\n            </div>\n\n            <div style="background: var(--white); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1.1rem;">\n                    <i class="fas fa-table"></i> An√°lise de Uso Individual por Usu√°rio\n                </h3>\n                <div style="overflow-x: auto;">\n                    <table style="width: 100%; border-collapse: collapse;">\n                        <thead>\n                            <tr style="background: var(--gray-50); border-bottom: 2px solid var(--gray-200);">\n                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--dark-gray);">Usu√°rio</th>\n                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--dark-gray);">Tamanho (KB)</th>\n                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--dark-gray);">Tamanho (MB)</th>\n                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--dark-gray);">% do Total</th>\n                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--dark-gray);">√öltima Atualiza√ß√£o</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${a.map(e=>{const t=parseFloat(e.usagePercent);return`\n                                <tr style="border-bottom: 1px solid var(--gray-200); background: ${t>30?"#fff5f5":t>15?"#fffbf0":"transparent"};">\n                                    <td style="padding: 0.75rem; font-weight: 600; color: var(--dark-gray);">\n                                        <i class="fas fa-user" style="margin-right: 0.5rem; color: var(--primary-color);"></i>\n                                        ${this.escapeHtml(e.username)}\n                                    </td>\n                                    <td style="padding: 0.75rem; text-align: center; color: var(--gray-700); font-weight: 600;">${e.dataSizeKB} KB</td>\n                                    <td style="padding: 0.75rem; text-align: center; color: var(--gray-700); font-weight: 600;">${e.dataSizeMB} MB</td>\n                                    <td style="padding: 0.75rem; text-align: center; color: var(--gray-700); font-weight: 600;">\n                                        <span style="padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); background: ${t>30?"#fee":t>15?"#fff3cd":"#d4edda"}; color: ${t>30?"#721c24":t>15?"#856404":"#155724"};">\n                                            ${t}%\n                                        </span>\n                                    </td>\n                                    <td style="padding: 0.75rem; text-align: center; color: var(--gray-600); font-size: 0.85rem;">${e.lastUpdateFormatted}</td>\n                                </tr>\n                            `}).join("")}\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        `,setTimeout(()=>{this.renderAdminUsersUsageChart(a)},100)}renderAdminUsersUsageChart(e){const t=document.getElementById("adminUsersUsageChart");if(!t||!window.Chart)return;const o=t.getContext("2d");this.adminUsersUsageChart&&this.adminUsersUsageChart.destroy();const a=e.map(e=>e.username),s=e.map(e=>parseFloat(e.dataSizeMB)),n=e.map(e=>{const t=parseFloat(e.usagePercent);return t>30?"rgba(220, 53, 69, 0.7)":t>15?"rgba(255, 193, 7, 0.7)":"rgba(40, 167, 69, 0.7)"});this.adminUsersUsageChart=new Chart(o,{type:"bar",data:{labels:a,datasets:[{label:"Consumo (MB)",data:s,backgroundColor:n,borderColor:e.map(e=>{const t=parseFloat(e.usagePercent);return t>30?"#dc3545":t>15?"#ffc107":"#28a745"}),borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(t){const o=e[t.dataIndex];return`Consumo: ${o.dataSizeMB} MB (${o.usagePercent}% do total)`}}}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Consumo em MB"}}}}})}calculateProductROI(){const e=document.getElementById("roiProductSelect"),t=document.getElementById("roiResults");if(!e||!t)return;const o=e.value;if(!o)return void(t.style.display="none");const a=this.items.find(e=>e.id===o);if(!a)return void(t.style.display="none");const s=a.price||0,n=a.cost||0;if(n<=0)return t.innerHTML='\n                <div style="text-align: center; padding: 1rem; color: var(--gray-600);">\n                    <i class="fas fa-info-circle"></i> Este produto n√£o possui custo cadastrado.\n                    <br><small style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">Adicione o custo de compra no cadastro do produto para calcular o ROI.</small>\n                </div>\n            ',void(t.style.display="block");const r=s-n,i=s>0?r/s*100:0,c=n>0?r/n*100:0;document.getElementById("roiSalePrice").textContent=`R$ ${s.toFixed(2).replace(".",",")}`,document.getElementById("roiCost").textContent=`R$ ${n.toFixed(2).replace(".",",")}`,document.getElementById("roiProfit").textContent=`R$ ${r.toFixed(2).replace(".",",")}`,document.getElementById("roiMargin").textContent=`${i.toFixed(2)}%`,document.getElementById("roiValue").textContent=`${c.toFixed(2)}%`,t.style.display="block"}simulatePrice(){const e=document.getElementById("simulatorCost"),t=document.getElementById("simulatorMargin"),o=document.getElementById("simulatorDiscount");if(!e||!t||!o)return;const a=parseFloat(e.value)||0,s=parseFloat(t.value)||0,n=parseFloat(o.value)||0;if(a<=0)return document.getElementById("simulatorPrice").textContent="R$ 0,00",document.getElementById("simulatorProfit").textContent="R$ 0,00",void(document.getElementById("simulatorFinalPrice").textContent="R$ 0,00");const r=a/(1-s/100),i=r-a,c=r*(1-n/100);document.getElementById("simulatorPrice").textContent=`R$ ${r.toFixed(2).replace(".",",")}`,document.getElementById("simulatorProfit").textContent=`R$ ${i.toFixed(2).replace(".",",")}`,document.getElementById("simulatorFinalPrice").textContent=`R$ ${c.toFixed(2).replace(".",",")}`}populateROIProductSelect(){const e=document.getElementById("roiProductSelect");if(e){for(;e.options.length>1;)e.remove(1);this.items.forEach(t=>{if(t.cost&&t.cost>0){const o=document.createElement("option");o.value=t.id;const a=t.name||t.brand||t.model||`Produto ${t.id}`;o.textContent=`${a} - R$ ${(t.price||0).toFixed(2).replace(".",",")}`,e.appendChild(o)}}),1===e.options.length&&this.items.forEach(t=>{const o=document.createElement("option");o.value=t.id;const a=t.name||t.brand||t.model||`Produto ${t.id}`;o.textContent=`${a} - R$ ${(t.price||0).toFixed(2).replace(".",",")}`,e.appendChild(o)})}}importData(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=e=>{try{const t=JSON.parse(e.target.result);confirm("Isso ir√° substituir todos os dados atuais. Deseja continuar?")&&(this.items=t.items||[],this.groups=t.groups||[],this.serviceGroups=t.serviceGroups||[],this.costs=t.costs||[],this.goals=t.goals||[],this.items=this.items.map(e=>(e.category||(e.category="Roupas"),e)),this.saveData(),this.renderItems(),this.renderGroups(),this.renderCosts(),this.renderGoals(),this.updateMonthFilter(),this.updateOverallSummary(),alert("Dados importados com sucesso!"))}catch(e){alert("Erro ao importar arquivo. Verifique se o arquivo est√° no formato correto."),console.error("Erro ao importar:",e)}},o.readAsText(t),e.target.value=""}openNotesSearchModal(){const e=document.getElementById("notesSearchModal");if(!e)return void console.error("Modal de busca por notas n√£o encontrado");const t=document.getElementById("notesSearchInput");t&&(t.value="",t.focus());const o=document.getElementById("notesSearchResults");o&&(o.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Digite um termo para buscar nas notas...</p>'),e.classList.add("active")}closeNotesSearchModal(){const e=document.getElementById("notesSearchModal");e&&e.classList.remove("active")}searchNotes(e){if(!e||""===e.trim())return{items:[],clients:[],suppliers:[],sales:[],appointments:[]};const t=e.toLowerCase().trim(),o={items:[],clients:[],suppliers:[],sales:[],appointments:[]};return this.items.forEach(e=>{e.notes&&e.notes.toLowerCase().includes(t)&&o.items.push({id:e.id,name:e.name||e.brand||e.model||`Produto ${e.id}`,notes:e.notes,type:"item"})}),this.clients.forEach(e=>{e.notes&&e.notes.toLowerCase().includes(t)&&o.clients.push({id:e.id,name:e.name,notes:e.notes,type:"client"})}),this.suppliers.forEach(e=>{e.notes&&e.notes.toLowerCase().includes(t)&&o.suppliers.push({id:e.id,name:e.name,notes:e.notes,type:"supplier"})}),this.completedSales.forEach(e=>{e.notes&&e.notes.toLowerCase().includes(t)&&o.sales.push({id:e.id,name:e.customerName,notes:e.notes,date:e.date,type:"sale"})}),this.serviceAppointments.forEach(e=>{e.notes&&e.notes.toLowerCase().includes(t)&&o.appointments.push({id:e.id,name:e.customerName,notes:e.notes,date:e.date,type:"appointment"})}),o}executeNotesSearch(){const e=document.getElementById("notesSearchInput"),t=document.getElementById("notesSearchResults");if(!e||!t)return;const o=e.value.trim();if(!o)return void(t.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Digite um termo para buscar nas notas...</p>');const a=this.searchNotes(o),s=a.items.length+a.clients.length+a.suppliers.length+a.sales.length+a.appointments.length;if(0===s)return void(t.innerHTML=`\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-search"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum resultado encontrado</h3>\n                    <p class="empty-state-message">\n                        N√£o foram encontradas notas contendo "${this.escapeHtml(o)}"\n                    </p>\n                </div>\n            `);let n=`<div style="grid-column: 1/-1; margin-bottom: 1rem; padding: 1rem; background: var(--light-gray); border-radius: var(--radius-md);">\n            <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">\n                <i class="fas fa-search"></i> Resultados da busca: "${this.escapeHtml(o)}"\n            </h3>\n            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">\n                Encontrados ${s} resultado(s)\n            </p>\n        </div>`;a.items.length>0&&(n+=`<div style="grid-column: 1/-1; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-box"></i> Produtos (${a.items.length})\n                </h4>\n            </div>`,a.items.forEach(e=>{n+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Produto</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-sticky-note"></i> <strong>Nota:</strong> ${this.escapeHtml(e.notes)}</p>\n                        </div>\n                    </div>\n                `})),a.clients.length>0&&(n+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-user"></i> Clientes (${a.clients.length})\n                </h4>\n            </div>`,a.clients.forEach(e=>{n+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Cliente</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-sticky-note"></i> <strong>Nota:</strong> ${this.escapeHtml(e.notes)}</p>\n                        </div>\n                    </div>\n                `})),a.suppliers.length>0&&(n+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-truck"></i> Fornecedores (${a.suppliers.length})\n                </h4>\n            </div>`,a.suppliers.forEach(e=>{n+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Fornecedor</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-sticky-note"></i> <strong>Nota:</strong> ${this.escapeHtml(e.notes)}</p>\n                        </div>\n                    </div>\n                `})),a.sales.length>0&&(n+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-shopping-cart"></i> Vendas (${a.sales.length})\n                </h4>\n            </div>`,a.sales.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"N/A";n+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Venda - ${t}</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-sticky-note"></i> <strong>Nota:</strong> ${this.escapeHtml(e.notes)}</p>\n                        </div>\n                    </div>\n                `})),a.appointments.length>0&&(n+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-calendar-check"></i> Agendamentos (${a.appointments.length})\n                </h4>\n            </div>`,a.appointments.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"N/A";n+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Agendamento - ${t}</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-sticky-note"></i> <strong>Nota:</strong> ${this.escapeHtml(e.notes)}</p>\n                        </div>\n                    </div>\n                `})),t.innerHTML=n}openAdvancedSearchModal(){const e=document.getElementById("advancedSearchModal");if(!e)return void console.error("Modal de busca avan√ßada n√£o encontrado");const t=document.getElementById("advancedSearchTerm");t&&(t.value="",t.focus());const o=document.getElementById("advancedSearchResults");o&&(o.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Digite um termo e selecione onde buscar...</p>'),e.classList.add("active")}closeAdvancedSearchModal(){const e=document.getElementById("advancedSearchModal");e&&e.classList.remove("active")}clearAdvancedSearch(){const e=document.getElementById("advancedSearchTerm"),t=document.getElementById("advancedSearchCategory"),o=document.getElementById("advancedSearchDateRange"),a=document.getElementById("advancedSearchResults");e&&(e.value=""),t&&(t.value=""),o&&(o.value=""),a&&(a.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Digite um termo e selecione onde buscar...</p>')}startAdvancedSearchQRScanner(){if(!window.Html5Qrcode)return void(void 0!==toast&&toast?toast.error("Biblioteca de scanner n√£o carregada. Verifique sua conex√£o.",3e3):alert("Biblioteca de scanner n√£o carregada. Verifique sua conex√£o."));const e=document.getElementById("advancedSearchQRContainer"),t=document.getElementById("advancedSearchQRReader");if(!e||!t)return;this.advancedSearchQRScanner&&this.stopAdvancedSearchQRScanner(),t.innerHTML="",e.style.display="block";const o=new Html5Qrcode("advancedSearchQRReader");this.advancedSearchQRScanner=o,o.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},e=>{const t=document.getElementById("advancedSearchTerm");t&&(t.value=e.trim()),this.stopAdvancedSearchQRScanner(),this.executeAdvancedSearch(),void 0!==toast&&toast&&toast.success("QR Code escaneado! Buscando...",2e3)},e=>{}).catch(t=>{console.error("Erro ao iniciar scanner:",t),void 0!==toast&&toast&&toast.error("Erro ao acessar a c√¢mera. Verifique as permiss√µes.",3e3),e.style.display="none",this.advancedSearchQRScanner=null})}stopAdvancedSearchQRScanner(){const e=document.getElementById("advancedSearchQRContainer"),t=document.getElementById("advancedSearchQRReader");this.advancedSearchQRScanner?this.advancedSearchQRScanner.stop().then(()=>{e&&(e.style.display="none"),t&&(t.innerHTML=""),this.advancedSearchQRScanner=null}).catch(o=>{console.error("Erro ao parar scanner:",o),e&&(e.style.display="none"),t&&(t.innerHTML=""),this.advancedSearchQRScanner=null}):(e&&(e.style.display="none"),t&&(t.innerHTML=""))}toggleAdvancedSearchVoice(){const e=document.getElementById("advancedSearchVoiceBtn"),t=document.getElementById("advancedSearchTerm");e&&t&&(this.voiceRecognitionActive?(this.stopVoiceRecognition(),e.classList.remove("active"),e.style.background="",void 0!==toast&&toast&&toast.info("Busca por voz desativada",2e3)):(this.startAdvancedSearchVoice(),e.classList.add("active"),e.style.background="var(--primary-color)",e.style.color="white",void 0!==toast&&toast&&toast.info("Fale o termo de busca...",2e3)))}startAdvancedSearchVoice(){if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return void(void 0!==toast&&toast&&toast.error("Reconhecimento de voz n√£o suportado neste navegador",3e3));if(this.voiceRecognitionActive)return;const e=new(window.SpeechRecognition||window.webkitSpeechRecognition);e.lang="pt-BR",e.continuous=!1,e.interimResults=!1,e.onstart=()=>{this.voiceRecognitionActive=!0,console.log("üé§ [VOICE SEARCH] Reconhecimento de voz iniciado para busca")},e.onresult=e=>{const t=e.results[0][0].transcript;console.log("üé§ [VOICE SEARCH] Texto reconhecido:",t);const o=document.getElementById("advancedSearchTerm");o&&(o.value=t.trim()),setTimeout(()=>{this.executeAdvancedSearch()},500),void 0!==toast&&toast&&toast.success(`Buscando: "${t}"`,2e3)},e.onerror=e=>{console.error("‚ùå [VOICE SEARCH] Erro no reconhecimento:",e.error),this.voiceRecognitionActive=!1;const t=document.getElementById("advancedSearchVoiceBtn");t&&(t.classList.remove("active"),t.style.background=""),"no-speech"===e.error?void 0!==toast&&toast&&toast.warning("Nenhum √°udio detectado. Tente novamente.",2e3):void 0!==toast&&toast&&toast.error("Erro no reconhecimento de voz",2e3)},e.onend=()=>{this.voiceRecognitionActive=!1;const e=document.getElementById("advancedSearchVoiceBtn");e&&(e.classList.remove("active"),e.style.background=""),console.log("üé§ [VOICE SEARCH] Reconhecimento de voz finalizado")},this.voiceRecognition=e,e.start()}executeAdvancedSearch(){const e=document.getElementById("advancedSearchTerm")?.value.trim(),t=document.getElementById("advancedSearchResults");if(!t)return;if(!e)return void(t.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Digite um termo para buscar...</p>');const o=e.toLowerCase(),a={items:[],clients:[],suppliers:[],sales:[],appointments:[]},s=document.getElementById("searchInProducts")?.checked||!1,n=document.getElementById("searchInClients")?.checked||!1,r=document.getElementById("searchInSuppliers")?.checked||!1,i=document.getElementById("searchInSales")?.checked||!1,c=document.getElementById("searchInAppointments")?.checked||!1,l=document.getElementById("searchInNotes")?.checked||!1,d=document.getElementById("advancedSearchCategory")?.value||"",m=document.getElementById("advancedSearchDateRange")?.value||"";let u=null,p=null;if(m){const e=new Date;switch(m){case"today":u=new Date(e.getFullYear(),e.getMonth(),e.getDate()),p=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1);break;case"week":const t=e.getDay();u=new Date(e),u.setDate(e.getDate()-t),u.setHours(0,0,0,0),p=new Date(u),p.setDate(u.getDate()+7);break;case"month":u=new Date(e.getFullYear(),e.getMonth(),1),p=new Date(e.getFullYear(),e.getMonth()+1,1);break;case"quarter":const o=Math.floor(e.getMonth()/3);u=new Date(e.getFullYear(),3*o,1),p=new Date(e.getFullYear(),3*(o+1),1);break;case"year":u=new Date(e.getFullYear(),0,1),p=new Date(e.getFullYear()+1,0,1)}}s&&this.items.forEach(e=>{if(d&&e.category!==d)return;const t=e.name||e.brand||e.model||"",s=e.brand||"",n=e.model||"",r=e.style||"";(t.toLowerCase().includes(o)||s.toLowerCase().includes(o)||n.toLowerCase().includes(o)||r.toLowerCase().includes(o)||l&&e.notes&&e.notes.toLowerCase().includes(o))&&a.items.push({id:e.id,name:t||s||n||`Produto ${e.id}`,category:e.category,price:e.price,type:"item"})}),n&&this.clients.forEach(e=>{(e.name.toLowerCase().includes(o)||e.cpf&&e.cpf.toLowerCase().includes(o)||e.email&&e.email.toLowerCase().includes(o)||e.phone&&e.phone.toLowerCase().includes(o)||l&&e.notes&&e.notes.toLowerCase().includes(o))&&a.clients.push({id:e.id,name:e.name,cpf:e.cpf,email:e.email,type:"client"})}),r&&this.suppliers.forEach(e=>{(e.name.toLowerCase().includes(o)||e.cnpj&&e.cnpj.toLowerCase().includes(o)||e.email&&e.email.toLowerCase().includes(o)||e.phone&&e.phone.toLowerCase().includes(o)||l&&e.notes&&e.notes.toLowerCase().includes(o))&&a.suppliers.push({id:e.id,name:e.name,cnpj:e.cnpj,type:"supplier"})}),i&&this.completedSales.forEach(e=>{if(u&&p){const t=new Date(e.date);if(t<u||t>=p)return}(e.customerName.toLowerCase().includes(o)||e.orderCode&&e.orderCode.toLowerCase().includes(o)||e.items&&e.items.some(e=>e.name&&e.name.toLowerCase().includes(o))||l&&e.notes&&e.notes.toLowerCase().includes(o))&&a.sales.push({id:e.id,name:e.customerName,orderCode:e.orderCode,totalValue:e.totalValue,date:e.date,type:"sale"})}),c&&this.serviceAppointments.forEach(e=>{if(u&&p){const t=new Date(e.date);if(t<u||t>=p)return}const t=this.items.find(t=>t.id===e.serviceTypeId),s=t?t.name||t.brand||t.model:"";(e.customerName.toLowerCase().includes(o)||e.customerContact&&e.customerContact.toLowerCase().includes(o)||s&&s.toLowerCase().includes(o)||l&&e.notes&&e.notes.toLowerCase().includes(o))&&a.appointments.push({id:e.id,name:e.customerName,serviceName:s,date:e.date,time:e.time,status:e.status,type:"appointment"})}),this.renderAdvancedSearchResults(a,e)}renderAdvancedSearchResults(e,t){const o=document.getElementById("advancedSearchResults");if(!o)return;const a=e.items.length+e.clients.length+e.suppliers.length+e.sales.length+e.appointments.length;if(0===a)return void(o.innerHTML=`\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-search"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum resultado encontrado</h3>\n                    <p class="empty-state-message">\n                        N√£o foram encontrados resultados para "${this.escapeHtml(t)}"\n                    </p>\n                </div>\n            `);let s=`<div style="grid-column: 1/-1; margin-bottom: 1rem; padding: 1rem; background: var(--light-gray); border-radius: var(--radius-md);">\n            <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">\n                <i class="fas fa-search"></i> Resultados da busca: "${this.escapeHtml(t)}"\n            </h3>\n            <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">\n                Encontrados ${a} resultado(s)\n            </p>\n        </div>`;e.items.length>0&&(s+=`<div style="grid-column: 1/-1; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-box"></i> Produtos (${e.items.length})\n                </h4>\n            </div>`,e.items.forEach(e=>{s+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">${e.category||"Produto"}</span>\n                        </div>\n                        <div class="item-details">\n                            <p><i class="fas fa-dollar-sign"></i> Pre√ßo: R$ ${(e.price||0).toFixed(2).replace(".",",")}</p>\n                        </div>\n                    </div>\n                `})),e.clients.length>0&&(s+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-user"></i> Clientes (${e.clients.length})\n                </h4>\n            </div>`,e.clients.forEach(e=>{s+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Cliente</span>\n                        </div>\n                        <div class="item-details">\n                            ${e.cpf?`<p><i class="fas fa-id-card"></i> CPF: ${this.escapeHtml(e.cpf)}</p>`:""}\n                            ${e.email?`<p><i class="fas fa-envelope"></i> ${this.escapeHtml(e.email)}</p>`:""}\n                        </div>\n                    </div>\n                `})),e.suppliers.length>0&&(s+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-truck"></i> Fornecedores (${e.suppliers.length})\n                </h4>\n            </div>`,e.suppliers.forEach(e=>{s+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Fornecedor</span>\n                        </div>\n                        <div class="item-details">\n                            ${e.cnpj?`<p><i class="fas fa-building"></i> CNPJ: ${this.escapeHtml(e.cnpj)}</p>`:""}\n                        </div>\n                    </div>\n                `})),e.sales.length>0&&(s+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-shopping-cart"></i> Vendas (${e.sales.length})\n                </h4>\n            </div>`,e.sales.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"N/A";s+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Venda - ${t}</span>\n                        </div>\n                        <div class="item-details">\n                            ${e.orderCode?`<p><i class="fas fa-barcode"></i> C√≥digo: ${this.escapeHtml(e.orderCode)}</p>`:""}\n                            <p><i class="fas fa-dollar-sign"></i> Total: R$ ${(e.totalValue||0).toFixed(2).replace(".",",")}</p>\n                        </div>\n                    </div>\n                `})),e.appointments.length>0&&(s+=`<div style="grid-column: 1/-1; margin-top: 1rem; margin-bottom: 0.5rem;">\n                <h4 style="margin: 0 0 0.75rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-calendar-check"></i> Agendamentos (${e.appointments.length})\n                </h4>\n            </div>`,e.appointments.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"N/A";s+=`\n                    <div class="item-card">\n                        <div class="item-header">\n                            <h3>${this.escapeHtml(e.name)}</h3>\n                            <span style="font-size: 0.75rem; color: var(--gray-600);">Agendamento - ${t}</span>\n                        </div>\n                        <div class="item-details">\n                            ${e.serviceName?`<p><i class="fas fa-tools"></i> Servi√ßo: ${this.escapeHtml(e.serviceName)}</p>`:""}\n                            ${e.time?`<p><i class="fas fa-clock"></i> Hor√°rio: ${this.escapeHtml(e.time)}</p>`:""}\n                            <p><i class="fas fa-info-circle"></i> Status: ${{pending:"Pendente",confirmed:"Confirmado",completed:"Conclu√≠do",cancelled:"Cancelado"}[e.status]||e.status}</p>\n                        </div>\n                    </div>\n                `})),o.innerHTML=s}openPromotionHistoryModal(){const e=document.getElementById("promotionHistoryModal");e?(this.populatePromotionHistoryFilter(),this.renderPromotionHistory(),e.classList.add("active")):console.error("Modal de hist√≥rico de promo√ß√µes n√£o encontrado")}closePromotionHistoryModal(){const e=document.getElementById("promotionHistoryModal");e&&e.classList.remove("active")}populatePromotionHistoryFilter(){const e=document.getElementById("promotionHistoryFilter");if(e){for(;e.options.length>1;)e.remove(1);this.coupons.forEach(t=>{const o=document.createElement("option");o.value=t.code,o.textContent=`${t.code} - ${t.description||"Sem descri√ß√£o"}`,e.appendChild(o)})}}renderPromotionHistory(){const e=document.getElementById("promotionHistoryList"),t=document.getElementById("promotionHistoryFilter");if(!e)return;const o=t?t.value:"",a=this.completedSales.filter(e=>e.discount&&e.discount.couponCode&&(!o||e.discount.couponCode===o));if(0===a.length)return void(e.innerHTML=`\n                <div class="empty-state" style="grid-column: 1/-1;">\n                    <div class="empty-state-icon">\n                        <i class="fas fa-history"></i>\n                    </div>\n                    <h3 class="empty-state-title">Nenhum uso de cupom encontrado</h3>\n                    <p class="empty-state-message">\n                        ${o?"Este cupom ainda n√£o foi usado em nenhuma venda.":"Ainda n√£o h√° vendas que utilizaram cupons de desconto."}\n                    </p>\n                </div>\n            `);const s={};a.forEach(e=>{const t=e.discount.couponCode;if(!s[t]){const e=this.coupons.find(e=>e.code===t);s[t]={coupon:e,sales:[],totalDiscount:0,totalValue:0}}s[t].sales.push(e),s[t].totalDiscount+=e.discount.amount||0,s[t].totalValue+=e.totalValue||0});let n="";Object.keys(s).forEach(e=>{const t=s[e],o=t.coupon;n+=`\n                <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--white); border: 1px solid var(--border-color); border-radius: var(--radius-md);">\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">\n                        <div>\n                            <h3 style="margin: 0; color: var(--primary-color);">\n                                <i class="fas fa-tag"></i> ${this.escapeHtml(e)}\n                            </h3>\n                            ${o?`\n                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">\n                                    ${"percent"===o.type?`${o.value}%`:`R$ ${o.value.toFixed(2).replace(".",",")}`} de desconto\n                                    ${o.description?` - ${this.escapeHtml(o.description)}`:""}\n                                </p>\n                            `:""}\n                        </div>\n                        <div style="text-align: right;">\n                            <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);">Total de usos</p>\n                            <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">\n                                ${t.sales.length}\n                            </p>\n                        </div>\n                    </div>\n                    \n                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">\n                        <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                            <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);">Total em Descontos</p>\n                            <p style="margin: 0.25rem 0 0 0; font-size: 1.2rem; font-weight: 600; color: #28a745;">\n                                R$ ${t.totalDiscount.toFixed(2).replace(".",",")}\n                            </p>\n                        </div>\n                        <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                            <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);">Valor Total das Vendas</p>\n                            <p style="margin: 0.25rem 0 0 0; font-size: 1.2rem; font-weight: 600; color: var(--primary-color);">\n                                R$ ${t.totalValue.toFixed(2).replace(".",",")}\n                            </p>\n                        </div>\n                    </div>\n                    \n                    <div>\n                        <h4 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1rem;">\n                            <i class="fas fa-shopping-cart"></i> Vendas que usaram este cupom (${t.sales.length})\n                        </h4>\n                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">\n                            ${t.sales.map(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"N/A",o=e.date?new Date(e.date).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):"";return`\n                                    <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm); border-left: 3px solid var(--primary-color);">\n                                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 0.5rem;">\n                                            <div style="flex: 1;">\n                                                <p style="margin: 0; font-weight: 600; color: var(--dark-gray);">\n                                                    ${this.escapeHtml(e.customerName||"Cliente n√£o informado")}\n                                                </p>\n                                                <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                                                    <i class="fas fa-calendar"></i> ${t} ${o?`√†s ${o}`:""}\n                                                    ${e.orderCode?` | <i class="fas fa-barcode"></i> ${this.escapeHtml(e.orderCode)}`:""}\n                                                </p>\n                                            </div>\n                                            <div style="text-align: right;">\n                                                <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);">Desconto aplicado</p>\n                                                <p style="margin: 0.25rem 0 0 0; font-weight: 600; color: #28a745;">\n                                                    - R$ ${(e.discount.amount||0).toFixed(2).replace(".",",")}\n                                                </p>\n                                                <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                                                    Total: R$ ${(e.totalValue||0).toFixed(2).replace(".",",")}\n                                                </p>\n                                            </div>\n                                        </div>\n                                    </div>\n                                `}).join("")}\n                        </div>\n                    </div>\n                </div>\n            `}),e.innerHTML=n}checkGoalsAlerts(){const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,o=this.goals.find(e=>e.month===t);if(!o)return;const a=this.getMonthSales(t),s=a/o.amount*100,n=new Date(e.getFullYear(),e.getMonth()+1,0).getDate()-e.getDate();if(s>=75&&s<100&&n<=7){const e=o.amount-a;void 0!==toast&&toast&&toast.warning(`Meta do m√™s: ${s.toFixed(1)}% conclu√≠da. Faltam R$ ${e.toFixed(2).replace(".",",")} e ${n} dia(s) restante(s)!`,5e3)}}checkAppointmentsReminders(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,0,0);const o=new Date(e);o.setHours(23,59,59,999);const a=this.serviceAppointments.filter(t=>{if("completed"===t.status||"cancelled"===t.status)return!1;const a=new Date(`${t.date}T${t.time}`);return a>=e&&a<=o}),s=new Date(t);s.setHours(23,59,59,999);const n=this.serviceAppointments.filter(e=>{if("completed"===e.status||"cancelled"===e.status)return!1;const o=new Date(`${e.date}T${e.time}`);return o>=t&&o<=s});a.length>0&&!sessionStorage.getItem("todayAppointmentsAlerted")&&void 0!==toast&&toast&&(toast.info(`Voc√™ tem ${a.length} agendamento(s) hoje!`,4e3),sessionStorage.setItem("todayAppointmentsAlerted","true")),n.length>0&&!sessionStorage.getItem("tomorrowAppointmentsAlerted")&&void 0!==toast&&toast&&(toast.info(`Voc√™ tem ${n.length} agendamento(s) amanh√£!`,4e3),sessionStorage.setItem("tomorrowAppointmentsAlerted","true"))}checkPendingOrdersAlerts(){const e=new Date;e.setHours(0,0,0,0);const t=this.pendingOrders.filter(t=>{if(!t.dueDate||"cancelled"===t.status||"completed"===t.status)return!1;const o=new Date(t.dueDate);return o.setHours(0,0,0,0),o<e}),o=this.pendingOrders.filter(t=>{if(!t.dueDate||"cancelled"===t.status||"completed"===t.status)return!1;const o=new Date(t.dueDate);o.setHours(0,0,0,0);const a=Math.ceil((o-e)/864e5);return a>=0&&a<=3});t.length>0&&!sessionStorage.getItem("expiredOrdersAlerted")&&void 0!==toast&&toast&&(toast.error(`Aten√ß√£o! ${t.length} pedido(s) vencido(s) precisam de aten√ß√£o.`,5e3),sessionStorage.setItem("expiredOrdersAlerted","true")),o.length>0&&!sessionStorage.getItem("expiringSoonOrdersAlerted")&&void 0!==toast&&toast&&(toast.warning(`${o.length} pedido(s) vence(m) em at√© 3 dias!`,4e3),sessionStorage.setItem("expiringSoonOrdersAlerted","true"))}openReportBuilderModal(){const e=document.getElementById("reportBuilderModal");if(!e)return void console.error("Modal de construtor de relat√≥rios n√£o encontrado");const t=document.getElementById("reportBuilderForm");t&&t.reset();const o=new Date,a=new Date(o.getFullYear(),o.getMonth(),1),s=new Date(o.getFullYear(),o.getMonth()+1,0),n=document.getElementById("reportBuilderStartDate"),r=document.getElementById("reportBuilderEndDate");n&&(n.value=a.toISOString().split("T")[0]),r&&(r.value=s.toISOString().split("T")[0]),e.classList.add("active")}closeReportBuilderModal(){const e=document.getElementById("reportBuilderModal");e&&e.classList.remove("active")}updateReportBuilderFields(){const e=document.getElementById("reportBuilderType")?.value;if(!document.getElementById("reportBuilderFilters"))return;const t=document.getElementById("reportBuilderCategory")?.parentElement,o=document.getElementById("reportBuilderStatus")?.parentElement;t&&(t.style.display="products"===e||"sales"===e?"block":"none"),o&&(o.style.display="sales"===e||"services"===e?"block":"none")}setReportBuilderPeriod(){const e=document.getElementById("reportBuilderPeriod")?.value;if(!e||""===e)return;const t=new Date;let o,a;switch(e){case"today":o=new Date(t),a=new Date(t);break;case"week":const e=t.getDay();o=new Date(t),o.setDate(t.getDate()-e),a=new Date(t),a.setDate(t.getDate()+(6-e));break;case"month":o=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);break;case"quarter":const s=Math.floor(t.getMonth()/3);o=new Date(t.getFullYear(),3*s,1),a=new Date(t.getFullYear(),3*(s+1),0);break;case"year":o=new Date(t.getFullYear(),0,1),a=new Date(t.getFullYear(),11,31);break;case"lastMonth":o=new Date(t.getFullYear(),t.getMonth()-1,1),a=new Date(t.getFullYear(),t.getMonth(),0);break;case"lastQuarter":const n=Math.floor(t.getMonth()/3)-1,r=n<0?t.getFullYear()-1:t.getFullYear(),i=n<0?9:3*n;o=new Date(r,i,1),a=new Date(r,i+3,0);break;case"lastYear":o=new Date(t.getFullYear()-1,0,1),a=new Date(t.getFullYear()-1,11,31);break;default:return}const s=document.getElementById("reportBuilderStartDate"),n=document.getElementById("reportBuilderEndDate");s&&(s.value=o.toISOString().split("T")[0]),n&&(n.value=a.toISOString().split("T")[0])}generateCustomReport(e){e&&e.preventDefault();const t=document.getElementById("reportBuilderType")?.value,o=document.getElementById("reportBuilderStartDate")?.value,a=document.getElementById("reportBuilderEndDate")?.value,s=document.getElementById("reportBuilderFormat")?.value,n=document.getElementById("reportBuilderIncludeCharts")?.checked||!1,r=document.getElementById("reportBuilderIncludeSummary")?.checked||!1,i=document.getElementById("reportBuilderCategory")?.value||"",c=document.getElementById("reportBuilderStatus")?.value||"";if(!t||!s)return void(void 0!==toast&&toast&&toast.warning("Por favor, preencha todos os campos obrigat√≥rios.",3e3));if(!o||!a)return void(void 0!==toast&&toast&&toast.warning("Por favor, selecione o per√≠odo do relat√≥rio.",3e3));let l={},d="";const m=new Date(o),u=new Date(a);switch(u.setHours(23,59,59,999),t){case"sales":d="Relat√≥rio de Vendas",l=this.generateSalesReport(m,u,i,c);break;case"services":d="Relat√≥rio de Servi√ßos",l=this.generateServicesReport(m,u,c);break;case"products":d="Relat√≥rio de Produtos",l=this.generateProductsReport(m,u,i);break;case"clients":d="Relat√≥rio de Clientes",l=this.generateClientsReport(m,u);break;case"financial":d="Relat√≥rio Financeiro",l=this.generateFinancialReport(m,u);break;case"custom":d="Relat√≥rio Personalizado",l=this.generateCustomCombinedReport(m,u,i,c)}const p=document.getElementById("reportBuilderSchedule")?.checked||!1,g=document.getElementById("reportBuilderShare")?.checked||!1,h={type:t,startDate:o,endDate:a,format:s,includeCharts:n,includeSummary:r,category:i,status:c,title:d};if(p){const e=document.getElementById("reportBuilderScheduleDate")?.value,t=document.getElementById("reportBuilderScheduleTime")?.value,o=document.getElementById("reportBuilderScheduleFrequency")?.value||"once";if(!e||!t)return void(void 0!==toast&&toast&&toast.warning("Por favor, preencha data e hora do agendamento.",3e3));this.scheduleReport(h,e,t,o),void 0!==toast&&toast&&toast.success("Relat√≥rio agendado com sucesso!",3e3)}if(g){const e=document.getElementById("reportBuilderShareEmails")?.value,t=document.getElementById("reportBuilderShareMessage")?.value||"";if(!e)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe pelo menos um email para compartilhamento.",3e3));this.shareReport(h,e,t),void 0!==toast&&toast&&toast.success("Relat√≥rio compartilhado com sucesso!",3e3)}p?this.closeReportBuilderModal():(this.exportReport(l,d,s,n,r),this.closeReportBuilderModal(),void 0!==toast&&toast&&toast.success("Relat√≥rio gerado com sucesso!",3e3))}toggleScheduleFields(){const e=document.getElementById("reportBuilderSchedule"),t=document.getElementById("scheduleFields");if(e&&t&&(t.style.display=e.checked?"block":"none",e.checked)){const e=new Date,t=document.getElementById("reportBuilderScheduleDate"),o=document.getElementById("reportBuilderScheduleTime");t&&(t.value=e.toISOString().split("T")[0]),o&&(o.value=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`)}}toggleShareFields(){const e=document.getElementById("reportBuilderShare"),t=document.getElementById("shareFields");e&&t&&(t.style.display=e.checked?"block":"none")}scheduleReport(e,t,o,a){const s=new Date(`${t}T${o}`);if(s<=new Date&&"once"===a)return void(void 0!==toast&&toast&&toast.warning("A data/hora do agendamento deve ser no futuro.",3e3));const n={id:`schedule_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,config:e,scheduleDate:s.toISOString(),frequency:a,createdAt:(new Date).toISOString(),lastRun:null,nextRun:s.toISOString(),active:!0};this.scheduledReports.push(n),this.saveData(),console.log("‚úÖ [SCHEDULE] Relat√≥rio agendado:",n),this.scheduleCheckInterval||this.initScheduleChecker()}shareReport(e,t,o){const a=t.split(",").map(e=>e.trim()).filter(e=>e);if(0===a.length)return void(void 0!==toast&&toast&&toast.warning("Nenhum email v√°lido fornecido.",3e3));const s={id:`share_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,config:e,sharedWith:a,message:o,sharedAt:(new Date).toISOString(),sent:!1};this.sharedReports.push(s),this.saveData(),console.log("‚úÖ [SHARE] Relat√≥rio compartilhado:",s),this.sendSharedReport(s)}async sendSharedReport(e){console.log("üìß [SHARE] Simulando envio de relat√≥rio para:",e.sharedWith),setTimeout(()=>{e.sent=!0,this.saveData(),void 0!==toast&&toast&&toast.info(`Relat√≥rio compartilhado com ${e.sharedWith.length} destinat√°rio(s)`,3e3)},1e3)}initScheduleChecker(){this.scheduleCheckInterval=setInterval(()=>{this.checkScheduledReports()},6e4),this.checkScheduledReports(),console.log("‚úÖ [SCHEDULE] Verificador de agendamentos iniciado")}checkScheduledReports(){const e=new Date;let t=!1;this.scheduledReports.forEach(o=>{if(!o.active)return;const a=new Date(o.nextRun);if(a<=e){if(console.log("‚è∞ [SCHEDULE] Executando relat√≥rio agendado:",o.id),this.executeScheduledReport(o),o.lastRun=(new Date).toISOString(),"once"===o.frequency)o.active=!1;else{const e=new Date(a);switch(o.frequency){case"daily":e.setDate(e.getDate()+1);break;case"weekly":e.setDate(e.getDate()+7);break;case"monthly":e.setMonth(e.getMonth()+1)}o.nextRun=e.toISOString()}t=!0}}),this.scheduledReports=this.scheduledReports.filter(e=>e.active),t&&this.saveData()}executeScheduledReport(e){const{config:t}=e,o=new Date(t.startDate),a=new Date(t.endDate);a.setHours(23,59,59,999);let s={},n=t.title||"Relat√≥rio Agendado";switch(t.type){case"sales":s=this.generateSalesReport(o,a,t.category,t.status);break;case"services":s=this.generateServicesReport(o,a,t.status);break;case"products":s=this.generateProductsReport(o,a,t.category);break;case"clients":s=this.generateClientsReport(o,a);break;case"financial":s=this.generateFinancialReport(o,a);break;case"custom":s=this.generateCustomCombinedReport(o,a,t.category,t.status)}this.exportReport(s,n,t.format,t.includeCharts,t.includeSummary),void 0!==toast&&toast&&toast.success(`Relat√≥rio agendado "${n}" gerado automaticamente!`,5e3),console.log("‚úÖ [SCHEDULE] Relat√≥rio agendado executado:",e.id)}generateSalesReport(e,t,o,a){const s=this.completedSales.filter(s=>{const n=s.date?new Date(s.date):new Date(s.createdAt),r=n>=e&&n<=t,i=!o||s.items?.some(e=>{const t=this.items.find(t=>t.id===e.itemId);return t&&t.category===o}),c=!a||s.status===a;return r&&i&&c}),n=s.reduce((e,t)=>e+(t.totalValue||0),0),r=s.reduce((e,t)=>e+(t.discount?.amount||0),0),i=s.reduce((e,t)=>e+(t.items?.reduce((e,t)=>e+(t.quantity||0),0)||0),0);return{type:"sales",period:{start:e,end:t},summary:{totalSales:s.length,totalValue:n,totalDiscount:r,totalItems:i,averageTicket:s.length>0?n/s.length:0},data:s,generatedAt:(new Date).toISOString()}}generateServicesReport(e,t,o){const a=this.serviceAppointments.filter(a=>{const s=new Date(`${a.date}T${a.time||"00:00"}`),n=s>=e&&s<=t,r=!o||a.status===o;return n&&r}),s=a.reduce((e,t)=>e+(t.price||0),0),n=a.reduce((e,t)=>{const o=this.items.find(e=>e.id===t.serviceTypeId);if(o&&o.duration){const[t,a]=o.duration.split(":").map(Number);return e+t+a/60}return e},0);return{type:"services",period:{start:e,end:t},summary:{totalServices:a.length,totalValue:s,totalHours:n,averageValue:a.length>0?s/a.length:0},data:a,generatedAt:(new Date).toISOString()}}generateProductsReport(e,t,o){const a=this.items.filter(e=>"Servi√ßos"!==e.category&&(!o||e.category===o)),s=a.map(o=>{const a=this.completedSales.filter(a=>{const s=a.date?new Date(a.date):new Date(a.createdAt);return s>=e&&s<=t&&a.items?.some(e=>e.itemId===o.id)}),s=a.reduce((e,t)=>{const a=t.items?.find(e=>e.itemId===o.id);return e+(a?.quantity||0)},0),n=a.reduce((e,t)=>{const a=t.items?.find(e=>e.itemId===o.id);return e+(a?.price||0)*(a?.quantity||0)},0);return{item:o,quantitySold:s,revenue:n,salesCount:a.length}});return{type:"products",period:{start:e,end:t},summary:{totalProducts:a.length,totalRevenue:s.reduce((e,t)=>e+t.revenue,0),totalQuantitySold:s.reduce((e,t)=>e+t.quantitySold,0)},data:s,generatedAt:(new Date).toISOString()}}generateClientsReport(e,t){const o=this.clients.map(o=>{const a=this.completedSales.filter(a=>{const s=a.date?new Date(a.date):new Date(a.createdAt);return a.customerName===o.name&&s>=e&&s<=t}),s=a.reduce((e,t)=>e+(t.totalValue||0),0);return{client:o,salesCount:a.length,totalSpent:s,averageTicket:a.length>0?s/a.length:0}});return{type:"clients",period:{start:e,end:t},summary:{totalClients:this.clients.length,activeClients:o.filter(e=>e.salesCount>0).length,totalRevenue:o.reduce((e,t)=>e+t.totalSpent,0)},data:o,generatedAt:(new Date).toISOString()}}generateFinancialReport(e,t){const o=this.completedSales.filter(o=>{const a=o.date?new Date(o.date):new Date(o.createdAt);return a>=e&&a<=t}),a=this.costs.filter(o=>{const a=o.date?new Date(o.date):new Date(o.createdAt);return a>=e&&a<=t}),s=o.reduce((e,t)=>e+(t.totalValue||0),0),n=a.reduce((e,t)=>e+(t.amount||0),0),r=s-n;return{type:"financial",period:{start:e,end:t},summary:{revenue:s,costs:n,profit:r,margin:s>0?r/s*100:0,salesCount:o.length,costsCount:a.length},sales:o,costs:a,generatedAt:(new Date).toISOString()}}generateCustomCombinedReport(e,t,o,a){return{type:"custom",period:{start:e,end:t},sales:this.generateSalesReport(e,t,o,a),services:this.generateServicesReport(e,t,a),products:this.generateProductsReport(e,t,o),clients:this.generateClientsReport(e,t),financial:this.generateFinancialReport(e,t),generatedAt:(new Date).toISOString()}}exportReport(e,t,o,a,s){const n=`${t.replace(/\s+/g,"_")}_${(new Date).toISOString().split("T")[0]}`;switch(o){case"html":this.exportReportHTML(e,t,n,a,s);break;case"json":this.exportReportJSON(e,n);break;case"csv":this.exportReportCSV(e,n);break;case"txt":this.exportReportTXT(e,t,n,s)}}exportReportHTML(e,t,o,a,s){let n=`<!DOCTYPE html>\n<html lang="pt-BR">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>${t}</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }\n        h1 { color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px; }\n        h2 { color: #666; margin-top: 30px; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        th { background-color: #dc3545; color: white; }\n        .summary { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }\n        .summary-item { margin: 10px 0; }\n        .summary-label { font-weight: bold; color: #666; }\n    </style>\n</head>\n<body>\n    <h1>${t}</h1>\n    <p><strong>Per√≠odo:</strong> ${new Date(e.period.start).toLocaleDateString("pt-BR")} a ${new Date(e.period.end).toLocaleDateString("pt-BR")}</p>\n    <p><strong>Gerado em:</strong> ${new Date(e.generatedAt).toLocaleString("pt-BR")}</p>\n`;s&&e.summary&&(n+='<div class="summary"><h2>Resumo Executivo</h2>',Object.entries(e.summary).forEach(([e,t])=>{const o=e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()),a="number"==typeof t&&t%1!=0?t.toFixed(2).replace(".",","):t;n+=`<div class="summary-item"><span class="summary-label">${o}:</span> ${a}</div>`}),n+="</div>"),n+=this.formatReportDataHTML(e),n+="</body></html>";const r=new Blob([n],{type:"text/html;charset=utf-8"}),i=URL.createObjectURL(r),c=document.createElement("a");c.href=i,c.download=`${o}.html`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(i)}formatReportDataHTML(e){return"<h2>Dados Detalhados</h2><p>Dados completos dispon√≠veis no formato JSON.</p>"}exportReportJSON(e,t){const o=JSON.stringify(e,null,2),a=new Blob([o],{type:"application/json;charset=utf-8"}),s=URL.createObjectURL(a),n=document.createElement("a");n.href=s,n.download=`${t}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}exportReportCSV(e,t){let o="Tipo,Valor\n";e.summary&&Object.entries(e.summary).forEach(([e,t])=>{o+=`${e},${t}\n`});const a=new Blob(["\ufeff"+o],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(a),n=document.createElement("a");n.href=s,n.download=`${t}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}exportReportTXT(e,t,o,a){let s=`${t}\n`;s+=`${"=".repeat(t.length)}\n\n`,s+=`Per√≠odo: ${new Date(e.period.start).toLocaleDateString("pt-BR")} a ${new Date(e.period.end).toLocaleDateString("pt-BR")}\n`,s+=`Gerado em: ${new Date(e.generatedAt).toLocaleString("pt-BR")}\n\n`,a&&e.summary&&(s+="RESUMO EXECUTIVO\n",s+="-".repeat(20)+"\n",Object.entries(e.summary).forEach(([e,t])=>{const o=e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase());s+=`${o}: ${t}\n`}),s+="\n");const n=new Blob([s],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=`${o}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}openExportModal(){if(!this.checkPermission("export"))return void(void 0!==toast&&toast?toast.error("Voc√™ n√£o tem permiss√£o para exportar dados.",3e3):alert("Voc√™ n√£o tem permiss√£o para exportar dados."));const e=document.getElementById("exportModal");if(!e)return void console.error("Modal de exporta√ß√£o n√£o encontrado");const t=document.getElementById("exportForm");t&&t.reset(),e.classList.add("active")}closeExportModal(){const e=document.getElementById("exportModal");e&&e.classList.remove("active")}exportData(e){e&&e.preventDefault();const t=document.getElementById("exportFormat")?.value,o=document.getElementById("exportDataType")?.value,a=document.getElementById("exportIncludeCharts")?.checked||!1,s=document.getElementById("exportIncludeSummary")?.checked||!1;if(!t||!o)return void(void 0!==toast&&toast&&toast.warning("Por favor, preencha todos os campos obrigat√≥rios.",3e3));let n={};switch(o){case"all":n={items:this.items,groups:this.groups,costs:this.costs,goals:this.goals,clients:this.clients,suppliers:this.suppliers,completedSales:this.completedSales,serviceAppointments:this.serviceAppointments,coupons:this.coupons,version:"1.0",exportDate:(new Date).toISOString()};break;case"items":n={items:this.items,version:"1.0",exportDate:(new Date).toISOString()};break;case"sales":n={completedSales:this.completedSales,groups:this.groups,version:"1.0",exportDate:(new Date).toISOString()};break;case"clients":n={clients:this.clients,version:"1.0",exportDate:(new Date).toISOString()};break;case"financial":n={groups:this.groups,costs:this.costs,goals:this.goals,completedSales:this.completedSales,version:"1.0",exportDate:(new Date).toISOString()}}const r=document.getElementById("exportSchedule")?.checked||!1,i=document.getElementById("exportEmail")?.checked||!1,c={format:t,dataType:o,includeCharts:a,includeSummary:s,exportDataObj:n};if(r){const e=document.getElementById("exportScheduleDate")?.value,t=document.getElementById("exportScheduleTime")?.value,o=document.getElementById("exportScheduleFrequency")?.value||"once";if(!e||!t)return void(void 0!==toast&&toast&&toast.warning("Por favor, preencha data e hora do agendamento.",3e3));this.scheduleExport(c,e,t,o,i),void 0!==toast&&toast&&toast.success("Exporta√ß√£o agendada com sucesso!",3e3)}if(i&&!r){const e=document.getElementById("exportEmailRecipients")?.value,t=document.getElementById("exportEmailSubject")?.value||"Exporta√ß√£o de Dados - Loja";if(!e)return void(void 0!==toast&&toast&&toast.warning("Por favor, informe pelo menos um email.",3e3));this.sendExportByEmail(c,e,t),void 0!==toast&&toast&&toast.success("Exporta√ß√£o enviada por email!",3e3)}if(r)this.closeExportModal();else{const e=`loja_export_${o}_${(new Date).toISOString().split("T")[0]}`;switch(t){case"json":this.exportAsJSON(n,e);break;case"pdf":this.exportAsPDF(n,o,e,a,s);break;case"excel":this.exportAsExcel(n,o,e);break;case"csv":this.exportAsCSV(n,o,e)}this.closeExportModal(),void 0!==toast&&toast&&toast.success("Dados exportados com sucesso!",3e3)}}toggleExportScheduleFields(){const e=document.getElementById("exportSchedule"),t=document.getElementById("exportScheduleFields");if(e&&t&&(t.style.display=e.checked?"block":"none",e.checked)){const e=new Date,t=document.getElementById("exportScheduleDate"),o=document.getElementById("exportScheduleTime");t&&(t.value=e.toISOString().split("T")[0]),o&&(o.value=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`)}}toggleExportEmailFields(){const e=document.getElementById("exportEmail"),t=document.getElementById("exportEmailFields");e&&t&&(t.style.display=e.checked?"block":"none")}scheduleExport(e,t,o,a,s=!1){const n=new Date(`${t}T${o}`);if(n<=new Date&&"once"===a)return void(void 0!==toast&&toast&&toast.warning("A data/hora do agendamento deve ser no futuro.",3e3));const r={id:`export_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,config:e,scheduleDate:n.toISOString(),frequency:a,sendEmail:s,emailRecipients:s?document.getElementById("exportEmailRecipients")?.value:null,emailSubject:s?document.getElementById("exportEmailSubject")?.value||"Exporta√ß√£o de Dados - Loja":null,createdAt:(new Date).toISOString(),lastRun:null,nextRun:n.toISOString(),active:!0};this.scheduledExports.push(r),this.saveData(),console.log("‚úÖ [EXPORT SCHEDULE] Exporta√ß√£o agendada:",r),this.exportScheduleCheckInterval||this.initExportScheduleChecker()}async sendExportByEmail(e,t,o){const a=t.split(",").map(e=>e.trim()).filter(e=>e);0!==a.length?(e.dataType,(new Date).toISOString().split("T")[0],console.log("üìß [EXPORT EMAIL] Simulando envio de exporta√ß√£o para:",a),console.log("üìß [EXPORT EMAIL] Assunto:",o),console.log("üìß [EXPORT EMAIL] Formato:",e.format),console.log("üìß [EXPORT EMAIL] Tipo de dados:",e.dataType),setTimeout(()=>{void 0!==toast&&toast&&toast.info(`Exporta√ß√£o enviada para ${a.length} destinat√°rio(s)`,3e3)},1e3)):void 0!==toast&&toast&&toast.warning("Nenhum email v√°lido fornecido.",3e3)}initExportScheduleChecker(){this.exportScheduleCheckInterval=setInterval(()=>{this.checkScheduledExports()},6e4),this.checkScheduledExports(),console.log("‚úÖ [EXPORT SCHEDULE] Verificador de agendamentos de exporta√ß√£o iniciado")}checkScheduledExports(){const e=new Date;let t=!1;this.scheduledExports.forEach(o=>{if(!o.active)return;const a=new Date(o.nextRun);if(a<=e){if(console.log("‚è∞ [EXPORT SCHEDULE] Executando exporta√ß√£o agendada:",o.id),this.executeScheduledExport(o),o.lastRun=(new Date).toISOString(),"once"===o.frequency)o.active=!1;else{const e=new Date(a);switch(o.frequency){case"daily":e.setDate(e.getDate()+1);break;case"weekly":e.setDate(e.getDate()+7);break;case"monthly":e.setMonth(e.getMonth()+1)}o.nextRun=e.toISOString()}t=!0}}),this.scheduledExports=this.scheduledExports.filter(e=>e.active),t&&this.saveData()}executeScheduledExport(e){const{config:t}=e,o=`loja_export_${t.dataType}_${(new Date).toISOString().split("T")[0]}`;switch(t.format){case"json":this.exportAsJSON(t.exportDataObj,o);break;case"pdf":this.exportAsPDF(t.exportDataObj,t.dataType,o,t.includeCharts,t.includeSummary);break;case"excel":this.exportAsExcel(t.exportDataObj,t.dataType,o);break;case"csv":this.exportAsCSV(t.exportDataObj,t.dataType,o)}e.sendEmail&&e.emailRecipients&&this.sendExportByEmail(t,e.emailRecipients,e.emailSubject||"Exporta√ß√£o de Dados - Loja"),void 0!==toast&&toast&&toast.success("Exporta√ß√£o agendada executada automaticamente!",5e3),console.log("‚úÖ [EXPORT SCHEDULE] Exporta√ß√£o agendada executada:",e.id)}exportAsJSON(e,t){const o=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`${t}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}exportAsPDF(e,t,o,a,s){if(void 0===window.jspdf||!window.jspdf.jsPDF)return void(void 0!==toast&&toast?toast.error("Biblioteca jsPDF n√£o est√° dispon√≠vel. Tente outro formato.",3e3):alert("Biblioteca jsPDF n√£o est√° dispon√≠vel. Tente outro formato."));const{jsPDF:n}=window.jspdf,r=new n,i=r.internal.pageSize.getWidth(),c=r.internal.pageSize.getHeight(),l=14;let d=l;r.setFillColor(220,53,69),r.rect(0,0,i,30,"F"),r.setTextColor(255,255,255),r.setFontSize(20),r.setFont("helvetica","bold"),r.text("Relat√≥rio de Exporta√ß√£o",l,20),r.setTextColor(0,0,0),r.setFontSize(10),r.setFont("helvetica","normal"),d=40,r.text(`Exportado em: ${(new Date).toLocaleString("pt-BR")}`,l,d),d+=6,r.text(`Tipo de dados: ${this.getDataTypeLabel(t)}`,l,d),d+=6;const m=sessionStorage.getItem("username")||"Usu√°rio";if(r.text(`Usu√°rio: ${m}`,l,d),d+=10,r.setDrawColor(220,53,69),r.setLineWidth(.5),r.line(l,d,i-l,d),d+=8,s){if(r.setFontSize(14),r.setFont("helvetica","bold"),r.setTextColor(220,53,69),r.text("Resumo Executivo",l,d),d+=8,r.setFontSize(10),r.setFont("helvetica","normal"),r.setTextColor(0,0,0),e.items){const t=e.items.reduce((e,t)=>e+(t.price||0)*(t.stock||0),0);r.text(`Total de Produtos: ${e.items.length}`,l,d),d+=6,r.text(`Valor Total em Estoque: R$ ${t.toFixed(2).replace(".",",")}`,l,d),d+=6}if(e.completedSales){const t=e.completedSales.reduce((e,t)=>e+(t.totalValue||0),0),o=e.completedSales.length>0?t/e.completedSales.length:0;r.text(`Total de Vendas: ${e.completedSales.length}`,l,d),d+=6,r.text(`Valor Total: R$ ${t.toFixed(2).replace(".",",")}`,l,d),d+=6,r.text(`Ticket M√©dio: R$ ${o.toFixed(2).replace(".",",")}`,l,d),d+=6}if(e.clients&&(r.text(`Total de Clientes: ${e.clients.length}`,l,d),d+=6),e.costs){const t=e.costs.reduce((e,t)=>e+(t.amount||0),0);r.text(`Total de Custos: R$ ${t.toFixed(2).replace(".",",")}`,l,d),d+=6}if(e.completedSales&&e.costs){const t=e.completedSales.reduce((e,t)=>e+(t.totalValue||0),0),o=t-e.costs.reduce((e,t)=>e+(t.amount||0),0),a=t>0?o/t*100:0;r.text(`Lucro L√≠quido: R$ ${o.toFixed(2).replace(".",",")}`,l,d),d+=6,r.text(`Margem de Lucro: ${a.toFixed(2).replace(".",",")}%`,l,d),d+=6}d+=5}if(e.items&&e.items.length>0){d>c-60&&(r.addPage(),d=l),r.setFontSize(12),r.setFont("helvetica","bold"),r.setTextColor(220,53,69),r.text("Produtos",l,d),d+=8;const t=e.items.map(e=>[(e.name||"Sem nome").substring(0,30),e.category||"",`R$ ${(e.price||0).toFixed(2).replace(".",",")}`,(e.stock||0).toString(),e.minStock?e.stock<e.minStock?"‚ö†Ô∏è":"‚úì":"-"]);r.autoTable({startY:d,head:[["Nome","Categoria","Pre√ßo","Estoque","Status"]],body:t,theme:"striped",headStyles:{fillColor:[220,53,69],textColor:[255,255,255],fontStyle:"bold"},styles:{fontSize:8,cellPadding:3},columnStyles:{0:{cellWidth:60},1:{cellWidth:40},2:{cellWidth:30,halign:"right"},3:{cellWidth:25,halign:"center"},4:{cellWidth:20,halign:"center"}},margin:{left:l,right:l}}),d=r.lastAutoTable.finalY+10}if(e.completedSales&&e.completedSales.length>0){d>c-60&&(r.addPage(),d=l),r.setFontSize(12),r.setFont("helvetica","bold"),r.setTextColor(220,53,69),r.text("Vendas Recentes",l,d),d+=8;const t=e.completedSales.slice(0,20).map(e=>[new Date(e.date||e.timestamp).toLocaleDateString("pt-BR"),e.clientName||"Cliente n√£o identificado",`R$ ${(e.totalValue||0).toFixed(2).replace(".",",")}`,e.items?.length||0]);r.autoTable({startY:d,head:[["Data","Cliente","Valor","Itens"]],body:t,theme:"striped",headStyles:{fillColor:[220,53,69],textColor:[255,255,255],fontStyle:"bold"},styles:{fontSize:8,cellPadding:3},margin:{left:l,right:l}})}const u=r.internal.getNumberOfPages();for(let e=1;e<=u;e++)r.setPage(e),r.setFontSize(8),r.setTextColor(128,128,128),r.text(`P√°gina ${e} de ${u} | Gerado em ${(new Date).toLocaleString("pt-BR")}`,i/2,c-10,{align:"center"});r.save(`${o}.pdf`)}exportAsExcel(e,t,o){let a="";a="\ufeff",e.items&&e.items.length>0&&(a+="Produtos\n",a+="Nome,Categoria,Pre√ßo,Estoque,Descri√ß√£o\n",e.items.forEach(e=>{a+=`"${(e.name||"").replace(/"/g,'""')}","${(e.category||"").replace(/"/g,'""')}",${(e.price||0).toFixed(2)},${e.stock||0},"${(e.description||"").replace(/"/g,'""')}"\n`}),a+="\n"),e.completedSales&&e.completedSales.length>0&&(a+="VENDAS\n",a+="Data,Cliente,CPF Cliente,Valor Total,Desconto,Itens,Forma de Pagamento\n",e.completedSales.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):e.timestamp?new Date(e.timestamp).toLocaleDateString("pt-BR"):"",o=e.clientName||e.customerName||"Cliente n√£o identificado",s=e.clientCPF||e.customerCPF||"",n=e.discount||e.discountValue||0,r=e.paymentMethod||e.payment||"N√£o informado";a+=`"${t}","${o.replace(/"/g,'""')}","${s.replace(/"/g,'""')}",${(e.totalValue||0).toFixed(2)},${n.toFixed(2)},${(e.items||[]).length},"${r.replace(/"/g,'""')}"\n`}),a+="\n"),e.clients&&e.clients.length>0&&(a+="CLIENTES\n",a+="Nome,CPF,Telefone,Email,Endere√ßo,Pontos de Fidelidade,Total Gasto,Total de Compras\n",e.clients.forEach(e=>{const t=e.totalSpent||0,o=e.totalPurchases||0;a+=`"${(e.name||"").replace(/"/g,'""')}","${(e.cpf||"").replace(/"/g,'""')}","${(e.phone||"").replace(/"/g,'""')}","${(e.email||"").replace(/"/g,'""')}","${(e.address||"").replace(/"/g,'""')}",${e.loyaltyPoints||0},${t.toFixed(2)},${o}\n`}),a+="\n"),e.costs&&e.costs.length>0&&(a+="CUSTOS\n",a+="Data,Descri√ß√£o,Categoria,Valor,Observa√ß√µes\n",e.costs.forEach(e=>{const t=e.date?new Date(e.date).toLocaleDateString("pt-BR"):"";a+=`"${t}","${(e.description||"").replace(/"/g,'""')}","${(e.category||"").replace(/"/g,'""')}",${(e.amount||0).toFixed(2)},"${(e.notes||"").replace(/"/g,'""')}"\n`}),a+="\n"),e.goals&&e.goals.length>0&&(a+="METAS\n",a+="M√™s,Valor da Meta,Valor Alcan√ßado,Percentual,Status\n",e.goals.forEach(e=>{const t=e.month||"",o=e.amount||0,s=this.getMonthSales(t),n=o>0?s/o*100:0,r=n>=100?"Atingida":n>=75?"Em andamento":"Abaixo do esperado";a+=`"${t}",${o.toFixed(2)},${s.toFixed(2)},${n.toFixed(2)}%,"${r}"\n`}),a+="\n"),e.suppliers&&e.suppliers.length>0&&(a+="FORNECEDORES\n",a+="Nome,CNPJ,Telefone,Email,Endere√ßo,Contato\n",e.suppliers.forEach(e=>{a+=`"${(e.name||"").replace(/"/g,'""')}","${(e.cnpj||"").replace(/"/g,'""')}","${(e.phone||"").replace(/"/g,'""')}","${(e.email||"").replace(/"/g,'""')}","${(e.address||"").replace(/"/g,'""')}","${(e.contact||"").replace(/"/g,'""')}"\n`}),a+="\n");const s=new Blob([a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=`${o}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}exportAsCSV(e,t,o){this.exportAsExcel(e,t,o)}getDataTypeLabel(e){return{all:"Todos os Dados",items:"Produtos",sales:"Vendas",clients:"Clientes",financial:"Dados Financeiros"}[e]||e}openPredictiveAnalysisModal(){const e=document.getElementById("predictiveAnalysisModal");e?(e.classList.add("active"),this.updatePredictiveAnalysis()):console.error("Modal de an√°lise preditiva n√£o encontrado")}closePredictiveAnalysisModal(){const e=document.getElementById("predictiveAnalysisModal");e&&e.classList.remove("active")}updatePredictiveAnalysis(){const e=parseInt(document.getElementById("predictivePeriod")?.value||6),t=this.calculateSalesForecast(e),o=document.getElementById("salesForecast");if(o){const e=t.confidence>=70?"üü¢":t.confidence>=50?"üü°":"üî¥";o.innerHTML=`R$ ${t.value.toFixed(2).replace(".",",")} <span style="font-size: 0.8em; color: var(--gray-600);" title="Confian√ßa: ${t.confidence}%">${e}</span>`}const a=document.getElementById("salesForecastDetails");if(a&&t.method){let e=`Confian√ßa: ${t.confidence}%`;t.trend&&(e+=` | Tend√™ncia: ${t.trend>0?"+":""}${t.trend.toFixed(2)}`),t.seasonalAdjustment&&(e+=` | Ajuste sazonal: ${t.seasonalAdjustment>0?"+":""}${t.seasonalAdjustment.toFixed(2)}`),a.textContent=e,a.style.display="block"}const s=this.calculateSalesTrend(e),n=document.getElementById("salesTrend");if(n){const e="up"===s.direction?"üìà":"down"===s.direction?"üìâ":"‚û°Ô∏è",t="up"===s.direction?"#28a745":"down"===s.direction?"#dc3545":"#6c757d",o="strong"===s.strength?"üí™":"moderate"===s.strength?"üëç":"üëé";n.innerHTML=`${e} <span style="color: ${t};">${s.percentage>0?"+":""}${s.percentage.toFixed(1)}%</span> <span style="font-size: 0.8em;" title="For√ßa da tend√™ncia: ${s.strength} (R¬≤=${s.rSquared})">${o}</span>`}const r=document.getElementById("salesTrendDetails");r&&s.strength&&(r.innerHTML=`For√ßa: <strong>${"strong"===s.strength?"Forte":"moderate"===s.strength?"Moderada":"Fraca"}</strong> (R¬≤=${s.rSquared})`,r.style.display="block");const i=this.calculateExpectedGrowth(e),c=document.getElementById("expectedGrowth");if(c){const e=i>0?"#28a745":i<0?"#dc3545":"#6c757d";c.innerHTML=`<span style="color: ${e};">${i>0?"+":""}${i.toFixed(1)}%</span>`}this.generatePredictiveInsights(e,t,s,i),this.generateRecommendations(e,t,s)}calculateSalesForecast(e=6){const t=new Date,o=[];for(let a=e-1;a>=0;a--){const e=new Date(t.getFullYear(),t.getMonth()-a,1),s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,n=this.getMonthSales(s);o.push(n)}if(0===o.length)return{value:0,confidence:0};const a=o.slice(-3),s=a.reduce((e,t)=>e+t,0)/a.length;let n=0;if(o.length>=2){const e=o.slice(0,Math.floor(o.length/2)),t=o.slice(Math.floor(o.length/2)),a=e.reduce((e,t)=>e+t,0)/e.length;n=(t.reduce((e,t)=>e+t,0)/t.length-a)/e.length}let r=0,i=0;o.forEach((e,t)=>{const o=t+1;r+=e*o,i+=o}),r=i>0?r/i:s;const c=t.getMonth(),l=this.calculateSeasonalAdjustment(c,o),d=r+n+l,m=o.reduce((e,t)=>e+Math.pow(t-s,2),0)/o.length,u=Math.sqrt(m),p=s>0?u/s:1;let g=100;return g-=Math.min(50,100*p),o.length<3&&(g-=20),Math.abs(n)>.5*s&&(g-=10),g=Math.max(0,Math.min(100,g)),{value:Math.max(0,d),confidence:Math.round(g),trend:n,seasonalAdjustment:l,method:"weighted_average_with_seasonality"}}calculateSeasonalAdjustment(e,t){if(t.length<12)return 0;const o={};t.forEach((a,s)=>{const n=(e-(t.length-1-s)+12)%12;o[n]||(o[n]=[]),o[n].push(a)});const a=t.reduce((e,t)=>e+t,0)/t.length;return o[e]&&o[e].length>0?o[e].reduce((e,t)=>e+t,0)/o[e].length-a:0}calculateSalesTrend(e=6){const t=new Date,o=[];for(let a=e-1;a>=0;a--){const e=new Date(t.getFullYear(),t.getMonth()-a,1),s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,n=this.getMonthSales(s);o.push(n)}if(o.length<2)return{direction:"stable",percentage:0};const a=o.slice(0,Math.floor(o.length/2)),s=o.slice(Math.floor(o.length/2)),n=a.reduce((e,t)=>e+t,0)/a.length,r=s.reduce((e,t)=>e+t,0)/s.length;if(0===n)return{direction:r>0?"up":"stable",percentage:0};const i=(r-n)/n*100;return{direction:i>5?"up":i<-5?"down":"stable",percentage:i}}calculateExpectedGrowth(e=6){return this.calculateSalesTrend(e).percentage}generatePredictiveInsights(e,t,o,a){const s=document.getElementById("predictiveInsights");if(!s)return;let n=[];t.value>0&&n.push({type:"info",icon:"üìä",title:"Previs√£o de Vendas",message:`Baseado nos √∫ltimos ${e} meses, a previs√£o para o pr√≥ximo m√™s √© de R$ ${t.value.toFixed(2).replace(".",",")} (confian√ßa: ${t.confidence.toFixed(0)}%)`}),"up"===o.direction?n.push({type:"success",icon:"üìà",title:"Tend√™ncia Positiva",message:`Vendas est√£o em crescimento de ${o.percentage.toFixed(1)}% comparado ao per√≠odo anterior`}):"down"===o.direction&&n.push({type:"warning",icon:"üìâ",title:"Tend√™ncia Negativa",message:`Vendas est√£o em decl√≠nio de ${Math.abs(o.percentage).toFixed(1)}% comparado ao per√≠odo anterior`});const r=this.getTopSellingProducts(e);r.length>0&&n.push({type:"info",icon:"‚≠ê",title:"Produtos em Destaque",message:`${r[0].name} √© o produto mais vendido com ${r[0].quantity} unidades nos √∫ltimos ${e} meses`}),s.innerHTML=n.map(e=>`\n            <div style="padding: 1rem; background: ${"success"===e.type?"#d4edda":"warning"===e.type?"#fff3cd":"#d1ecf1"}; border-left: 4px solid ${"success"===e.type?"#28a745":"warning"===e.type?"#ffc107":"#17a2b8"}; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                <div style="display: flex; align-items: start; gap: 0.75rem;">\n                    <span style="font-size: 1.5rem;">${e.icon}</span>\n                    <div style="flex: 1;">\n                        <h4 style="margin: 0 0 0.25rem 0; color: var(--dark-gray); font-size: 0.95rem; font-weight: 600;">${e.title}</h4>\n                        <p style="margin: 0; color: var(--gray-700); font-size: 0.9rem;">${e.message}</p>\n                    </div>\n                </div>\n            </div>\n        `).join("")}generateRecommendations(e,t,o){const a=document.getElementById("recommendationsList");if(!a)return;let s=[];"down"===o.direction&&s.push({priority:"high",title:"A√ß√£o Necess√°ria: Vendas em Decl√≠nio",message:"Considere criar promo√ß√µes ou campanhas de marketing para reverter a tend√™ncia de queda nas vendas."});const n=this.items.filter(e=>"Servi√ßos"!==e.category&&e.stock&&e.minStock&&e.stock<e.minStock);n.length>0&&s.push({priority:"medium",title:"Reposi√ß√£o de Estoque",message:`${n.length} produto(s) est√£o com estoque abaixo do m√≠nimo. Considere fazer reposi√ß√£o.`});const r=new Date,i=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`,c=this.goals.find(e=>e.month===i);if(c){const e=this.getMonthSales(i)/c.amount*100,t=new Date(r.getFullYear(),r.getMonth()+1,0).getDate()-r.getDate();e<75&&t<=7&&s.push({priority:"high",title:"Meta em Risco",message:`A meta do m√™s est√° em ${e.toFixed(1)}% com apenas ${t} dia(s) restante(s). A√ß√£o imediata recomendada.`})}t.value>0&&t.confidence>70&&s.push({priority:"low",title:"Oportunidade de Crescimento",message:`A previs√£o indica vendas de R$ ${t.value.toFixed(2).replace(".",",")} no pr√≥ximo m√™s. Prepare-se para atender essa demanda.`}),0===s.length?a.innerHTML='<p style="color: var(--gray-600); font-style: italic;">Nenhuma recomenda√ß√£o no momento.</p>':a.innerHTML=s.map(e=>`\n                <div style="padding: 1rem; background: ${"high"===e.priority?"#fee":"medium"===e.priority?"#fff3cd":"#f8f9fa"}; border-left: 4px solid ${"high"===e.priority?"#dc3545":"medium"===e.priority?"#ffc107":"#6c757d"}; border-radius: var(--radius-sm); margin-bottom: 0.75rem;">\n                    <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-gray); font-size: 0.95rem; font-weight: 600;">${e.title}</h4>\n                    <p style="margin: 0; color: var(--gray-700); font-size: 0.9rem;">${e.message}</p>\n                </div>\n            `).join("")}getTopSellingProducts(e=6){const t=new Date,o={};for(let a=e-1;a>=0;a--){const e=new Date(t.getFullYear(),t.getMonth()-a,1),s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,n=this.groups.find(e=>e.month===s);n&&n.days.forEach(e=>{e.sales.forEach(e=>{e.items.forEach(e=>{o[e.itemId]||(o[e.itemId]={itemId:e.itemId,quantity:0,revenue:0}),o[e.itemId].quantity+=e.quantity||0,o[e.itemId].revenue+=(e.price||0)*(e.quantity||0)})})})}return Object.values(o).map(e=>({...e,name:this.getItemName(e.itemId)})).sort((e,t)=>t.quantity-e.quantity).slice(0,5)}checkCookieConsent(){const e=localStorage.getItem("cookieConsent");e?(this.cookieConsent=JSON.parse(e),this.updateCookieConsentStatus()):this.showCookieConsentBanner()}showCookieConsentBanner(){const e=document.getElementById("cookieConsentBanner");e&&e.remove();const t=document.createElement("div");t.id="cookieConsentBanner",t.style.cssText="\n            position: fixed;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            background: var(--dark-gray);\n            color: var(--white);\n            padding: 1rem 1.5rem;\n            z-index: 10000;\n            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            gap: 1rem;\n            flex-wrap: wrap;\n        ",t.innerHTML='\n            <div style="flex: 1; min-width: 250px;">\n                <p style="margin: 0; font-size: 0.9rem;">\n                    <i class="fas fa-cookie-bite"></i> Este site utiliza cookies e armazenamento local para melhorar sua experi√™ncia. \n                    <a href="#" onclick="app.openPrivacyPolicyModal(); return false;" style="color: var(--primary-color); text-decoration: underline;">Saiba mais</a>\n                </p>\n            </div>\n            <div style="display: flex; gap: 0.5rem;">\n                <button onclick="app.acceptCookieConsent()" style="padding: 0.5rem 1rem; background: var(--primary-color); color: var(--white); border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">\n                    Aceitar\n                </button>\n                <button onclick="app.rejectCookieConsent()" style="padding: 0.5rem 1rem; background: transparent; color: var(--white); border: 1px solid var(--white); border-radius: var(--radius-sm); cursor: pointer;">\n                    Recusar\n                </button>\n            </div>\n        ',document.body.appendChild(t)}acceptCookieConsent(){const e={accepted:!0,timestamp:(new Date).toISOString(),version:"1.0"};localStorage.setItem("cookieConsent",JSON.stringify(e)),this.cookieConsent=e,this.updateCookieConsentStatus(),this.hideCookieConsentBanner(),void 0!==toast&&toast&&toast.success("Consentimento de cookies aceito.",3e3)}rejectCookieConsent(){const e={accepted:!1,timestamp:(new Date).toISOString(),version:"1.0"};localStorage.setItem("cookieConsent",JSON.stringify(e)),this.cookieConsent=e,this.updateCookieConsentStatus(),this.hideCookieConsentBanner(),localStorage.removeItem("appTheme"),localStorage.removeItem("searchHistory"),void 0!==toast&&toast&&toast.info("Consentimento recusado. Alguns recursos podem n√£o funcionar corretamente.",4e3)}hideCookieConsentBanner(){const e=document.getElementById("cookieConsentBanner");e&&e.remove()}updateCookieConsentStatus(){const e=document.getElementById("cookieConsentStatus");if(e)if(this.cookieConsent){const t=new Date(this.cookieConsent.timestamp),o=this.cookieConsent.accepted?"Aceito":"Recusado",a=this.cookieConsent.accepted?"#28a745":"#dc3545";e.innerHTML=`\n                <span style="color: ${a}; font-weight: 600;">${o}</span> em ${t.toLocaleDateString("pt-BR")} √†s ${t.toLocaleTimeString("pt-BR")}\n            `}else e.textContent="N√£o definido"}openPrivacyPolicyModal(){const e=document.getElementById("privacyPolicyModal");if(!e)return void console.error("Modal de pol√≠tica de privacidade n√£o encontrado");const t=document.getElementById("privacyPolicyDate");t&&(t.textContent=(new Date).toLocaleDateString("pt-BR")),e.classList.add("active"),this.logDataAccess("view","privacy_policy",null,"Visualiza√ß√£o da pol√≠tica de privacidade")}closePrivacyPolicyModal(){const e=document.getElementById("privacyPolicyModal");e&&e.classList.remove("active")}exportPrivacyPolicy(){const e=document.getElementById("privacyPolicyContent")?.innerText||"",t=new Blob([e],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=`politica_privacidade_${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),void 0!==toast&&toast&&toast.success("Pol√≠tica de privacidade exportada com sucesso!",3e3)}exportPersonalData(){const e=sessionStorage.getItem("username");if(!e)return void(void 0!==toast&&toast&&toast.error("Usu√°rio n√£o identificado.",3e3));const t={username:e,exportedAt:(new Date).toISOString(),clients:this.clients||[],suppliers:this.suppliers||[],userData:{items:this.items||[],groups:this.groups||[],costs:this.costs||[],goals:this.goals||[],completedSales:this.completedSales||[],pendingOrders:this.pendingOrders||[],serviceAppointments:this.serviceAppointments||[]},preferences:{theme:localStorage.getItem(`appTheme_${e}`)||"red"},auditLog:(this.auditLog||[]).filter(t=>t.username===e),dataAccessLogs:(this.dataAccessLogs||[]).filter(t=>t.username===e)},o=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`meus_dados_${e}_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),this.logDataAccess("export","personal_data",e,"Exporta√ß√£o de dados pessoais"),void 0!==toast&&toast&&toast.success("Dados pessoais exportados com sucesso!",3e3)}requestDataDeletion(){const e=sessionStorage.getItem("username");if(!e)return void(void 0!==toast&&toast&&toast.error("Usu√°rio n√£o identificado.",3e3));const t="Tem certeza que deseja solicitar a exclus√£o de todos os seus dados pessoais?\n\nEsta a√ß√£o ir√°:\n- Excluir todos os clientes cadastrados\n- Excluir todos os fornecedores cadastrados\n- Excluir todos os dados de vendas associados\n- Excluir prefer√™ncias e configura√ß√µes\n\nEsta a√ß√£o N√ÉO PODE ser desfeita!";void 0!==confirmDialog&&confirmDialog?confirmDialog.danger(t,"Solicitar Exclus√£o de Dados").then(t=>{t&&this.performDataDeletion(e)}):confirm(t)&&this.performDataDeletion(e)}performDataDeletion(e){try{this.logDataAccess("delete_request","personal_data",e,"Solicita√ß√£o de exclus√£o de dados (LGPD)"),this.clients=[],this.suppliers=[];const t=`lojaData_${e}`;localStorage.removeItem(t),localStorage.removeItem(`appTheme_${e}`),this.completedSales=this.completedSales.filter(e=>!e.clientName||"Cliente n√£o cadastrado"===e.clientName),this.saveData(),this.logDataAccess("delete","personal_data",e,"Exclus√£o de dados pessoais realizada"),void 0!==toast&&toast&&toast.success("Dados pessoais exclu√≠dos com sucesso!",3e3),setTimeout(()=>{window.location.reload()},2e3)}catch(e){console.error("Erro ao excluir dados:",e),void 0!==toast&&toast&&toast.error("Erro ao excluir dados. Verifique o console.",4e3)}}viewDataAccessLogs(){const e=document.getElementById("dataAccessLogsModal");e?(e.classList.add("active"),this.renderDataAccessLogs()):console.error("Modal de logs de acesso n√£o encontrado")}closeDataAccessLogsModal(){const e=document.getElementById("dataAccessLogsModal");e&&e.classList.remove("active")}renderDataAccessLogs(e="all"){const t=document.getElementById("dataAccessLogsList");if(!t)return;let o=this.dataAccessLogs||[];"all"!==e&&(o=o.filter(t=>"client"===e?"client"===t.entityType:"supplier"===e?"supplier"===t.entityType:"export"===e?"export"===t.action:"delete"!==e||"delete"===t.action||"delete_request"===t.action)),o.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),0!==o.length?t.innerHTML=o.map(e=>{const t=new Date(e.timestamp),o={view:"üëÅÔ∏è",export:"üì•",delete:"üóëÔ∏è",delete_request:"‚ö†Ô∏è",update:"‚úèÔ∏è",create:"‚ûï"}[e.action]||"üìã";return`\n                <div style="padding: 1rem; background: var(--white); border-left: 4px solid ${{view:"#17a2b8",export:"#28a745",delete:"#dc3545",delete_request:"#ffc107",update:"#007bff",create:"#6c757d"}[e.action]||"#6c757d"}; border-radius: var(--radius-sm); margin-bottom: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">\n                    <div style="display: flex; align-items: start; gap: 0.75rem;">\n                        <span style="font-size: 1.5rem;">${o}</span>\n                        <div style="flex: 1;">\n                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">\n                                <h4 style="margin: 0; color: var(--dark-gray); font-size: 0.95rem; font-weight: 600;">\n                                    ${"view"===e.action?"Visualiza√ß√£o":"export"===e.action?"Exporta√ß√£o":"delete"===e.action?"Exclus√£o":"delete_request"===e.action?"Solicita√ß√£o de Exclus√£o":"update"===e.action?"Atualiza√ß√£o":"create"===e.action?"Cria√ß√£o":e.action}\n                                </h4>\n                                <span style="font-size: 0.85rem; color: var(--gray-600);">\n                                    ${t.toLocaleDateString("pt-BR")} ${t.toLocaleTimeString("pt-BR")}\n                                </span>\n                            </div>\n                            <p style="margin: 0 0 0.25rem 0; color: var(--gray-700); font-size: 0.9rem;">\n                                <strong>Tipo:</strong> ${"client"===e.entityType?"Cliente":"supplier"===e.entityType?"Fornecedor":"personal_data"===e.entityType?"Dados Pessoais":e.entityType||"N/A"}\n                            </p>\n                            <p style="margin: 0 0 0.25rem 0; color: var(--gray-700); font-size: 0.9rem;">\n                                <strong>Usu√°rio:</strong> ${e.username||"N/A"}\n                            </p>\n                            ${e.description?`<p style="margin: 0; color: var(--gray-600); font-size: 0.85rem; font-style: italic;">${e.description}</p>`:""}\n                        </div>\n                    </div>\n                </div>\n            `}).join(""):t.innerHTML='<p style="text-align: center; color: var(--gray-600); padding: 2rem;">Nenhum log de acesso encontrado.</p>'}filterDataAccessLogs(){const e=document.getElementById("dataAccessLogsFilter")?.value||"all";this.renderDataAccessLogs(e)}exportDataAccessLogs(){const e=this.dataAccessLogs||[],t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=`logs_acesso_dados_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),void 0!==toast&&toast&&toast.success("Logs de acesso exportados com sucesso!",3e3)}logDataAccess(e,t,o,a){const s=sessionStorage.getItem("username")||"unknown",n=(new Date).toISOString(),r={id:"DATA_ACCESS_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),action:e,entityType:t,entityId:o,username:s,timestamp:n,description:a};this.dataAccessLogs.unshift(r),this.dataAccessLogs.length>500&&(this.dataAccessLogs=this.dataAccessLogs.slice(0,500)),setTimeout(()=>{this.saveData()},100)}async loadCryptoConfig(e){if(this.cryptoConfig&&this.cryptoConfig.username===e)return this.cryptoConfig;try{const t=await fetch("/api/crypto-config",{method:"GET",headers:{"Content-Type":"application/json","X-Username":e}});if(!t.ok)return console.warn("‚ö†Ô∏è [CRYPTO] N√£o foi poss√≠vel carregar config do servidor, usando fallback local"),this.getLocalCryptoConfig(e);const o=await t.json();if(o.success&&o.config)return this.cryptoConfig={...o.config,username:e},console.log("‚úÖ [CRYPTO] Configura√ß√£o carregada do servidor"),this.cryptoConfig}catch(e){console.warn("‚ö†Ô∏è [CRYPTO] Erro ao carregar config do servidor:",e.message)}return this.getLocalCryptoConfig(e)}getLocalCryptoConfig(e){const t=this.generateLocalDerivedSalt(e);return this.cryptoConfig={derivedSalt:t,algorithm:"AES-GCM",keyLength:256,iterations:1e5,hashAlgorithm:"SHA-256",username:e,isLocal:!0},console.log("‚ÑπÔ∏è [CRYPTO] Usando configura√ß√£o local (offline)"),this.cryptoConfig}generateLocalDerivedSalt(e){const t=`${e}:${sessionStorage.getItem("sessionId")||this.generateSessionId()}:${navigator.userAgent.slice(0,50)}`;let o=0;for(let e=0;e<t.length;e++)o=(o<<5)-o+t.charCodeAt(e),o&=o;return btoa(Math.abs(o).toString(16)+t.slice(0,20))}generateSessionId(){const e="sess_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36);return sessionStorage.setItem("sessionId",e),e}async loadCryptoConfig(e){if(this.cryptoConfig&&this.cryptoConfig.username===e)return this.cryptoConfig;try{const t=await fetch("/api/crypto-config",{method:"GET",headers:{"Content-Type":"application/json","X-Username":e}});if(!t.ok)return console.warn("‚ö†Ô∏è [CRYPTO] N√£o foi poss√≠vel carregar config do servidor, usando fallback local"),this.getLocalCryptoConfig(e);const o=await t.json();if(o.success&&o.config)return this.cryptoConfig={...o.config,username:e},console.log("‚úÖ [CRYPTO] Configura√ß√£o carregada do servidor"),this.cryptoConfig}catch(e){console.warn("‚ö†Ô∏è [CRYPTO] Erro ao carregar config do servidor:",e.message)}return this.getLocalCryptoConfig(e)}getLocalCryptoConfig(e){const t=this.generateLocalDerivedSalt(e);return this.cryptoConfig={derivedSalt:t,algorithm:"AES-GCM",keyLength:256,iterations:1e5,hashAlgorithm:"SHA-256",username:e,isLocal:!0},console.log("‚ÑπÔ∏è [CRYPTO] Usando configura√ß√£o local (offline)"),this.cryptoConfig}generateLocalDerivedSalt(e){const t=`${e}:${sessionStorage.getItem("sessionId")||this.generateSessionId()}:${navigator.userAgent.slice(0,50)}`;let o=0;for(let e=0;e<t.length;e++)o=(o<<5)-o+t.charCodeAt(e),o&=o;return btoa(Math.abs(o).toString(16)+t.slice(0,20))}generateSessionId(){const e="sess_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36);return sessionStorage.setItem("sessionId",e),e}async generateEncryptionKey(e,t){try{const o=await this.loadCryptoConfig(e);if(!o||!o.derivedSalt)return console.error("‚ùå [CRYPTO] N√£o foi poss√≠vel obter configura√ß√£o de criptografia"),null;const a=await crypto.subtle.importKey("raw",(new TextEncoder).encode(e+t+o.derivedSalt),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),s=await crypto.subtle.deriveKey({name:"PBKDF2",salt:(new TextEncoder).encode(o.derivedSalt),iterations:o.iterations||1e5,hash:o.hashAlgorithm||"SHA-256"},a,{name:o.algorithm||"AES-GCM",length:o.keyLength||256},!0,["encrypt","decrypt"]);return this.encryptionKeys[e]=s,s}catch(e){return console.error("Erro ao gerar chave de criptografia:",e),null}}async getEncryptionKey(e){if(this.encryptionKeys[e])return this.encryptionKeys[e];const t=sessionStorage.getItem("userPasswordHash");return t?await this.generateEncryptionKey(e,t):null}async encryptSensitiveData(e,t){if(!this.encryptionEnabled)return e;try{const o=await this.getEncryptionKey(t);if(!o)return console.warn("‚ö†Ô∏è [ENCRYPT] Chave de criptografia n√£o dispon√≠vel, dados n√£o ser√£o criptografados"),e;const a=JSON.stringify(e),s=(new TextEncoder).encode(a),n=crypto.getRandomValues(new Uint8Array(12)),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},o,s),i=new Uint8Array(n.length+r.byteLength);return i.set(n,0),i.set(new Uint8Array(r),n.length),{encrypted:!0,data:btoa(String.fromCharCode(...i)),algorithm:"AES-GCM",timestamp:(new Date).toISOString()}}catch(t){return console.error("Erro ao criptografar dados:",t),e}}async decryptSensitiveData(e,t){if(!e||!e.encrypted)return e;try{const o=await this.getEncryptionKey(t);if(!o)return console.warn("‚ö†Ô∏è [DECRYPT] Chave de criptografia n√£o dispon√≠vel, dados n√£o podem ser descriptografados"),e;const a=Uint8Array.from(atob(e.data),e=>e.charCodeAt(0)),s=a.slice(0,12),n=a.slice(12),r=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},o,n),i=(new TextDecoder).decode(r);return JSON.parse(i)}catch(t){return console.error("Erro ao descriptografar dados:",t),e}}async encryptClientData(e,t){if(!this.encryptionEnabled||!e||0===e.length)return e;try{const o=[];for(const a of e){const e={cpf:a.cpf,phone:a.phone,email:a.email,address:a.address},s=await this.encryptSensitiveData(e,t);o.push({...a,sensitiveData:s,cpf:null,phone:null,email:null,address:null})}return o}catch(t){return console.error("Erro ao criptografar dados de clientes:",t),e}}async decryptClientData(e,t){if(!e||0===e.length)return e;try{const o=[];for(const a of e)if(a.sensitiveData&&a.sensitiveData.encrypted){const e=await this.decryptSensitiveData(a.sensitiveData,t);o.push({...a,...e,sensitiveData:void 0})}else o.push(a);return o}catch(t){return console.error("Erro ao descriptografar dados de clientes:",t),e}}async encryptBackup(e,t){if(!this.encryptionEnabled)return e;try{return{...e,clients:await this.encryptClientData(e.clients||[],t),suppliers:await this.encryptClientData(e.suppliers||[],t)}}catch(t){return console.error("Erro ao criptografar backup:",t),e}}async decryptBackup(e,t){try{return{...e,clients:await this.decryptClientData(e.clients||[],t),suppliers:await this.decryptClientData(e.suppliers||[],t)}}catch(t){return console.error("Erro ao descriptografar backup:",t),e}}canMakeRequest(){const e=Date.now();return e-this.requestWindowStart>=6e4&&(this.requestWindowStart=e,this.requestCount=0),this.requestCount>=30?{allowed:!1,remainingSeconds:Math.ceil((6e4-(e-this.requestWindowStart))/1e3)}:{allowed:!0}}async makeRequestWithRateLimit(e,t={}){const o=this.canMakeRequest();if(!o.allowed)throw new Error(`Rate limit atingido. Aguarde ${o.remainingSeconds} segundos.`);this.requestCount++;const a=Date.now()-this.lastRequestTime;return a<200&&await new Promise(e=>setTimeout(e,200-a)),this.lastRequestTime=Date.now(),fetch(e,t)}startInactivityMonitoring(){this.resetInactivityTimer(),["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(e=>{document.addEventListener(e,()=>{this.resetInactivityTimer()},{passive:!0})}),console.log("‚úÖ [INACTIVITY] Monitoramento de inatividade iniciado")}resetInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.lastActivityTime=Date.now(),this.inactivityTimer=setTimeout(()=>{this.logoutUser()},this.inactivityTimeout);const e=this.inactivityTimeout-3e5;setTimeout(()=>{this.inactivityTimer&&void 0!==toast&&toast&&toast.warning("Voc√™ ser√° desconectado em 5 minutos por inatividade. Mova o mouse ou pressione uma tecla para continuar.",1e4)},e)}logoutUser(){console.log("‚ö†Ô∏è [INACTIVITY] Logout autom√°tico por inatividade"),this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=null),sessionStorage.removeItem("loggedIn"),sessionStorage.removeItem("username"),sessionStorage.removeItem("userRole"),void 0!==toast&&toast&&toast.error("Voc√™ foi desconectado por inatividade. Fa√ßa login novamente.",5e3),setTimeout(()=>{window.location.href="/index.html"},2e3)}async requestNotificationPermission(){return"Notification"in window?"granted"===Notification.permission||"denied"!==Notification.permission&&"granted"===await Notification.requestPermission():(console.warn("‚ö†Ô∏è [PWA] Notifica√ß√µes n√£o suportadas neste navegador"),!1)}async showNotification(e,t={}){if(!await this.requestNotificationPermission())return void console.warn("‚ö†Ô∏è [PWA] Permiss√£o de notifica√ß√µes negada");const o={body:t.body||"",icon:"/images/icone-e-transicao.jpg",badge:"/images/icone-e-transicao.jpg",tag:t.tag||"loja-notification",requireInteraction:t.requireInteraction||!1,data:t.data||{},actions:t.actions||[]};try{if("serviceWorker"in navigator){const t=await navigator.serviceWorker.ready;await t.showNotification(e,o)}else new Notification(e,o)}catch(e){console.error("Erro ao exibir notifica√ß√£o:",e)}}async sendPushNotification(e,t,o={}){if("serviceWorker"in navigator)try{const a=await navigator.serviceWorker.ready;await a.showNotification(e,{body:t,icon:"/images/icone-e-transicao.jpg",badge:"/images/icone-e-transicao.jpg",tag:"loja-push",data:o,requireInteraction:!1})}catch(e){console.error("Erro ao enviar notifica√ß√£o push:",e)}else console.warn("‚ö†Ô∏è [PWA] Service Worker n√£o dispon√≠vel")}isOnline(){return navigator.onLine}async syncWhenOnline(){if(this.isOnline())try{if("serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype){const e=await navigator.serviceWorker.ready;await e.sync.register("sync-data")}else await this.saveData()}catch(e){console.error("Erro ao sincronizar dados:",e)}}async checkPWAInstallation(){return!!window.matchMedia("(display-mode: standalone)").matches||!("BeforeInstallPromptEvent"in window)&&null}async promptPWAInstallation(){return"BeforeInstallPromptEvent"in window||console.warn("‚ö†Ô∏è [PWA] Instala√ß√£o n√£o suportada"),!1}async initPWA(){let e;await this.checkPWAInstallation()&&console.log("‚úÖ [PWA] Aplicativo instalado"),window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),e=t;const o=document.getElementById("installPWAButton");o&&(o.style.display="block",o.addEventListener("click",async()=>{if(e){e.prompt();const{outcome:t}=await e.userChoice;console.log(`[PWA] Instala√ß√£o: ${t}`),e=null,o.style.display="none"}}))}),window.addEventListener("appinstalled",()=>{console.log("‚úÖ [PWA] Aplicativo instalado com sucesso!"),void 0!==toast&&toast&&toast.success("Aplicativo instalado com sucesso!",3e3)}),window.addEventListener("online",()=>{console.log("‚úÖ [PWA] Conex√£o restaurada"),this.syncWhenOnline(),void 0!==toast&&toast&&toast.info("Conex√£o restaurada. Sincronizando dados...",3e3)}),window.addEventListener("offline",()=>{console.warn("‚ö†Ô∏è [PWA] Conex√£o perdida"),void 0!==toast&&toast&&toast.warning("Voc√™ est√° offline. Algumas funcionalidades podem estar limitadas.",4e3)})}async buscarCEP(e){try{const t=e.replace(/\D/g,"");if(8!==t.length)throw new Error("CEP deve conter 8 d√≠gitos");const o=await fetch(`https://viacep.com.br/ws/${t}/json/`);if(!o.ok)throw new Error("Erro ao buscar CEP");const a=await o.json();if(a.erro)throw new Error("CEP n√£o encontrado");return{cep:a.cep,logradouro:a.logradouro||"",complemento:a.complemento||"",bairro:a.bairro||"",cidade:a.localidade||"",estado:a.uf||"",enderecoCompleto:`${a.logradouro||""}, ${a.bairro||""}, ${a.localidade||""} - ${a.uf||""}`.replace(/^,\s*|,\s*$/g,"")}}catch(e){throw console.error("Erro ao buscar CEP:",e),e}}async preencherEnderecoPorCEP(e,t,o,a){const s=e.value;if(8===s.replace(/\D/g,"").length)try{const e=await this.buscarCEP(s);t&&(t.value=e.logradouro||""),o&&(o.value=e.cidade||""),a&&(a.value=e.estado||""),void 0!==toast&&toast&&toast.success("Endere√ßo preenchido automaticamente!",2e3)}catch(e){console.error("Erro ao preencher endere√ßo:",e),void 0!==toast&&toast&&toast.error("CEP n√£o encontrado ou inv√°lido",3e3)}}validarCPF(e){const t=e.replace(/\D/g,"");if(11!==t.length)return!1;if(/^(\d)\1{10}$/.test(t))return!1;let o=0;for(let e=0;e<9;e++)o+=parseInt(t.charAt(e))*(10-e);let a=11-o%11;if(a>=10&&(a=0),a!==parseInt(t.charAt(9)))return!1;o=0;for(let e=0;e<10;e++)o+=parseInt(t.charAt(e))*(11-e);return a=11-o%11,a>=10&&(a=0),a===parseInt(t.charAt(10))}validarCNPJ(e){const t=e.replace(/\D/g,"");if(14!==t.length)return!1;if(/^(\d)\1{13}$/.test(t))return!1;let o=t.length-2,a=t.substring(0,o),s=t.substring(o),n=0,r=o-7;for(let e=o;e>=1;e--)n+=a.charAt(o-e)*r--,r<2&&(r=9);let i=n%11<2?0:11-n%11;if(i!==parseInt(s.charAt(0)))return!1;o+=1,a=t.substring(0,o),n=0,r=o-7;for(let e=o;e>=1;e--)n+=a.charAt(o-e)*r--,r<2&&(r=9);return i=n%11<2?0:11-n%11,i===parseInt(s.charAt(1))}async buscarCotacaoMoedas(e="BRL",t="USD"){try{const o=await fetch(`https://api.exchangerate-api.com/v4/latest/${e}`);if(!o.ok)throw new Error("Erro ao buscar cota√ß√£o");const a=await o.json();return{base:a.base,date:a.date,rates:a.rates,targetRate:a.rates[t]||null}}catch(e){throw console.error("Erro ao buscar cota√ß√£o:",e),e}}async converterMoeda(e,t,o){try{const a=await this.buscarCotacaoMoedas(t,o);if(!a.targetRate)throw new Error(`Taxa de c√¢mbio n√£o encontrada para ${o}`);return e*a.targetRate}catch(e){throw console.error("Erro ao converter moeda:",e),e}}async obterGeolocalizacao(){return new Promise((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy})},e=>{t(e)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):t(new Error("Geolocaliza√ß√£o n√£o suportada"))})}async buscarEnderecoPorCoordenadas(e,t){try{const o=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`,{headers:{"User-Agent":"LojaGestaoApp/1.0"}});if(!o.ok)throw new Error("Erro ao buscar endere√ßo");const a=await o.json();return{endereco:a.display_name||"",cidade:a.address?.city||a.address?.town||"",estado:a.address?.state||"",cep:a.address?.postcode||""}}catch(e){throw console.error("Erro ao buscar endere√ßo por coordenadas:",e),e}}calcularDistancia(e,t,o,a){const s=this.toRad(o-e),n=this.toRad(a-t),r=Math.sin(s/2)*Math.sin(s/2)+Math.cos(this.toRad(e))*Math.cos(this.toRad(o))*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371}toRad(e){return e*Math.PI/180}async buscarInfoCNPJ(e){try{const t=e.replace(/\D/g,"");if(14!==t.length)throw new Error("CNPJ deve conter 14 d√≠gitos");const o=await fetch(`https://www.receitaws.com.br/v1/${t}`);if(!o.ok)throw new Error("Erro ao buscar CNPJ");const a=await o.json();if("ERROR"===a.status)throw new Error(a.message||"CNPJ n√£o encontrado");return{cnpj:a.cnpj,nome:a.nome||"",fantasia:a.fantasia||"",situacao:a.situacao||"",abertura:a.abertura||"",tipo:a.tipo||"",logradouro:a.logradouro||"",numero:a.numero||"",complemento:a.complemento||"",bairro:a.bairro||"",municipio:a.municipio||"",uf:a.uf||"",cep:a.cep||"",telefone:a.telefone||"",email:a.email||""}}catch(e){throw console.error("Erro ao buscar CNPJ:",e),e}}initIndexedDB(){if(!window.indexedDB)return console.warn("‚ö†Ô∏è [INDEXEDDB] IndexedDB n√£o suportado neste navegador"),void(this.useIndexedDB=!1);const e=indexedDB.open(this.dbName,this.dbVersion);e.onerror=e=>{console.error("‚ùå [INDEXEDDB] Erro ao abrir banco de dados:",e),this.useIndexedDB=!1},e.onsuccess=e=>{this.indexedDB=e.target.result,this.useIndexedDB=!0,console.log("‚úÖ [INDEXEDDB] Banco de dados aberto com sucesso")},e.onupgradeneeded=e=>{const t=e.target.result;if(t.objectStoreNames.contains("data")||t.createObjectStore("data",{keyPath:"username"}).createIndex("username","username",{unique:!0}),!t.objectStoreNames.contains("backups")){const e=t.createObjectStore("backups",{keyPath:"id",autoIncrement:!0});e.createIndex("username","username",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}console.log("‚úÖ [INDEXEDDB] Estrutura do banco de dados criada/atualizada")}}initVoiceNavigation(){"webkitSpeechRecognition"in window||"SpeechRecognition"in window?(this.setupVoiceCommands(),console.log("‚úÖ [VOICE] Navega√ß√£o por voz inicializada")):console.warn("‚ö†Ô∏è [VOICE] Web Speech API n√£o suportada neste navegador")}setupVoiceCommands(){this.voiceCommands={"abrir produtos":()=>this.switchTab("itemsPanel"),"abrir clientes":()=>this.switchTab("clientsPanel"),"abrir vendas":()=>this.switchTab("salesPanel"),"abrir fornecedores":()=>this.switchTab("suppliersPanel"),"abrir admin":()=>this.switchTab("adminPanel"),"novo produto":()=>this.openItemModal(),"novo cliente":()=>this.openClientModal(),"nova venda":()=>this.openSaleModal(),salvar:()=>this.saveData(),fechar:()=>this.closeAllModals(),ajuda:()=>{const e=document.getElementById("helpBtn");e&&e.click()}}}startVoiceRecognition(){if(this.voiceRecognitionActive)return void console.log("‚ÑπÔ∏è [VOICE] Reconhecimento de voz j√° est√° ativo");const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(e){this.voiceRecognition=new e,this.voiceRecognition.lang="pt-BR",this.voiceRecognition.continuous=!1,this.voiceRecognition.interimResults=!1,this.voiceRecognition.onstart=()=>{this.voiceRecognitionActive=!0,console.log("üé§ [VOICE] Reconhecimento de voz iniciado"),void 0!==toast&&toast&&toast.info("Ouvindo...",2e3)},this.voiceRecognition.onresult=e=>{const t=e.results[0][0].transcript.toLowerCase().trim();console.log("üé§ [VOICE] Comando reconhecido:",t),this.processVoiceCommand(t)},this.voiceRecognition.onerror=e=>{console.error("‚ùå [VOICE] Erro no reconhecimento:",e.error),this.voiceRecognitionActive=!1},this.voiceRecognition.onend=()=>{this.voiceRecognitionActive=!1,console.log("üõë [VOICE] Reconhecimento de voz finalizado")};try{this.voiceRecognition.start()}catch(e){console.error("‚ùå [VOICE] Erro ao iniciar reconhecimento:",e)}}else console.error("‚ùå [VOICE] SpeechRecognition n√£o dispon√≠vel")}stopVoiceRecognition(){this.voiceRecognition&&this.voiceRecognitionActive&&(this.voiceRecognition.stop(),this.voiceRecognitionActive=!1,console.log("üõë [VOICE] Reconhecimento de voz parado"))}processVoiceCommand(e){for(const[t,o]of Object.entries(this.voiceCommands))if(e.includes(t))return console.log(`‚úÖ [VOICE] Executando comando: ${t}`),o(),void(void 0!==toast&&toast&&toast.success(`Comando executado: ${t}`,2e3));console.log("‚ö†Ô∏è [VOICE] Comando n√£o reconhecido:",e),void 0!==toast&&toast&&toast.warning("Comando n√£o reconhecido",2e3)}toggleVoiceRecognition(){this.voiceRecognitionActive?this.stopVoiceRecognition():this.startVoiceRecognition()}announceLiveRegion(e,t="polite"){let o=document.getElementById("aria-live-region");o||(o=document.createElement("div"),o.id="aria-live-region",o.setAttribute("role","status"),o.setAttribute("aria-live",t),o.setAttribute("aria-atomic","true"),o.className="sr-only",o.style.cssText="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;",document.body.appendChild(o)),o.textContent=e,setTimeout(()=>{o&&(o.textContent="")},1e3)}initPullToRefresh(){if(!this.isMobileDevice())return;const e=document.querySelector(".main-content")||document.body;let t=document.getElementById("pullToRefreshIndicator");t||(t=document.createElement("div"),t.id="pullToRefreshIndicator",t.style.cssText="\n                position: fixed;\n                top: -60px;\n                left: 50%;\n                transform: translateX(-50%);\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                background: var(--primary-color);\n                color: white;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n                transition: top 0.3s ease;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n            ",t.innerHTML='<i class="fas fa-sync-alt"></i>',document.body.appendChild(t));let o=0,a=0,s=!1,n=0,r=!1;e.addEventListener("touchstart",t=>{const a=window.scrollY||window.pageYOffset||document.documentElement.scrollTop,i=e.scrollTop||0;a<=5&&i<=5?(o=t.touches[0].clientY,n=a,s=!1,r=!1):o=0},{passive:!0}),e.addEventListener("touchmove",i=>{if(0===o)return;const c=window.scrollY||window.pageYOffset||document.documentElement.scrollTop,l=e.scrollTop||0;if(c>n+5||l>5)return r=!0,void(o=0);a=i.touches[0].clientY;const d=a-o;if(d>0&&c<=5&&l<=5&&!r){s=!0,d>10&&i.preventDefault();const e=120,o=80,a=Math.min(d,e),n=Math.min(a/o,1);t.style.top=`${Math.min(a-20,60)}px`;const r=360*n;t.querySelector("i").style.transform=`rotate(${r}deg)`,a>=o?(t.style.background="var(--primary-color)",t.style.transform="translateX(-50%) scale(1.1)"):(t.style.background="var(--gray-500)",t.style.transform="translateX(-50%) scale(1)")}else d<0&&(o=0,s=!1,this.resetPullToRefreshIndicator(t))},{passive:!1}),e.addEventListener("touchend",()=>{s&&o>0&&!r&&a-o>=this.pullToRefresh.threshold?this.triggerPullToRefresh(t):this.resetPullToRefreshIndicator(t),o=0,a=0,s=!1,r=!1,n=0},{passive:!0}),console.log("‚úÖ [PULL-TO-REFRESH] Inicializado")}async triggerPullToRefresh(e){if(this.pullToRefresh.isRefreshing)return;this.pullToRefresh.isRefreshing=!0;const t=e||document.getElementById("pullToRefreshIndicator");t&&(t.style.top="20px",t.querySelector("i").classList.add("fa-spin")),this.announceLiveRegion("Atualizando dados...");try{await this.loadData(),void 0!==toast&&toast&&toast.success("Dados atualizados!",2e3),this.announceLiveRegion("Dados atualizados com sucesso")}catch(e){console.error("‚ùå [PULL-TO-REFRESH] Erro ao atualizar:",e),void 0!==toast&&toast&&toast.error("Erro ao atualizar dados",3e3),this.announceLiveRegion("Erro ao atualizar dados")}finally{setTimeout(()=>{this.resetPullToRefreshIndicator(t),this.pullToRefresh.isRefreshing=!1},500)}}resetPullToRefreshIndicator(e){const t=e||document.getElementById("pullToRefreshIndicator");t&&(t.style.top="-60px",t.querySelector("i").classList.remove("fa-spin"),t.querySelector("i").style.transform="rotate(0deg)",t.style.background="var(--gray-500)",t.style.transform="translateX(-50%) scale(1)")}analyzeCompetition(e=6){const t={priceComparison:this.comparePrices(e),productComparison:this.compareProducts(e),marketTrends:this.analyzeMarketTrends(e),competitiveAdvantages:this.identifyCompetitiveAdvantages(e),recommendations:[]};return t.recommendations=this.generateCompetitiveRecommendations(t),t}comparePrices(e=6){const t=new Date,o=new Date(t.getFullYear(),t.getMonth()-e,1),a=this.completedSales.filter(e=>new Date(e.date)>=o).flatMap(e=>e.items||[]).map(e=>{const t=this.items.find(t=>t.id===e.id||t.name===e.name);return t?{price:e.price||t.price,cost:t.cost||0}:null}).filter(e=>null!==e),s=a.length>0?a.reduce((e,t)=>e+(t.price||0),0)/a.length:0,n=a.length>0?a.reduce((e,t)=>e+(t.cost>0?(t.price-t.cost)/t.price*100:0),0)/a.length:0,r=1.1*s;return{ourAvgPrice:s,marketAvgPrice:r,priceDifference:(s-r)/r*100,ourAvgMargin:n,marketAvgMargin:35,marginDifference:n-35,competitiveness:s<r?"competitivo":s>r?"acima":"similar"}}compareProducts(e=6){const t=new Date,o=new Date(t.getFullYear(),t.getMonth()-e,1),a={};this.completedSales.filter(e=>new Date(e.date)>=o).forEach(e=>{(e.items||[]).forEach(e=>{const t=this.items.find(t=>t.id===e.id||t.name===e.name);t&&t.category&&(a[t.category]=(a[t.category]||0)+1)})});const s=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({category:e,sales:t})),n=new Set;return this.completedSales.filter(e=>new Date(e.date)>=o).forEach(e=>{(e.items||[]).forEach(e=>{n.add(e.id||e.name)})}),{topCategories:s,productDiversity:n.size,totalProducts:this.items.length,diversityScore:n.size/this.items.length*100,marketShare:this.calculateMarketShare(e)}}analyzeMarketTrends(e=6){const t=new Date,o=[];for(let a=e-1;a>=0;a--){const e=new Date(t.getFullYear(),t.getMonth()-a,1),s=new Date(t.getFullYear(),t.getMonth()-a+1,0),n=this.completedSales.filter(t=>{const o=new Date(t.date);return o>=e&&o<=s}),r=n.reduce((e,t)=>e+(t.totalValue||0),0),i=n.length;o.push({month:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,total:r,count:i,avgTicket:i>0?r/i:0})}const a=o.slice(0,Math.floor(o.length/2)),s=o.slice(Math.floor(o.length/2)),n=a.reduce((e,t)=>e+t.total,0)/a.length,r=s.reduce((e,t)=>e+t.total,0)/s.length;return{monthlyData:o,trend:r>n?"crescimento":r<n?"decl√≠nio":"est√°vel",trendPercentage:n>0?(r-n)/n*100:0,avgMonthlyGrowth:this.calculateAverageGrowth(o),seasonality:this.detectSeasonality(o)}}identifyCompetitiveAdvantages(e=6){const t=[],o=this.comparePrices(e);"competitivo"===o.competitiveness&&t.push({type:"pre√ßo",description:"Pre√ßos abaixo da m√©dia do mercado",impact:"alto",value:Math.abs(o.priceDifference)}),o.ourAvgMargin>o.marketAvgMargin&&t.push({type:"margem",description:"Margem de lucro acima da m√©dia",impact:"alto",value:o.marginDifference});const a=this.compareProducts(e);a.diversityScore>70&&t.push({type:"diversidade",description:"Boa diversidade de produtos",impact:"m√©dio",value:a.diversityScore});const s=this.analyzeMarketTrends(e);return"crescimento"===s.trend&&s.trendPercentage>5&&t.push({type:"crescimento",description:"Crescimento consistente",impact:"alto",value:s.trendPercentage}),t}calculateMarketShare(e=6){const t=new Date,o=new Date(t.getFullYear(),t.getMonth()-e,1),a=this.completedSales.filter(e=>new Date(e.date)>=o).reduce((e,t)=>e+(t.totalValue||0),0),s=20*a;return{ourSales:a,estimatedMarketTotal:s,marketShare:s>0?a/s*100:0}}calculateAverageGrowth(e){if(e.length<2)return 0;const t=[];for(let o=1;o<e.length;o++){const a=e[o-1].total,s=e[o].total;a>0&&t.push((s-a)/a*100)}return t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0}detectSeasonality(e){const t={};e.forEach(e=>{const o=parseInt(e.month.split("-")[1]);t[o]||(t[o]=[]),t[o].push(e.total)});const o={};Object.keys(t).forEach(e=>{const a=t[e];o[e]=a.reduce((e,t)=>e+t,0)/a.length});const a=Object.values(o).reduce((e,t)=>e+t,0)/Object.keys(o).length,s={};return Object.keys(o).forEach(e=>{s[e]=(o[e]-a)/a*100}),{hasSeasonality:Math.max(...Object.values(s))-Math.min(...Object.values(s))>20,monthVariations:s,peakMonth:Object.keys(o).reduce((e,t)=>o[e]>o[t]?e:t),lowMonth:Object.keys(o).reduce((e,t)=>o[e]<o[t]?e:t)}}generateCompetitiveRecommendations(e){const t=[];return"acima"===e.priceComparison.competitiveness&&t.push({type:"pre√ßo",priority:"alta",title:"Ajustar Pre√ßos",description:`Seus pre√ßos est√£o ${e.priceComparison.priceDifference.toFixed(1)}% acima da m√©dia do mercado. Considere revisar pre√ßos para aumentar competitividade.`,action:"Revisar estrat√©gia de precifica√ß√£o"}),e.priceComparison.marginDifference<-5&&t.push({type:"margem",priority:"alta",title:"Melhorar Margem de Lucro",description:`Sua margem est√° ${Math.abs(e.priceComparison.marginDifference).toFixed(1)}% abaixo da m√©dia. Considere negociar melhores condi√ß√µes com fornecedores ou ajustar pre√ßos.`,action:"Negociar com fornecedores"}),e.productComparison.diversityScore<50&&t.push({type:"produto",priority:"m√©dia",title:"Aumentar Diversidade de Produtos",description:`Sua diversidade de produtos est√° baixa (${e.productComparison.diversityScore.toFixed(1)}%). Considere expandir o cat√°logo.`,action:"Adicionar novos produtos"}),"decl√≠nio"===e.marketTrends.trend&&e.marketTrends.trendPercentage<-10&&t.push({type:"tend√™ncia",priority:"alta",title:"Revers√£o de Tend√™ncia",description:`Vendas em decl√≠nio de ${Math.abs(e.marketTrends.trendPercentage).toFixed(1)}%. Considere campanhas promocionais ou ajustes estrat√©gicos.`,action:"Criar campanha promocional"}),0===e.competitiveAdvantages.length&&t.push({type:"geral",priority:"m√©dia",title:"Desenvolver Vantagens Competitivas",description:"Identifique e desenvolva diferenciais competitivos para se destacar no mercado.",action:"An√°lise estrat√©gica"}),t}openCompetitiveAnalysisModal(){const e=document.getElementById("competitiveAnalysisModal");e?(e.classList.add("active"),this.updateCompetitiveAnalysis()):console.error("Modal de an√°lise de concorr√™ncia n√£o encontrado")}closeCompetitiveAnalysisModal(){const e=document.getElementById("competitiveAnalysisModal");e&&e.classList.remove("active")}updateCompetitiveAnalysis(){const e=parseInt(document.getElementById("competitivePeriod")?.value||6);this.renderCompetitiveAnalysis(e)}exportCompetitiveAnalysis(){const e=parseInt(document.getElementById("competitivePeriod")?.value||6),t={period:e,analysis:this.analyzeCompetition(e),generatedAt:(new Date).toISOString()},o=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`analise_concorrencia_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),void 0!==toast&&toast&&toast.success("An√°lise de concorr√™ncia exportada com sucesso!",3e3)}renderCompetitiveAnalysis(e=6){const t=this.analyzeCompetition(e),o=document.getElementById("competitiveAnalysisContainer");if(!o)return;let a=`\n            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">\n                <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                    <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--gray-600);">Competitividade de Pre√ßos</h3>\n                    <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: ${"competitivo"===t.priceComparison.competitiveness?"#28a745":"acima"===t.priceComparison.competitiveness?"#dc3545":"#6c757d"};">\n                        ${"competitivo"===t.priceComparison.competitiveness?"‚úì Competitivo":"acima"===t.priceComparison.competitiveness?"‚Üë Acima":"‚Üí Similar"}\n                    </p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                        ${t.priceComparison.priceDifference>0?"+":""}${t.priceComparison.priceDifference.toFixed(1)}% vs mercado\n                    </p>\n                </div>\n                <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                    <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--gray-600);">Margem de Lucro</h3>\n                    <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: ${t.priceComparison.ourAvgMargin>t.priceComparison.marketAvgMargin?"#28a745":"#dc3545"};">\n                        ${t.priceComparison.ourAvgMargin.toFixed(1)}%\n                    </p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                        ${t.priceComparison.marginDifference>0?"+":""}${t.priceComparison.marginDifference.toFixed(1)}% vs mercado\n                    </p>\n                </div>\n                <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                    <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--gray-600);">Diversidade de Produtos</h3>\n                    <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: ${t.productComparison.diversityScore>70?"#28a745":t.productComparison.diversityScore>50?"#ffc107":"#dc3545"};">\n                        ${t.productComparison.diversityScore.toFixed(1)}%\n                    </p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                        ${t.productComparison.productDiversity} produtos √∫nicos\n                    </p>\n                </div>\n                <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius-sm);">\n                    <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--gray-600);">Tend√™ncia de Mercado</h3>\n                    <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: ${"crescimento"===t.marketTrends.trend?"#28a745":"decl√≠nio"===t.marketTrends.trend?"#dc3545":"#6c757d"};">\n                        ${"crescimento"===t.marketTrends.trend?"üìà Crescimento":"decl√≠nio"===t.marketTrends.trend?"üìâ Decl√≠nio":"‚û°Ô∏è Est√°vel"}\n                    </p>\n                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--gray-600);">\n                        ${t.marketTrends.trendPercentage>0?"+":""}${t.marketTrends.trendPercentage.toFixed(1)}%\n                    </p>\n                </div>\n            </div>\n\n            <div style="margin-bottom: 1.5rem;">\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-trophy"></i> Vantagens Competitivas\n                </h3>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">\n                    ${t.competitiveAdvantages.length>0?t.competitiveAdvantages.map(e=>`\n                            <div style="padding: 0.75rem; background: ${"alto"===e.impact?"#d4edda":"#fff3cd"}; border-left: 3px solid ${"alto"===e.impact?"#28a745":"#ffc107"}; border-radius: var(--radius-sm);">\n                                <strong style="display: block; margin-bottom: 0.25rem; color: var(--dark-gray);">${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</strong>\n                                <p style="margin: 0; font-size: 0.85rem; color: var(--gray-700);">${e.description}</p>\n                            </div>\n                        `).join(""):'<p style="color: var(--gray-600);">Nenhuma vantagem competitiva identificada no per√≠odo.</p>'}\n                </div>\n            </div>\n\n            <div style="margin-bottom: 1.5rem;">\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray); font-size: 1rem;">\n                    <i class="fas fa-lightbulb"></i> Recomenda√ß√µes\n                </h3>\n                <div style="display: flex; flex-direction: column; gap: 0.75rem;">\n                    ${t.recommendations.map(e=>`\n                        <div style="padding: 1rem; background: ${"alta"===e.priority?"#f8d7da":"#fff3cd"}; border-left: 4px solid ${"alta"===e.priority?"#dc3545":"#ffc107"}; border-radius: var(--radius-sm);">\n                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">\n                                <strong style="color: var(--dark-gray);">${e.title}</strong>\n                                <span style="padding: 0.25rem 0.5rem; background: ${"alta"===e.priority?"#dc3545":"#ffc107"}; color: white; border-radius: var(--radius-sm); font-size: 0.75rem;">\n                                    ${"alta"===e.priority?"Alta":"M√©dia"}\n                                </span>\n                            </div>\n                            <p style="margin: 0 0 0.5rem 0; color: var(--gray-700); font-size: 0.9rem;">${e.description}</p>\n                            <p style="margin: 0; font-size: 0.85rem; color: var(--gray-600);"><strong>A√ß√£o:</strong> ${e.action}</p>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `;o.innerHTML=a}initCacheCleanup(){setInterval(()=>{const e=Date.now();Object.keys(this.chartCache).forEach(t=>{const o=this.chartCache[t];o&&o.timestamp&&e-o.timestamp>(this.cacheStrategies.charts.ttl||3e5)&&(delete this.chartCache[t],console.log(`üóëÔ∏è [CACHE] Cache expirado removido: ${t}`))})},6e4),console.log("‚úÖ [CACHE] Limpeza autom√°tica de cache inicializada")}setupScrollThrottle(){const e=(e,t)=>{let o;return function(){const a=arguments;o||(e.apply(this,a),o=!0,setTimeout(()=>o=!1,t))}};document.querySelectorAll(".items-list, .clients-list, .suppliers-list, .main-content").forEach(t=>{t&&t.addEventListener("scroll",e(()=>{},100),{passive:!0})}),console.log("‚úÖ [SCROLL] Throttle de scroll configurado")}initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const o=e.target;o.dataset.src&&(o.src=o.dataset.src,o.removeAttribute("data-src"),o.classList.add("loaded"),t.unobserve(o))}})},{rootMargin:"50px"});document.querySelectorAll("img[data-src]").forEach(t=>{e.observe(t)}),console.log("‚úÖ [LAZY LOADING] Lazy loading de imagens inicializado")}else document.querySelectorAll("img[data-src]").forEach(e=>{e.src=e.dataset.src,e.removeAttribute("data-src")})}renderListWithVirtualScrolling(e,t,o,a=20){const s=document.getElementById(e);if(!s)return;let n=1;const r=Math.ceil(t.length/a),i=e=>{const c=(e-1)*a,l=c+a,d=t.slice(c,l);if(s.innerHTML="",d.forEach((e,t)=>{const a=o(e,c+t);a&&s.appendChild(a)}),r>1){const e=document.createElement("div");e.className="pagination",e.style.cssText="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 1rem;";const o=document.createElement("button");o.className="btn-small btn-secondary",o.innerHTML='<i class="fas fa-chevron-left"></i> Anterior',o.disabled=1===n,o.addEventListener("click",()=>{n>1&&(n--,i(n))}),e.appendChild(o);const a=document.createElement("span");a.textContent=`P√°gina ${n} de ${r} (${t.length} itens)`,a.style.cssText="padding: 0 1rem; color: var(--gray-600);",e.appendChild(a);const c=document.createElement("button");c.className="btn-small btn-secondary",c.innerHTML='Pr√≥ximo <i class="fas fa-chevron-right"></i>',c.disabled=n===r,c.addEventListener("click",()=>{n<r&&(n++,i(n))}),e.appendChild(c),s.appendChild(e)}};return i(1),{renderPage:i,currentPage:n,totalPages:r}}initInfiniteScroll(e,t,o=200){const a=document.getElementById(e);if(!a)return;let s=!1,n=!0;const r=()=>{if(s||!n)return;const e=a.scrollTop,r=a.scrollHeight;e+a.clientHeight>=r-o&&(s=!0,t().then(e=>{s=!1,e&&void 0!==e.hasMore&&(n=e.hasMore)}).catch(e=>{console.error("Erro ao carregar mais itens:",e),s=!1}))};return a.addEventListener("scroll",r,{passive:!0}),r(),{reset:()=>{n=!0,s=!1},setHasMore:e=>{n=e}}}async loadComponent(e){return new Promise(t=>{setTimeout(()=>{console.log(`‚úÖ [LAZY LOADING] Componente ${e} carregado`),t(!0)},100)})}createLazyImage(e,t="",o=""){const a=document.createElement("img");if(a.className=o,a.alt=t,a.dataset.src=e,a.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="1" height="1"%3E%3C/svg%3E',a.style.cssText="opacity: 0; transition: opacity 0.3s;",a.addEventListener("load",()=>{a.style.opacity="1"}),"IntersectionObserver"in window){const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(a.src=a.dataset.src,a.removeAttribute("data-src"),e.unobserve(a))})},{rootMargin:"50px"});e.observe(a)}else a.src=e;return a}async requestCameraAccess(){try{return await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})}catch(e){throw console.error("Erro ao acessar c√¢mera:",e),e}}async capturePhoto(e){return new Promise((t,o)=>{const a=document.createElement("canvas");a.width=e.videoWidth,a.height=e.videoHeight,a.getContext("2d").drawImage(e,0,0),a.toBlob(e=>{if(e){const o=URL.createObjectURL(e);t({blob:e,url:o,dataUrl:a.toDataURL("image/jpeg",.8)})}else o(new Error("Erro ao capturar foto"))},"image/jpeg",.8)})}async requestGeolocation(){return new Promise((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy})},e=>{t(e)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):t(new Error("Geolocaliza√ß√£o n√£o suportada"))})}async shareContent(e){if(!navigator.share)return e.text&&(await navigator.clipboard.writeText(e.text),void 0!==toast&&toast&&toast.success("Conte√∫do copiado para √°rea de transfer√™ncia!",3e3)),!1;try{return await navigator.share(e),!0}catch(e){return"AbortError"!==e.name&&console.error("Erro ao compartilhar:",e),!1}}openNativeCalendar(e){const t=e.startDate||(new Date).toISOString().split("T")[0],o=e.endDate||t,a=e.title||"Agendamento",s=e.description||"",n=e.location||"",r=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(a)}&dates=${t.replace(/-/g,"")}/${o.replace(/-/g,"")}&details=${encodeURIComponent(s)}&location=${encodeURIComponent(n)}`;window.open(r,"_blank")}async addToContacts(e){const t=`BEGIN:VCARD\nVERSION:3.0\nFN:${e.name||""}\nTEL:${e.phone||""}\nEMAIL:${e.email||""}\nADR:${e.address||""}\nEND:VCARD`,o=new Blob([t],{type:"text/vcard"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`${e.name||"contato"}.vcf`,s.click(),URL.revokeObjectURL(a),void 0!==toast&&toast&&toast.success("Contato salvo! Abra o arquivo .vcf para adicionar aos seus contatos.",4e3)}isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768}getDeviceOrientation(){return window.innerHeight>window.innerWidth?"portrait":"landscape"}initKeyboardNavigation(){document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&"k"===e.key){e.preventDefault();const t=document.getElementById("globalSearchInput");t&&t.focus()}if("Escape"===e.key&&this.closeAllModals(),(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),this.saveData(),void 0!==toast&&toast&&toast.info("Dados salvos!",2e3)),"ArrowRight"===e.key||"ArrowLeft"===e.key){const t=document.querySelector(".tab-btn.active");if(t){const o=Array.from(document.querySelectorAll(".tab-btn")),a=o.indexOf(t);let s;s="ArrowRight"===e.key?(a+1)%o.length:(a-1+o.length)%o.length,o[s]&&o[s].click()}}}),this.setupListKeyboardNavigation(),this.setupModalKeyboardNavigation(),console.log("‚úÖ [KEYBOARD] Navega√ß√£o por teclado inicializada")}setupListKeyboardNavigation(){document.querySelectorAll(".items-list, .clients-list, .suppliers-list").forEach(e=>{e.setAttribute("tabindex","0"),e.setAttribute("role","listbox"),e.addEventListener("keydown",t=>{const o=Array.from(e.querySelectorAll('[role="listitem"], .item-card, .client-card, .supplier-card')),a=o.findIndex(e=>e===document.activeElement||e.contains(document.activeElement));let s=a;switch(t.key){case"ArrowDown":t.preventDefault(),s=(a+1)%o.length;break;case"ArrowUp":t.preventDefault(),s=(a-1+o.length)%o.length;break;case"Home":t.preventDefault(),s=0;break;case"End":t.preventDefault(),s=o.length-1;break;case"Enter":case" ":if(t.preventDefault(),o[a]){const e=o[a].querySelector("button, a");e&&e.click()}return}o[s]&&(o[s].focus(),o[s].scrollIntoView({behavior:"smooth",block:"nearest"}))})})}setupModalKeyboardNavigation(){document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("keydown",t=>{if("Tab"===t.key){const o=e.querySelectorAll('input, textarea, select, button, [href], [tabindex]:not([tabindex="-1"])'),a=o[0],s=o[o.length-1];t.shiftKey?document.activeElement===a&&(t.preventDefault(),s.focus()):document.activeElement===s&&(t.preventDefault(),a.focus())}})})}closeAllModals(){document.querySelectorAll(".modal.active").forEach(e=>{e.classList.remove("active")})}exportPredictiveAnalysis(){const e=parseInt(document.getElementById("predictivePeriod")?.value||6),t={period:e,forecast:this.calculateSalesForecast(e),trend:this.calculateSalesTrend(e),growth:this.calculateExpectedGrowth(e),topProducts:this.getTopSellingProducts(e),generatedAt:(new Date).toISOString()},o=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`analise_preditiva_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),void 0!==toast&&toast&&toast.success("An√°lise preditiva exportada com sucesso!",3e3)}renderIntegrationsStatus(){const e=document.getElementById("integrationsStatus");if(!e)return;const t=[{name:"Email",config:this.emailConfig,enabled:this.emailConfig?.enabled},{name:"SMS",config:this.smsConfig,enabled:this.smsConfig?.enabled},{name:"WhatsApp",config:this.whatsappConfig,enabled:this.whatsappConfig?.enabled},{name:"E-commerce",config:this.ecommerceConfig,enabled:Object.values(this.ecommerceConfig||{}).some(e=>e?.enabled)},{name:"ERP",config:this.erpConfig,enabled:Object.values(this.erpConfig||{}).some(e=>e?.enabled)}];e.innerHTML=t.map(e=>{const t=e.enabled?"‚úÖ Ativo":"‚ùå Inativo",o=e.enabled?"#28a745":"#dc3545";return`\n                <div style="padding: 0.75rem; background: white; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">\n                    <strong style="display: block; margin-bottom: 0.25rem;">${e.name}</strong>\n                    <span style="color: ${o}; font-size: 0.9rem;">${t}</span>\n                </div>\n            `}).join("")}openEmailConfigModal(){const e=document.getElementById("emailConfigModal");if(!e)return;const t=this.emailConfig||{};document.getElementById("emailEnabled").checked=t.enabled||!1,document.getElementById("emailProvider").value=t.provider||"smtp",t.smtp&&(document.getElementById("smtpHost").value=t.smtp.host||"",document.getElementById("smtpPort").value=t.smtp.port||587,document.getElementById("smtpSecure").checked=t.smtp.secure||!1,document.getElementById("smtpUsername").value=t.smtp.username||"",document.getElementById("smtpPassword").value=t.smtp.password||""),t.sendgrid&&(document.getElementById("sendgridApiKey").value=t.sendgrid.apiKey||""),t.ses&&(document.getElementById("sesAccessKeyId").value=t.ses.accessKeyId||"",document.getElementById("sesSecretAccessKey").value=t.ses.secretAccessKey||"",document.getElementById("sesRegion").value=t.ses.region||"us-east-1"),t.mailgun&&(document.getElementById("mailgunApiKey").value=t.mailgun.apiKey||"",document.getElementById("mailgunDomain").value=t.mailgun.domain||""),this.toggleEmailProviderFields(),e.classList.add("active")}closeEmailConfigModal(){const e=document.getElementById("emailConfigModal");e&&e.classList.remove("active")}toggleEmailProviderFields(){const e=document.getElementById("emailProvider").value;document.getElementById("emailSMTPFields").style.display="smtp"===e?"block":"none",document.getElementById("emailSendGridFields").style.display="sendgrid"===e?"block":"none",document.getElementById("emailSESFields").style.display="ses"===e?"block":"none",document.getElementById("emailMailgunFields").style.display="mailgun"===e?"block":"none"}saveEmailConfig(e){e&&e.preventDefault();const t=document.getElementById("emailEnabled").checked,o=document.getElementById("emailProvider").value;this.emailConfig={enabled:t,provider:o,smtp:{host:document.getElementById("smtpHost").value,port:parseInt(document.getElementById("smtpPort").value)||587,secure:document.getElementById("smtpSecure").checked,username:document.getElementById("smtpUsername").value,password:document.getElementById("smtpPassword").value},sendgrid:{apiKey:document.getElementById("sendgridApiKey").value},ses:{accessKeyId:document.getElementById("sesAccessKeyId").value,secretAccessKey:document.getElementById("sesSecretAccessKey").value,region:document.getElementById("sesRegion").value||"us-east-1"},mailgun:{apiKey:document.getElementById("mailgunApiKey").value,domain:document.getElementById("mailgunDomain").value}},this.saveData(),this.renderIntegrationsStatus(),this.closeEmailConfigModal(),void 0!==toast&&toast&&toast.success("Configura√ß√£o de email salva com sucesso!",3e3)}async testEmailConnection(){const e=document.getElementById("emailProvider")?.value||this.emailConfig?.provider||"smtp",t=this.emailConfig||{};void 0!==toast&&toast&&toast.info("Testando conex√£o de email...",2e3);try{if("smtp"===e){const e=t.smtp||{};if(!e.host||!e.username||!e.password)throw new Error("Preencha todos os campos obrigat√≥rios (Host, Usu√°rio, Senha)");if(!/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e.host))throw new Error("Host SMTP inv√°lido");return void 0!==toast&&toast&&toast.success("Credenciais SMTP v√°lidas! (Teste completo requer backend)",4e3),{success:!0,message:"Credenciais v√°lidas"}}if("sendgrid"===e){const e=t.sendgrid?.apiKey||"";if(!e)throw new Error("API Key do SendGrid √© obrigat√≥ria");const o=await fetch("https://api.sendgrid.com/v3/user/profile",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(o.ok){const e=await o.json();return void 0!==toast&&toast&&toast.success(`SendGrid conectado! Usu√°rio: ${e.username||"N/A"}`,4e3),{success:!0,message:"SendGrid conectado",data:e}}{const e=await o.json();throw new Error(`SendGrid: ${e.errors?.[0]?.message||"Credenciais inv√°lidas"}`)}}if("ses"===e){const e=t.ses||{};if(!e.accessKeyId||!e.secretAccessKey)throw new Error("Access Key ID e Secret Access Key s√£o obrigat√≥rios");return void 0!==toast&&toast&&toast.success("Credenciais AWS SES v√°lidas! (Teste completo requer backend)",4e3),{success:!0,message:"Credenciais v√°lidas"}}if("mailgun"===e){const e=t.mailgun||{};if(!e.apiKey||!e.domain)throw new Error("API Key e Domain s√£o obrigat√≥rios");const o=btoa(`api:${e.apiKey}`),a=await fetch(`https://api.mailgun.net/v3/${e.domain}`,{method:"GET",headers:{Authorization:`Basic ${o}`}});if(a.ok||200===a.status)return void 0!==toast&&toast&&toast.success(`Mailgun conectado! Dom√≠nio: ${e.domain}`,4e3),{success:!0,message:"Mailgun conectado"};throw new Error("Mailgun: Credenciais inv√°lidas ou dom√≠nio n√£o encontrado")}}catch(e){return console.error("Erro ao testar conex√£o de email:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3),{success:!1,message:e.message}}}openSMSConfigModal(){const e=document.getElementById("smsConfigModal");if(!e)return;const t=this.smsConfig||{};document.getElementById("smsEnabled").checked=t.enabled||!1,document.getElementById("smsProvider").value=t.provider||"twilio",t.twilio&&(document.getElementById("twilioAccountSid").value=t.twilio.accountSid||"",document.getElementById("twilioAuthToken").value=t.twilio.authToken||"",document.getElementById("twilioFromNumber").value=t.twilio.fromNumber||""),t.zenvia&&(document.getElementById("zenviaApiKey").value=t.zenvia.apiKey||"",document.getElementById("zenviaFromNumber").value=t.zenvia.fromNumber||""),t.totalvoice&&(document.getElementById("totalvoiceAccessToken").value=t.totalvoice.accessToken||"",document.getElementById("totalvoiceFromNumber").value=t.totalvoice.fromNumber||""),this.toggleSMSProviderFields(),e.classList.add("active")}closeSMSConfigModal(){const e=document.getElementById("smsConfigModal");e&&e.classList.remove("active")}toggleSMSProviderFields(){const e=document.getElementById("smsProvider").value;document.getElementById("smsTwilioFields").style.display="twilio"===e?"block":"none",document.getElementById("smsZenviaFields").style.display="zenvia"===e?"block":"none",document.getElementById("smsTotalVoiceFields").style.display="totalvoice"===e?"block":"none"}saveSMSConfig(e){e&&e.preventDefault();const t=document.getElementById("smsEnabled").checked,o=document.getElementById("smsProvider").value;this.smsConfig={enabled:t,provider:o,twilio:{accountSid:document.getElementById("twilioAccountSid").value,authToken:document.getElementById("twilioAuthToken").value,fromNumber:document.getElementById("twilioFromNumber").value},zenvia:{apiKey:document.getElementById("zenviaApiKey").value,fromNumber:document.getElementById("zenviaFromNumber").value},totalvoice:{accessToken:document.getElementById("totalvoiceAccessToken").value,fromNumber:document.getElementById("totalvoiceFromNumber").value}},this.saveData(),this.renderIntegrationsStatus(),this.closeSMSConfigModal(),void 0!==toast&&toast&&toast.success("Configura√ß√£o de SMS salva com sucesso!",3e3)}async testSMSConnection(){const e=document.getElementById("smsProvider")?.value||this.smsConfig?.provider||"twilio",t=this.smsConfig||{};void 0!==toast&&toast&&toast.info("Testando conex√£o de SMS...",2e3);try{if("twilio"===e){const e=t.twilio||{};if(!e.accountSid||!e.authToken)throw new Error("Account SID e Auth Token s√£o obrigat√≥rios");const o=btoa(`${e.accountSid}:${e.authToken}`),a=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${e.accountSid}.json`,{method:"GET",headers:{Authorization:`Basic ${o}`}});if(a.ok){const t=await a.json();return void 0!==toast&&toast&&toast.success(`Twilio conectado! Conta: ${t.friendly_name||e.accountSid}`,4e3),{success:!0,message:"Twilio conectado",data:t}}{const e=await a.json();throw new Error(`Twilio: ${e.message||"Credenciais inv√°lidas"}`)}}if("zenvia"===e){const e=t.zenvia||{};if(!e.apiKey)throw new Error("API Key da Zenvia √© obrigat√≥ria");const o=await fetch("https://api.zenvia.com/v2/account",{method:"GET",headers:{"X-API-TOKEN":e.apiKey,"Content-Type":"application/json"}});if(o.ok){const e=await o.json();return void 0!==toast&&toast&&toast.success(`Zenvia conectada! Conta: ${e.name||"N/A"}`,4e3),{success:!0,message:"Zenvia conectada",data:e}}throw new Error("Zenvia: Credenciais inv√°lidas")}if("totalvoice"===e){const e=t.totalvoice||{};if(!e.accessToken)throw new Error("Access Token do TotalVoice √© obrigat√≥rio");const o=await fetch("https://api.totalvoice.com.br/account",{method:"GET",headers:{"Access-Token":e.accessToken,"Content-Type":"application/json"}});if(o.ok){const e=await o.json();return void 0!==toast&&toast&&toast.success(`TotalVoice conectado! Conta: ${e.dados?.nome||"N/A"}`,4e3),{success:!0,message:"TotalVoice conectado",data:e}}{const e=await o.json();throw new Error(`TotalVoice: ${e.mensagem||"Credenciais inv√°lidas"}`)}}}catch(e){return console.error("Erro ao testar conex√£o de SMS:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3),{success:!1,message:e.message}}}openWhatsAppConfigModal(){const e=document.getElementById("whatsappConfigModal");if(!e)return;const t=this.whatsappConfig||{};document.getElementById("whatsappEnabled").checked=t.enabled||!1,document.getElementById("whatsappApiKey").value=t.apiKey||"",document.getElementById("whatsappPhoneNumberId").value=t.phoneNumberId||"",document.getElementById("whatsappBusinessAccountId").value=t.businessAccountId||"",document.getElementById("whatsappWebhookUrl").value=t.webhookUrl||"",e.classList.add("active")}closeWhatsAppConfigModal(){const e=document.getElementById("whatsappConfigModal");e&&e.classList.remove("active")}saveWhatsAppConfig(e){e&&e.preventDefault(),this.whatsappConfig={enabled:document.getElementById("whatsappEnabled").checked,provider:"whatsapp_business",apiKey:document.getElementById("whatsappApiKey").value,phoneNumberId:document.getElementById("whatsappPhoneNumberId").value,businessAccountId:document.getElementById("whatsappBusinessAccountId").value,webhookUrl:document.getElementById("whatsappWebhookUrl").value},this.saveData(),this.renderIntegrationsStatus(),this.closeWhatsAppConfigModal(),void 0!==toast&&toast&&toast.success("Configura√ß√£o de WhatsApp salva com sucesso!",3e3)}async testWhatsAppConnection(){const e=this.whatsappConfig||{};void 0!==toast&&toast&&toast.info("Testando conex√£o de WhatsApp...",2e3);try{if(!e.apiKey||!e.phoneNumberId||!e.businessAccountId)throw new Error("API Key, Phone Number ID e Business Account ID s√£o obrigat√≥rios");const t=await fetch(`https://graph.facebook.com/v18.0/${e.phoneNumberId}`,{method:"GET",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"}});if(t.ok){const e=await t.json();return void 0!==toast&&toast&&toast.success(`WhatsApp conectado! N√∫mero: ${e.display_phone_number||"N/A"}`,4e3),{success:!0,message:"WhatsApp conectado",data:e}}{const e=await t.json();throw new Error(`WhatsApp: ${e.error?.message||"Credenciais inv√°lidas"}`)}}catch(e){return console.error("Erro ao testar conex√£o de WhatsApp:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3),{success:!1,message:e.message}}}openEcommerceConfigModal(){const e=document.getElementById("ecommerceConfigModal");if(!e)return;const t=this.ecommerceConfig||{};let o="woocommerce";t.shopify?.enabled?o="shopify":t.mercadoLivre?.enabled&&(o="mercadoLivre"),document.getElementById("ecommercePlatform").value=o,t.woocommerce&&(document.getElementById("woocommerceEnabled").checked=t.woocommerce.enabled||!1,document.getElementById("woocommerceUrl").value=t.woocommerce.url||"",document.getElementById("woocommerceConsumerKey").value=t.woocommerce.consumerKey||"",document.getElementById("woocommerceConsumerSecret").value=t.woocommerce.consumerSecret||""),t.shopify&&(document.getElementById("shopifyEnabled").checked=t.shopify.enabled||!1,document.getElementById("shopifyShop").value=t.shopify.shop||"",document.getElementById("shopifyApiKey").value=t.shopify.apiKey||"",document.getElementById("shopifyApiSecret").value=t.shopify.apiSecret||""),t.mercadoLivre&&(document.getElementById("mercadoLivreEnabled").checked=t.mercadoLivre.enabled||!1,document.getElementById("mercadoLivreClientId").value=t.mercadoLivre.clientId||"",document.getElementById("mercadoLivreClientSecret").value=t.mercadoLivre.clientSecret||"",document.getElementById("mercadoLivreAccessToken").value=t.mercadoLivre.accessToken||""),this.toggleEcommercePlatformFields(),e.classList.add("active")}closeEcommerceConfigModal(){const e=document.getElementById("ecommerceConfigModal");e&&e.classList.remove("active")}toggleEcommercePlatformFields(){const e=document.getElementById("ecommercePlatform").value;document.getElementById("woocommerceFields").style.display="woocommerce"===e?"block":"none",document.getElementById("shopifyFields").style.display="shopify"===e?"block":"none",document.getElementById("mercadoLivreFields").style.display="mercadoLivre"===e?"block":"none"}saveEcommerceConfig(){const e=document.getElementById("ecommercePlatform").value;"woocommerce"===e?(this.ecommerceConfig.woocommerce={enabled:document.getElementById("woocommerceEnabled").checked,url:document.getElementById("woocommerceUrl").value,consumerKey:document.getElementById("woocommerceConsumerKey").value,consumerSecret:document.getElementById("woocommerceConsumerSecret").value},this.ecommerceConfig.shopify&&(this.ecommerceConfig.shopify.enabled=!1),this.ecommerceConfig.mercadoLivre&&(this.ecommerceConfig.mercadoLivre.enabled=!1)):"shopify"===e?(this.ecommerceConfig.shopify={enabled:document.getElementById("shopifyEnabled").checked,shop:document.getElementById("shopifyShop").value,apiKey:document.getElementById("shopifyApiKey").value,apiSecret:document.getElementById("shopifyApiSecret").value},this.ecommerceConfig.woocommerce&&(this.ecommerceConfig.woocommerce.enabled=!1),this.ecommerceConfig.mercadoLivre&&(this.ecommerceConfig.mercadoLivre.enabled=!1)):"mercadoLivre"===e&&(this.ecommerceConfig.mercadoLivre={enabled:document.getElementById("mercadoLivreEnabled").checked,clientId:document.getElementById("mercadoLivreClientId").value,clientSecret:document.getElementById("mercadoLivreClientSecret").value,accessToken:document.getElementById("mercadoLivreAccessToken").value},this.ecommerceConfig.woocommerce&&(this.ecommerceConfig.woocommerce.enabled=!1),this.ecommerceConfig.shopify&&(this.ecommerceConfig.shopify.enabled=!1)),this.saveData(),this.renderIntegrationsStatus(),this.closeEcommerceConfigModal(),void 0!==toast&&toast&&toast.success("Configura√ß√£o de e-commerce salva com sucesso!",3e3)}async testEcommerceConnection(){const e=document.getElementById("ecommercePlatform")?.value||"woocommerce",t=this.ecommerceConfig||{};void 0!==toast&&toast&&toast.info(`Testando conex√£o com ${e}...`,2e3);try{if("woocommerce"===e){const e=t.woocommerce||{};if(!e.url||!e.consumerKey||!e.consumerSecret)throw new Error("URL, Consumer Key e Consumer Secret s√£o obrigat√≥rios");if(!/^https?:\/\/.+/.test(e.url))throw new Error("URL inv√°lida. Use http:// ou https://");const o=e.url.replace(/\/$/,"")+"/wp-json/wc/v3/system_status",a=btoa(`${e.consumerKey}:${e.consumerSecret}`),s=await fetch(o,{method:"GET",headers:{Authorization:`Basic ${a}`,"Content-Type":"application/json"}});if(s.ok){const e=await s.json();return void 0!==toast&&toast&&toast.success(`WooCommerce conectado! Vers√£o: ${e.environment?.version||"N/A"}`,4e3),{success:!0,message:"WooCommerce conectado",data:e}}{const e=await s.json();throw new Error(`WooCommerce: ${e.message||"Credenciais inv√°lidas ou URL incorreta"}`)}}if("shopify"===e){const e=t.shopify||{};if(!e.shop||!e.apiKey||!e.apiSecret)throw new Error("Shop, API Key e API Secret s√£o obrigat√≥rios");const o=e.shop.replace(/\.myshopify\.com$/,""),a=`https://${o}.myshopify.com/admin/api/2024-01/shop.json`,s=btoa(`${e.apiKey}:${e.apiSecret}`),n=await fetch(a,{method:"GET",headers:{Authorization:`Basic ${s}`,"Content-Type":"application/json"}});if(n.ok){const e=await n.json();return void 0!==toast&&toast&&toast.success(`Shopify conectado! Loja: ${e.shop?.name||o}`,4e3),{success:!0,message:"Shopify conectado",data:e}}{const e=await n.json();throw new Error(`Shopify: ${e.errors||"Credenciais inv√°lidas"}`)}}if("mercadoLivre"===e){const e=t.mercadoLivre||{};if(!e.clientId||!e.clientSecret||!e.accessToken)throw new Error("Client ID, Client Secret e Access Token s√£o obrigat√≥rios");const o=await fetch("https://api.mercadolibre.com/users/me",{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json"}});if(o.ok){const e=await o.json();return void 0!==toast&&toast&&toast.success(`Mercado Livre conectado! Usu√°rio: ${e.nickname||"N/A"}`,4e3),{success:!0,message:"Mercado Livre conectado",data:e}}{const e=await o.json();throw new Error(`Mercado Livre: ${e.message||"Token inv√°lido ou expirado"}`)}}}catch(e){return console.error("Erro ao testar conex√£o de e-commerce:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3),{success:!1,message:e.message}}}openERPConfigModal(){const e=document.getElementById("erpConfigModal");if(!e)return;const t=this.erpConfig||{};let o="totvs";t.sap?.enabled&&(o="sap"),document.getElementById("erpPlatform").value=o,t.totvs&&(document.getElementById("totvsEnabled").checked=t.totvs.enabled||!1,document.getElementById("totvsUrl").value=t.totvs.url||"",document.getElementById("totvsUsername").value=t.totvs.username||"",document.getElementById("totvsPassword").value=t.totvs.password||"",document.getElementById("totvsDatabase").value=t.totvs.database||""),t.sap&&(document.getElementById("sapEnabled").checked=t.sap.enabled||!1,document.getElementById("sapUrl").value=t.sap.url||"",document.getElementById("sapUsername").value=t.sap.username||"",document.getElementById("sapPassword").value=t.sap.password||"",document.getElementById("sapClient").value=t.sap.client||""),this.toggleERPPlatformFields(),e.classList.add("active")}closeERPConfigModal(){const e=document.getElementById("erpConfigModal");e&&e.classList.remove("active")}toggleERPPlatformFields(){const e=document.getElementById("erpPlatform").value;document.getElementById("totvsFields").style.display="totvs"===e?"block":"none",document.getElementById("sapFields").style.display="sap"===e?"block":"none"}saveERPConfig(){const e=document.getElementById("erpPlatform").value;"totvs"===e?(this.erpConfig.totvs={enabled:document.getElementById("totvsEnabled").checked,url:document.getElementById("totvsUrl").value,username:document.getElementById("totvsUsername").value,password:document.getElementById("totvsPassword").value,database:document.getElementById("totvsDatabase").value},this.erpConfig.sap&&(this.erpConfig.sap.enabled=!1)):"sap"===e&&(this.erpConfig.sap={enabled:document.getElementById("sapEnabled").checked,url:document.getElementById("sapUrl").value,username:document.getElementById("sapUsername").value,password:document.getElementById("sapPassword").value,client:document.getElementById("sapClient").value},this.erpConfig.totvs&&(this.erpConfig.totvs.enabled=!1)),this.saveData(),this.renderIntegrationsStatus(),this.closeERPConfigModal(),void 0!==toast&&toast&&toast.success("Configura√ß√£o de ERP salva com sucesso!",3e3)}async testERPConnection(){const e=document.getElementById("erpPlatform")?.value||"totvs",t=this.erpConfig||{};void 0!==toast&&toast&&toast.info(`Testando conex√£o com ${e.toUpperCase()}...`,2e3);try{if("totvs"===e){const e=t.totvs||{};if(!e.url||!e.username||!e.password)throw new Error("URL, Usu√°rio e Senha s√£o obrigat√≥rios");if(!/^https?:\/\/.+/.test(e.url))throw new Error("URL inv√°lida. Use http:// ou https://");return void 0!==toast&&toast&&toast.success("Credenciais TOTVS v√°lidas! (Teste completo requer backend com SDK)",5e3),{success:!0,message:"Credenciais v√°lidas (teste completo requer backend)"}}if("sap"===e){const e=t.sap||{};if(!(e.url&&e.username&&e.password&&e.client))throw new Error("URL, Usu√°rio, Senha e Client s√£o obrigat√≥rios");if(!/^https?:\/\/.+/.test(e.url))throw new Error("URL inv√°lida. Use http:// ou https://");if(!/^\d+$/.test(e.client))throw new Error("Client deve ser um n√∫mero (ex: 100, 200)");return void 0!==toast&&toast&&toast.success("Credenciais SAP v√°lidas! (Teste completo requer backend com SAP SDK)",5e3),{success:!0,message:"Credenciais v√°lidas (teste completo requer backend)"}}}catch(e){return console.error("Erro ao testar conex√£o de ERP:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3),{success:!1,message:e.message}}}async sendEmail(e,t,o,a=""){if(!this.emailConfig?.enabled)throw new Error("Integra√ß√£o de email n√£o est√° habilitada");const s=this.emailConfig.provider||"smtp",n=this.emailConfig;try{if("sendgrid"===s){const s=n.sendgrid?.apiKey;if(!s)throw new Error("API Key do SendGrid n√£o configurada");const r=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({personalizations:[{to:[{email:e}]}],from:{email:n.fromEmail||"noreply@example.com"},subject:t,content:[{type:"text/plain",value:a||o.replace(/<[^>]*>/g,"")},{type:"text/html",value:o}]})});if(r.ok)return{success:!0,message:"Email enviado com sucesso"};{const e=await r.json();throw new Error(`SendGrid: ${e.errors?.[0]?.message||"Erro ao enviar email"}`)}}if("mailgun"===s){const s=n.mailgun||{};if(!s.apiKey||!s.domain)throw new Error("API Key e Domain do Mailgun n√£o configurados");const r=new FormData;r.append("from",n.fromEmail||`noreply@${s.domain}`),r.append("to",e),r.append("subject",t),r.append("html",o),a&&r.append("text",a);const i=btoa(`api:${s.apiKey}`),c=await fetch(`https://api.mailgun.net/v3/${s.domain}/messages`,{method:"POST",headers:{Authorization:`Basic ${i}`},body:r});if(c.ok)return{success:!0,message:"Email enviado com sucesso"};{const e=await c.json();throw new Error(`Mailgun: ${e.message||"Erro ao enviar email"}`)}}throw new Error(`Envio de email via ${s} requer backend. Use SendGrid ou Mailgun para envio direto.`)}catch(e){throw console.error("Erro ao enviar email:",e),e}}async sendSMS(e,t){if(!this.smsConfig?.enabled)throw new Error("Integra√ß√£o de SMS n√£o est√° habilitada");const o=this.smsConfig.provider||"twilio",a=this.smsConfig;try{if("twilio"===o){const o=a.twilio||{};if(!o.accountSid||!o.authToken||!o.fromNumber)throw new Error("Credenciais do Twilio n√£o configuradas completamente");const s=btoa(`${o.accountSid}:${o.authToken}`),n=new URLSearchParams;n.append("From",o.fromNumber),n.append("To",e),n.append("Body",t);const r=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${o.accountSid}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${s}`,"Content-Type":"application/x-www-form-urlencoded"},body:n});if(r.ok)return{success:!0,message:"SMS enviado com sucesso",sid:(await r.json()).sid};{const e=await r.json();throw new Error(`Twilio: ${e.message||"Erro ao enviar SMS"}`)}}if("zenvia"===o){const o=a.zenvia||{};if(!o.apiKey||!o.fromNumber)throw new Error("API Key e n√∫mero remetente da Zenvia n√£o configurados");const s=await fetch("https://api.zenvia.com/v2/channels/sms/messages",{method:"POST",headers:{"X-API-TOKEN":o.apiKey,"Content-Type":"application/json"},body:JSON.stringify({from:o.fromNumber,to:e,contents:[{type:"text",text:t}]})});if(s.ok)return{success:!0,message:"SMS enviado com sucesso",id:(await s.json()).id};throw new Error("Zenvia: Erro ao enviar SMS")}if("totalvoice"===o){const o=a.totalvoice||{};if(!o.accessToken||!o.fromNumber)throw new Error("Access Token e n√∫mero remetente do TotalVoice n√£o configurados");const s=await fetch("https://api.totalvoice.com.br/sms",{method:"POST",headers:{"Access-Token":o.accessToken,"Content-Type":"application/json"},body:JSON.stringify({numero_destino:e,mensagem:t,resposta_usuario:!1})});if(s.ok){const e=await s.json();return{success:!0,message:"SMS enviado com sucesso",id:e.dados?.id}}{const e=await s.json();throw new Error(`TotalVoice: ${e.mensagem||"Erro ao enviar SMS"}`)}}}catch(e){throw console.error("Erro ao enviar SMS:",e),e}}async sendWhatsApp(e,t){if(!this.whatsappConfig?.enabled)throw new Error("Integra√ß√£o de WhatsApp n√£o est√° habilitada");const o=this.whatsappConfig;try{if(!o.apiKey||!o.phoneNumberId)throw new Error("API Key e Phone Number ID n√£o configurados");const a=e.replace(/[+\s]/g,""),s=await fetch(`https://graph.facebook.com/v18.0/${o.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${o.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:a,type:"text",text:{body:t}})});if(s.ok){const e=await s.json();return{success:!0,message:"WhatsApp enviado com sucesso",id:e.messages?.[0]?.id}}{const e=await s.json();throw new Error(`WhatsApp: ${e.error?.message||"Erro ao enviar mensagem"}`)}}catch(e){throw console.error("Erro ao enviar WhatsApp:",e),e}}initPerformanceMonitoring(){if(this.performanceMetrics={pageLoadTime:0,domContentLoaded:0,firstPaint:0,firstContentfulPaint:0,timeToInteractive:0,memoryUsage:null,renderTimes:[],apiCallTimes:[],cacheHitRate:{hits:0,misses:0},functionCallTimes:{}},window.performance&&window.performance.timing){const e=window.performance.timing;this.performanceMetrics.pageLoadTime=e.loadEventEnd-e.navigationStart,this.performanceMetrics.domContentLoaded=e.domContentLoadedEventEnd-e.navigationStart}window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("paint").forEach(e=>{"first-paint"===e.name?this.performanceMetrics.firstPaint=e.startTime:"first-contentful-paint"===e.name&&(this.performanceMetrics.firstContentfulPaint=e.startTime)}),performance.memory&&(this.updateMemoryUsage(),setInterval(()=>this.updateMemoryUsage(),3e4)),this.interceptFetch(),this.monitorRendering(),console.log("‚úÖ [PERFORMANCE] Sistema de monitoramento inicializado")}updateMemoryUsage(){performance.memory&&(this.performanceMetrics.memoryUsage={used:(performance.memory.usedJSHeapSize/1048576).toFixed(2),total:(performance.memory.totalJSHeapSize/1048576).toFixed(2),limit:(performance.memory.jsHeapSizeLimit/1048576).toFixed(2),timestamp:Date.now()})}interceptFetch(){const e=window.fetch,t=this;window.fetch=async function(...o){const a=performance.now(),s=o[0];try{const n=await e.apply(this,o),r=performance.now()-a;return t.performanceMetrics.apiCallTimes.push({url:"string"==typeof s?s:s.url||"unknown",duration:r,timestamp:Date.now(),status:n.status}),t.performanceMetrics.apiCallTimes.length>100&&t.performanceMetrics.apiCallTimes.shift(),n}catch(e){const o=performance.now()-a;throw t.performanceMetrics.apiCallTimes.push({url:"string"==typeof s?s:s.url||"unknown",duration:o,timestamp:Date.now(),status:"error",error:e.message}),e}}}monitorRendering(){const e=this,t=this.renderItems;this.renderItems=function(...o){const a=performance.now(),s=t.apply(e,o),n=performance.now()-a;return e.performanceMetrics.renderTimes.push({function:"renderItems",duration:n,timestamp:Date.now()}),e.performanceMetrics.renderTimes.length>50&&e.performanceMetrics.renderTimes.shift(),s}}measureFunction(e,t){const o=this;return function(...a){const s=performance.now(),n=t.apply(this,a),r=performance.now()-s;return o.performanceMetrics.functionCallTimes[e]||(o.performanceMetrics.functionCallTimes[e]=[]),o.performanceMetrics.functionCallTimes[e].push({duration:r,timestamp:Date.now()}),o.performanceMetrics.functionCallTimes[e].length>20&&o.performanceMetrics.functionCallTimes[e].shift(),n}}recordCacheAccess(e){"hit"===e?this.performanceMetrics.cacheHitRate.hits++:this.performanceMetrics.cacheHitRate.misses++}getCacheHitRate(){const{hits:e,misses:t}=this.performanceMetrics.cacheHitRate,o=e+t;return o>0?e/o:0}getPerformanceReport(){return{pageLoad:{pageLoadTime:this.performanceMetrics.pageLoadTime,domContentLoaded:this.performanceMetrics.domContentLoaded,firstPaint:this.performanceMetrics.firstPaint,firstContentfulPaint:this.performanceMetrics.firstContentfulPaint},memory:this.performanceMetrics.memoryUsage,rendering:{averageRenderTime:this.calculateAverage(this.performanceMetrics.renderTimes,"duration"),totalRenders:this.performanceMetrics.renderTimes.length,slowRenders:this.performanceMetrics.renderTimes.filter(e=>e.duration>100).length},api:{averageResponseTime:this.calculateAverage(this.performanceMetrics.apiCallTimes,"duration"),totalCalls:this.performanceMetrics.apiCallTimes.length,slowCalls:this.performanceMetrics.apiCallTimes.filter(e=>e.duration>1e3).length,errorRate:this.calculateErrorRate(this.performanceMetrics.apiCallTimes)},cache:{hitRate:this.getCacheHitRate(),hits:this.performanceMetrics.cacheHitRate.hits,misses:this.performanceMetrics.cacheHitRate.misses},functions:this.calculateFunctionStats(),timestamp:Date.now()}}calculateAverage(e,t){return e&&0!==e.length?e.reduce((e,o)=>e+(o[t]||0),0)/e.length:0}calculateErrorRate(e){return e&&0!==e.length?e.filter(e=>"error"===e.status||e.status>=400).length/e.length:0}calculateFunctionStats(){const e={};return Object.keys(this.performanceMetrics.functionCallTimes).forEach(t=>{const o=this.performanceMetrics.functionCallTimes[t];e[t]={averageTime:this.calculateAverage(o,"duration"),totalCalls:o.length,maxTime:Math.max(...o.map(e=>e.duration)),minTime:Math.min(...o.map(e=>e.duration))}}),e}renderPerformancePanel(){const e=this.getPerformanceReport(),t=document.getElementById("performancePanel");if(!t)return;const o=`\n            <div class="performance-panel">\n                <h2><i class="fas fa-tachometer-alt"></i> Monitoramento de Performance</h2>\n                \n                <div class="performance-section">\n                    <h3>Carregamento da P√°gina</h3>\n                    <div class="metric">\n                        <span class="metric-label">Tempo Total:</span>\n                        <span class="metric-value">${e.pageLoad.pageLoadTime}ms</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">DOM Content Loaded:</span>\n                        <span class="metric-value">${e.pageLoad.domContentLoaded}ms</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">First Paint:</span>\n                        <span class="metric-value">${e.pageLoad.firstPaint.toFixed(2)}ms</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">First Contentful Paint:</span>\n                        <span class="metric-value">${e.pageLoad.firstContentfulPaint.toFixed(2)}ms</span>\n                    </div>\n                </div>\n\n                ${e.memory?`\n                <div class="performance-section">\n                    <h3>Uso de Mem√≥ria</h3>\n                    <div class="metric">\n                        <span class="metric-label">Usado:</span>\n                        <span class="metric-value">${e.memory.used} MB</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Total:</span>\n                        <span class="metric-value">${e.memory.total} MB</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Limite:</span>\n                        <span class="metric-value">${e.memory.limit} MB</span>\n                    </div>\n                    <div class="progress-bar" style="margin-top: 0.5rem;">\n                        <div class="progress-fill" style="width: ${(e.memory.used/e.memory.limit*100).toFixed(1)}%"></div>\n                    </div>\n                </div>\n                `:""}\n\n                <div class="performance-section">\n                    <h3>Renderiza√ß√£o</h3>\n                    <div class="metric">\n                        <span class="metric-label">Tempo M√©dio:</span>\n                        <span class="metric-value">${e.rendering.averageRenderTime.toFixed(2)}ms</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Total de Renderiza√ß√µes:</span>\n                        <span class="metric-value">${e.rendering.totalRenders}</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Renderiza√ß√µes Lentas (&gt;100ms):</span>\n                        <span class="metric-value ${e.rendering.slowRenders>0?"warning":""}">${e.rendering.slowRenders}</span>\n                    </div>\n                </div>\n\n                <div class="performance-section">\n                    <h3>Chamadas de API</h3>\n                    <div class="metric">\n                        <span class="metric-label">Tempo M√©dio de Resposta:</span>\n                        <span class="metric-value">${e.api.averageResponseTime.toFixed(2)}ms</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Total de Chamadas:</span>\n                        <span class="metric-value">${e.api.totalCalls}</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Chamadas Lentas (&gt;1s):</span>\n                        <span class="metric-value ${e.api.slowCalls>0?"warning":""}">${e.api.slowCalls}</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Taxa de Erro:</span>\n                        <span class="metric-value ${e.api.errorRate>.1?"error":""}">${(100*e.api.errorRate).toFixed(2)}%</span>\n                    </div>\n                </div>\n\n                <div class="performance-section">\n                    <h3>Cache</h3>\n                    <div class="metric">\n                        <span class="metric-label">Taxa de Acerto:</span>\n                        <span class="metric-value">${(100*e.cache.hitRate).toFixed(2)}%</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Hits:</span>\n                        <span class="metric-value">${e.cache.hits}</span>\n                    </div>\n                    <div class="metric">\n                        <span class="metric-label">Misses:</span>\n                        <span class="metric-value">${e.cache.misses}</span>\n                    </div>\n                </div>\n\n                <div class="performance-actions" style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">\n                    <button class="btn-primary" onclick="app.exportPerformanceReport()">\n                        <i class="fas fa-download"></i> Exportar Relat√≥rio\n                    </button>\n                    <button class="btn-secondary" onclick="app.resetPerformanceMetrics()">\n                        <i class="fas fa-redo"></i> Resetar M√©tricas\n                    </button>\n                </div>\n            </div>\n        `;t.innerHTML=o}exportPerformanceReport(){const e=this.getPerformanceReport(),t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a,s.download=`performance-report-${Date.now()}.json`,s.click(),URL.revokeObjectURL(a),void 0!==toast&&toast&&toast.success("Relat√≥rio de performance exportado!",3e3)}resetPerformanceMetrics(){this.performanceMetrics={pageLoadTime:this.performanceMetrics.pageLoadTime,domContentLoaded:this.performanceMetrics.domContentLoaded,firstPaint:this.performanceMetrics.firstPaint,firstContentfulPaint:this.performanceMetrics.firstContentfulPaint,timeToInteractive:0,memoryUsage:this.performanceMetrics.memoryUsage,renderTimes:[],apiCallTimes:[],cacheHitRate:{hits:0,misses:0},functionCallTimes:{}},void 0!==toast&&toast&&toast.success("M√©tricas de performance resetadas!",3e3),this.renderPerformancePanel()}memoize(e,t=(...e)=>JSON.stringify(e)){const o=new Map;return function(...a){const s=t(...a);if(o.has(s))return this.recordCacheAccess("hit"),o.get(s);this.recordCacheAccess("miss");const n=e.apply(this,a);return o.set(s,n),n}}calculateVirtualScroll(e,t,o,a){const s=Math.floor(a/o),n=Math.min(s+Math.ceil(t/o)+1,e.length);return{startIndex:s,endIndex:n,visibleItems:e.slice(s,n),totalHeight:e.length*o,offsetY:s*o}}debounce(e,t=300){let o;const a=function(...a){clearTimeout(o),o=setTimeout(()=>e.apply(this,a),t)};return a.cancel=()=>clearTimeout(o),a}throttle(e,t=100){let o;return function(...a){o||(e.apply(this,a),o=!0,setTimeout(()=>o=!1,t))}}processMessageTemplate(e,t={}){if(!e||"string"!=typeof e)return e||"";let o=e;Object.keys(t).forEach(e=>{const a=new RegExp(`\\{\\{${e}\\}\\}`,"g");o=o.replace(a,t[e]||"")});const a={data:(new Date).toLocaleDateString("pt-BR"),hora:(new Date).toLocaleTimeString("pt-BR"),dataHora:(new Date).toLocaleString("pt-BR"),ano:(new Date).getFullYear(),mes:(new Date).toLocaleDateString("pt-BR",{month:"long"})};return Object.keys(a).forEach(e=>{const t=new RegExp(`\\{\\{${e}\\}\\}`,"g");o=o.replace(t,a[e])}),o}createMessageTemplate(e){const t={id:Date.now().toString(),name:e.name||"Template sem nome",type:e.type||"email",subject:e.subject||"",content:e.content||"",variables:e.variables||[],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};return this.messageTemplates.push(t),this.saveData(),this.logAction("create","messageTemplate",t.id,t.name),void 0!==toast&&toast&&toast.success("Template criado com sucesso!",3e3),t}updateMessageTemplate(e,t){const o=this.messageTemplates.find(t=>t.id===e);if(!o)throw new Error("Template n√£o encontrado");return Object.keys(t).forEach(e=>{"id"!==e&&"createdAt"!==e&&(o[e]=t[e])}),o.updatedAt=(new Date).toISOString(),this.saveData(),this.logAction("update","messageTemplate",o.id,o.name),void 0!==toast&&toast&&toast.success("Template atualizado com sucesso!",3e3),o}deleteMessageTemplate(e){const t=this.messageTemplates.findIndex(t=>t.id===e);if(-1===t)throw new Error("Template n√£o encontrado");const o=this.messageTemplates[t];this.messageTemplates.splice(t,1),this.saveData(),this.logAction("delete","messageTemplate",e,o.name),void 0!==toast&&toast&&toast.success("Template deletado com sucesso!",3e3)}async deleteMessageTemplateWithConfirm(e){const t=this.getMessageTemplate(e);if(t){if(await ConfirmSystem.confirm({title:"Confirmar Exclus√£o",message:`Tem certeza que deseja excluir o template "${t.name}"?`,type:"danger"}))try{this.deleteMessageTemplate(e),this.renderMessageTemplates()}catch(e){console.error("Erro ao deletar template:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3)}}else void 0!==toast&&toast&&toast.error("Template n√£o encontrado",3e3)}getMessageTemplate(e){return this.messageTemplates.find(t=>t.id===e)||null}getMessageTemplatesByType(e){return this.messageTemplates.filter(t=>t.type===e)}async sendMessageWithTemplate(e,t,o={}){const a=this.getMessageTemplate(e);if(!a)throw new Error("Template n√£o encontrado");const s=this.processMessageTemplate(a.subject,o),n=this.processMessageTemplate(a.content,o);let r;try{if("email"===a.type)r=await this.sendEmail(t,s,n);else if("sms"===a.type)r=await this.sendSMS(t,n);else{if("whatsapp"!==a.type)throw new Error(`Tipo de template inv√°lido: ${a.type}`);r=await this.sendWhatsApp(t,n)}return this.messageHistory.push({id:Date.now().toString(),type:a.type,to:t,subject:s,content:n,templateId:a.id,templateName:a.name,status:"success",sentAt:(new Date).toISOString(),variables:o}),this.messageHistory.length>1e3&&this.messageHistory.shift(),this.saveData(),r}catch(e){throw this.messageHistory.push({id:Date.now().toString(),type:a.type,to:t,subject:s,content:n,templateId:a.id,templateName:a.name,status:"error",sentAt:(new Date).toISOString(),error:e.message,variables:o}),this.saveData(),e}}scheduleMessage(e,t,o,a={}){const s=this.getMessageTemplate(e);if(!s)throw new Error("Template n√£o encontrado");const n={id:Date.now().toString(),templateId:e,templateName:s.name,type:s.type,to:t,variables:a,scheduledAt:o instanceof Date?o.toISOString():o,sent:!1,createdAt:(new Date).toISOString()};return this.scheduledMessages.push(n),this.saveData(),this.logAction("create","scheduledMessage",n.id,`Agendado para ${o}`),this.initScheduledMessagesChecker(),void 0!==toast&&toast&&toast.success("Mensagem agendada com sucesso!",3e3),n}initScheduledMessagesChecker(){this.scheduledMessagesInterval||(this.scheduledMessagesInterval=setInterval(()=>{this.checkScheduledMessages()},6e4),console.log("‚úÖ [MESSAGES] Verificador de mensagens agendadas iniciado"))}async checkScheduledMessages(){const e=new Date,t=this.scheduledMessages.filter(t=>!t.sent&&new Date(t.scheduledAt)<=e);for(const e of t)try{await this.sendMessageWithTemplate(e.templateId,e.to,e.variables),e.sent=!0,e.sentAt=(new Date).toISOString(),void 0!==toast&&toast&&toast.success(`Mensagem agendada enviada para ${e.to}`,3e3)}catch(t){e.error=t.message,console.error("‚ùå [MESSAGES] Erro ao enviar mensagem agendada:",t),void 0!==toast&&toast&&toast.error(`Erro ao enviar mensagem agendada: ${t.message}`,5e3)}t.length>0&&this.saveData()}renderMessageTemplates(){const e=document.getElementById("messageTemplatesList");if(!e)return;if(0===this.messageTemplates.length)return void(e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-envelope-open-text" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>\n                    <p style="color: var(--gray-600);">Nenhum template de mensagem criado ainda.</p>\n                    <button class="btn-primary" onclick="app.openMessageTemplateModal()">\n                        <i class="fas fa-plus"></i> Criar Primeiro Template\n                    </button>\n                </div>\n            ');const t=this.messageTemplates.map(e=>{const t={email:"fa-envelope",sms:"fa-sms",whatsapp:"fa-whatsapp"}[e.type]||"fa-envelope",o={email:"#dc3545",sms:"#28a745",whatsapp:"#25D366"}[e.type]||"#6c757d";return`\n                <div class="template-card" style="border-left: 4px solid ${o};">\n                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">\n                        <div>\n                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">\n                                <i class="fas ${t}" style="color: ${o};"></i>\n                                ${e.name}\n                            </h3>\n                            <small style="color: var(--gray-600);">\n                                ${e.type.toUpperCase()} ‚Ä¢ Criado em ${new Date(e.createdAt).toLocaleDateString("pt-BR")}\n                            </small>\n                        </div>\n                        <div style="display: flex; gap: 0.5rem;">\n                            <button class="btn-secondary" onclick="app.openMessageTemplateModal('${e.id}')" title="Editar">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button class="btn-secondary" onclick="app.deleteMessageTemplateWithConfirm('${e.id}')" title="Deletar">\n                                <i class="fas fa-trash"></i>\n                            </button>\n                        </div>\n                    </div>\n                    ${e.subject?`<p style="margin: 0.5rem 0; color: var(--gray-700);"><strong>Assunto:</strong> ${e.subject}</p>`:""}\n                    <p style="margin: 0; color: var(--gray-600); font-size: 0.9rem;">\n                        ${e.content.substring(0,100)}${e.content.length>100?"...":""}\n                    </p>\n                    ${e.variables&&e.variables.length>0?`\n                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: gap: 0.25rem;">\n                            ${e.variables.map(e=>`<span style="background: var(--light-gray); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">{{${e}}}</span>`).join("")}\n                        </div>\n                    `:""}\n                </div>\n            `}).join("");e.innerHTML=t}openMessageTemplateModal(e=null){const t=document.getElementById("messageTemplateModal");if(!t)return void console.warn("Modal de template de mensagem n√£o encontrado");const o=document.getElementById("messageTemplateForm"),a=document.getElementById("messageTemplateModalTitle");if(!o||!a)return void console.warn("Elementos do modal n√£o encontrados");const s=e?this.getMessageTemplate(e):null;s?(a.textContent="Editar Template de Mensagem",o.templateName.value=s.name||"",o.templateType.value=s.type||"email",o.templateSubject.value=s.subject||"",o.templateContent.value=s.content||"",o.templateVariables.value=(s.variables||[]).join(", "),o.dataset.templateId=e):(a.textContent="Criar Template de Mensagem",o.reset(),o.templateType.value="email",delete o.dataset.templateId),this.toggleMessageTemplateFields(),t.classList.add("active")}closeMessageTemplateModal(){const e=document.getElementById("messageTemplateModal");e&&e.classList.remove("active")}toggleMessageTemplateFields(){const e=document.getElementById("messageTemplateType")?.value||"email",t=document.getElementById("messageTemplateSubjectField");t&&(t.style.display="email"===e?"block":"none")}saveMessageTemplate(e){e&&e.preventDefault();const t=document.getElementById("messageTemplateForm");if(!t)return;const o=t.dataset.templateId,a={name:t.templateName.value,type:t.templateType.value,subject:t.templateSubject.value,content:t.templateContent.value,variables:t.templateVariables.value.split(",").map(e=>e.trim()).filter(e=>e.length>0)};try{o?this.updateMessageTemplate(o,a):this.createMessageTemplate(a),this.renderMessageTemplates(),this.closeMessageTemplateModal()}catch(e){console.error("Erro ao salvar template:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3)}}renderMessageHistory(){const e=document.getElementById("messageHistoryList"),t=document.getElementById("historyStats");if(!e)return;const o=document.getElementById("historyFilterType")?.value||"",a=document.getElementById("historyFilterStatus")?.value||"",s=(document.getElementById("historySearch")?.value||"").toLowerCase();let n=[...this.messageHistory];o&&(n=n.filter(e=>e.type===o)),a&&(n=n.filter(e=>e.status===a)),s&&(n=n.filter(e=>e.to.toLowerCase().includes(s)||e.subject&&e.subject.toLowerCase().includes(s)||e.content&&e.content.toLowerCase().includes(s)||e.templateName&&e.templateName.toLowerCase().includes(s)));const r=this.messageHistory.length,i=this.messageHistory.filter(e=>"success"===e.status).length,c=this.messageHistory.filter(e=>"error"===e.status).length;if(this.messageHistory.filter(e=>"email"===e.type).length,this.messageHistory.filter(e=>"sms"===e.type).length,this.messageHistory.filter(e=>"whatsapp"===e.type).length,t&&(t.innerHTML=`\n                <div style="background: var(--white); padding: 1rem; border-radius: var(--radius-sm); border-left: 4px solid #007bff;">\n                    <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.25rem;">Total</div>\n                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--dark-gray);">${r}</div>\n                </div>\n                <div style="background: var(--white); padding: 1rem; border-radius: var(--radius-sm); border-left: 4px solid #28a745;">\n                    <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.25rem;">Sucesso</div>\n                    <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${i}</div>\n                </div>\n                <div style="background: var(--white); padding: 1rem; border-radius: var(--radius-sm); border-left: 4px solid #dc3545;">\n                    <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.25rem;">Erros</div>\n                    <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">${c}</div>\n                </div>\n                <div style="background: var(--white); padding: 1rem; border-radius: var(--radius-sm); border-left: 4px solid #ffc107;">\n                    <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.25rem;">Taxa de Sucesso</div>\n                    <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${r>0?(i/r*100).toFixed(1):0}%</div>\n                </div>\n            `),0===n.length)return void(e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-history" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>\n                    <p style="color: var(--gray-600);">Nenhuma mensagem encontrada com os filtros selecionados.</p>\n                </div>\n            ');const l=n.sort((e,t)=>new Date(t.sentAt)-new Date(e.sentAt)).slice(0,100).map(e=>{const t="success"===e.status?"fa-check-circle":"fa-times-circle",o="success"===e.status?"#28a745":"#dc3545";return`\n                <div class="history-item" style="border-left: 3px solid ${o};">\n                    <div style="display: flex; justify-content: space-between; align-items: start;">\n                        <div style="flex: 1;">\n                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">\n                                <i class="fas ${{email:"fa-envelope",sms:"fa-sms",whatsapp:"fa-whatsapp"}[e.type]||"fa-envelope"}" style="color: var(--gray-600);"></i>\n                                <strong>${e.to}</strong>\n                                <i class="fas ${t}" style="color: ${o};"></i>\n                            </div>\n                            ${e.subject?`<p style="margin: 0.25rem 0; color: var(--gray-700);"><strong>Assunto:</strong> ${e.subject}</p>`:""}\n                            <p style="margin: 0.25rem 0; color: var(--gray-600); font-size: 0.9rem;">\n                                ${e.content.substring(0,150)}${e.content.length>150?"...":""}\n                            </p>\n                            ${e.templateName?`<small style="color: var(--gray-500);">Template: ${e.templateName}</small>`:""}\n                        </div>\n                        <div style="text-align: right;">\n                            <small style="color: var(--gray-500);">\n                                ${new Date(e.sentAt).toLocaleString("pt-BR")}\n                            </small>\n                            ${e.error?`<div style="color: ${o}; font-size: 0.8rem; margin-top: 0.25rem;">${e.error}</div>`:""}\n                        </div>\n                    </div>\n                </div>\n            `}).join("");e.innerHTML=l}renderScheduledMessages(){const e=document.getElementById("scheduledMessagesList");if(!e)return;if(0===this.scheduledMessages.length)return void(e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-clock" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>\n                    <p style="color: var(--gray-600);">Nenhuma mensagem agendada.</p>\n                    <button class="btn-primary" onclick="app.openScheduleMessageModal()">\n                        <i class="fas fa-plus"></i> Agendar Primeira Mensagem\n                    </button>\n                </div>\n            ');const t=this.scheduledMessages.filter(e=>!e.sent),o=this.scheduledMessages.filter(e=>e.sent);t.sort((e,t)=>new Date(e.scheduledAt)-new Date(t.scheduledAt)),o.sort((e,t)=>new Date(t.sentAt||t.scheduledAt)-new Date(e.sentAt||e.scheduledAt));let a="";t.length>0&&(a+=`\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray);">\n                    <i class="fas fa-hourglass-half"></i> Pendentes (${t.length})\n                </h3>\n            `,a+=t.map(e=>{const t=this.getMessageTemplate(e.templateId),o=new Date(e.scheduledAt),a=new Date,s=o<a,n=o-a,r=Math.floor(n/36e5),i=Math.floor(n%36e5/6e4),c={email:"fa-envelope",sms:"fa-sms",whatsapp:"fa-whatsapp"}[e.type]||"fa-envelope",l={email:"#dc3545",sms:"#28a745",whatsapp:"#25D366"}[e.type]||"#6c757d";return`\n                    <div class="scheduled-message-card" style="border-left: 4px solid ${l}; ${s?"opacity: 0.7;":""}">\n                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">\n                            <div style="flex: 1;">\n                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">\n                                    <i class="fas ${c}" style="color: ${l};"></i>\n                                    <strong>${e.to}</strong>\n                                </div>\n                                <p style="margin: 0.25rem 0; color: var(--gray-700);">\n                                    <strong>Template:</strong> ${t?.name||"Template n√£o encontrado"}\n                                </p>\n                                <p style="margin: 0.25rem 0; color: var(--gray-600); font-size: 0.9rem;">\n                                    <i class="fas fa-calendar"></i> ${o.toLocaleString("pt-BR")}\n                                </p>\n                                ${s?'\n                                    <p style="margin: 0.25rem 0; color: #ffc107; font-size: 0.85rem;">\n                                        <i class="fas fa-exclamation-triangle"></i> Agendado para o passado - ser√° enviado na pr√≥xima verifica√ß√£o\n                                    </p>\n                                ':`\n                                    <p style="margin: 0.25rem 0; color: var(--gray-600); font-size: 0.85rem;">\n                                        <i class="fas fa-hourglass-half"></i> Envio em ${r>0?`${r}h `:""}${i}min\n                                    </p>\n                                `}\n                                ${e.error?`\n                                    <p style="margin: 0.25rem 0; color: #dc3545; font-size: 0.85rem;">\n                                        <i class="fas fa-exclamation-circle"></i> Erro: ${e.error}\n                                    </p>\n                                `:""}\n                            </div>\n                            <div style="display: flex; gap: 0.5rem;">\n                                ${e.sent?'\n                                    <span style="color: #28a745; font-size: 0.9rem;">\n                                        <i class="fas fa-check-circle"></i> Enviada\n                                    </span>\n                                ':`\n                                    <button class="btn-secondary" onclick="app.cancelScheduledMessage('${e.id}')" title="Cancelar">\n                                        <i class="fas fa-times"></i>\n                                    </button>\n                                `}\n                            </div>\n                        </div>\n                    </div>\n                `}).join(""),a+='<div style="margin: 1.5rem 0;"></div>'),o.length>0&&(a+=`\n                <h3 style="margin: 0 0 1rem 0; color: var(--dark-gray);">\n                    <i class="fas fa-check-circle"></i> Enviadas (${o.length})\n                </h3>\n            `,a+=o.slice(0,10).map(e=>{const t=this.getMessageTemplate(e.templateId),o=e.sentAt?new Date(e.sentAt):new Date(e.scheduledAt),a={email:"fa-envelope",sms:"fa-sms",whatsapp:"fa-whatsapp"}[e.type]||"fa-envelope",s={email:"#dc3545",sms:"#28a745",whatsapp:"#25D366"}[e.type]||"#6c757d";return`\n                    <div class="scheduled-message-card" style="border-left: 4px solid ${s}; opacity: 0.6;">\n                        <div style="display: flex; justify-content: space-between; align-items: start;">\n                            <div style="flex: 1;">\n                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">\n                                    <i class="fas ${a}" style="color: ${s};"></i>\n                                    <strong>${e.to}</strong>\n                                    <i class="fas fa-check-circle" style="color: #28a745;"></i>\n                                </div>\n                                <p style="margin: 0.25rem 0; color: var(--gray-700); font-size: 0.9rem;">\n                                    <strong>Template:</strong> ${t?.name||"Template n√£o encontrado"}\n                                </p>\n                                <p style="margin: 0.25rem 0; color: var(--gray-600); font-size: 0.85rem;">\n                                    <i class="fas fa-calendar-check"></i> Enviada em ${o.toLocaleString("pt-BR")}\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                `}).join("")),e.innerHTML=a}openScheduleMessageModal(){const e=document.getElementById("scheduleMessageModal");if(!e)return void console.warn("Modal de agendamento n√£o encontrado");const t=document.getElementById("scheduleMessageForm"),o=document.getElementById("scheduleTemplate");if(!t||!o)return void console.warn("Elementos do modal n√£o encontrados");o.innerHTML='<option value="">Selecione um template...</option>',this.messageTemplates.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.name} (${e.type.toUpperCase()})`,o.appendChild(t)}),t.reset(),document.getElementById("templateVariablesContainer").innerHTML='<p style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0;">Selecione um template para ver as vari√°veis</p>';const a=new Date;a.setMinutes(a.getMinutes()+1);const s=a.toISOString().slice(0,16);document.getElementById("scheduleDateTime").min=s,e.classList.add("active")}closeScheduleMessageModal(){const e=document.getElementById("scheduleMessageModal");e&&e.classList.remove("active")}loadTemplateVariables(){const e=document.getElementById("scheduleTemplate")?.value,t=document.getElementById("templateVariablesContainer");if(!e||!t)return;const o=this.getMessageTemplate(e);if(!o)return;const a=["nome","data","hora","dataHora","ano","mes",...o.variables||[]];if(0===a.length)return void(t.innerHTML='<p style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0;">Este template n√£o usa vari√°veis</p>');let s='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">';a.forEach(e=>{s+=`\n                <div class="form-group" style="margin: 0;">\n                    <label for="var_${e}" style="font-size: 0.85rem;">{{${e}}}</label>\n                    <input type="text" id="var_${e}" name="variables[${e}]" placeholder="Valor para ${e}" />\n                </div>\n            `}),s+="</div>",t.innerHTML=s}saveScheduledMessage(e){e&&e.preventDefault();const t=document.getElementById("scheduleMessageForm");if(!t)return;const o=t.templateId.value,a=t.to.value,s=t.scheduledAt.value;if(!o||!a||!s)return void(void 0!==toast&&toast&&toast.error("Preencha todos os campos obrigat√≥rios",3e3));const n={};t.querySelectorAll('[name^="variables["]').forEach(e=>{const t=e.name.match(/variables\[(.+)\]/);t&&e.value.trim()&&(n[t[1]]=e.value.trim())});try{this.scheduleMessage(o,a,s,n),this.renderScheduledMessages(),this.closeScheduleMessageModal()}catch(e){console.error("Erro ao agendar mensagem:",e),void 0!==toast&&toast&&toast.error(`Erro: ${e.message}`,5e3)}}async cancelScheduledMessage(e){const t=this.scheduledMessages.find(t=>t.id===e);if(t){if(await ConfirmSystem.confirm({title:"Cancelar Agendamento",message:`Tem certeza que deseja cancelar o agendamento para ${t.to}?`,type:"warning"})){const o=this.scheduledMessages.findIndex(t=>t.id===e);-1!==o&&(this.scheduledMessages.splice(o,1),this.saveData(),this.logAction("delete","scheduledMessage",e,`Cancelado: ${t.to}`),this.renderScheduledMessages(),void 0!==toast&&toast&&toast.success("Agendamento cancelado com sucesso!",3e3))}}else void 0!==toast&&toast&&toast.error("Mensagem n√£o encontrada",3e3)}async importProductsFromEcommerce(e=null){const t=e||this.getActiveEcommercePlatform();if(!t)throw new Error("Nenhuma plataforma de e-commerce configurada");const o=this.ecommerceConfig[t];if(!o||!o.enabled)throw new Error(`Plataforma ${t} n√£o est√° habilitada`);void 0!==toast&&toast&&toast.info(`Importando produtos de ${t}...`,3e3);try{let e=[];"woocommerce"===t?e=await this.importWooCommerceProducts(o):"shopify"===t?e=await this.importShopifyProducts(o):"mercadoLivre"===t&&(e=await this.importMercadoLivreProducts(o));const a=e.map(e=>this.convertEcommerceProductToLocal(e,t));let s=0,n=0;return a.forEach(e=>{const o=this.items.findIndex(o=>o.ecommerceId===e.ecommerceId&&o.ecommercePlatform===t);-1!==o?(this.items[o]={...this.items[o],...e,id:this.items[o].id},n++):(e.id=Date.now().toString()+Math.random().toString(36).substr(2,9),e.ecommerceId=e.ecommerceId||e.id,e.ecommercePlatform=t,this.items.push(e),s++)}),this.saveData(),this.logAction("import","products","ecommerce",`Importados ${s} novos e ${n} atualizados de ${t}`),void 0!==toast&&toast&&toast.success(`Importa√ß√£o conclu√≠da: ${s} novos, ${n} atualizados`,5e3),{added:s,updated:n,total:a.length}}catch(e){throw console.error("Erro ao importar produtos:",e),void 0!==toast&&toast&&toast.error(`Erro ao importar produtos: ${e.message}`,5e3),e}}async exportProductsToEcommerce(e=[],t=null){const o=t||this.getActiveEcommercePlatform();if(!o)throw new Error("Nenhuma plataforma de e-commerce configurada");const a=this.ecommerceConfig[o];if(!a||!a.enabled)throw new Error(`Plataforma ${o} n√£o est√° habilitada`);const s=e.length>0?this.items.filter(t=>e.includes(t.id)):this.items;if(0===s.length)throw new Error("Nenhum produto selecionado para exportar");void 0!==toast&&toast&&toast.info(`Exportando ${s.length} produtos para ${o}...`,3e3);try{let e=0,t=0;const n=[];for(const r of s)try{const s=this.convertLocalProductToEcommerce(r,o);let n;"woocommerce"===o?n=await this.exportToWooCommerce(r,s,a):"shopify"===o?n=await this.exportToShopify(r,s,a):"mercadoLivre"===o&&(n=await this.exportToMercadoLivre(r,s,a)),n.created?(e++,r.ecommerceId=n.id,r.ecommercePlatform=o):n.updated&&t++}catch(e){n.push({product:r.name||r.id,error:e.message})}return this.saveData(),this.logAction("export","products","ecommerce",`Exportados ${e} novos e ${t} atualizados para ${o}`),void 0!==toast&&toast&&(n.length>0?toast.warning(`Exporta√ß√£o conclu√≠da com ${n.length} erros: ${e} novos, ${t} atualizados`,5e3):toast.success(`Exporta√ß√£o conclu√≠da: ${e} novos, ${t} atualizados`,5e3)),{exported:e,updated:t,errors:n}}catch(e){throw console.error("Erro ao exportar produtos:",e),void 0!==toast&&toast&&toast.error(`Erro ao exportar produtos: ${e.message}`,5e3),e}}async importOrdersFromEcommerce(e=null,t=null,o=null){const a=e||this.getActiveEcommercePlatform();if(!a)throw new Error("Nenhuma plataforma de e-commerce configurada");const s=this.ecommerceConfig[a];if(!s||!s.enabled)throw new Error(`Plataforma ${a} n√£o est√° habilitada`);void 0!==toast&&toast&&toast.info(`Importando pedidos de ${a}...`,3e3);try{let e=[];"woocommerce"===a?e=await this.importWooCommerceOrders(s,t,o):"shopify"===a?e=await this.importShopifyOrders(s,t,o):"mercadoLivre"===a&&(e=await this.importMercadoLivreOrders(s,t,o));const n=e.map(e=>this.convertEcommerceOrderToSale(e,a));let r=0;return n.forEach(e=>{-1===this.completedSales.findIndex(t=>t.ecommerceId===e.ecommerceId&&t.ecommercePlatform===a)&&(e.id=Date.now().toString()+Math.random().toString(36).substr(2,9),e.ecommerceId=e.ecommerceId||e.id,e.ecommercePlatform=a,this.completedSales.push(e),r++)}),this.saveData(),this.logAction("import","orders","ecommerce",`Importados ${r} pedidos de ${a}`),void 0!==toast&&toast&&toast.success(`Importa√ß√£o conclu√≠da: ${r} pedidos importados`,5e3),{added:r,total:n.length}}catch(e){throw console.error("Erro ao importar pedidos:",e),void 0!==toast&&toast&&toast.error(`Erro ao importar pedidos: ${e.message}`,5e3),e}}getActiveEcommercePlatform(){const e=this.ecommerceConfig||{};return e.woocommerce?.enabled?"woocommerce":e.shopify?.enabled?"shopify":e.mercadoLivre?.enabled?"mercadoLivre":null}convertEcommerceProductToLocal(e,t){return"woocommerce"===t?{name:e.name||"",price:parseFloat(e.price||0),cost:parseFloat(e.cost||0),stock:parseInt(e.stock_quantity||0),description:e.description||"",sku:e.sku||"",category:e.categories?.[0]?.name||"",ecommerceId:e.id?.toString()||""}:"shopify"===t?{name:e.title||"",price:parseFloat(e.variants?.[0]?.price||0),cost:0,stock:parseInt(e.variants?.[0]?.inventory_quantity||0),description:e.body_html||"",sku:e.variants?.[0]?.sku||"",category:e.product_type||"",ecommerceId:e.id?.toString()||""}:"mercadoLivre"===t?{name:e.title||"",price:parseFloat(e.price||0),cost:0,stock:parseInt(e.available_quantity||0),description:e.description||"",sku:e.seller_custom_field||"",category:e.category_id||"",ecommerceId:e.id||""}:e}convertLocalProductToEcommerce(e,t){return"woocommerce"===t?{name:e.name||"",type:"simple",regular_price:(e.price||0).toString(),description:e.description||"",short_description:e.description?.substring(0,200)||"",sku:e.sku||"",manage_stock:!0,stock_quantity:e.stock||0,categories:e.category?[{name:e.category}]:[]}:"shopify"===t?{title:e.name||"",body_html:e.description||"",vendor:"Loja",product_type:e.category||"",variants:[{price:(e.price||0).toString(),sku:e.sku||"",inventory_quantity:e.stock||0}]}:"mercadoLivre"===t?{title:e.name||"",price:e.price||0,available_quantity:e.stock||0,description:e.description||"",seller_custom_field:e.sku||""}:e}convertEcommerceOrderToSale(e,t){let o=[],a=0,s="",n="";return"woocommerce"===t?(o=(e.line_items||[]).map(e=>({name:e.name,quantity:e.quantity,price:parseFloat(e.price||0)})),a=parseFloat(e.total||0),s=`${e.billing?.first_name||""} ${e.billing?.last_name||""}`.trim(),n=e.billing?.email||""):"shopify"===t?(o=(e.line_items||[]).map(e=>({name:e.name,quantity:e.quantity,price:parseFloat(e.price||0)})),a=parseFloat(e.total_price||0),s=`${e.customer?.first_name||""} ${e.customer?.last_name||""}`.trim(),n=e.customer?.email||e.email||""):"mercadoLivre"===t&&(o=[{name:e.title||"Produto",quantity:1,price:parseFloat(e.price||0)}],a=parseFloat(e.price||0),s=e.buyer?.nickname||"",n=e.buyer?.email||""),{items:o,total:a,date:e.date_created||e.created_at||e.date_created||(new Date).toISOString(),customerName:s,customerEmail:n,paymentMethod:e.payment_method_title||e.financial_status||"Online",status:e.status||"completed",ecommerceId:e.id?.toString()||e.order_id?.toString()||""}}async importWooCommerceProducts(e){const t=`${e.url}/wp-json/wc/v3/products?per_page=100`,o=btoa(`${e.consumerKey}:${e.consumerSecret}`),a=await fetch(t,{headers:{Authorization:`Basic ${o}`}});if(!a.ok)throw new Error(`WooCommerce: ${a.status} ${a.statusText}`);return await a.json()}async importShopifyProducts(e){const t=`https://${e.shop}.myshopify.com/admin/api/2024-01/products.json?limit=250`,o=await fetch(t,{headers:{"X-Shopify-Access-Token":e.apiKey}});if(!o.ok)throw new Error(`Shopify: ${o.status} ${o.statusText}`);return(await o.json()).products||[]}async importMercadoLivreProducts(e){const t=`https://api.mercadolivre.com/users/me/items/search?access_token=${e.accessToken}`,o=await fetch(t);if(!o.ok)throw new Error(`Mercado Livre: ${o.status} ${o.statusText}`);const a=(await o.json()).results||[];return(await Promise.all(a.slice(0,50).map(async t=>{try{const o=`https://api.mercadolivre.com/items/${t}?access_token=${e.accessToken}`,a=await fetch(o);if(a.ok)return await a.json()}catch(e){console.error(`Erro ao buscar item ${t}:`,e)}return null}))).filter(e=>null!==e)}async exportToWooCommerce(e,t,o){const a=e.ecommerceId?`${o.url}/wp-json/wc/v3/products/${e.ecommerceId}`:`${o.url}/wp-json/wc/v3/products`,s=btoa(`${o.consumerKey}:${o.consumerSecret}`),n=e.ecommerceId?"PUT":"POST",r=await fetch(a,{method:n,headers:{Authorization:`Basic ${s}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok){const e=await r.json().catch(()=>({message:r.statusText}));throw new Error(`WooCommerce: ${e.message||r.statusText}`)}return{created:"POST"===n,updated:"PUT"===n,id:(await r.json()).id}}async exportToShopify(e,t,o){const a=e.ecommerceId?`https://${o.shop}.myshopify.com/admin/api/2024-01/products/${e.ecommerceId}.json`:`https://${o.shop}.myshopify.com/admin/api/2024-01/products.json`,s=e.ecommerceId?"PUT":"POST",n={product:t},r=await fetch(a,{method:s,headers:{"X-Shopify-Access-Token":o.apiKey,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){const e=await r.json().catch(()=>({message:r.statusText}));throw new Error(`Shopify: ${e.errors||e.message||r.statusText}`)}const i=await r.json();return{created:"POST"===s,updated:"PUT"===s,id:i.product?.id}}async exportToMercadoLivre(e,t,o){throw new Error("Exporta√ß√£o para Mercado Livre requer configura√ß√£o adicional de OAuth")}async importWooCommerceOrders(e,t,o){let a=`${e.url}/wp-json/wc/v3/orders?per_page=100&status=completed`;t&&(a+=`&after=${t.toISOString()}`),o&&(a+=`&before=${o.toISOString()}`);const s=btoa(`${e.consumerKey}:${e.consumerSecret}`),n=await fetch(a,{headers:{Authorization:`Basic ${s}`}});if(!n.ok)throw new Error(`WooCommerce: ${n.status} ${n.statusText}`);return await n.json()}async importShopifyOrders(e,t,o){let a=`https://${e.shop}.myshopify.com/admin/api/2024-01/orders.json?limit=250&status=any`;t&&(a+=`&created_at_min=${t.toISOString()}`),o&&(a+=`&created_at_max=${o.toISOString()}`);const s=await fetch(a,{headers:{"X-Shopify-Access-Token":e.apiKey}});if(!s.ok)throw new Error(`Shopify: ${s.status} ${s.statusText}`);return(await s.json()).orders||[]}async importMercadoLivreOrders(e,t,o){if(!e.sellerId)throw new Error("Seller ID do Mercado Livre n√£o configurado");let a=`https://api.mercadolivre.com/orders/search?seller=${e.sellerId}&access_token=${e.accessToken}`;t&&(a+=`&order.date_created.from=${t.toISOString()}`),o&&(a+=`&order.date_created.to=${o.toISOString()}`);const s=await fetch(a);if(!s.ok)throw new Error(`Mercado Livre: ${s.status} ${s.statusText}`);return(await s.json()).results||[]}renderEcommerceSyncStatus(){const e=document.getElementById("activeEcommercePlatform");if(!e)return;const t=this.getActiveEcommercePlatform();if(t){const o={woocommerce:"WooCommerce",shopify:"Shopify",mercadoLivre:"Mercado Livre"};e.textContent=`Plataforma ativa: ${o[t]||t}`;const a=e.parentElement;a&&(a.style.background="#d4edda",a.style.borderLeft="4px solid #28a745")}else{e.textContent="Nenhuma plataforma de e-commerce configurada";const t=e.parentElement;t&&(t.style.background="#fff3cd",t.style.borderLeft="4px solid #ffc107")}}async syncStockWithEcommerce(e="both"){const t=this.getActiveEcommercePlatform();if(!t)throw new Error("Nenhuma plataforma de e-commerce configurada");const o=this.ecommerceConfig[t];if(!o||!o.enabled)throw new Error(`Plataforma ${t} n√£o est√° habilitada`);const a=this.items.filter(e=>e.ecommerceId&&e.ecommercePlatform===t);if(0===a.length)return void 0!==toast&&toast&&toast.info("Nenhum produto vinculado ao E-commerce encontrado",3e3),{synced:0,errors:[]};void 0!==toast&&toast&&toast.info(`Sincronizando estoque de ${a.length} produtos...`,3e3);let s=0;const n=[];try{if("from"===e||"both"===e)for(const e of a)try{const a=await this.getEcommerceStock(e,t,o);null!==a&&(e.stock=a,s++)}catch(t){n.push({product:e.name||e.id,error:t.message})}if("to"===e||"both"===e)for(const e of a)try{await this.updateEcommerceStock(e,t,o),s++}catch(t){n.push({product:e.name||e.id,error:t.message})}return this.saveData(),this.logAction("sync","stock","ecommerce",`Sincronizado estoque de ${s} produtos com ${t}`),void 0!==toast&&toast&&(n.length>0?toast.warning(`Sincroniza√ß√£o conclu√≠da com ${n.length} erros: ${s} produtos sincronizados`,5e3):toast.success(`Estoque sincronizado: ${s} produtos`,5e3)),{synced:s,errors:n}}catch(e){throw console.error("Erro ao sincronizar estoque:",e),void 0!==toast&&toast&&toast.error(`Erro ao sincronizar estoque: ${e.message}`,5e3),e}}async getEcommerceStock(e,t,o){if("woocommerce"===t){const t=`${o.url}/wp-json/wc/v3/products/${e.ecommerceId}`,a=btoa(`${o.consumerKey}:${o.consumerSecret}`),s=await fetch(t,{headers:{Authorization:`Basic ${a}`}});if(!s.ok)throw new Error(`WooCommerce: ${s.status}`);const n=await s.json();return parseInt(n.stock_quantity||0)}if("shopify"===t){const t=`https://${o.shop}.myshopify.com/admin/api/2024-01/products/${e.ecommerceId}.json`,a=await fetch(t,{headers:{"X-Shopify-Access-Token":o.apiKey}});if(!a.ok)throw new Error(`Shopify: ${a.status}`);const s=await a.json();return parseInt(s.product?.variants?.[0]?.inventory_quantity||0)}if("mercadoLivre"===t){const t=`https://api.mercadolivre.com/items/${e.ecommerceId}?access_token=${o.accessToken}`,a=await fetch(t);if(!a.ok)throw new Error(`Mercado Livre: ${a.status}`);const s=await a.json();return parseInt(s.available_quantity||0)}return null}async updateEcommerceStock(e,t,o){if("woocommerce"===t){const t=`${o.url}/wp-json/wc/v3/products/${e.ecommerceId}`,a=btoa(`${o.consumerKey}:${o.consumerSecret}`),s=await fetch(t,{method:"PUT",headers:{Authorization:`Basic ${a}`,"Content-Type":"application/json"},body:JSON.stringify({stock_quantity:e.stock||0})});if(!s.ok)throw new Error(`WooCommerce: ${s.status}`)}else if("shopify"===t){const t=e.ecommerceVariantId;if(!t)throw new Error("Variant ID n√£o encontrado para Shopify");const a=`https://${o.shop}.myshopify.com/admin/api/2024-01/inventory_levels/set.json`,s=await fetch(a,{method:"POST",headers:{"X-Shopify-Access-Token":o.apiKey,"Content-Type":"application/json"},body:JSON.stringify({location_id:o.locationId||1,inventory_item_id:t,available:e.stock||0})});if(!s.ok)throw new Error(`Shopify: ${s.status}`)}else if("mercadoLivre"===t){const t=`https://api.mercadolivre.com/items/${e.ecommerceId}?access_token=${o.accessToken}`,a=await fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({available_quantity:e.stock||0})});if(!a.ok)throw new Error(`Mercado Livre: ${a.status}`)}}startAutoStockSync(e=30){this.autoStockSyncInterval&&clearInterval(this.autoStockSyncInterval),this.autoStockSyncInterval=setInterval(()=>{this.getActiveEcommercePlatform()&&this.syncStockWithEcommerce("both").catch(e=>{console.error("Erro na sincroniza√ß√£o autom√°tica de estoque:",e)})},60*e*1e3),console.log(`‚úÖ [E-COMMERCE] Sincroniza√ß√£o autom√°tica de estoque iniciada (a cada ${e} minutos)`)}stopAutoStockSync(){this.autoStockSyncInterval&&(clearInterval(this.autoStockSyncInterval),this.autoStockSyncInterval=null,console.log("‚úÖ [E-COMMERCE] Sincroniza√ß√£o autom√°tica de estoque parada"))}}function openModalSafely(e){window.app&&window.app.openModalSafely(e)}function closeModalSafely(e){window.app&&window.app.closeModalSafely(e)}function atualizarResumoEstoqueMes(e,t){if(!e||!t)return;const o=window.app?.carregarEstoque?window.app.carregarEstoque(e,t):null,a=o?.totalInicial||0,s=o?.movimentacoes||[],n=s.filter(e=>e.qtd<0).reduce((e,t)=>e+Math.abs(t.qtd),0),r=a-n;document.getElementById("resumoEstoqueInicial").textContent=`${a} un`,document.getElementById("resumoEstoqueVendido").textContent=`${n} un`,document.getElementById("resumoEstoqueDisponivel").textContent=`${r} un`;const i=document.getElementById("movimentacoesAviso");i&&(0===s.length?(i.textContent="Nenhuma movimenta√ß√£o registrada para este m√™s.",i.style.display="block"):(i.textContent="",i.style.display="none"))}function adicionarEntradaEstoque(){const e=sessionStorage.getItem("username"),t=document.getElementById("mesSelecionado")?.value,o=document.getElementById("estoqueEntradaDia"),a=document.getElementById("estoqueEntradaQuantidade"),s=document.getElementById("estoqueEntradaFeedback"),n=document.getElementById("adicionarEntradaEstoqueBtn"),r=document.getElementById("estoqueEntradaDiaMsg"),i=document.getElementById("estoqueEntradaQuantidadeMsg");if(n&&"true"===n.dataset.busy)return;if(!(e&&t&&o&&a))return;const c=o.value,l=Number(a.value);o.classList.remove("invalid"),a.classList.remove("invalid"),r&&(r.textContent=""),r&&r.classList.remove("show"),i&&(i.textContent=""),i&&i.classList.remove("show"),s&&(s.textContent=""),s&&s.classList.remove("show");let d=!1;if(c&&c.startsWith(t)||(o.classList.add("invalid"),r&&(r.textContent="Informe uma data dentro do m√™s selecionado.",r.classList.add("show")),d=!0),(!l||l<=0)&&(a.classList.add("invalid"),i&&(i.textContent="Informe uma quantidade maior que zero.",i.classList.add("show")),d=!0),d)return void(void 0!==toast&&toast&&toast.warning("Preencha os campos corretamente."));const m=(window.app?.carregarEstoque?window.app.carregarEstoque(e,t):null)||{totalInicial:0,movimentacoes:[]};m.movimentacoes=m.movimentacoes||[],m.movimentacoes.push({tipo:"entrada",qtd:Math.abs(l),data:c}),n&&(n.dataset.busy="true",n.disabled=!0),window.app?.salvarEstoque&&(window.app.salvarEstoque(e,t,m),atualizarResumoEstoqueMes(e,t),void 0!==toast&&toast&&toast.success("Entrada de estoque registrada"),s&&(s.textContent=`Entrada registrada: +${Math.abs(l)} un em ${c}.`,s.classList.add("show")),o.value="",a.value="",n&&setTimeout(()=>{n.dataset.busy="false",n.disabled=!1},800))}function atualizarEstadoEstoqueInput(){const e=document.getElementById("mesSelecionado")?.value,t=document.getElementById("estoqueMes");t&&(t.disabled=!e,e||(t.value=""))}function normalizarMes(e){return/^\d{4}-\d{2}$/.test(e),e}let app;function inicializarApp(){console.log("üü£ [APP.JS] ========== INICIALIZANDO APLICA√á√ÉO =========="),console.log("üü£ [APP.JS] Criando inst√¢ncia de LojaApp..."),console.log("üü£ [APP.JS] SessionStorage:",{loggedIn:sessionStorage.getItem("loggedIn"),username:sessionStorage.getItem("username")});try{window.app?(console.log("‚ÑπÔ∏è [APP.JS] Inst√¢ncia de LojaApp j√° existe"),app=window.app):(console.log("üü£ [APP.JS] Criando nova inst√¢ncia de LojaApp..."),window.app=new LojaApp,app=window.app,console.log("‚úÖ [APP.JS] Inst√¢ncia de LojaApp criada com sucesso!"))}catch(e){console.error("‚ùå [APP.JS] ERRO ao criar LojaApp:",e),console.error("‚ùå [APP.JS] Stack:",e.stack),console.error("‚ùå [APP.JS] Mensagem:",e.message),console.warn("‚ö†Ô∏è [APP.JS] Tentando continuar mesmo com erro...")}}document.addEventListener("DOMContentLoaded",()=>{console.log("üü£ [APP.JS] ========== DOMContentLoaded DISPARADO =========="),inicializarApp()}),"complete"!==document.readyState&&"interactive"!==document.readyState||(console.log("üü£ [APP.JS] DOM j√° est√° pronto, inicializando imediatamente..."),setTimeout(inicializarApp,100));