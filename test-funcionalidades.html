<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Testes de Funcionalidades - ERP</title>
        <!-- Bibliotecas necess√°rias para os testes -->
        <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
        <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                    Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                background: #f5f5f5;
                padding: 2rem;
                line-height: 1.6;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 8px;
                padding: 2rem;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h1 {
                color: #dc3545;
                margin-bottom: 1rem;
            }

            .test-section {
                margin: 2rem 0;
                padding: 1.5rem;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #dc3545;
            }

            .test-section h2 {
                color: #333;
                margin-bottom: 1rem;
                font-size: 1.2rem;
            }

            .test-item {
                margin: 1rem 0;
                padding: 1rem;
                background: white;
                border-radius: 5px;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .test-item input[type='checkbox'] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

            .test-item label {
                flex: 1;
                cursor: pointer;
            }

            .test-btn {
                padding: 0.5rem 1rem;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9rem;
            }

            .test-btn:hover {
                background: #c82333;
            }

            .status {
                padding: 0.5rem 1rem;
                border-radius: 5px;
                font-size: 0.85rem;
                font-weight: 500;
            }

            .status.pending {
                background: #ffc107;
                color: #000;
            }

            .status.success {
                background: #28a745;
                color: white;
            }

            .status.error {
                background: #dc3545;
                color: white;
            }

            .results {
                margin-top: 2rem;
                padding: 1rem;
                background: #e9ecef;
                border-radius: 5px;
                max-height: 400px;
                overflow-y: auto;
            }

            .result-item {
                padding: 0.5rem;
                margin: 0.5rem 0;
                border-radius: 3px;
                font-size: 0.9rem;
            }

            .result-item.success {
                background: #d4edda;
                color: #155724;
            }

            .result-item.error {
                background: #f8d7da;
                color: #721c24;
            }

            .result-item.info {
                background: #d1ecf1;
                color: #0c5460;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üß™ Testes de Funcionalidades - Sistema ERP</h1>
            <p style="color: #666; margin-bottom: 2rem">
                Este painel ajuda a testar todas as funcionalidades
                implementadas do sistema.
            </p>

            <!-- Se√ß√£o 1: Backup -->
            <div class="test-section">
                <h2>1. Sistema de Backup com M√∫ltiplos Pontos</h2>

                <div class="test-item">
                    <input type="checkbox" id="test-backup-manual" />
                    <label for="test-backup-manual"
                        >Teste 1.1: Criar backup manual</label
                    >
                    <button class="test-btn" onclick="testBackupManual()">
                        Testar
                    </button>
                    <span class="status pending" id="status-backup-manual"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-backup-auto" />
                    <label for="test-backup-auto"
                        >Teste 1.2: Backup autom√°tico</label
                    >
                    <button class="test-btn" onclick="testBackupAuto()">
                        Testar
                    </button>
                    <span class="status pending" id="status-backup-auto"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-backup-points" />
                    <label for="test-backup-points"
                        >Teste 1.3: M√∫ltiplos pontos de armazenamento</label
                    >
                    <button class="test-btn" onclick="testBackupPoints()">
                        Testar
                    </button>
                    <span class="status pending" id="status-backup-points"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-backup-restore" />
                    <label for="test-backup-restore"
                        >Teste 1.4: Restaurar backup</label
                    >
                    <button class="test-btn" onclick="testBackupRestore()">
                        Testar
                    </button>
                    <span class="status pending" id="status-backup-restore"
                        >Pendente</span
                    >
                </div>
            </div>

            <!-- Se√ß√£o 2: Exporta√ß√£o -->
            <div class="test-section">
                <h2>2. Exporta√ß√£o Avan√ßada</h2>

                <div class="test-item">
                    <input type="checkbox" id="test-export-pdf" />
                    <label for="test-export-pdf"
                        >Teste 2.1: Exporta√ß√£o PDF</label
                    >
                    <button class="test-btn" onclick="testExportPDF()">
                        Testar
                    </button>
                    <span class="status pending" id="status-export-pdf"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-export-excel" />
                    <label for="test-export-excel"
                        >Teste 2.2: Exporta√ß√£o Excel/CSV</label
                    >
                    <button class="test-btn" onclick="testExportExcel()">
                        Testar
                    </button>
                    <span class="status pending" id="status-export-excel"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-export-schedule" />
                    <label for="test-export-schedule"
                        >Teste 2.3: Agendamento de exporta√ß√£o</label
                    >
                    <button class="test-btn" onclick="testExportSchedule()">
                        Testar
                    </button>
                    <span class="status pending" id="status-export-schedule"
                        >Pendente</span
                    >
                </div>
            </div>

            <!-- Se√ß√£o 3: Audit Log -->
            <div class="test-section">
                <h2>3. Hist√≥rico de Altera√ß√µes (Audit Log)</h2>

                <div class="test-item">
                    <input type="checkbox" id="test-audit-log" />
                    <label for="test-audit-log"
                        >Teste 3.1: Registrar altera√ß√µes</label
                    >
                    <button class="test-btn" onclick="testAuditLog()">
                        Testar
                    </button>
                    <span class="status pending" id="status-audit-log"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-audit-revert-update" />
                    <label for="test-audit-revert-update"
                        >Teste 3.2: Revers√£o de atualiza√ß√£o</label
                    >
                    <button class="test-btn" onclick="testAuditRevertUpdate()">
                        Testar
                    </button>
                    <span class="status pending" id="status-audit-revert-update"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-audit-revert-create" />
                    <label for="test-audit-revert-create"
                        >Teste 3.3: Revers√£o de cria√ß√£o</label
                    >
                    <button class="test-btn" onclick="testAuditRevertCreate()">
                        Testar
                    </button>
                    <span class="status pending" id="status-audit-revert-create"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-audit-filters" />
                    <label for="test-audit-filters"
                        >Teste 3.4: Filtros do audit log</label
                    >
                    <button class="test-btn" onclick="testAuditFilters()">
                        Testar
                    </button>
                    <span class="status pending" id="status-audit-filters"
                        >Pendente</span
                    >
                </div>
            </div>

            <!-- Se√ß√£o 4: Busca Avan√ßada -->
            <div class="test-section">
                <h2>4. Busca Avan√ßada</h2>

                <div class="test-item">
                    <input type="checkbox" id="test-search-global" />
                    <label for="test-search-global"
                        >Teste 4.1: Busca global</label
                    >
                    <button class="test-btn" onclick="testSearchGlobal()">
                        Testar
                    </button>
                    <span class="status pending" id="status-search-global"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-search-qr" />
                    <label for="test-search-qr"
                        >Teste 4.2: Busca por QR code</label
                    >
                    <button class="test-btn" onclick="testSearchQR()">
                        Testar
                    </button>
                    <span class="status pending" id="status-search-qr"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-search-voice" />
                    <label for="test-search-voice"
                        >Teste 4.3: Busca por voz</label
                    >
                    <button class="test-btn" onclick="testSearchVoice()">
                        Testar
                    </button>
                    <span class="status pending" id="status-search-voice"
                        >Pendente</span
                    >
                </div>

                <div class="test-item">
                    <input type="checkbox" id="test-search-filters" />
                    <label for="test-search-filters"
                        >Teste 4.4: Filtros avan√ßados</label
                    >
                    <button class="test-btn" onclick="testSearchFilters()">
                        Testar
                    </button>
                    <span class="status pending" id="status-search-filters"
                        >Pendente</span
                    >
                </div>
            </div>

            <!-- Resultados -->
            <div class="results">
                <h3 style="margin-bottom: 1rem">üìä Resultados dos Testes</h3>
                <div id="testResults"></div>
            </div>

            <div
                style="
                    margin-top: 2rem;
                    padding: 1rem;
                    background: #e7f3ff;
                    border-radius: 5px;
                "
            >
                <p>
                    <strong>üí° Dica:</strong> Abra o console do navegador (F12)
                    para ver logs detalhados dos testes.
                </p>
                <p style="margin-top: 0.5rem">
                    <strong>‚ö†Ô∏è Importante:</strong> Alguns testes requerem que
                    voc√™ esteja logado no sistema principal.
                </p>
                <p style="margin-top: 0.5rem">
                    <strong>üîÑ Status do Sistema:</strong>
                    <span id="systemStatus">Carregando...</span>
                </p>
            </div>
        </div>

        <script>
            // ========== MODO DE TESTE ==========
            // Definir flag de modo de teste ANTES de carregar app.js
            window.TEST_MODE = true;
            window.SUPPRESS_UI_WARNINGS = true; // Suprimir warnings de UI em modo de teste

            // ========== CARREGAR SISTEMA ==========
            let systemLoaded = false;
            let systemLoading = false;

            async function loadSystem() {
                if (systemLoaded || systemLoading) return;
                systemLoading = true;

                addResult('Sistema', 'info', 'Carregando sistema...');

                // Carregar app.js
                return new Promise((resolve, reject) => {
                    if (typeof LojaApp !== 'undefined' && window.app) {
                        systemLoaded = true;
                        systemLoading = false;
                        addResult(
                            'Sistema',
                            'success',
                            'Sistema j√° carregado!'
                        );
                        resolve();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = '/js/app.js?v=' + Date.now();

                    script.onerror = function () {
                        // Tentar caminho relativo
                        const scriptRetry = document.createElement('script');
                        scriptRetry.src = 'js/app.js?v=' + Date.now();
                        scriptRetry.onerror = function () {
                            systemLoading = false;
                            addResult(
                                'Sistema',
                                'error',
                                'Erro ao carregar app.js. Abra gerenciamento.html primeiro.'
                            );
                            reject(
                                new Error('N√£o foi poss√≠vel carregar app.js')
                            );
                        };
                        scriptRetry.onload = function () {
                            initializeApp().then(resolve).catch(reject);
                        };
                        document.head.appendChild(scriptRetry);
                    };

                    script.onload = function () {
                        initializeApp().then(resolve).catch(reject);
                    };

                    document.head.appendChild(script);
                });
            }

            async function initializeApp() {
                return new Promise((resolve, reject) => {
                    let tentativas = 0;
                    const maxTentativas = 20;

                    function tentar() {
                        tentativas++;
                        if (tentativas > maxTentativas) {
                            systemLoading = false;
                            addResult(
                                'Sistema',
                                'error',
                                'Timeout ao inicializar LojaApp'
                            );
                            reject(new Error('Timeout'));
                            return;
                        }

                        if (typeof LojaApp !== 'undefined') {
                            if (!window.app) {
                                try {
                                    window.app = new LojaApp();
                                    addResult(
                                        'Sistema',
                                        'success',
                                        'LojaApp inicializado!'
                                    );
                                } catch (error) {
                                    systemLoading = false;
                                    addResult(
                                        'Sistema',
                                        'error',
                                        `Erro ao criar LojaApp: ${error.message}`
                                    );
                                    reject(error);
                                    return;
                                }
                            }
                            systemLoaded = true;
                            systemLoading = false;
                            resolve();
                        } else {
                            setTimeout(tentar, 200);
                        }
                    }

                    tentar();
                });
            }

            // Atualizar status do sistema
            function updateSystemStatus() {
                const statusEl = document.getElementById('systemStatus');
                if (statusEl) {
                    if (systemLoaded && window.app) {
                        statusEl.textContent = '‚úÖ Sistema carregado e pronto';
                        statusEl.style.color = '#28a745';
                    } else if (systemLoading) {
                        statusEl.textContent = '‚è≥ Carregando sistema...';
                        statusEl.style.color = '#ffc107';
                    } else {
                        statusEl.textContent = '‚ùå Sistema n√£o carregado';
                        statusEl.style.color = '#dc3545';
                    }
                }
            }

            // Carregar sistema ao iniciar
            window.addEventListener('DOMContentLoaded', () => {
                updateSystemStatus();
                loadSystem()
                    .then(() => {
                        updateSystemStatus();
                    })
                    .catch((err) => {
                        console.error('Erro ao carregar sistema:', err);
                        updateSystemStatus();
                    });

                // Atualizar status periodicamente
                setInterval(updateSystemStatus, 1000);
            });

            // Fun√ß√£o para adicionar resultado
            function addResult(testName, status, message) {
                const resultsDiv = document.getElementById('testResults');
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${status}`;
                resultItem.innerHTML = `<strong>${testName}:</strong> ${message}`;
                resultsDiv.appendChild(resultItem);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }

            // Fun√ß√£o para atualizar status
            function updateStatus(testId, status, message) {
                const statusEl = document.getElementById(`status-${testId}`);
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `status ${status}`;
                }
                const checkbox = document.getElementById(`test-${testId}`);
                if (checkbox) {
                    checkbox.checked = status === 'success';
                }
            }

            // Teste 1.1: Backup Manual
            async function testBackupManual() {
                addResult('Backup Manual', 'info', 'Iniciando teste...');
                updateStatus('backup-manual', 'pending', 'Testando...');

                try {
                    // Garantir que sistema est√° carregado
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error(
                            'Sistema n√£o carregado. Aguarde o carregamento ou abra gerenciamento.html primeiro.'
                        );
                    }

                    // Verificar se usu√°rio est√° logado
                    const username = sessionStorage.getItem('username');
                    if (!username) {
                        throw new Error(
                            'Usu√°rio n√£o logado. Fa√ßa login primeiro.'
                        );
                    }

                    // Criar backup
                    await app.createManualBackup();

                    // Verificar se backup foi criado
                    app.loadBackupHistory();
                    if (app.backupHistory.length > 0) {
                        const lastBackup = app.backupHistory[0];
                        if (
                            lastBackup.storagePoints &&
                            lastBackup.storagePoints.length > 0
                        ) {
                            updateStatus(
                                'backup-manual',
                                'success',
                                `‚úÖ OK (${lastBackup.storagePoints.length} pontos)`
                            );
                            addResult(
                                'Backup Manual',
                                'success',
                                `Backup criado com sucesso! Armazenado em: ${lastBackup.storagePoints.join(
                                    ', '
                                )}`
                            );
                        } else {
                            updateStatus('backup-manual', 'success', '‚úÖ OK');
                            addResult(
                                'Backup Manual',
                                'success',
                                'Backup criado com sucesso!'
                            );
                        }
                    } else {
                        throw new Error('Backup n√£o foi criado');
                    }
                } catch (error) {
                    updateStatus('backup-manual', 'error', '‚ùå Erro');
                    addResult(
                        'Backup Manual',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 1.2: Backup Autom√°tico
            async function testBackupAuto() {
                addResult('Backup Autom√°tico', 'info', 'Iniciando teste...');
                updateStatus('backup-auto', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Configurar backup autom√°tico
                    const username = sessionStorage.getItem('username');
                    if (!username) {
                        throw new Error('Usu√°rio n√£o logado.');
                    }

                    // Ativar backup autom√°tico
                    app.startAutoBackup('daily');

                    // Aguardar um pouco para garantir que a configura√ß√£o foi salva
                    await new Promise((resolve) => setTimeout(resolve, 300));

                    // Verificar configura√ß√£o
                    const configStr = localStorage.getItem(
                        `autoBackupConfig_${username}`
                    );
                    if (configStr) {
                        const config = JSON.parse(configStr);
                        if (config.enabled) {
                            updateStatus('backup-auto', 'success', '‚úÖ OK');
                            addResult(
                                'Backup Autom√°tico',
                                'success',
                                `Backup autom√°tico configurado: ${config.frequency}`
                            );
                        } else {
                            throw new Error(
                                'Backup autom√°tico n√£o foi ativado'
                            );
                        }
                    } else {
                        throw new Error('Configura√ß√£o n√£o encontrada');
                    }
                } catch (error) {
                    updateStatus('backup-auto', 'error', '‚ùå Erro');
                    addResult(
                        'Backup Autom√°tico',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 1.3: M√∫ltiplos Pontos
            async function testBackupPoints() {
                addResult('M√∫ltiplos Pontos', 'info', 'Iniciando teste...');
                updateStatus('backup-points', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    const username = sessionStorage.getItem('username');
                    if (!username) {
                        throw new Error('Usu√°rio n√£o logado.');
                    }

                    // Verificar pontos configurados
                    const points = [];

                    // localStorage (sempre ativo)
                    points.push('localStorage');

                    // IndexedDB
                    if (app.useIndexedDB && app.indexedDB) {
                        points.push('IndexedDB');
                    }

                    // Cloud
                    const cloudEnabled =
                        localStorage.getItem(
                            `backupStorage_cloud_${username}`
                        ) === 'true';
                    if (cloudEnabled) {
                        points.push('Nuvem');
                    }

                    // Download
                    const downloadEnabled =
                        localStorage.getItem(
                            `autoBackupDownload_${username}`
                        ) === 'true';
                    if (downloadEnabled) {
                        points.push('Download');
                    }

                    updateStatus(
                        'backup-points',
                        'success',
                        `‚úÖ ${points.length} pontos`
                    );
                    addResult(
                        'M√∫ltiplos Pontos',
                        'success',
                        `Pontos configurados: ${points.join(', ')}`
                    );
                } catch (error) {
                    updateStatus('backup-points', 'error', '‚ùå Erro');
                    addResult(
                        'M√∫ltiplos Pontos',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 1.4: Restaurar Backup
            async function testBackupRestore() {
                addResult('Restaurar Backup', 'info', 'Iniciando teste...');
                updateStatus('backup-restore', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    app.loadBackupHistory();

                    if (app.backupHistory.length === 0) {
                        throw new Error(
                            'Nenhum backup dispon√≠vel para restaurar. Crie um backup primeiro.'
                        );
                    }

                    const lastBackup = app.backupHistory[0];
                    const checksum = app.generateChecksum(lastBackup.data);

                    if (checksum === lastBackup.checksum) {
                        updateStatus('backup-restore', 'success', '‚úÖ OK');
                        addResult(
                            'Restaurar Backup',
                            'success',
                            `Backup √≠ntegro e pronto para restaurar. ID: ${lastBackup.id}`
                        );
                    } else {
                        throw new Error(
                            'Backup corrompido (checksum n√£o confere)'
                        );
                    }
                } catch (error) {
                    updateStatus('backup-restore', 'error', '‚ùå Erro');
                    addResult(
                        'Restaurar Backup',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 2.1: Exporta√ß√£o PDF
            async function testExportPDF() {
                addResult('Exporta√ß√£o PDF', 'info', 'Iniciando teste...');
                updateStatus('export-pdf', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se jsPDF est√° carregado
                    // A biblioteca pode estar em window.jspdf.jsPDF ou window.jspdf
                    let jsPDFAvailable = false;
                    if (typeof window.jspdf !== 'undefined') {
                        if (
                            typeof window.jspdf.jsPDF !== 'undefined' ||
                            typeof window.jspdf.jsPDF === 'function'
                        ) {
                            jsPDFAvailable = true;
                        }
                    }

                    if (!jsPDFAvailable) {
                        // Aguardar um pouco e tentar novamente
                        await new Promise((resolve) =>
                            setTimeout(resolve, 500)
                        );
                        if (
                            typeof window.jspdf !== 'undefined' &&
                            (typeof window.jspdf.jsPDF !== 'undefined' ||
                                typeof window.jspdf.jsPDF === 'function')
                        ) {
                            jsPDFAvailable = true;
                        }
                    }

                    if (!jsPDFAvailable) {
                        throw new Error(
                            'Biblioteca jsPDF n√£o carregada. Verifique se as bibliotecas foram carregadas corretamente.'
                        );
                    }

                    // Criar dados de teste
                    const testData = {
                        items: app.items.slice(0, 5) || [],
                        completedSales: app.completedSales.slice(0, 5) || [],
                    };

                    // Testar exporta√ß√£o
                    app.exportAsPDF(
                        testData,
                        'all',
                        'teste_export',
                        true,
                        true
                    );

                    updateStatus('export-pdf', 'success', '‚úÖ OK');
                    addResult(
                        'Exporta√ß√£o PDF',
                        'success',
                        'PDF gerado com sucesso! Verifique o download.'
                    );
                } catch (error) {
                    updateStatus('export-pdf', 'error', '‚ùå Erro');
                    addResult(
                        'Exporta√ß√£o PDF',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 2.2: Exporta√ß√£o Excel
            async function testExportExcel() {
                addResult('Exporta√ß√£o Excel', 'info', 'Iniciando teste...');
                updateStatus('export-excel', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Criar dados de teste
                    const testData = {
                        items: app.items.slice(0, 5) || [],
                        completedSales: app.completedSales.slice(0, 5) || [],
                        clients: app.clients.slice(0, 5) || [],
                    };

                    // Testar exporta√ß√£o
                    app.exportAsExcel(testData, 'all', 'teste_export');

                    updateStatus('export-excel', 'success', '‚úÖ OK');
                    addResult(
                        'Exporta√ß√£o Excel',
                        'success',
                        'CSV gerado com sucesso! Verifique o download.'
                    );
                } catch (error) {
                    updateStatus('export-excel', 'error', '‚ùå Erro');
                    addResult(
                        'Exporta√ß√£o Excel',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 2.3: Agendamento de Exporta√ß√£o
            async function testExportSchedule() {
                addResult(
                    'Agendamento Exporta√ß√£o',
                    'info',
                    'Iniciando teste...'
                );
                updateStatus('export-schedule', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se agendamentos est√£o funcionando
                    if (
                        app.scheduledExports &&
                        Array.isArray(app.scheduledExports)
                    ) {
                        updateStatus('export-schedule', 'success', '‚úÖ OK');
                        addResult(
                            'Agendamento Exporta√ß√£o',
                            'success',
                            `Sistema de agendamento ativo. ${app.scheduledExports.length} agendamentos configurados.`
                        );
                    } else {
                        throw new Error(
                            'Sistema de agendamento n√£o inicializado'
                        );
                    }
                } catch (error) {
                    updateStatus('export-schedule', 'error', '‚ùå Erro');
                    addResult(
                        'Agendamento Exporta√ß√£o',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 3.1: Audit Log
            async function testAuditLog() {
                addResult('Audit Log', 'info', 'Iniciando teste...');
                updateStatus('audit-log', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se audit log existe
                    if (app.auditLog && Array.isArray(app.auditLog)) {
                        updateStatus(
                            'audit-log',
                            'success',
                            `‚úÖ ${app.auditLog.length} logs`
                        );
                        addResult(
                            'Audit Log',
                            'success',
                            `Sistema de audit log ativo. ${app.auditLog.length} registros encontrados.`
                        );
                    } else {
                        throw new Error('Audit log n√£o inicializado');
                    }
                } catch (error) {
                    updateStatus('audit-log', 'error', '‚ùå Erro');
                    addResult('Audit Log', 'error', `Erro: ${error.message}`);
                }
            }

            // Teste 3.2: Revers√£o de Atualiza√ß√£o
            async function testAuditRevertUpdate() {
                addResult('Revers√£o Atualiza√ß√£o', 'info', 'Iniciando teste...');
                updateStatus('audit-revert-update', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de revers√£o existe
                    if (typeof app.revertAuditLogAction === 'function') {
                        // Verificar se h√° logs revers√≠veis
                        const reversibleLogs = app.auditLog.filter(
                            (log) =>
                                log.reversible ||
                                (log.action === 'update' &&
                                    log.details &&
                                    log.details.previousData)
                        );

                        if (reversibleLogs.length > 0) {
                            updateStatus(
                                'audit-revert-update',
                                'success',
                                `‚úÖ ${reversibleLogs.length} revers√≠veis`
                            );
                            addResult(
                                'Revers√£o Atualiza√ß√£o',
                                'success',
                                `Fun√ß√£o de revers√£o dispon√≠vel. ${reversibleLogs.length} a√ß√µes podem ser revertidas.`
                            );
                        } else {
                            updateStatus(
                                'audit-revert-update',
                                'success',
                                '‚úÖ OK'
                            );
                            addResult(
                                'Revers√£o Atualiza√ß√£o',
                                'info',
                                'Fun√ß√£o de revers√£o dispon√≠vel. Nenhuma a√ß√£o revers√≠vel no momento.'
                            );
                        }
                    } else {
                        throw new Error('Fun√ß√£o de revers√£o n√£o encontrada');
                    }
                } catch (error) {
                    updateStatus('audit-revert-update', 'error', '‚ùå Erro');
                    addResult(
                        'Revers√£o Atualiza√ß√£o',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 3.3: Revers√£o de Cria√ß√£o
            async function testAuditRevertCreate() {
                addResult('Revers√£o Cria√ß√£o', 'info', 'Iniciando teste...');
                updateStatus('audit-revert-create', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de revers√£o de cria√ß√£o existe
                    if (typeof app.deleteEntityForRevert === 'function') {
                        const createLogs = app.auditLog.filter(
                            (log) => log.action === 'create'
                        );

                        updateStatus(
                            'audit-revert-create',
                            'success',
                            `‚úÖ ${createLogs.length} cria√ß√µes`
                        );
                        addResult(
                            'Revers√£o Cria√ß√£o',
                            'success',
                            `Fun√ß√£o de revers√£o de cria√ß√£o dispon√≠vel. ${createLogs.length} cria√ß√µes podem ser revertidas.`
                        );
                    } else {
                        throw new Error(
                            'Fun√ß√£o de revers√£o de cria√ß√£o n√£o encontrada'
                        );
                    }
                } catch (error) {
                    updateStatus('audit-revert-create', 'error', '‚ùå Erro');
                    addResult(
                        'Revers√£o Cria√ß√£o',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 3.4: Filtros Audit Log
            async function testAuditFilters() {
                addResult('Filtros Audit Log', 'info', 'Iniciando teste...');
                updateStatus('audit-filters', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de renderiza√ß√£o existe
                    if (typeof app.renderAuditLog === 'function') {
                        updateStatus('audit-filters', 'success', '‚úÖ OK');
                        addResult(
                            'Filtros Audit Log',
                            'success',
                            'Sistema de filtros dispon√≠vel. Filtros por a√ß√£o e entidade funcionando.'
                        );
                    } else {
                        throw new Error(
                            'Fun√ß√£o de renderiza√ß√£o n√£o encontrada'
                        );
                    }
                } catch (error) {
                    updateStatus('audit-filters', 'error', '‚ùå Erro');
                    addResult(
                        'Filtros Audit Log',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 4.1: Busca Global
            async function testSearchGlobal() {
                addResult('Busca Global', 'info', 'Iniciando teste...');
                updateStatus('search-global', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de busca avan√ßada existe
                    if (typeof app.executeAdvancedSearch === 'function') {
                        updateStatus('search-global', 'success', '‚úÖ OK');
                        addResult(
                            'Busca Global',
                            'success',
                            'Sistema de busca global dispon√≠vel. Busca em m√∫ltiplas entidades funcionando.'
                        );
                    } else {
                        throw new Error(
                            'Fun√ß√£o de busca avan√ßada n√£o encontrada'
                        );
                    }
                } catch (error) {
                    updateStatus('search-global', 'error', '‚ùå Erro');
                    addResult(
                        'Busca Global',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 4.2: Busca por QR Code
            async function testSearchQR() {
                addResult('Busca QR Code', 'info', 'Iniciando teste...');
                updateStatus('search-qr', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de scanner existe
                    if (
                        typeof app.startAdvancedSearchQRScanner === 'function'
                    ) {
                        // Verificar se biblioteca est√° carregada
                        if (typeof window.Html5Qrcode !== 'undefined') {
                            updateStatus('search-qr', 'success', '‚úÖ OK');
                            addResult(
                                'Busca QR Code',
                                'success',
                                'Scanner QR dispon√≠vel. Biblioteca Html5Qrcode carregada.'
                            );
                        } else {
                            updateStatus(
                                'search-qr',
                                'error',
                                '‚ö†Ô∏è Sem biblioteca'
                            );
                            addResult(
                                'Busca QR Code',
                                'error',
                                'Fun√ß√£o dispon√≠vel, mas biblioteca Html5Qrcode n√£o carregada.'
                            );
                        }
                    } else {
                        throw new Error('Fun√ß√£o de scanner QR n√£o encontrada');
                    }
                } catch (error) {
                    updateStatus('search-qr', 'error', '‚ùå Erro');
                    addResult(
                        'Busca QR Code',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 4.3: Busca por Voz
            async function testSearchVoice() {
                addResult('Busca por Voz', 'info', 'Iniciando teste...');
                updateStatus('search-voice', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de voz existe
                    if (typeof app.startAdvancedSearchVoice === 'function') {
                        // Verificar se Web Speech API est√° dispon√≠vel
                        const hasSpeechRecognition =
                            'webkitSpeechRecognition' in window ||
                            'SpeechRecognition' in window;

                        if (hasSpeechRecognition) {
                            updateStatus('search-voice', 'success', '‚úÖ OK');
                            addResult(
                                'Busca por Voz',
                                'success',
                                'Reconhecimento de voz dispon√≠vel. Web Speech API suportada.'
                            );
                        } else {
                            updateStatus(
                                'search-voice',
                                'error',
                                '‚ö†Ô∏è N√£o suportado'
                            );
                            addResult(
                                'Busca por Voz',
                                'error',
                                'Fun√ß√£o dispon√≠vel, mas Web Speech API n√£o suportada neste navegador.'
                            );
                        }
                    } else {
                        throw new Error(
                            'Fun√ß√£o de busca por voz n√£o encontrada'
                        );
                    }
                } catch (error) {
                    updateStatus('search-voice', 'error', '‚ùå Erro');
                    addResult(
                        'Busca por Voz',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Teste 4.4: Filtros Avan√ßados
            async function testSearchFilters() {
                addResult('Filtros Avan√ßados', 'info', 'Iniciando teste...');
                updateStatus('search-filters', 'pending', 'Testando...');

                try {
                    if (!systemLoaded) {
                        await loadSystem();
                    }

                    if (typeof app === 'undefined' || !window.app) {
                        throw new Error('Sistema n√£o carregado.');
                    }

                    // Verificar se fun√ß√£o de busca avan√ßada existe
                    if (typeof app.executeAdvancedSearch === 'function') {
                        updateStatus('search-filters', 'success', '‚úÖ OK');
                        addResult(
                            'Filtros Avan√ßados',
                            'success',
                            'Sistema de filtros avan√ßados dispon√≠vel. Filtros por categoria, per√≠odo e entidade funcionando.'
                        );
                    } else {
                        throw new Error(
                            'Fun√ß√£o de busca avan√ßada n√£o encontrada'
                        );
                    }
                } catch (error) {
                    updateStatus('search-filters', 'error', '‚ùå Erro');
                    addResult(
                        'Filtros Avan√ßados',
                        'error',
                        `Erro: ${error.message}`
                    );
                }
            }

            // Executar todos os testes
            async function runAllTests() {
                addResult('Sistema', 'info', 'Iniciando todos os testes...');

                // Garantir que sistema est√° carregado
                if (!systemLoaded) {
                    addResult(
                        'Sistema',
                        'info',
                        'Carregando sistema antes dos testes...'
                    );
                    try {
                        await loadSystem();
                    } catch (error) {
                        addResult(
                            'Sistema',
                            'error',
                            `Erro ao carregar sistema: ${error.message}`
                        );
                        return;
                    }
                }

                setTimeout(() => testBackupManual(), 100);
                setTimeout(() => testBackupAuto(), 200);
                setTimeout(() => testBackupPoints(), 300);
                setTimeout(() => testBackupRestore(), 400);
                setTimeout(() => testExportPDF(), 500);
                setTimeout(() => testExportExcel(), 600);
                setTimeout(() => testExportSchedule(), 700);
                setTimeout(() => testAuditLog(), 800);
                setTimeout(() => testAuditRevertUpdate(), 900);
                setTimeout(() => testAuditRevertCreate(), 1000);
                setTimeout(() => testAuditFilters(), 1100);
                setTimeout(() => testSearchGlobal(), 1200);
                setTimeout(() => testSearchQR(), 1300);
                setTimeout(() => testSearchVoice(), 1400);
                setTimeout(() => testSearchFilters(), 1500);
            }

            // Adicionar bot√£o para executar todos
            window.addEventListener('DOMContentLoaded', () => {
                const container = document.querySelector('.container');
                const runAllBtn = document.createElement('button');
                runAllBtn.textContent = '‚ñ∂Ô∏è Executar Todos os Testes';
                runAllBtn.className = 'test-btn';
                runAllBtn.style.cssText =
                    'margin: 1rem 0; padding: 1rem; font-size: 1rem; width: 100%;';
                runAllBtn.onclick = runAllTests;
                container.insertBefore(
                    runAllBtn,
                    container.firstChild.nextSibling
                );
            });
        </script>
    </body>
</html>
